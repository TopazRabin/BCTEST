OBJECT Page 50001 Quick Quote Worksheet
{
  OBJECT-PROPERTIES
  {
    Date=07/01/20;
    Time=12:00:00 AM;
    Modified=Yes;
    Version List=TOP010,230;
  }
  PROPERTIES
  {
    InsertAllowed=No;
    DeleteAllowed=No;
    SourceTable=Table50001;
    SourceTableView=SORTING(Line No.,Item No.,Sell-To Customer No.)
                    ORDER(Ascending);
    PageType=List;
    OnOpenPage=BEGIN
                 CalcTotal;
                 CalcMarginPct; //TOP230 KT ABCSI CRP 2 Fixes 05282015
               END;

  }
  CONTROLS
  {
    { 1000000000;0;Container;
                ContainerType=ContentArea }

    { 1000000001;1;Group  ;
                Name=Group;
                GroupType=Repeater }

    { 1000000002;2;Field  ;
                SourceExpr="Item No.";
                Editable=FALSE }

    { 1000000003;2;Field  ;
                SourceExpr="Line No.";
                Editable=FALSE }

    { 1000000005;2;Field  ;
                SourceExpr="Reason Code" }

    { 1000000006;2;Field  ;
                SourceExpr="Reason Code Comment" }

    { 1000000007;2;Field  ;
                SourceExpr="Lost Opportunity" }

    { 1000000008;2;Field  ;
                SourceExpr=Description;
                Editable=FALSE }

    { 1000000004;2;Field  ;
                SourceExpr="Location Code" }

    { 1000000010;2;Field  ;
                SourceExpr="Current Qty.";
                OnValidate=BEGIN
                             //TOP230 KT ABCSI CRP 2 Fixes 05282015
                             CalcTotal;
                             CalcMarginPct;
                             //TOP230 KT ABCSI CRP 2 Fixes 05282015
                           END;
                            }

    { 1000000011;2;Field  ;
                SourceExpr="Current UOM" }

    { 1000000012;2;Field  ;
                SourceExpr="Qty per Unit of Measure" }

    { 1000000009;2;Field  ;
                SourceExpr="Current Qty (Base)";
                OnValidate=BEGIN
                             //TOP230 KT ABCSI CRP 2 Fixes 05282015
                             CalcTotal;
                             CalcMarginPct;
                             //TOP230 KT ABCSI CRP 2 Fixes 05282015
                           END;
                            }

    { 1000000013;2;Field  ;
                SourceExpr="Unit Price";
                OnValidate=BEGIN
                             //TOP230 KT ABCSI CRP 2 Fixes 05282015
                             CalcTotal;
                             CalcMarginPct;
                             //TOP230 KT ABCSI CRP 2 Fixes 05282015
                           END;
                            }

    { 1000000020;2;Field  ;
                Name=Line Amount;
                SourceExpr="Current Qty (Base)"*"Unit Price" }

    { 1000000014;2;Field  ;
                SourceExpr="Sell-To Customer No.";
                Editable=FALSE }

    { 1000000015;2;Field  ;
                SourceExpr="Promotion Code";
                Editable=FALSE }

    { 1000000016;1;Group  ;
                GroupType=Group }

    { 1000000017;2;Group  ;
                GroupType=Group }

    { 1000000018;3;Group  ;
                GroupType=Group }

    { 1000000019;4;Field  ;
                CaptionML=ENU=Total;
                SourceExpr=OrderTotal;
                AutoFormatType=1;
                Editable=FALSE }

    { 1000000021;4;Field  ;
                Name=<MarginPct>;
                CaptionML=ENU=Gross Margin %;
                SourceExpr=MarginPct;
                Editable=FALSE }

  }
  CODE
  {
    VAR
      OrderTotal@1000000000 : Decimal;
      Item@1000000001 : Record 27;
      LineCount@1000000002 : Integer;
      MarginPct@1000000003 : Decimal;

    PROCEDURE SetTotal@1000000005(varOrderTotal@1000000000 : Decimal);
    BEGIN
      OrderTotal := varOrderTotal;
    END;

    PROCEDURE CalcTotal@1000000010();
    BEGIN
      RESET;
      SETCURRENTKEY("Location Code",Description,"Item No.","Sell-To Customer No.");
      SETFILTER("Current Qty.",'<>%1',0);
      //SETRANGE("Sell-To Customer No.","Sell-To Customer No.");
      IF FIND('-') THEN REPEAT
        OrderTotal += "Current Qty (Base)" * "Unit Price";
      UNTIL NEXT = 0;
    END;

    PROCEDURE CalcMarginPct@1000000000();
    BEGIN
      LineCount := 0;
      MarginPct := 0;
      IF FINDFIRST THEN REPEAT
        Item.GET("Item No.");
        IF ("Current Qty." <> 0) AND ("Unit Price" <> 0 ) AND (Item."Unit Cost" <> 0) THEN BEGIN
          MarginPct += ROUND((("Current Qty (Base)" * "Unit Price") - ("Current Qty (Base)" * Item."Unit Cost")) * 100 / ("Current Qty (Base)" * "Unit Price"),0.1);
          LineCount += 1;
        END;
      UNTIL NEXT = 0;
      IF LineCount <> 0 THEN
        MarginPct := MarginPct / LineCount;
    END;

    BEGIN
    {
      TOP010 KT ABCSI Stock Status Quick Quote Screen 12082014
        - Place Holder for Show Order Summary Action on Stock Status Quick Quote Screen

      TOP230 KT ABCSI CRP 2 Fixes 05282015
        - Added a new function CalcMarginPct and new field MarginPct
    }
    END.
  }
}

