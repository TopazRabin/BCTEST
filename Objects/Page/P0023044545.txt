OBJECT Page 23044545 WMDM Base Optional Merge
{
  OBJECT-PROPERTIES
  {
    Date=05/04/17;
    Time=[ 8:57:01 AM];
    Version List=WMDM1.8.1705;
  }
  PROPERTIES
  {
    CaptionML=[ENU=WMDM Base Optional Merge;
               ESM=WMDM Bar Combinar opcional;
               FRC=WMDM Bar Fusion en option;
               ENC=WMDM Base Optional Merge];
  }
  CONTROLS
  {
  }
  CODE
  {

    PROCEDURE compressLines@1000000000();
    VAR
      ltrecItemJnl@1000000003 : TEMPORARY Record 83;
      lrecItem@1000000002 : Record 27;
      ldlgProgress@1000000001 : Dialog;
      lnEntryNo@1000000000 : Integer;
      ltcProgressStr@1000000004 : TextConst 'ENU=Compressing entries\Entry Number #1#####';
      lrecComponentUsage@1000000005 : Record 23044501;
    BEGIN
      {
      // This should be used when the handheld generates consumption entries.
      // Merges all similar lines together to minimize the # of lines posted

      ItemJnlLine.FINDSET;
      IF ItemJnlLine."Entry Type" <> ItemJnlLine."Entry Type"::Consumption THEN
        EXIT;

      ldlgProgress.OPEN(ltcProgressStr, lnEntryNo);

      REPEAT
        lnEntryNo +=1;
        ldlgProgress.UPDATE(1, lnEntryNo);

        IF ItemJnlLine."Item No."<> '' THEN BEGIN
          // set component usage for line
          IF (ItemJnlLine."Prod. Serial No." <> '') OR (ItemJnlLine."Prod. Lot No." <> '') THEN BEGIN
            CLEAR(lrecComponentUsage);
            lrecComponentUsage.addUsage(ItemJnlLine);
          END;//if

          IF NOT hasTracking THEN BEGIN
            // only merge items that do not have any item tracking lines
            ltrecItemJnl.SETRANGE("Journal Template Name", ItemJnlLine."Journal Template Name");
            ltrecItemJnl.SETRANGE("Journal Batch Name", ItemJnlLine."Journal Batch Name");
            ltrecItemJnl.SETRANGE("Item No.", ItemJnlLine."Item No.");
            ltrecItemJnl.SETRANGE("Location Code", ItemJnlLine."Location Code");
            ltrecItemJnl.SETRANGE("Variant Code", ItemJnlLine."Variant Code");


            // below two are not valid for Nav2013
            //ltrecItemJnl.SETRANGE("Prod. Order No.", ItemJnlLine."Prod. Order No.");
            //ltrecItemJnl.SETRANGE("Prod. Order Line No.", ItemJnlLine."Prod. Order Line No.");
            // replaced with the following three fields
            ltrecItemJnl.SETRANGE("Order Type", ItemJnlLine."Order Type");
            ltrecItemJnl.SETRANGE("Order No.", ItemJnlLine."Order No.");
            ltrecItemJnl.SETRANGE("Order Line No.", ItemJnlLine."Order Line No.");

            // although it is best practice for the document no. to be the order no., we need
            // to make sure that we also support the not-best-practices approach as well.
            ltrecItemJnl.SETRANGE("Document No.", ItemJnlLine."Document No.");
            ltrecItemJnl.SETRANGE("Document Line No.", ItemJnlLine."Document Line No.");

            // must be limited to consumption only.
            ltrecItemJnl.SETRANGE("Entry Type", ItemJnlLine."Entry Type"::Consumption);



            IF NOT ltrecItemJnl.FINDSET THEN BEGIN
              ltrecItemJnl := ItemJnlLine;
              ltrecItemJnl.INSERT;
            END ELSE BEGIN
              ltrecItemJnl.VALIDATE(Quantity, ltrecItemJnl.Quantity + ItemJnlLine.Quantity);
              ltrecItemJnl.VALIDATE("Unit of Measure Code", ItemJnlLine."Unit of Measure Code");
              ltrecItemJnl.MODIFY;
            END;//if found line

            ItemJnlLine.DELETE(TRUE);
          END;//if item no.
        END;//if item tracking
      UNTIL ItemJnlLine.NEXT = 0;

      // got temp lines and deleted original, so rebuild batch and continue posting
      ltrecItemJnl.RESET;
      IF ltrecItemJnl.FINDSET THEN
        REPEAT
          ItemJnlLine := ltrecItemJnl;
          ItemJnlLine."Prod. Serial No." := '';
          ItemJnlLine."Prod. Lot No." := '';
          ItemJnlLine.ValidateShortcutDimCode(1, ItemJnlLine."Shortcut Dimension 1 Code");
          ItemJnlLine.ValidateShortcutDimCode(2, ItemJnlLine."Shortcut Dimension 2 Code");
          ItemJnlLine.INSERT;
        UNTIL ltrecItemJnl.NEXT = 0;

      ldlgProgress.CLOSE;
      }
    END;

    PROCEDURE hasTracking@1000000001() : Boolean;
    VAR
      lrecResEntry@1000000000 : Record 337;
    BEGIN
      {
      //This should be used when the handheld generates consumption entries.
      // Determines if the line has serial numbers on it or not

      lrecResEntry.SETRANGE("Source ID",ItemJnlLine."Journal Template Name");
      lrecResEntry.SETRANGE("Source Ref. No.",ItemJnlLine."Line No.");
      lrecResEntry.SETRANGE("Source Type",DATABASE::"Item Journal Line");
      lrecResEntry.SETRANGE("Source Subtype",ItemJnlLine."Entry Type");
      lrecResEntry.SETRANGE("Source Batch Name",ItemJnlLine."Journal Batch Name");
      lrecResEntry.SETRANGE("Source Prod. Order Line",0);
      lrecResEntry.SETFILTER("Qty. to Handle (Base)",'<>0');
      lrecResEntry.SETRANGE("Item Tracking", lrecResEntry."Item Tracking"::"Lot No.",  lrecResEntry."Item Tracking"::"Serial No.");
      EXIT(lrecResEntry.FINDSET);
      }
    END;

    BEGIN
    {
      ************************
      Copyright Notice
      This objects content is copyright of Insight Works 2011.  All rights reserved.
      Any redistribution or reproduction of part or all of the contents in any form is prohibited.
      ************************

      ********************************************************
      NOTE: This codeunit is not intended to compile.
      ********************************************************

      Use the instructions below to optionally merge in wmdm changes in the base NAV objects.
      Code has been commented out so will need to be un-commented apon merge.

      Item Jnl.-Post Batch codeunit (C23)
        - If you need to compress consumption lines prior to posting
        - Copy the function 'compressLines' from this page to the 'Item Jnl.-Post Batch' codeunit
        - Copy the function 'hasTracking' from this page to the 'Item Jnl.-Post Batch' codeunit
        - Add a call to compresslines in the 'Code' function of the codeunit (see below).
            ...

            CheckLines(ItemJnlLine);

            compressLines; //<DMS Version="WMDM" />

            // Find next register no.
            ...
    }
    END.
  }
}

