OBJECT Report 50068 Send Customer Statement_AUTO
{
  OBJECT-PROPERTIES
  {
    Date=07/01/20;
    Time=12:00:00 AM;
    Modified=Yes;
    Version List=SE0.53.46;
  }
  PROPERTIES
  {
    CaptionML=ENU=Send Customer Statement;
    ProcessingOnly=Yes;
  }
  DATASET
  {
    { 6836;    ;DataItem;                    ;
               DataItemTable=Table18;
               DataItemTableView=SORTING(No.)
                                 WHERE(Print Statements=FILTER(Yes),
                                       Balance (LCY)=FILTER(>0));
               OnPreDataItem=VAR
                               JobQueueEntry@1000000001 : Record 472;
                               CurrObjectID@1000000000 : Integer;
                             BEGIN
                               // <TPZ61>
                               IF NOT GUIALLOWED OR IsNASBackgroundClient THEN BEGIN
                                 WORKDATE := CALCDATE('<CM+1D-1M-1D>',TODAY);
                                END;
                                      {
                                 EVALUATE(
                                  CurrObjectID,
                                   COPYSTR(CurrReport.OBJECTID(FALSE),STRPOS(CurrReport.OBJECTID(FALSE),' ') + 1));

                                 JobQueueEntry.RESET;
                                 JobQueueEntry.SETRANGE("Object Type to Run",JobQueueEntry."Object Type to Run"::Report);
                                 JobQueueEntry.SETRANGE("Object ID to Run",CurrObjectID);
                                 IF JobQueueEntry.FINDFIRST AND
                                    (JobQueueEntry."Parameter String" <> '')
                                 THEN
                                   SETFILTER("No.",JobQueueEntry."Parameter String");
                               END;
                               // </TPZ61>
                                }
                               // CustomerNo := '54449';
                                SETRANGE("No.",CustomerNo);
                             END;

               OnAfterGetRecord=BEGIN
                                  // <TPZ61>
                                  //EMailMgt.SendCustomerStatement(Customer,TRUE,TRUE);
                                  // </TPZ61>
                                END;

               OnPostDataItem=BEGIN
                                // <TPZ61>
                                IF NOT GUIALLOWED THEN
                                  WORKDATE := TODAY;
                                // </TPZ61>
                              END;

               ReqFilterFields=No.,E-Mail Cust. Stat. Send Date;
               CalcFields=Balance (LCY) }

    { 1240030000;1;Column;COMPANYNAME        ;
               SourceExpr=COMPANYNAME }

    { 1240030002;1;Column;FORMAT_TODAY_0_4_  ;
               SourceExpr=FORMAT(TODAY,0,4) }

    { 1240030003;1;Column;USERID             ;
               SourceExpr=USERID }

    { 1240030005;1;Column;CurrReport_PAGENO  ;
               SourceExpr=CurrReport.PAGENO }

    { 1240030006;1;Column;Customer__No__     ;
               SourceExpr="No." }

    { 1240030008;1;Column;Customer_Name      ;
               SourceExpr=Name }

    { 1240030001;1;Column;Send_Customer_StatementCaption;
               SourceExpr=Send_Customer_StatementCaptionLbl }

    { 1240030004;1;Column;CurrReport_PAGENOCaption;
               SourceExpr=CurrReport_PAGENOCaptionLbl }

    { 1240030007;1;Column;Customer__No__Caption;
               SourceExpr=FIELDCAPTION("No.") }

    { 1240030009;1;Column;Customer_NameCaption;
               SourceExpr=FIELDCAPTION(Name) }

    { 1000000000;1;DataItem;                 ;
               DataItemTable=Table50007;
               OnAfterGetRecord=VAR
                                  Customer2@1000000000 : Record 18;
                                  CustomerLedgerEntry@1000000001 : Record 21;
                                BEGIN
                                  // <TPZ61>
                                  //EmailHdlg.SetBatch(TRUE);
                                  //EmailHdlg.SetDivisionCode("Customer Division"."Shortcut Dimension 5 Code");
                                  //EMailMgt.SendCustomerStatement(Customer,TRUE,TRUE);
                                  //EmailHdlg.SetDivisionCode('');
                                  //EmailHdlg.SetBatch(FALSE);
                                  // </TPZ61>

                                  {
                                  CustomerLedgerEntry.RESET();
                                  CustomerLedgerEntry.SETFILTER("Customer No.","Customer No.");
                                  CustomerLedgerEntry.SETRANGE(Open,TRUE);
                                  CustomerLedgerEntry.SETFILTER("Shortcut Dimension 5 Code","Shortcut Dimension 5 Code");
                                  IF NOT CustomerLedgerEntry.FINDFIRST THEN
                                    CurrReport.SKIP;
                                  }

                                  EmailHdlg.SetBatch(TRUE);
                                  EmailHdlg.SetDivisionCode("Shortcut Dimension 5 Code");
                                  //EmailHdlg.SetDivisionCode(''); //EB
                                  Customer2.RESET;
                                  //Customer2.SETRANGE("No.","Customer No.");                 // SHAIL
                                  Customer2.SETRANGE("No.",CustomerNo);
                                  Customer2.SETFILTER("Division Code Filter","Shortcut Dimension 5 Code");//<TPZ2582>
                                  Customer2.FINDFIRST;
                                  //<TPZ2582>
                                  Customer2.CALCFIELDS("Balance (LCY)");
                                  IF Customer2."Balance (LCY)" = 0 THEN
                                    CurrReport.SKIP;
                                  //</TPZ2582>

                                  EMailMgt.SendCustomerStatement(Customer2,TRUE,TRUE);
                                  EmailHdlg.SetDivisionCode('');
                                END;

               DataItemLink=Customer No.=FIELD(No.) }

    { 1000000001;2;Column;ShortcutDim5Code   ;
               SourceExpr="Shortcut Dimension 5 Code" }

    { 1000000002;2;Column;ShortcutDim5Code_Caption;
               SourceExpr=FIELDCAPTION("Shortcut Dimension 5 Code") }

  }
  REQUESTPAGE
  {
    PROPERTIES
    {
    }
    CONTROLS
    {
    }
  }
  LABELS
  {
  }
  CODE
  {
    VAR
      EMailMgt@1000000000 : Codeunit 14000903;
      Send_Customer_StatementCaptionLbl@8448 : TextConst 'ENU=Send Customer Statement';
      CurrReport_PAGENOCaptionLbl@8565 : TextConst 'ENU=Page';
      EmailHdlg@1000000001 : Codeunit 50011;
      CustomerNo@1000000002 : Code[10];

    PROCEDURE IsNASBackgroundClient@1000000003() : Boolean;
    VAR
      ActiveSession@1000 : Record 2000000110;
    BEGIN
      // <TPZ61>
      IF ActiveSession.GET(SERVICEINSTANCEID,SESSIONID) AND
         ((ActiveSession."Client Type" = ActiveSession."Client Type"::NAS) OR
          (ActiveSession."Client Type" = ActiveSession."Client Type"::Background))
      THEN
        EXIT(TRUE);

      EXIT(FALSE);
      // <TPZ61>
    END;

    PROCEDURE SetCustomerNo@1000000000(CustNo@1000000000 : Code[10]);
    BEGIN
           CustomerNo:=CustNo;
    END;

    BEGIN
    {
      2015-07-29 TPZ61 TAKHMETO
        Data Model has been updated, Filtering using Parameter String from Job Queue Entry has been added
      2017-06-28 TPZ1938 EBAGIM
        Report Modified to allow automation via Job Queue
      2018-10-26 TPZ2430 SNAGPAL
        Move outbound emails to O365 smtp server.
      2019-05-02 TPZ2582 UCHOUHAN
        Added code to filter according to Division.
    }
    END.
  }
  RDLDATA
  {
  }
}

