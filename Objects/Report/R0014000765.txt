OBJECT Report 14000765 Import UPS Billing Data
{
  OBJECT-PROPERTIES
  {
    Date=06/28/17;
    Time=12:00:00 PM;
    Version List=SE0.60.03;
  }
  PROPERTIES
  {
    ProcessingOnly=Yes;
    OnPreReport=BEGIN
                  PackingStation.GetPackingStation;
                  CarrierPackingStation.GetPackingStation(PackingStation);

                  ShippingBillReconHeader.GET(ShippingBillNo);

                  Window.OPEN('Import UPS Billing Data\#1###### records processed.');
                END;

    OnPostReport=BEGIN
                   InsertShippingBillLine;
                   Window.CLOSE;
                 END;

  }
  DATASET
  {
    { 5444;    ;DataItem;                    ;
               DataItemTable=Table2000000026;
               DataItemTableView=SORTING(Number);
               OnPreDataItem=BEGIN
                               SETRANGE(Number,1);
                             END;

               OnAfterGetRecord=VAR
                                  TextLine@1240020000 : Text[1024];
                                BEGIN
                                  IF NOT UPLOADINTOSTREAM(
                                           'Select UPS Billing Data and click Open',
                                           CarrierPackingStation."UPSlink Temp. Files Directory",
                                           'Text or CSV Files (*.txt, *.csv)|*.txt;*.csv',TempText,InputStream)
                                  THEN
                                    ERROR('Error uploading file to server.');

                                  //UPSInputFile.TEXTMODE(TRUE);
                                  //UPSInputFile.OPEN(UPSInputFilename);

                                  WHILE GetTextLine(TextLine) DO BEGIN
                                    UPSBillingData1.INIT;
                                    UPSBillingData1."Shipping Bill No." := ShippingBillReconHeader."Shipping Bill No.";
                                    UPSBillingData1."Line No." := UPSBillingData1."Line No." + 10000;
                                    UPSBillingData2.INIT;
                                    UPSBillingData2."Shipping Bill No." := ShippingBillReconHeader."Shipping Bill No.";
                                    UPSBillingData2."Line No." := UPSBillingData1."Line No.";

                                    TextLine := TextLine + ',';
                                    FOR i := 1 TO 185 DO BEGIN
                                      IF COPYSTR(TextLine,1,1) = '"' THEN BEGIN
                                        TextLine := COPYSTR(TextLine,2);  // remove first "
                                        TextPart := COPYSTR(TextLine,1,STRPOS(TextLine,'"')-1);  // up to next "
                                        TextLine := COPYSTR(TextLine,STRPOS(TextLine,'"')+2);
                                      END ELSE BEGIN
                                        CommaPos := STRPOS(TextLine,',');
                                        IF CommaPos <= 0 THEN
                                          ERROR(Text001);
                                        TextPart := COPYSTR(TextLine,1,CommaPos - 1);
                                        TextLine := COPYSTR(TextLine,CommaPos + 1);
                                      END;
                                      CASE i OF
                                        1:
                                          UPSBillingData1.Version := TextPart;
                                        2:
                                          UPSBillingData1."Recipient Number" := TextPart;
                                        3:
                                          UPSBillingData1."Account Number" := TextPart;
                                        4:
                                          UPSBillingData1."Account Country" := TextPart;
                                        5:
                                          UPSBillingData1."Invoice Date" := TextPart;
                                        6:
                                          UPSBillingData1."Invoice Number" := TextPart;
                                        7:
                                          UPSBillingData1."Invoice Type Code" := TextPart;
                                        8:
                                          UPSBillingData1."Invoice Type Detail Code" := TextPart;
                                        9:
                                          UPSBillingData1."Account Tax ID" := TextPart;
                                        10:
                                          UPSBillingData1."Invoice Currency Code" := TextPart;
                                        11:
                                          UPSBillingData1."Invoice Amount" := TextPart;
                                        12:
                                          UPSBillingData1."Transaction Date" := TextPart;
                                        13:
                                          UPSBillingData1."Pickup Record Number" := TextPart;
                                        14:
                                          UPSBillingData1."Lead Shipment Number" := TextPart;
                                        15:
                                          UPSBillingData1."World Ease Number" := TextPart;
                                        16:
                                          UPSBillingData1."Shipment Reference Number 1" := TextPart;
                                        17:
                                          UPSBillingData1."Shipment Reference Number 2" := TextPart;
                                        18:
                                          UPSBillingData1."Bill Option Code" := TextPart;
                                        19:
                                          UPSBillingData1."Package Quantity" := TextPart;
                                        20:
                                          UPSBillingData1."Oversize Quantity" := TextPart;
                                        21:
                                          UPSBillingData1."Tracking Number" := TextPart;
                                        22:
                                          UPSBillingData1."Package Reference Number 1" := TextPart;
                                        23:
                                          UPSBillingData1."Package Reference Number 2" := TextPart;
                                        24:
                                          UPSBillingData1."Package Reference Number 3" := TextPart;
                                        25:
                                          UPSBillingData1."Package Reference Number 4" := TextPart;
                                        26:
                                          UPSBillingData1."Package Reference Number 5" := TextPart;
                                        27:
                                          UPSBillingData1."Entered Weight" := TextPart;
                                        28:
                                          UPSBillingData1."Entered Weight Unit of Measure" := TextPart;
                                        29:
                                          UPSBillingData1."Billed Weight" := TextPart;
                                        30:
                                          UPSBillingData1."Billed Weight Unit of Measure" := TextPart;
                                        31:
                                          UPSBillingData1."Container Type" := TextPart;
                                        32:
                                          UPSBillingData1."Billed Weight Type" := TextPart;
                                        33:
                                          UPSBillingData1."Package Dimensions" := TextPart;
                                        34:
                                          UPSBillingData1.Zone := TextPart;
                                        35:
                                          UPSBillingData1."Charge Category Code" := TextPart;
                                        36:
                                          UPSBillingData1."Charge Category Detail Code" := TextPart;
                                        37:
                                          UPSBillingData1."Charge Source" := TextPart;
                                        38:
                                          UPSBillingData1."Type Code 1" := TextPart;
                                        39:
                                          UPSBillingData1."Type Detail Code 1" := TextPart;
                                        40:
                                          UPSBillingData1."Type Detail Value 1" := TextPart;
                                        41:
                                          UPSBillingData1."Type Code 2" := TextPart;
                                        42:
                                          UPSBillingData1."Type Detail Code 2" := TextPart;
                                        43:
                                          UPSBillingData1."Type Detail Value 2" := TextPart;
                                        44:
                                          UPSBillingData1."Charge Classification Code" := TextPart;
                                        45:
                                          UPSBillingData1."Charge Description Code" := TextPart;
                                        46:
                                          UPSBillingData1."Charge Description" := TextPart;
                                        47:
                                          UPSBillingData1."Charged Unit Quantity" := TextPart;
                                        48:
                                          UPSBillingData1."Basis Currency Code" := TextPart;
                                        49:
                                          UPSBillingData1."Basis Value" := TextPart;
                                        50:
                                          UPSBillingData1."Tax Indicator" := TextPart;
                                        51:
                                          UPSBillingData1."Transaction Currency Code" := TextPart;
                                        52:
                                          UPSBillingData1."Incentive Amount" := TextPart;
                                        53:
                                          UPSBillingData1."Net Amount" := TextPart;
                                        54:
                                          UPSBillingData1."Misc Currency Code" := TextPart;
                                        55:
                                          UPSBillingData1."Misc Incentive Amount" := TextPart;
                                        56:
                                          UPSBillingData1."Misc Net Amount" := TextPart;
                                        57:
                                          UPSBillingData1."Alt  Invoicing Currency Code" := TextPart;
                                        58:
                                          UPSBillingData1."Alternate Invoice Amount" := TextPart;
                                        59:
                                          UPSBillingData1."Invoice Exchange Rate" := TextPart;
                                        60:
                                          UPSBillingData1."Tax Variance Amount" := TextPart;
                                        61:
                                          UPSBillingData1."Currency Variance Amount" := TextPart;
                                        62:
                                          UPSBillingData1."Invoice Level Charge" := TextPart;
                                        63:
                                          UPSBillingData1."Invoice Due Date" := TextPart;
                                        64:
                                          UPSBillingData1."Alternate Invoice Number" := TextPart;
                                        65:
                                          UPSBillingData1."Store Number" := TextPart;
                                        66:
                                          UPSBillingData1."Customer Reference Number" := TextPart;
                                        67:
                                          UPSBillingData1."Sender Name" := TextPart;
                                        68:
                                          UPSBillingData1."Sender Company Name" := TextPart;
                                        69:
                                          UPSBillingData1."Sender Address Line 1" := TextPart;
                                        70:
                                          UPSBillingData1."Sender Address Line 2" := TextPart;
                                        71:
                                          UPSBillingData1."Sender City" := TextPart;
                                        72:
                                          UPSBillingData1."Sender State" := TextPart;
                                        73:
                                          UPSBillingData1."Sender Postal" := TextPart;
                                        74:
                                          UPSBillingData1."Sender Country" := TextPart;
                                        75:
                                          UPSBillingData1."Receiver Name" := TextPart;
                                        76:
                                          UPSBillingData1."Receiver Company Name" := TextPart;
                                        77:
                                          UPSBillingData1."Receiver Address Line 1" := TextPart;
                                        78:
                                          UPSBillingData1."Receiver Address Line 2" := TextPart;
                                        79:
                                          UPSBillingData1."Receiver City" := TextPart;
                                        80:
                                          UPSBillingData1."Receiver State" := TextPart;
                                        81:
                                          UPSBillingData1."Receiver Postal" := TextPart;
                                        82:
                                          UPSBillingData1."Receiver Country" := TextPart;
                                        83:
                                          UPSBillingData1."Third Party Name" := TextPart;
                                        84:
                                          UPSBillingData1."Third Party Company Name" := TextPart;
                                        85:
                                          UPSBillingData1."Third Party Address Line 1" := TextPart;
                                        86:
                                          UPSBillingData1."Third Party Address Line 2" := TextPart;
                                        87:
                                          UPSBillingData1."Third Party City" := TextPart;
                                        88:
                                          UPSBillingData1."Third Party State" := TextPart;
                                        89:
                                          UPSBillingData1."Third Party Postal" := TextPart;
                                        90:
                                          UPSBillingData1."Third Party Country" := TextPart;
                                        91:
                                          UPSBillingData1."Sold To Name" := TextPart;
                                        92:
                                          UPSBillingData1."Sold To Company Name" := TextPart;
                                        93:
                                          UPSBillingData1."Sold To Address Line 1" := TextPart;
                                        94:
                                          UPSBillingData1."Sold To Address Line 2" := TextPart;
                                        95:
                                          UPSBillingData1."Sold To City" := TextPart;
                                        96:
                                          UPSBillingData1."Sold To State" := TextPart;
                                        97:
                                          UPSBillingData1."Sold To Postal" := TextPart;
                                        98:
                                          UPSBillingData1."Sold To Country" := TextPart;
                                        99:
                                          UPSBillingData1."Misc Address Qual 1" := TextPart;
                                        100:
                                          UPSBillingData1."Misc Address 1 Name" := TextPart;
                                        101:
                                          UPSBillingData1."Misc Address 1 Company Name" := TextPart;
                                        102:
                                          UPSBillingData1."Misc Address 1 Address Line 1" := TextPart;
                                        103:
                                          UPSBillingData1."Misc Address 1 Address Line 2" := TextPart;
                                        104:
                                          UPSBillingData1."Misc Address 1 City" := TextPart;
                                        105:
                                          UPSBillingData1."Misc Address 1 State" := TextPart;
                                        106:
                                          UPSBillingData1."Misc Address 1 Postal" := TextPart;
                                        107:
                                          UPSBillingData1."Misc Address 1 Country" := TextPart;
                                        108:
                                          UPSBillingData1."Misc Address Qual 2" := TextPart;
                                        109:
                                          UPSBillingData1."Misc Address 2 Name" := TextPart;
                                        110:
                                          UPSBillingData1."Misc Address 2 Company Name" := TextPart;
                                        111:
                                          UPSBillingData1."Misc Address 2 Address Line 1" := TextPart;
                                        112:
                                          UPSBillingData1."Misc Address 2 Address Line 2" := TextPart;
                                        113:
                                          UPSBillingData1."Misc Address 2 City" := TextPart;
                                        114:
                                          UPSBillingData1."Misc Address 2 State" := TextPart;
                                        115:
                                          UPSBillingData1."Misc Address 2 Postal" := TextPart;
                                        116:
                                          UPSBillingData1."Misc Address 2 Country" := TextPart;
                                        117:
                                          UPSBillingData1."Shipment Date" := TextPart;
                                        118:
                                          UPSBillingData1."Shipment Export Date" := TextPart;
                                        119:
                                          UPSBillingData1."Shipment Import Date" := TextPart;
                                        120:
                                          UPSBillingData1."Entry Date" := TextPart;
                                        121:
                                          UPSBillingData1."Direct Shipment Date" := TextPart;
                                        122:
                                          UPSBillingData1."Shipment Delivery Date" := TextPart;
                                        123:
                                          UPSBillingData1."Shipment Release Date" := TextPart;
                                        124:
                                          UPSBillingData1."Cycle Date" := TextPart;
                                        125:
                                          UPSBillingData1."EFT Date" := TextPart;
                                        126:
                                          UPSBillingData1."Validation Date" := TextPart;
                                        127:
                                          UPSBillingData1."Entry Port" := TextPart;
                                        128:
                                          UPSBillingData1."Entry Number" := TextPart;
                                        129:
                                          UPSBillingData1."Export Place" := TextPart;
                                        130:
                                          UPSBillingData1."Shipment Value Amount" := TextPart;
                                        131:
                                          UPSBillingData1."Shipment Description" := TextPart;
                                        132:
                                          UPSBillingData1."Entered Currency Code" := TextPart;
                                        133:
                                          UPSBillingData1."Customs Number" := TextPart;
                                        134:
                                          UPSBillingData1."Exchange Rate" := TextPart;
                                        135:
                                          UPSBillingData1."Master Air Waybill Number" := TextPart;
                                        136:
                                          UPSBillingData1.EPU := TextPart;
                                        137:
                                          UPSBillingData1."Entry Type" := TextPart;
                                        138:
                                          UPSBillingData1."CPC Code" := TextPart;
                                        139:
                                          UPSBillingData1."Line Item Number" := TextPart;
                                        140:
                                          UPSBillingData1."Goods Description" := TextPart;
                                        141:
                                          UPSBillingData1."Entered Value" := TextPart;
                                        142:
                                          UPSBillingData1."Duty Amount" := TextPart;
                                        143:
                                          UPSBillingData1.Weight := TextPart;
                                        144:
                                          UPSBillingData1."Unit of Measure" := TextPart;
                                        145:
                                          UPSBillingData2."Item Quantity" := TextPart;
                                        146:
                                          UPSBillingData2."Item Quantity Unit of Measure" := TextPart;
                                        147:
                                          UPSBillingData2."Import Tax ID" := TextPart;
                                        148:
                                          UPSBillingData2."Declaration Number" := TextPart;
                                        149:
                                          UPSBillingData2."Carrier Name" := TextPart;
                                        150:
                                          UPSBillingData2."CCCD Number" := TextPart;
                                        151:
                                          UPSBillingData2."Cycle Number" := TextPart;
                                        152:
                                          UPSBillingData2."Foreign Trade Ref Number" := TextPart;
                                        153:
                                          UPSBillingData2."Job Number" := TextPart;
                                        154:
                                          UPSBillingData2."Transport Mode" := TextPart;
                                        155:
                                          UPSBillingData2."Tax Type" := TextPart;
                                        156:
                                          UPSBillingData2."Tariff Code" := TextPart;
                                        157:
                                          UPSBillingData2."Tariff Rate" := TextPart;
                                        158:
                                          UPSBillingData2."Tariff Treatment Number" := TextPart;
                                        159:
                                          UPSBillingData2."Contact Name" := TextPart;
                                        160:
                                          UPSBillingData2."Class Number" := TextPart;
                                        161:
                                          UPSBillingData2."Document Type" := TextPart;
                                        162:
                                          UPSBillingData2."Office Number" := TextPart;
                                        163:
                                          UPSBillingData2."Document Number" := TextPart;
                                        164:
                                          UPSBillingData2."Duty Value" := TextPart;
                                        165:
                                          UPSBillingData2."Total Value for Duty" := TextPart;
                                        166:
                                          UPSBillingData2."Excise Tax Amount" := TextPart;
                                        167:
                                          UPSBillingData2."Excise Tax Rate" := TextPart;
                                        168:
                                          UPSBillingData2."GST Amount" := TextPart;
                                        169:
                                          UPSBillingData2."GST Rate" := TextPart;
                                        170:
                                          UPSBillingData2."Order In Council" := TextPart;
                                        171:
                                          UPSBillingData2."Origin Country" := TextPart;
                                        172:
                                          UPSBillingData2."SIMA Access" := TextPart;
                                        173:
                                          UPSBillingData2."Tax Value" := TextPart;
                                        174:
                                          UPSBillingData2."Total Customs Amount" := TextPart;
                                        175:
                                          UPSBillingData2."Misc Line 1" := TextPart;
                                        176:
                                          UPSBillingData2."Misc Line 2" := TextPart;
                                        177:
                                          UPSBillingData2."Misc Line 3" := TextPart;
                                        178:
                                          UPSBillingData2."Misc Line 4" := TextPart;
                                        179:
                                          UPSBillingData2."Misc Line 5" := TextPart;
                                        180:
                                          UPSBillingData2."Payor Role Code" := TextPart;
                                        181:
                                          UPSBillingData2."Misc Line 7" := TextPart;
                                        182:
                                          UPSBillingData2."Misc Line 8" := TextPart;
                                        183:
                                          UPSBillingData2."Misc Line 9" := TextPart;
                                        184:
                                          UPSBillingData2."Misc Line 10" := TextPart;
                                        185:
                                          UPSBillingData2."UPS Internal Use" := TextPart;
                                      END;
                                    END;

                                    UPSBillingData1.ConvertImportedFields;

                                    UPSBillingData1.INSERT;
                                    UPSBillingData2.INSERT;

                                    UpdateWindow;
                                  END;
                                END;

               OnPostDataItem=BEGIN
                                IF UPSBillingData1."Invoice Number" <> '' THEN BEGIN
                                  ShippingBillReconHeader.VALIDATE("External Document No.",UPSBillingData1."Invoice Number");
                                  ShippingBillReconHeader."Invoice Date" := UPSBillingData1."Invoice Date (Converted)";
                                  ShippingBillReconHeader.MODIFY;
                                END;
                              END;
                               }

  }
  REQUESTPAGE
  {
    PROPERTIES
    {
    }
    CONTROLS
    {
      { 1900000001;0;Container;
                  ContainerType=ContentArea }

      { 1900000002;1;Group  ;
                  CaptionML=ENU=Options }

      { 1240020000;2;Field  ;
                  CaptionML=ENU=Shipping Bill Reconciliation;
                  SourceExpr=ShippingBillNo;
                  TableRelation="Shipping Bill Recon. Header" }

    }
  }
  LABELS
  {
  }
  CODE
  {
    VAR
      ShippingBillReconHeader@1240020006 : Record 14000751;
      ShippingBillReconline@1240020003 : Record 14000752;
      UPSBillingData1@1240020002 : Record 14000775;
      UPSBillingData2@1240020001 : Record 14000776;
      PackingStation@1240020009 : Record 14000709;
      CarrierPackingStation@1240020000 : Record 14000729;
      InputStream@1240020013 : InStream;
      TextPart@1240020011 : Text[250];
      TempText@1240020012 : Text;
      i@1240020004 : Integer;
      CommaPos@1240020005 : Integer;
      ShippingBillNo@1240020008 : Code[20];
      Text001@1240020010 : TextConst 'ENU=Invalid File Format for input file.';
      Window@1240020007 : Dialog;
      x@1240020014 : Integer;

    PROCEDURE InitializeRequest@2(NewShippingBillNo@1240030000 : Code[20]);
    BEGIN
      ShippingBillNo := NewShippingBillNo;
    END;

    PROCEDURE InsertShippingBillLine@3();
    VAR
      LastTrackNo@1240030000 : Code[30];
      FirstEntry@1240030001 : Boolean;
      TotalNetCharge@1240030006 : Decimal;
      TotalIncentive@1240030003 : Decimal;
      TotalWgt@1240030004 : Decimal;
      TotalNet@1240030005 : Decimal;
    BEGIN
      //>> Insert Reconcile line after all the UPS bill entries are imported
      LastTrackNo := 'X Y Z';
      FirstEntry := FALSE;
      UPSBillingData1.RESET;
      UPSBillingData1.SETRANGE("Shipping Bill No.",ShippingBillReconHeader."Shipping Bill No.");
      IF UPSBillingData1.FIND('-') THEN
        REPEAT
          IF (UPSBillingData1."Net Amount (Converted)" <> 0) THEN BEGIN
            IF (LastTrackNo <> UPSBillingData1."Tracking Number") OR
              (UPSBillingData1."Charge Category Code" <> 'SHP') OR
              (UPSBillingData1."Tracking Number" = '')
            THEN BEGIN
              TotalNetCharge := 0;
              TotalIncentive := 0;
              TotalWgt := 0;
              TotalNet := 0;
              FirstEntry := TRUE;

              ShippingBillReconline.INIT;
              ShippingBillReconline."Shipping Bill No." := ShippingBillReconHeader."Shipping Bill No.";
              ShippingBillReconline."Line No." := UPSBillingData1."Line No.";
              ShippingBillReconline.VALIDATE("External Tracking No.",UPSBillingData1."Tracking Number");
              IF ShippingBillReconline."No." = '' THEN
                ShippingBillReconline.Type := ShippingBillReconline.Type::"Other Charges";
              ShippingBillReconline.VALIDATE(Description,UPSBillingData1."Charge Description");
            END;

            TotalNetCharge := TotalNetCharge + UPSBillingData1."Net Amount (Converted)";
            ShippingBillReconline.VALIDATE("Net Charge Amount",TotalNetCharge);
            IF UPSBillingData1."Incentive Amount(Converted)" <> 0 THEN BEGIN
              TotalIncentive := TotalIncentive + UPSBillingData1."Incentive Amount(Converted)";
              ShippingBillReconline.VALIDATE("Incentive Amount",TotalIncentive);
              ShippingBillReconline.VALIDATE("Discount Invoiced",TotalIncentive);
            END;
            TotalWgt := TotalWgt + UPSBillingData1."Billed Weight (Converted)";
            ShippingBillReconline."Weight Invoiced" := TotalWgt;

            IF FirstEntry THEN BEGIN
              ShippingBillReconline.INSERT;
              FirstEntry := FALSE;
            END ELSE
              ShippingBillReconline.MODIFY;
          END;
          LastTrackNo := UPSBillingData1."Tracking Number";
        UNTIL UPSBillingData1.NEXT = 0;
    END;

    PROCEDURE GetTextLine@1240030000(VAR TextLine@1240030001 : Text) : Boolean;
    VAR
      i@1240030002 : Integer;
      Char@1240030003 : Char;
      HyphenFound@1240030004 : Boolean;
    BEGIN
      i := 1;
      TextLine := '';;

      IF InputStream.EOS THEN
        EXIT(FALSE);

      InputStream.READ(Char);

      IF Char IN [10,13,20] THEN
        EXIT(FALSE);

      TextLine := FORMAT(Char);

      REPEAT
        InputStream.READ(Char);
        IF (i < 1024) AND (Char <> 10) AND (Char <> 13) THEN
          TextLine := TextLine + FORMAT(Char);
        i := i + 1;
      UNTIL (Char = 10);

      IF STRLEN(TextLine) > 0 THEN BEGIN
        Char := TextLine[1];
        IF NOT (Char IN [10,13,20]) THEN
          EXIT(TRUE)
        ELSE
          EXIT(FALSE);
      END ELSE
        EXIT(FALSE);
    END;

    PROCEDURE UpdateWindow@1240020001();
    BEGIN
      x := x + 1;
      IF ((ROUND(x/1000,1) - (x/1000)) = 0) THEN
        Window.UPDATE(1,x);
    END;

    BEGIN
    END.
  }
  RDLDATA
  {
  }
}

