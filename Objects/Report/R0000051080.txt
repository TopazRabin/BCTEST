OBJECT Report 51080 Auto Post Bill Of Lading
{
  OBJECT-PROPERTIES
  {
    Date=03/05/21;
    Time=[ 4:40:48 AM];
    Modified=Yes;
    Version List=ASN;
  }
  PROPERTIES
  {
    ProcessingOnly=Yes;
  }
  DATASET
  {
    { 1000000000;;DataItem;                  ;
               DataItemTable=Table14000822;
               DataItemTableView=SORTING(No.)
                                 WHERE(Posted=CONST(No));
               OnAfterGetRecord=VAR
                                  ReleaseBOL@1000000000 : Boolean;
                                BEGIN
                                  PostedDocFound := TRUE;
                                  //<TPZ841>
                                  {BillofLadingInfoLine.RESET;
                                  BillofLadingInfoLine.SETRANGE(BillofLadingInfoLine."Bill of Lading No.","No.");
                                  BillofLadingInfoLine.SETRANGE(BillofLadingInfoLine."Source Type",36);
                                  BillofLadingInfoLine.SETRANGE(BillofLadingInfoLine."Source Subtype",BillofLadingInfoLine."Source Subtype"::"1");
                                  BillofLadingInfoLine.SETFILTER(BillofLadingInfoLine."Source ID",'<>%1','');
                                  IF BillofLadingInfoLine.FINDSET THEN BEGIN
                                    REPEAT
                                      IF (BillofLadingInfoLine."Posted Source ID" = '') THEN BEGIN
                                          PostedDocFound := FALSE;
                                          CurrReport.SKIP;
                                      END;
                                    UNTIL BillofLadingInfoLine.NEXT = 0;
                                  END ELSE
                                    PostedDocFound := FALSE;
                                  }
                                  {
                                  BillofLadingInfoLine1.RESET;
                                  BillofLadingInfoLine1.SETRANGE(BillofLadingInfoLine1."Bill of Lading No.","No.");
                                  IF BillofLadingInfoLine1.FINDSET THEN BEGIN
                                    REPEAT
                                      IF BillofLadingInfoLine1."EDI ASN" THEN
                                         CurrReport.SKIP;
                                    UNTIL BillofLadingInfoLine1.NEXT =0;
                                  END;
                                  }
                                  IF Released = FALSE THEN BEGIN
                                    ReleaseBOL := TRUE;
                                    BillOfLadingLine.RESET;
                                    BillOfLadingLine.SETRANGE("Bill of Lading No.","No.");
                                    //BillOfLadingLine.SETFILTER("Posted Source ID", '<>%1','');
                                    IF BillOfLadingLine.FINDSET THEN BEGIN
                                      REPEAT
                                        IF BillOfLadingLine."Posted Source ID" = '' THEN
                                          ReleaseBOL := FALSE;
                                      UNTIL BillOfLadingLine.NEXT = 0;
                                    END ELSE
                                      ReleaseBOL := FALSE;
                                    IF ReleaseBOL THEN BEGIN
                                      BOLMgt.CloseBillOfLading("Bill of Lading",0);
                                      BOLMgt.CloseBOLSummary("Bill of Lading");
                                    END;
                                  END;

                                  BillofLadingInfoLine.RESET;
                                  BillofLadingInfoLine.SETRANGE(BillofLadingInfoLine."Bill of Lading No.","No.");
                                  //BillofLadingInfoLine.SETRANGE(BillofLadingInfoLine."Source Type",36);
                                  //BillofLadingInfoLine.SETRANGE(BillofLadingInfoLine."Source Subtype",BillofLadingInfoLine."Source Subtype"::"1");
                                  BillofLadingInfoLine.SETFILTER(BillofLadingInfoLine."Source ID",'<>%1','');
                                  IF BillofLadingInfoLine.FINDSET THEN BEGIN
                                    REPEAT
                                      SalesShipmentHeader.RESET;
                                      SalesShipmentHeader. SETRANGE("Order No.",BillofLadingInfoLine."Source ID");
                                      IF NOT SalesShipmentHeader.FINDFIRST THEN BEGIN
                                         PostedDocFound := FALSE;
                                          CurrReport.SKIP;
                                      END;
                                      //-->28418
                                      Package.RESET;
                                      Package.SETRANGE("Source Type",BillofLadingInfoLine."Source Type");
                                      Package.SETRANGE("Source Subtype",BillofLadingInfoLine."Source Subtype");
                                      Package.SETRANGE("Source ID",BillofLadingInfoLine."Source ID");
                                      IF Package.FINDFIRST THEN BEGIN
                                         PostedDocFound := FALSE;
                                         CurrReport.SKIP;
                                      END;
                                      //<--28418
                                    UNTIL BillofLadingInfoLine.NEXT = 0;
                                  END ELSE
                                    PostedDocFound := FALSE;
                                  //</TPZ841>

                                  //<TPZ841>
                                  BillOfLadingLine.RESET;
                                  BillOfLadingLine.SETRANGE("Bill of Lading No.","No.");
                                  IF BillOfLadingLine.FINDSET THEN
                                    REPEAT
                                      IF (BillOfLadingLine.Type=BillOfLadingLine.Type::Order) AND (NOT "Cost On Documents") THEN BEGIN
                                          SalesHeader.SETRANGE("Document Type",SalesHeader."Document Type"::Order);
                                          SalesHeader.SETRANGE("No.",BillOfLadingLine."Source ID");
                                          SalesHeader.SETFILTER("Shipping Payment Type",'%1|%2', SalesHeader."Shipping Payment Type"::Prepaid,SalesHeader."Shipping Payment Type"::Consignee);
                                          IF SalesHeader.FINDFIRST THEN BEGIN
                                             SalesLine.SETRANGE("Document Type",SalesLine."Document Type"::Order);
                                             SalesLine.SETRANGE("Document No.",SalesHeader."No.");
                                             SalesLine.SETRANGE("Shipping Charge",TRUE);
                                             IF NOT SalesLine.FINDFIRST THEN
                                                CurrReport.SKIP;
                                          END;
                                      END;
                                    UNTIL BillOfLadingLine.NEXT = 0;
                                  //</TPZ841>

                                  IF PostedDocFound THEN BEGIN
                                    IF NOT Released THEN BEGIN
                                      //BOL Release
                                       BOLMgt.CloseBillOfLading("Bill of Lading",0);
                                    END;
                                    IF NOT "Summary Released" THEN
                                         // BOL Summary Released
                                       BOLMgt.CloseBOLSummary("Bill of Lading");

                                    IF "EDI ASN" THEN BEGIN
                                      PackingRule.GetPackingRule("Ship-to Type","Ship-to No.","Ship-to Code");
                                      IF PackingRule."Allow BOL Post Before ASN Send" = FALSE THEN BEGIN
                                        IF "EDI ASN" AND NOT "EDI BSN" AND NOT "EDI ASN Generated" THEN BEGIN
                                            EDIIntegration.SendASN("Bill of Lading");
                                            GET("No.");
                                        END;

                                        IF "EDI ASN" AND "EDI BSN" AND NOT "EDI BSN Generated" THEN BEGIN
                                            EDIASNSend.ExportASN("Bill of Lading",'E_SLSBSN',FALSE);
                                            GET("No.");
                                          END;
                                      END;
                                    END;
                                   //BOL Post
                                   BOLMgt.PostBillOfLading("Bill of Lading",FALSE);
                                  END ELSE
                                   CurrReport.SKIP;

                                END;

               ReqFilterFields=No. }

  }
  REQUESTPAGE
  {
    PROPERTIES
    {
    }
    CONTROLS
    {
    }
  }
  LABELS
  {
  }
  CODE
  {
    VAR
      BillofLadingInfoLine@1000000000 : Record 14000827;
      PostedDocFound@1000000001 : Boolean;
      BOLMgt@1000000002 : Codeunit 14000821;
      PackingRule@1000000003 : Record 14000715;
      EDIIntegration@1000000005 : Codeunit 14000363;
      Shipping@1000000004 : Codeunit 14000701;
      EDIASNSend@1000000006 : Codeunit 14002358;
      BillOfLadingLine@1000000009 : Record 14000823;
      SalesHeader@1000000008 : Record 36;
      SalesLine@1000000007 : Record 37;
      SalesShipmentHeader@1000000010 : Record 110;
      BillofLadingInfoLine1@1000000011 : Record 14000827;
      Package@1000000012 : Record 14000701;

    BEGIN
    {
      03-29-2018 UCHOUHAN TPZ841
        Developed for Auto Bill Of Lading Posting.
      04-27-2018 UCHOUHAN TPZ841
        Skipped records which reuires Manual entry shipping charges.
      05-31-2018 UCHOUHAN TPZ841
        Old Code commented and added new code to find posted shipment.
      2020-03-30 28418 GGUPTA
        Code added for Stop post BOL if package open
    }
    END.
  }
  RDLDATA
  {
  }
}

