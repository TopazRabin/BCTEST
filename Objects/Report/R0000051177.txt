OBJECT Report 51177 Price Increase
{
  OBJECT-PROPERTIES
  {
    Date=06/30/21;
    Time=[ 7:54:55 AM];
    Modified=Yes;
    Version List=price;
  }
  PROPERTIES
  {
    ProcessingOnly=Yes;
    OnPostReport=BEGIN
                   Window.CLOSE;
                 END;

  }
  DATASET
  {
    { 1170000000;;DataItem;                  ;
               DataItemTable=Table18;
               DataItemTableView=WHERE(Blocked=FILTER(<>All));
               OnPreDataItem=BEGIN
                               SalesLineBuffer.DELETEALL;
                               //CurrReport.QUIT;
                               Window.OPEN('Processing' + '@1@@@@@@@@@@@@@@@@@@@@@@@@@\');
                               CountVar := COUNT;
                             END;

               OnAfterGetRecord=BEGIN
                                  CurrRec += 1;
                                  Window.UPDATE(1,(CurrRec/CountVar*10000) DIV 1);
                                  CustLedgerEntry.RESET;
                                  CustLedgerEntry.SETRANGE("Document Type",CustLedgerEntry."Document Type"::Invoice);
                                  CustLedgerEntry.SETRANGE("Customer No.",Customer."No.");
                                  CustLedgerEntry.SETFILTER("Posting Date",'>=%1',CALCDATE('<-2Y>',TODAY));
                                  IF CustLedgerEntry.FINDFIRST THEN BEGIN
                                    Item.RESET;
                                    //Item.SETRANGE("No.",'1012');
                                    Item.SETRANGE(Type,Item.Type::Inventory);
                                    Item.SETRANGE(Blocked,FALSE);
                                    Item.SETFILTER("Base Unit of Measure",'<>%1','');
                                    //Item.SETRANGE("Item Category Code",'PVC');
                                    Item.SETRANGE("Price Book Code",'00');
                                    Item.SETRANGE("Shortcut Dimension 5 Code",'E');
                                    IF Item.FINDSET THEN
                                    REPEAT
                                      LineNo += 1;
                                      SalesLineBuffer.INIT;
                                      SalesLineBuffer."Document Type" := SalesLineBuffer."Document Type"::Order;
                                      //SalesLineBuffer."Document No." := 'Price Increase';
                                      SalesLineBuffer."Line No." := LineNo;
                                      SalesLineBuffer.VALIDATE(Type,SalesLineBuffer.Type::Item);
                                      SalesLineBuffer.VALIDATE("Sell-to Customer No.",Customer."No.");
                                      SalesLineBuffer."Item Category Code" := Item."Item Category Code";
                                      SalesLineBuffer."Product Group Code" := Item."Product Group Code";
                                      SalesLineBuffer."Customer Price Group" := Customer."Customer Price Group";
                                      SalesLineBuffer.VALIDATE("No.",Item."No.");
                                      SalesLineBuffer.VALIDATE(Quantity,1);
                                      SalesLineBuffer."Unit Cost" := Item."Average Unit Cost";
                                      //Gross Margin % Avg Cost
                                      //-->TPZ2881
                                      IF (SalesLineBuffer.Quantity <> 0) AND (SalesLineBuffer."Unit Cost" <> 0) AND (SalesLineBuffer."Actual Unit Price" <> 0) THEN BEGIN
                                        SalesLineBuffer."Gross Margin %" := ROUND(((SalesLineBuffer.Quantity * SalesLineBuffer."Actual Unit Price") - (SalesLineBuffer.Quantity * SalesLineBuffer."Unit Cost")) * 100 / (SalesLineBuffer.Quantity * SalesLineBuffer."Actual Unit Price"),0.1);
                                      END ELSE
                                        SalesLineBuffer."Gross Margin %" := 0;
                                      //<--
                                      //IF GMarAvgCostPerc <= 25 THEN
                                      IF SalesLineBuffer."Gross Margin %" < 25 THEN //VAH
                                        SalesLineBuffer.INSERT;

                                    UNTIL Item.NEXT=0;
                                  END;
                                END;

               OnPostDataItem=BEGIN
                                MESSAGE('Done')
                              END;

               ReqFilterFields=No. }

  }
  REQUESTPAGE
  {
    PROPERTIES
    {
    }
    CONTROLS
    {
    }
  }
  LABELS
  {
  }
  CODE
  {
    VAR
      CustLedgerEntry@1170000000 : Record 21;
      SalesLineBuffer@1170000001 : Record 50021;
      Item@1170000002 : Record 27;
      LineNo@1170000003 : Integer;
      DateFilter@1170000004 : Date;
      GMarAvgCostPerc@1000000000 : Decimal;
      CountVar@1000000001 : Integer;
      CurrRec@1000000002 : Integer;
      Window@1000000003 : Dialog;

    BEGIN
    END.
  }
  RDLDATA
  {
  }
}

