OBJECT Codeunit 14002651 Formula Release
{
  OBJECT-PROPERTIES
  {
    Date=03/01/20;
    Time=12:00:00 PM;
    Version List=UBP3.02;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {

    PROCEDURE Release@1240030000(Formula@1240030000 : Record 14002652);
    VAR
      AdvForSetup@1240020000 : Record 14002651;
      FormulaPeriod@1240030001 : Record 14002653;
      Text000@1240030002 : TextConst 'ENU=You must define at least one Formula Period with a weight before releasing a Formula.';
      Excludes@1240030003 : Integer;
      Text001@1240030004 : TextConst 'ENU=You have excluded all periods.';
    BEGIN
      Formula.TESTFIELD(Released,FALSE);
      FormulaPeriod.RESET;
      FormulaPeriod.SETRANGE("Formula Code",Formula.Code);
      FormulaPeriod.SETFILTER(Period,'<>%1',0);
      Formula."Formula Periods" := FormulaPeriod.COUNT;
      IF Formula."Formula Periods" = 0 THEN
        ERROR(Text000);

      AdvForSetup.GET;
      IF Formula."Formula Group Code" = AdvForSetup."Seasonal Formula Group" THEN
        Formula."Seasonal Formula" := TRUE
      ELSE
        Formula."Seasonal Formula" := FALSE;
      IF Formula."Exclude Low Usage Period" THEN
        Excludes := 1
      ELSE
        Excludes := 0;
      IF Formula."Exclude High Usage Period" THEN
        Excludes := Excludes + 1;
      IF Formula."Formula Periods" < Excludes + 1 THEN
        ERROR(Text001);
      Formula.Released := TRUE;
      Formula.MODIFY;
      UpdateFormulaGroupCode;
    END;

    PROCEDURE Reopen@1240030001(VAR Formula@1240030000 : Record 14002652);
    BEGIN
      Formula.TESTFIELD(Released,TRUE);
      Formula.Released := FALSE;
      UpdateFormulaGroupCode;
    END;

    PROCEDURE UpdateFormulaGroupCode@1240030002();
    VAR
      Formula@1240030000 : Record 14002652;
      FormulaGroup@1240030002 : Record 14002664;
    BEGIN
      FormulaGroup.RESET;
      IF FormulaGroup.FIND('-') THEN
        REPEAT
          FormulaGroup."Minimum Formula Periods" := 0;
          Formula.SETRANGE(Released,TRUE);
          Formula.SETRANGE("Formula Group Code",FormulaGroup.Code);
          IF Formula.FIND('-') THEN
            REPEAT
              IF FormulaGroup."Minimum Formula Periods" = 0 THEN
                FormulaGroup."Minimum Formula Periods" := Formula."Formula Periods"
              ELSE IF
                Formula."Formula Periods" < FormulaGroup."Minimum Formula Periods" THEN
                  FormulaGroup."Minimum Formula Periods" := Formula."Formula Periods";
            UNTIL Formula.NEXT = 0;
          FormulaGroup.MODIFY;
        UNTIL FormulaGroup.NEXT = 0;
    END;

    BEGIN
    END.
  }
}

