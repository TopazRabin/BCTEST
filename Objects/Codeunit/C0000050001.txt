OBJECT Codeunit 50001 ASN Notification Mgt.
{
  OBJECT-PROPERTIES
  {
    Date=07/01/20;
    Time=12:00:00 AM;
    Modified=Yes;
    Version List=TOP060;
  }
  PROPERTIES
  {
    Permissions=TableData 458=i,
                TableData 50003=rimd;
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      SalesSetup@1000000001 : Record 311;
      SMTP@1000 : Codeunit 400;
      SenderName@1001 : Text[100];
      SenderAddress@1002 : Text[100];
      Recipient@1003 : Text[100];
      Subject@1004 : Text[100];
      Body@1005 : Text;
      InStreamTemplate@1009 : InStream;
      InSReadChar@1008 : Text[1];
      CharNo@1014 : Text[4];
      I@1010 : Integer;
      Text001@1007 : TextConst 'ENU=Sales %1;ESM=Ventas %1;FRC=Vente %1;ENC=Sales %1';
      Text002@1011 : TextConst 'ENU=Purchase %1;ESM=Compra %1;FRC=Achat %1;ENC=Purchase %1';
      Text003@1012 : TextConst 'ENU=ASN E-mail Notification for:;ESM=requiere su aprobaci¢n.;FRC=n‚cessite votre approbation.;ENC=requires your approval.';
      Text004@1013 : TextConst 'ENU=To view your documents for approval, please use this link;ESM=Para ver los documentos para aprobaci¢n, abra este v¡nculo;FRC=Pour afficher vos documents pour approbation, utilisez ce lien;ENC=To view your documents for approval, please use this link';
      Text005@1015 : TextConst 'ENU=Customer;ESM=Cliente;FRC=Client;ENC=Customer';
      Text0005@1000000002 : TextConst 'ENU=Dear Customer,';
      Text0006@1000000003 : TextConst 'ENU="Attaching the "';
      Text0007@1000000004 : TextConst 'ENU=This is system generated e-mail. Please do not reply to this email address because this mail box is not monitored.';
      WebViewTok@1016 : TextConst '@@@=Opens the document in the Microsoft Dynamics NAV web client;ENU=Web view;ESM=Vista web;FRC=Affichage Web;ENC=Web view';
      Text007@1017 : TextConst 'ENU=Microsoft Dynamics NAV: %1 Mail;ESM=Microsoft Dynamics NAV: Correo %1;FRC=Microsoft Dynamics NAV: %1 courriel;ENC=Microsoft Dynamics NAV: %1 Mail';
      Text008@1018 : TextConst 'ENU=Approval;ESM=Aprobaci¢n;FRC=Approbation;ENC=Approval';
      Text009@1019 : TextConst 'ENU=Cancelation;ESM=Cancelaci¢n;FRC=Annulation;ENC=Cancellation';
      Text010@1020 : TextConst 'ENU=Rejection;ESM=Rechazo;FRC=Refus;ENC=Rejection';
      Text011@1021 : TextConst 'ENU=Delegation;ESM=Delegaci¢n;FRC=D‚l‚gation;ENC=Delegation';
      Text012@1022 : TextConst 'ENU=Overdue Approvals;ESM=Aprobaciones vencidas;FRC=Approbations en retard;ENC=Overdue Approvals';
      Text013@1023 : TextConst 'ENU=Microsoft Dynamics NAV E-mail Notification System;ESM=Sistema aprobaci¢n docs. Microsoft Dynamics NAV;FRC=SystŠme d''approbation de documents de Microsoft Dynamics NAV;ENC=Microsoft Dynamics NAV Document Approval System';
      Text014@1024 : TextConst 'ENU=has been canceled.;ESM=se ha cancelado.;FRC=a ‚t‚ annul‚.;ENC=has been cancelled.';
      Text016@1026 : TextConst 'ENU=has been rejected.;ESM=se ha rechazado.;FRC=a ‚t‚ refus‚.;ENC=has been rejected.';
      Text018@1028 : TextConst 'ENU=Vendor;ESM=Proveedor;FRC=Fournisseur;ENC=Vendor';
      Text020@1030 : TextConst 'ENU=has been delegated.;ESM=se ha delegado.;FRC=a ‚t‚ d‚l‚gu‚.;ENC=has been delegated.';
      Text022@1032 : TextConst 'ENU=Overdue approval;ESM=Aprobaci¢n vencida;FRC=Approbation en retard;ENC=Overdue approval';
      Text030@1033 : TextConst 'ENU=Not yet overdue;ESM=No vencida todav¡a;FRC=Pas encore en retard;ENC=Not yet overdue';
      Text033@1036 : TextConst 'ENU=Rejection comments:;ESM=Comentarios rechazo:;FRC=Commentaires sur le refus :;ENC=Rejection comments:';
      Text040@1037 : TextConst 'ENU=You must import an ASN E-Mail Template in Sales & Receivables Setup.;ESM=Debe importar una Plantilla aprobaci¢n en Configuraci¢n aprobaci¢n.;FRC=Vous devez importer un modŠle d''approbation dans le module Configuration d''approbation.;ENC=You must import an Approval Template in Approval Setup.';
      Text041@1038 : TextConst 'ENU=You must import an Overdue Approval Template in Approval Setup.;ESM=Debe importar una Plantilla aprobaci¢n vencida en Configuraci¢n aprobaci¢n.;FRC=Vous devez importer un modŠle d''approbation en retard dans le module Configuration d''approbation.;ENC=You must import an Overdue Approval Template in Approval Setup.';
      FromUser@1040 : Text[100];
      Text042@1041 : TextConst 'ENU=Available Credit Limit ($);ESM=L¡mite cr‚dito disponible ($);FRC=Limite de cr‚dit disponible ($);ENC=Available Credit Limit ($)';
      Text043@1042 : TextConst 'ENU=Request Amount ($);ESM=Importe solic. ($);FRC=Montant demand‚ ($);ENC=Request Amount ($)';
      MailCreated@1006 : Boolean;
      OpenBracketTok@1025 : TextConst '@@@={Locked};ENU=(;ESM=(;FRC=(;ENC=(';
      CloseBracketTok@1027 : TextConst '@@@={Locked};ENU=);ESM=);FRC=);ENC=)';
      abcsi001@1000000000 : TextConst 'ENU=Approval Type';
      FileName@1000000005 : Text[250];
      ClientFileName@1000000008 : Text[250];
      ReportName@1000000006 : Text[50];
      FileMgt@1000000007 : Codeunit 419;

    PROCEDURE SendSalesApprovalsMail@1(SalesShptHeader@1000 : Record 110;CreateLog@1000000000 : Boolean);
    VAR
      EMailMgt@1000000001 : Codeunit 14000903;
    BEGIN
      //TM BEG 071015 TPZ813
      EMailMgt.SendSalesShipmentASNEmail(SalesShptHeader,TRUE,FALSE);

      IF CreateLog THEN InsertASNLogEntries(SalesShptHeader);
      //TM END 071015 TPZ813
    END;

    PROCEDURE GetEmailAddress@7(SalesShptHeader@1000 : Record 110);
    VAR
      SRSetup@1001 : Record 311;
      UserSetup@1000000000 : Record 91;
    BEGIN
      SRSetup.GET;
      SRSetup.TESTFIELD("Sender E-Mail");
      SenderAddress := SRSetup."Sender E-Mail";
      Recipient := SalesShptHeader."E-Mail (ASN)";
    END;

    PROCEDURE FillSalesTemplate@14(VAR Body@1000 : Text;FieldNo@1001 : Text[30];Header@1002 : Record 110);
    VAR
      SRSetup@1000000000 : Record 311;
    BEGIN
      SRSetup.GET;
      CASE FieldNo OF
        '1':
          Body := STRSUBSTNO(Body,Text0005);
        '2':
          Body := SRSetup."ASN E-Mail Body1";

        '3':
          Body := STRSUBSTNO(Body,Text003);
        '4':
          BEGIN
            IF Header."Order No." <> '' THEN
              Body := STRSUBSTNO(Text001,'Order')
            ELSE
              Body := STRSUBSTNO(Text001,'Shipment')
          END;
        '5':
          BEGIN
            IF Header."Order No." <> '' THEN
              Body := STRSUBSTNO(Body,Header."Order No.")
            ELSE
              Body := STRSUBSTNO(Body,Header."No.");
          END;
        '6':
            Body := '';
        '7':
            Body := SRSetup."ASN E-Mail Signature Line1";
        '8':
            Body := SRSetup."ASN E-Mail Signature Line2";
        '9':
            Body := SRSetup."ASN E-Mail Body2";
      END;
    END;

    PROCEDURE SaveReport@1000000002(SalesShptHeader@1000000000 : Record 110);
    VAR
      SRSetup@1000000001 : Record 311;
      ActiveSession@1000000007 : Record 2000000110;
      FileSystemObject@1000000006 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.File" RUNONCLIENT;
      TempFile@1000000005 : File;
      NVInStream@1000000004 : InStream;
      Result@1000000003 : Text;
    BEGIN
      CLEAR(FileName);
      CLEAR(ClientFileName);
      CLEAR(ReportName);
      SRSetup.GET;
      SRSetup.TESTFIELD("ASN Report Path");
      SRSetup.TESTFIELD("ASN Report ID");
      FileName := SRSetup."ASN Report Path";
      IF COPYSTR(FileName,STRLEN(FileName),1) <> '\' THEN
        FileName := FileName + '\';

      IF SalesShptHeader."Order No." <> '' THEN
        ReportName := SalesShptHeader."Order No." + '-' + DELCHR(FORMAT(CREATEGUID),'=','{}-') + '-' + 'ASN.pdf'
      ELSE
        ReportName := SalesShptHeader."No." + '-' + DELCHR(FORMAT(CREATEGUID),'=','{}-') + '-' + 'ASN.pdf';

      FileName := FileName + ReportName;

      SalesShptHeader.SETRECFILTER;


      REPORT.SAVEASPDF(SRSetup."ASN Report ID",FileName,SalesShptHeader);

      ClientFileName := FileMgt.DownloadTempFile(FileName);
      FileMgt.DeleteServerFile(FileName);
    END;

    PROCEDURE SetTemplate@25(SalesShptHeader@1000000000 : Record 110);
    BEGIN
      SalesSetup.GET;
      SalesSetup.CALCFIELDS("ASN E-Mail Template");
      IF NOT SalesSetup."ASN E-Mail Template".HASVALUE THEN
        ERROR(Text040);
      SalesSetup."ASN E-Mail Template".CREATEINSTREAM(InStreamTemplate);
      SenderName := SalesSetup."Sender Name";
      CLEAR(SenderAddress);
      CLEAR(Recipient);
      GetEmailAddress(SalesShptHeader);
    END;

    PROCEDURE InsertASNLogEntries@1000000000(SalesShptHeader@1000000000 : Record 110);
    VAR
      ASNLogEntry@1000000001 : Record 50003;
      NewSequenceNo@1000000002 : Integer;
    BEGIN
      WITH ASNLogEntry DO BEGIN
        SETRANGE("Table ID",DATABASE::"Sales Shipment Header");
        SETRANGE("Document No.",SalesShptHeader."No.");
        IF FINDLAST THEN
          NewSequenceNo := "Sequence No." + 1
        ELSE
          NewSequenceNo := 1;

        "Table ID" := DATABASE::"Sales Shipment Header";
        "Document No." := SalesShptHeader."No.";
        "Sequence No." := NewSequenceNo;
        "Sell-to Customer No." := SalesShptHeader."Sell-to Customer No.";
        "Sell-to Customer Name" := SalesShptHeader."Sell-to Customer Name";
        "Ship-to Code" := SalesShptHeader."Ship-to Code";
        "Ship-to Name" := SalesShptHeader."Ship-to Name";
        "Ship-to Name 2" := SalesShptHeader."Ship-to Name 2";
        "Ship-to Address" := SalesShptHeader."Ship-to Address";
        "Ship-to Address 2" := SalesShptHeader."Ship-to Address 2";
        "Ship-to City" := SalesShptHeader."Ship-to City";
        "Ship-to Post Code" := SalesShptHeader."Ship-to Post Code";
        "Ship-to County" := SalesShptHeader."Ship-to County";
        "Ship-to Country/Region Code" := SalesShptHeader."Ship-to Country/Region Code";
        "E-Mail" := SalesShptHeader."E-Mail (ASN)";
        "Sales Order No." := SalesShptHeader."Order No.";
        "Customer PO No." := SalesShptHeader."External Document No.";
        SalesShptHeader.CALCFIELDS("No. of Posted Packages");
        "No. of Packages on Shipment" := SalesShptHeader."No. of Posted Packages";
        ASNLogEntry."Creation Date Time" := CURRENTDATETIME;
        ASNLogEntry."User ID" := USERID;
        INSERT;
      END;
    END;

    BEGIN
    {
      TOP060 KT ABCSI ASN Via Email 04172015
        - Created this object as part of this SMT
      TPZ813
        - Changed codes to use Lanham E-Mail to send ASN email.
    }
    END.
  }
}

