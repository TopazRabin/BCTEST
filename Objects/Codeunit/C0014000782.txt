OBJECT Codeunit 14000782 FedEx Transaction 6.80.003
{
  OBJECT-PROPERTIES
  {
    Date=06/28/17;
    Time=12:00:00 PM;
    Version List=SE0.60.12;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      FDXAPIClient@1240030000 : Text;
      PackingStation@1240030001 : Record 14000709;
      CarrierPackingStation@1240030011 : Record 14000729;
      FedExGlobalRegistration@1240030002 : Record 14000786;
      ShippingSetup@1240030003 : Record 14000707;
      ShippingAgent@1240030004 : Record 291;
      ShippingAgentService@1240030005 : Record 14000708;
      ShippingAgentAccount@1240030006 : Record 14000788;
      Shipping@1240030007 : Codeunit 14000701;
      NameAndAddressMgt@1240030111 : Codeunit 14000709;
      Window@1240030008 : Dialog;
      BufferFileName@1240030009 : Text[250];
      ShippingSetupRetrieved@1240030010 : Boolean;
      Text001@1001 : TextConst 'ENU=Communicating with FedEx';
      Text002@1002 : TextConst 'ENU=Registration with FedEx was succesful.';
      Text003@1003 : TextConst 'ENU="Error: "';
      Text004@1004 : TextConst 'ENU=Sales Order %1';
      Text005@1005 : TextConst 'ENU=There must be at least one item in the package for international shipments.';
      Text006@1006 : TextConst 'ENU=Either Company Name or Contact Name must be filled in.';
      Text007@1007 : TextConst 'ENU=The Broker Country Code must be same as the Recipient Country Code: %1';
      Text008@1008 : TextConst 'ENU=WARNING';
      Text009@1009 : TextConst 'ENU=INFORMATION';
      Text010@1010 : TextConst 'ENU=SHIPPING WARNING';
      Text011@1011 : TextConst 'ENU=SHIPPING INFO';
      Text012@1012 : TextConst 'ENU=URSA HARD';
      Text013@1013 : TextConst 'ENU=URSA SOFT';
      Text014@1014 : TextConst 'ENU=RESERVED';
      Text015@1015 : TextConst 'ENU=FEDEX WARNING:\';
      Text016@1016 : TextConst 'ENU=Type: %1\';
      Text017@1017 : TextConst 'ENU=Code: %2\';
      Text018@1018 : TextConst 'ENU=Ship-to Name or Ship-to Contact is required.';
      Text019@1019 : TextConst 'ENU=Either Ship-to Name or Ship-to Contact must be filled in.';
      Text020@1020 : TextConst 'ENU=You cannot schedule a shipment more than 9 days in advance.';
      Text021@1021 : TextConst 'ENU=Consignee is not available for FedEx Express shipments';
      Text022@1022 : TextConst 'ENU=Please specify the FedEx Account number for the third party duties payer.';
      Text023@1023 : TextConst 'ENU=Please specify the duties payer.';
      Text024@1024 : TextConst 'ENU=FEDEX Label';
      Text025@1025 : TextConst 'ENU=FEDEX COD Label';
      Text026@1026 : TextConst 'ENU=C:\Program Files\FedEx\FedEx Ship Manager API\labels';
      Text027@1027 : TextConst 'ENU=There are no label files saved.';
      Text028@1028 : TextConst 'ENU=No Global Registration record.';
      Text029@1029 : TextConst 'ENU=FEDEX Account %1';
      Text030@1030 : TextConst 'ENU=%1 account(s) has been manifested with FedEx';
      Text031@1031 : TextConst 'ENU=Live FedEX Registration for account number %1 not found.';
      Text032@1032 : TextConst 'ENU=FedEx registration for account number %1 not found.';
      Text033@1033 : TextConst 'ENU=Manifest for FedEx Account %1 has been posted.';
      Text034@1034 : TextConst 'ENU=Driver Label %1';
      Text035@1035 : TextConst 'ENU=FEDEX Account %1 closed.\%2';
      Text036@1036 : TextConst 'ENU=Error closing FEDEX Account %1:\%2';
      Text037@1037 : TextConst 'ENU=File: %1 does not exist.';
      Text038@1038 : TextConst 'ENU=%1 formatted is %2 with %3 decimals.';
      Text039@1039 : TextConst 'ENU=FEDEX API Configuration File Not found.';
      Text040@1040 : TextConst 'ENU=config.ini not found in %1.';
      Text041@1041 : TextConst 'ENU=Wrong FDXHOST string %1.';
      Text042@1042 : TextConst 'ENU=FDXHOST Line not found in %1.';
      Text043@1043 : TextConst 'ENU=Signature Required is no longer supported, use Delivery Signature Options.';
      Text044@1044 : TextConst 'ENU=Acknowledgement of Delivery is no longer supported.';

    PROCEDURE GlobalRegistrationRequest@1(VAR CurrentFedExGlobalRegistration@1240030000 : Record 14000786);
    VAR
      UniversalTransactionID@1240030001 : Integer;
    BEGIN
      WITH CurrentFedExGlobalRegistration DO BEGIN
        ShippingAgentAccount.GET("Shipper Account No.");
        TestWEBAPI(ShippingAgentAccount);
        UniversalTransactionID := 3003;
        "Error Code" := '';
        "Error Message" := '';
        GetPackingStation;
        TESTFIELD("Shipper Company Name");
        TESTFIELD("Shipper Address 1");
        TESTFIELD("Shipper City");
        TESTFIELD("Shipper State");
        TESTFIELD("Shipper ZIP Code");
        TESTFIELD("Shipper Country Code");
        TESTFIELD("Shipper Account No.");
        TESTFIELD("Shipper Contact");
        TESTFIELD("Shipper Phone Number");
      {  CLEAR(FDXAPIClient);
        CREATE(FDXAPIClient);
        FDXAPIClient.ApiClear;
        FDXAPIClient.SetTransactionType('211');
        FDXAPIClient.SetField('1',"Transaction ID");
        FDXAPIClient.SetField('10',"Shipper Account No.");
        FDXAPIClient.SetField('4003',"Shipper Contact");
        FDXAPIClient.SetField('4007',"Shipper Company Name");
        FDXAPIClient.SetField('4008',"Shipper Address 1");
        IF "Shipper Address 2" <> '' THEN
          FDXAPIClient.SetField('4009',"Shipper Address 2");
        FDXAPIClient.SetField('4011',"Shipper City");
        FDXAPIClient.SetField('4012',FixState("Shipper State"));
        FDXAPIClient.SetField('4013',FixZIPCode("Shipper ZIP Code"));
        FDXAPIClient.SetField('4014',"Shipper Country Code");
        FDXAPIClient.SetField('4015',FixPhoneNo("Shipper Phone Number"));
        IF "Email Address" <> '' THEN
          FDXAPIClient.SetField('4018',"Email Address");
        IF "Shipper FAX Number" <> '' THEN
          FDXAPIClient.SetField('4022',FixPhoneNo("Shipper FAX Number"));
        Window.OPEN(Text001);

        FDXAPIClient.ApiBuild;
        FDXAPIClient.FEDEXAPITransaction(
          UniversalTransactionID,CarrierPackingStation."Proxy Address",
          Text2Integer(CarrierPackingStation."Proxy Port"));
        FDXAPIClient.ApiParse;
        Window.CLOSE;
        "Error Code" := FDXAPIClient.GetField('2');
        "Error Message" := FDXAPIClient.GetField('3');
        IF ("Error Code" = '0') OR ("Error Code" = '') THEN BEGIN
          "Meter Number" := FDXAPIClient.GetField('498');
          "Subscription Service 1" := FDXAPIClient.GetFieldInstance('4021',0);
          "Subscription Service 2" := FDXAPIClient.GetFieldInstance('4021',1);
          IF ShippingAgentAccount."Test Status" = ShippingAgentAccount."Test Status"::Live THEN
            "Live Registration" := TRUE;
          MESSAGE(Text002);
        END ELSE
          MESSAGE(Text003 + "Error Message");}
        MODIFY;
      END;
    END;

    LOCAL PROCEDURE GetTransactionID@3() NextTransactionID@1240030000 : Code[40];
    VAR
      ShippingNumbering@1240030002 : Record 14000725;
      NoSeriesMgt@1240030001 : Codeunit 396;
    BEGIN
      GetShippingSetup;
      GetPackingStation;

      IF ShippingNumbering.GET(
           DATABASE::"Shipping Setup",ShippingSetup."Primary Key",
           ShippingSetup.FIELDNO("Last FedEx Transaction No."))
      THEN BEGIN
        ShippingNumbering.GetNextNumber;
        NextTransactionID := ShippingNumbering."Last No. Used";
      END ELSE BEGIN
        ShippingSetup.TESTFIELD("FedEx Transaction Nos.");
        NextTransactionID := NoSeriesMgt.GetNextNo(ShippingSetup."FedEx Transaction Nos.",WORKDATE,TRUE);
      END;

      CarrierPackingStation.TESTFIELD("FedEx Buffer Directory");
      IF COPYSTR(
           CarrierPackingStation."FedEx Buffer Directory",
           STRLEN(CarrierPackingStation."FedEx Buffer Directory"),1) =
         '\'
      THEN
        BufferFileName :=
          CarrierPackingStation."FedEx Buffer Directory" + NextTransactionID + '.buf'
      ELSE
        BufferFileName :=
          CarrierPackingStation."FedEx Buffer Directory" + '\' + NextTransactionID + '.buf';
    END;

    LOCAL PROCEDURE DeleteRequest@5(VAR CurrentFedExDeletePackage@1240030000 : Record 14000787);
    VAR
      FedExDeletePackage@1240030001 : Record 14000787;
      Package@1240030002 : Record 14000701;
      PostedPackage@1240030003 : Record 14000704;
      TransactionID@1240030004 : Code[40];
      TransactionType@1240030005 : Code[10];
      UniversalTransactionID@1240030006 : Integer;
    BEGIN
      WITH CurrentFedExDeletePackage DO BEGIN
        TransactionID := "Transaction ID";
        FedExDeletePackage.RESET;
        FedExDeletePackage.SETRANGE("Transaction Type",123);
        FedExDeletePackage.SETRANGE("Transaction ID",TransactionID);
        IF FedExDeletePackage.FIND('+') THEN BEGIN
          TransactionID := GetTransactionID;
          FedExDeletePackage.INIT;
          FedExDeletePackage.COPY(CurrentFedExDeletePackage);
          FedExDeletePackage."Transaction ID" := TransactionID;
          FedExDeletePackage.INSERT;
        END;

        GetGlobalShipperInfo;
      {  CLEAR(FDXAPIClient);
        CREATE(FDXAPIClient);
        FDXAPIClient.ApiClear;
        FDXAPIClient.SetTransactionType('023');
        FDXAPIClient.SetField('1',TransactionID);
        IF "Shipper Account No." = '' THEN
          "Shipper Account No." := FedExGlobalRegistration."Shipper Account No.";
        FDXAPIClient.SetField('10',"Shipper Account No.");
        IF "Meter Number" = '' THEN
          "Meter Number" := FedExGlobalRegistration."Meter Number";
        FDXAPIClient.SetField('498',"Meter Number");
        IF Carrier = Carrier::"FedEx Express" THEN BEGIN
          UniversalTransactionID := 1005;
          FDXAPIClient.SetField('3025','FDXE');
        END ELSE BEGIN
          UniversalTransactionID := 3001;
          FDXAPIClient.SetField('3025','FDXG');
        END;
        FDXAPIClient.SetField('29',"Master Tracking No.");
        Window.OPEN(Text001);
        FDXAPIClient.ApiBuild;
        FDXAPIClient.FEDEXAPITransaction(
          UniversalTransactionID,CarrierPackingStation."Proxy Address",
          Text2Integer(CarrierPackingStation."Proxy Port"));
        FDXAPIClient.ApiParse;
        Window.CLOSE;
        FedExDeletePackage.INIT;
        FedExDeletePackage.COPY(CurrentFedExDeletePackage);
        TransactionType := FDXAPIClient.GetTransactionType;
        EVALUATE(FedExDeletePackage."Transaction Type",TransactionType);
        FedExDeletePackage."Transaction ID" := TransactionID;
        FedExDeletePackage."Error Code" := FDXAPIClient.GetField('2');
        FedExDeletePackage."Error Message" := FDXAPIClient.GetField('3');}
        FedExDeletePackage.INSERT;
        IF (FedExDeletePackage."Error Code" = '0') OR (FedExDeletePackage."Error Code" = '') THEN BEGIN
          Package.RESET;
          Package.SETCURRENTKEY("External Tracking No.");
          Package.SETRANGE("External Tracking No.","Master Tracking No.");
          IF Package.FIND('-') THEN
            REPEAT
              Package.Closed := FALSE;
              Package.MODIFY;
            UNTIL Package.NEXT = 0;
          PostedPackage.RESET;
          PostedPackage.SETCURRENTKEY("External Tracking No.");
          PostedPackage.SETRANGE("External Tracking No.","Master Tracking No.");
          IF PostedPackage.FIND('-') THEN
            REPEAT
              PostedPackage.Closed := FALSE;
              PostedPackage.MODIFY;
            UNTIL PostedPackage.NEXT = 0;
        END ELSE
          ERROR(FedExDeletePackage."Error Message");
      END;
    END;

    LOCAL PROCEDURE GetRate@8(VAR CurrentFedExShipment@1240030000 : Record 14000783;GiveError@1240030001 : Boolean) : Decimal;
    VAR
      CurrentFedExShipment2@1240030002 : Record 14000789;
      FedExShipment@1240030004 : Record 14000783;
      FedExShipment2@1240030005 : Record 14000789;
      TransactionID@1240030006 : Code[40];
      UniversalTransactionID@1240030009 : Integer;
    BEGIN
      WITH CurrentFedExShipment DO BEGIN
        IF NOT CurrentFedExShipment2.GET("Transaction Type","Transaction ID") THEN BEGIN
          CurrentFedExShipment2.INIT;
          CurrentFedExShipment2."Transaction Type" := "Transaction Type";
          CurrentFedExShipment2."Transaction ID" := "Transaction ID";
          CurrentFedExShipment2.INSERT;
        END;
        TransactionID := "Transaction ID";
        IF Carrier = Carrier::"FedEx Express" THEN
          UniversalTransactionID := 2017
        ELSE
          UniversalTransactionID := 3004;
        FedExShipment.RESET;
        FedExShipment.SETRANGE("Transaction Type",122);
        FedExShipment.SETRANGE("Transaction ID",TransactionID);
        IF FedExShipment.FIND('+') THEN BEGIN
          TransactionID := GetTransactionID;
          FedExShipment.INIT;
          FedExShipment.COPY(CurrentFedExShipment);
          FedExShipment."Transaction ID" := TransactionID;
          FedExShipment.INSERT;
        END;

        IF "Shipper Account No." = '' THEN
          "Shipper Account No." := FedExGlobalRegistration."Shipper Account No.";
        IF "Meter Number" = '' THEN
          "Meter Number" := FedExGlobalRegistration."Meter Number";

      //  SetFDXAPIDomReqFields(CurrentFedExShipment,TransactionID,TRUE,GiveError);

        Window.OPEN(Text001);
      {  FDXAPIClient.ApiBuild;
        FDXAPIClient.FEDEXAPITransaction(
          UniversalTransactionID,CarrierPackingStation."Proxy Address",
          Text2Integer(CarrierPackingStation."Proxy Port"));
        FDXAPIClient.ApiParse;
        Window.CLOSE;

        FedExShipment.INIT;
        FedExShipment.COPY(CurrentFedExShipment);
        FedExShipment2.INIT;
        FedExShipment2.TRANSFERFIELDS(CurrentFedExShipment2);
        FedExShipment."Transaction Type" := 122;
        FedExShipment."Transaction ID" := TransactionID;
        FedExShipment."Error Code" := FDXAPIClient.GetField('2');
        FedExShipment."Error Message" := FDXAPIClient.GetField('3');
        FedExShipment."DIM Weight Used Flag" := YN2Boolean(FDXAPIClient.GetField('431'));
        FedExShipment."Rate Scale" := FDXAPIClient.GetField('1089');
        FedExShipment."Rate Currency Type" := FDXAPIClient.GetField('1090');
        FedExShipment2."Rate Zone" := FDXAPIClient.GetField('1092');
        FedExShipment."Billed Weight" := Text2Decimal(FDXAPIClient.GetField('1402'));
        FedExShipment."Dim Weight" := Text2Decimal(FDXAPIClient.GetField('1403'));
        FedExShipment."Base Charge" := Text2Decimal(FDXAPIClient.GetField('1416'));
        FedExShipment."Total Surcharge" := Text2Decimal(FDXAPIClient.GetField('1417'));
        FedExShipment."Total Discount" := Text2Decimal(FDXAPIClient.GetField('1418'));
        FedExShipment."Net Charge" := Text2Decimal(FDXAPIClient.GetField('1419'));
        FedExShipment."Total Rebate Amount" := Text2Decimal(FDXAPIClient.GetField('1420'));
        FedExShipment.Oversize := YN2Boolean(FDXAPIClient.GetField('3010'));
        FedExShipment2."List Base Rate" := Text2Decimal(FDXAPIClient.GetField('1530'));
        FedExShipment2."List Total Surcharge" := Text2Decimal(FDXAPIClient.GetField('1507'));
        FedExShipment2."Effective Net Discount" := Text2Decimal(FDXAPIClient.GetField('1525'));
        FedExShipment2."List Net Charge" := Text2Decimal(FDXAPIClient.GetField('1528'));
        FedExShipment2."List Total Rebate Amount" := Text2Decimal(FDXAPIClient.GetField('1532'));}
        FedExShipment.INSERT;
        IF NOT FedExShipment2.INSERT THEN
          FedExShipment2.MODIFY;
        IF FedExShipment."Error Message" <> '' THEN BEGIN
          IF GiveError THEN
            ERROR(FedExShipment."Error Message")
          ELSE
            EXIT(0);
        END;
        EXIT(FedExShipment."Net Charge");
      END;
    END;

    PROCEDURE GetShippingCharge@12(VAR CurrentPackage@1240030000 : Record 14000701;GiveError@1240030001 : Boolean);
    VAR
      FedExOptionPage@1240030002 : Record 14000781;
      FedExShipment@1240030003 : Record 14000783;
      FedExIntlShipment@1240030004 : Record 14000785;
      TransactionID@1240030007 : Code[40];
      TotalCharge@1240030008 : Decimal;
      FedExShipment2@1240030005 : Record 14000789;
    BEGIN
      WITH CurrentPackage DO BEGIN
        GetShippingAgent("Shipping Agent Code");
        IF ShippingAgent."Disable Rate Calculation" THEN
          EXIT;

        GetShippingSetup;
        GetPackingStation;
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");
        GetShippingAgentService("Shipping Agent Code","Shipping Agent Service","World Wide Service");
        FedExOptionPage.GET(FedExOptionPage.Type::Package,"No.",0,0);
        GetGlobalShipperInfo;

        TestWEBAPI(ShippingAgentAccount);

        TransactionID := GetTransactionID;
        ClearTotalValueFields;
        VALIDATE("Calculation Weight",GetWeight);
        TESTFIELD("Calculation Weight");
        GetCalculationFields(1,'>');
        TESTFIELD("Calculation Value");

        FedExShipment.INIT;
        FedExShipment."Transaction Type" := 22;
        FedExShipment."Transaction ID" := TransactionID;
        FedExShipment."Shipper Account No." := FedExGlobalRegistration."Shipper Account No.";
        FedExShipment."Meter Number" := FedExGlobalRegistration."Meter Number";
        FedExShipment."Shipper State" := FixState(FedExGlobalRegistration."Shipper State");
        FedExShipment."Shipper Zip Code" := FixZIPCode(FedExGlobalRegistration."Shipper ZIP Code");
        FedExShipment."Shipper Country Code" := FedExGlobalRegistration."Shipper Country Code";

        IF (ShippingAgentService."Service Indicator" = '90') OR
           (ShippingAgentService."Service Indicator" = '92')
        THEN
          FedExShipment.Carrier := FedExShipment.Carrier::"FedEx Ground"
        ELSE
          FedExShipment.Carrier := FedExShipment.Carrier::"FedEx Express";

        FedExShipment."Destination State" := FixState("Ship-to State");
        FedExShipment."Destination Zip Code" := FixZIPCode("Ship-to ZIP Code");
        FedExShipment."Destination Country Code" := GetFedExCountryCode("Ship-to Country Code");

        IF "Packing Date" = 0D THEN
          "Packing Date" := WORKDATE;
        FedExShipment."Shipment Date - Integer" := Date2Integer("Packing Date");
        FedExShipment."Payment Code" := '1';

        IF ShippingSetup."Default Weight Units" =
           ShippingSetup."Default Weight Units"::LBS
        THEN
          FedExShipment."Weight Units" := 'LBS'
        ELSE
          FedExShipment."Weight Units" := 'KGS';

        IF ((FedExShipment."Destination Country Code" <> '') AND (FedExShipment."Destination Country Code" <> 'US')) OR
          ("Service Indicator" = '92')
        THEN BEGIN
          FedExShipment."Package Sequence" := "Package No.";
          FedExShipment."Package Count" := "Total Packages";
        END ELSE BEGIN
          FedExShipment."Package Sequence" := 1;
          FedExShipment."Package Count" := 1;
        END;

        FedExShipment."Service Code" := "Service Indicator";
        FedExShipment."Package Weight" := ROUND("Calculation Weight",0.1);
        FedExShipment."Declared Value" := ROUND("Calculation Insured Value",0.01);
        IF COD THEN BEGIN
          FedExShipment."COD Flag" := TRUE;
          TESTFIELD("COD Amount");
          FedExShipment."COD Amount" := "COD Amount";
          IF "COD Cashiers Check" THEN
            FedExShipment."COD Collection Type" := '2'
          ELSE
            FedExShipment."COD Collection Type" := '1';
        END;

        FedExShipment."Source ID" := "Source ID";
        FedExShipment."Package No." := "No.";
        FedExShipment."Package Length" := "Calculation Length";
        FedExShipment."Package Width" := "Calculation Width";
        FedExShipment."Package Height" := "Calculation Height";

        TransferFromOptionPage(
          FedExShipment,FedExIntlShipment,FedExOptionPage,TRUE,GiveError,"Residential Delivery");

        FedExShipment.INSERT;
        TotalCharge := GetRate(FedExShipment,GiveError);
        IF TotalCharge <> 0 THEN BEGIN
          FedExShipment.GET(122,TransactionID);
          "FedEx Transaction ID" := TransactionID;
          FedExShipment2.GET(22,TransactionID);
          IF (ShippingAgentAccount."Rate Option" = ShippingAgentAccount."Rate Option"::Default) THEN BEGIN
            "Shipping Cost" := TotalCharge;
            "Base Charge" := FedExShipment."Base Charge";
            Surcharge := FedExShipment."Total Surcharge";
            "Discount Amount" := FedExShipment."Total Discount";
            "Rebate Amount" := FedExShipment."Total Rebate Amount";
          END ELSE
            IF (ShippingAgentAccount."Rate Option" = ShippingAgentAccount."Rate Option"::List) AND
              (NOT "World Wide Service")
            THEN BEGIN
              "Shipping Cost" := FedExShipment2."List Net Charge";
              "Base Charge" := FedExShipment2."List Base Rate";
              Surcharge := FedExShipment2."List Total Surcharge";
              "Rebate Amount" := FedExShipment2."List Total Rebate Amount";
              "Discount Amount" := FedExShipment2."Effective Net Discount";
            END ELSE BEGIN
              "Shipping Cost" := FedExShipment."Net Charge";
              "Base Charge" := FedExShipment."Base Charge";
              Surcharge := FedExShipment."Total Surcharge";
              "Rebate Amount" := FedExShipment."Total Rebate Amount";
              "Discount Amount" := FedExShipment."Total Discount";
            END;

          IF NOT Closed THEN BEGIN
            Markup :=
              Shipping.GetMarkup(
                ShippingAgentService,"Shipping Cost","Ship-to Type","Ship-to No.","Ship-to Code");
            IF "Override Shipping Charge" <> 0 THEN
              "Shipping Charge" := "Override Shipping Charge"
            ELSE
              "Shipping Charge" := "Shipping Cost" + Markup + "Additional Shipping Charge";
          END;
          TestAndTransferToThirdParty(CurrentPackage,FedExOptionPage,ShippingAgentService);
        END;
      END;
    END;

    PROCEDURE RateShop@14(RateShopHeader@1240030000 : Record 14000741;VAR RateShopLine@1240030001 : Record 14000742;CurrentShippingAgentService@1240030002 : Record 14000708);
    VAR
      FedExShipment@1240030003 : Record 14000783;
      FedExOptionPage@1240030004 : Record 14000781;
      FedExIntlShipment@1240030005 : Record 14000785;
      RateShopLineCOD@1240030006 : Record 14000742;
      FedExShipment2@1240030007 : Record 14000789;
      FedExTrans@1240030008 : Codeunit 14000782;
      TransactionID@1240030009 : Code[40];
      InsureThroughShippingAgent@1240030010 : Boolean;
      ShipmentDate@1240030011 : Date;
      ShippingCost@1240030012 : Decimal;
    BEGIN
      WITH RateShopHeader DO BEGIN
        GetShippingAgent(CurrentShippingAgentService."Shipping Agent Code");
        IF ShippingAgent."Disable Rate Calculation" THEN
          EXIT;

        GetShippingSetup;
        CLEAR(PackingStation);
        IF "Rate Shop Packing Station Code" <> '' THEN
          PackingStation.GET("Rate Shop Packing Station Code")
        ELSE
          GetPackingStation;
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");
        GetGlobalShipperInfo;
        TestWEBAPI(ShippingAgentAccount);

        IF NOT FedExOptionPage.GET(FedExOptionPage.Type::"Rate Shop",RateShopHeader."No.",0,0) THEN
          IF NOT FedExOptionPage.GET(FedExOptionPage.Type::Package,RateShopHeader."Package No.",0,0) THEN
            IF NOT FedExOptionPage.GET(
                     FedExOptionPage.Type::Document,RateShopHeader."Source ID",
                     RateShopHeader."Source Type",RateShopHeader."Source Subtype")
            THEN
              IF NOT FedExOptionPage.GET(
                       FedExOptionPage.Type::"Bill of Lading",RateShopHeader."Bill of Lading No.",0,0)
              THEN BEGIN
                FedExOptionPage.RESET;
                FedExOptionPage.SETCURRENTKEY(
                  Type,"Shipping Agent Code","Shipping Agent Service","World Wide Service");
                FedExOptionPage.SETRANGE(Type,FedExOptionPage.Type::Setup);
                FedExOptionPage.SETRANGE(
                  "Shipping Agent Code",CurrentShippingAgentService."Shipping Agent Code");
                FedExOptionPage.SETRANGE("Shipping Agent Service",CurrentShippingAgentService.Code);
                FedExOptionPage.SETRANGE(
                  "World Wide Service",CurrentShippingAgentService."World Wide Service");
                IF NOT FedExOptionPage.FIND('-') THEN
                  FedExOptionPage.INIT;
              END;

        TransactionID := GetTransactionID;
        IF "No. of Packages" < 1 THEN
          "No. of Packages" := 1;
        VALIDATE("Calculation Weight",GetWeight / "No. of Packages");
        TESTFIELD("Calculation Weight");
        "Calculation Value" := GetValue / "No. of Packages";
        TESTFIELD("Calculation Value");

        CASE "Shipping Insurance" OF
          "Shipping Insurance"::" ":
            IF "Shipping Payment Type" = "Shipping Payment Type"::Prepaid THEN
              InsureThroughShippingAgent := ShippingAgentAccount."Insure Through Carrier"
            ELSE
              InsureThroughShippingAgent := ShippingAgentAccount."Insured Third Party/Collect";
          "Shipping Insurance"::Never:
            InsureThroughShippingAgent := FALSE;
          "Shipping Insurance"::Always:
            InsureThroughShippingAgent := TRUE;
        END;
        "Calculation Insured Value" := GetInsuredValue(InsureThroughShippingAgent) / "No. of Packages";

        "Calculation Volume" := GetVolume / "No. of Packages";
        // Add Handling for Rate Shop for Dimensions
        IF ShippingAgentAccount."COD Rule" <>
           ShippingAgentAccount."COD Rule"::"All on Last Package"
        THEN
          "COD Amount" := "COD Amount" / "No. of Packages";

        FedExShipment.INIT;
        FedExIntlShipment.INIT;
        FedExShipment."Transaction Type" := 22;
        FedExShipment."Transaction ID" := TransactionID;
        FedExIntlShipment."Transaction Type" := 22;
        FedExIntlShipment."Transaction ID" := TransactionID;
        FedExShipment."Shipper Account No." := FedExGlobalRegistration."Shipper Account No.";
        FedExShipment."Meter Number" := FedExGlobalRegistration."Meter Number";
        FedExShipment."Shipper State" := FixState(FedExGlobalRegistration."Shipper State");
        FedExShipment."Shipper Zip Code" := FixZIPCode(FedExGlobalRegistration."Shipper ZIP Code");
        FedExShipment."Shipper Country Code" := FedExGlobalRegistration."Shipper Country Code";

        IF (CurrentShippingAgentService."Service Indicator" = '90') OR
           (CurrentShippingAgentService."Service Indicator" = '92')
        THEN
          FedExShipment.Carrier := FedExShipment.Carrier::"FedEx Ground"
        ELSE
          FedExShipment.Carrier := FedExShipment.Carrier::"FedEx Express";
        FedExShipment."Destination State" := FixState("Ship-to State");
        FedExShipment."Destination Zip Code" := FixZIPCode("Ship-to ZIP Code");
        FedExShipment."Destination Country Code" := GetFedExCountryCode("Ship-to Country Code");

        IF "Shipment Date" = 0D THEN
          ShipmentDate := WORKDATE
        ELSE
          ShipmentDate := "Shipment Date";
        FedExShipment."Shipment Date - Integer" := Date2Integer(ShipmentDate);

        FedExShipment."Payment Code" := '1';

        IF COD THEN BEGIN
          FedExShipment."COD Flag" := TRUE;
          TESTFIELD("COD Amount");
          FedExShipment."COD Amount" := "COD Amount";
          IF "COD Cashiers Check" THEN
            FedExShipment."COD Collection Type" := '2'
          ELSE
            FedExShipment."COD Collection Type" := '1';
        END;

        IF ShippingSetup."Default Weight Units" =
           ShippingSetup."Default Weight Units"::LBS
        THEN
          FedExShipment."Weight Units" := 'LBS'
        ELSE
          FedExShipment."Weight Units" := 'KGS';

        FedExShipment."Service Code" := CurrentShippingAgentService."Service Indicator";
        FedExShipment."Package Weight" := ROUND("Calculation Weight",0.1);
        FedExShipment."Declared Value" := ROUND("Calculation Insured Value",0.01);
        IF "Calculation Insured Value" > 0 THEN
          FedExIntlShipment."Declared Value Currency Type" := 'USD';

        FedExShipment."Package Sequence" := 1;
        FedExShipment."Package Count" := 1;
        FedExShipment."Rate Shop No." := "No.";
        FedExShipment."Package Length" := GetLength;
        FedExShipment."Package Width" := GetWidth;
        FedExShipment."Package Height" := GetHeight;

        TransferFromOptionPage(
          FedExShipment,FedExIntlShipment,FedExOptionPage,TRUE,FALSE,"Residential Delivery");

        FedExShipment.INSERT;
        FedExIntlShipment.INSERT;

        ShippingCost := GetRate(FedExShipment,FALSE);
        IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
      //    FDXAPIClient.SaveBuffer(BufferFileName);

        IF FedExShipment.GET(122,TransactionID) THEN BEGIN
          IF NOT FedExShipment2.GET(122,TransactionID) THEN BEGIN
            IF NOT FedExShipment2.GET(22,TransactionID) THEN BEGIN
              FedExShipment2.INIT;
              FedExShipment2."Transaction Type" := 122;
              FedExShipment2."Transaction ID" := TransactionID;
            END;
          END;
          RateShopLine.INIT;
          RateShopLine."Rate Shop No." := "No.";
          RateShopLine."Shipping Agent Code" := CurrentShippingAgentService."Shipping Agent Code";
          RateShopLine."World Wide Service" := CurrentShippingAgentService."World Wide Service";
          RateShopLine."Shipping Agent Service" := CurrentShippingAgentService.Code;
          RateShopLine."Insure Through Shipping Agent" := InsureThroughShippingAgent;
          RateShopLine.Sorting := CurrentShippingAgentService."Rateshop Sorting";
          RateShopLine."Service Description" := CurrentShippingAgentService.Description;
          RateShopLine."Service Error Message" := FedExShipment."Error Message";
          RateShopLine.Zone := FedExShipment2."Rate Zone";
          RateShopLine."Hundred Weight Rate" := FALSE;
          IF ShippingAgentAccount."Rate Option" = ShippingAgentAccount."Rate Option"::Default THEN BEGIN
            RateShopLine."Shipping Cost" := ShippingCost;
            RateShopLine."Base Charge" := FedExShipment."Base Charge";
            RateShopLine.Surcharge := FedExShipment."Total Surcharge";
            RateShopLine."Rebate Amount" := FedExShipment."Total Rebate Amount";
            RateShopLine."Discount Amount" := FedExShipment."Total Discount";
          END ELSE
            IF (ShippingAgentAccount."Rate Option" = ShippingAgentAccount."Rate Option"::List) AND
              (NOT RateShopLine."World Wide Service")
            THEN BEGIN
              RateShopLine."Shipping Cost" := FedExShipment2."List Net Charge";
              RateShopLine."Base Charge" := FedExShipment2."List Base Rate";
              RateShopLine.Surcharge := FedExShipment2."List Total Surcharge";
              RateShopLine."Rebate Amount" := FedExShipment2."List Total Rebate Amount";
              RateShopLine."Discount Amount" := FedExShipment2."Effective Net Discount";
            END ELSE BEGIN
              RateShopLine."Shipping Cost" := FedExShipment."Net Charge";
              RateShopLine."Base Charge" := FedExShipment."Base Charge";
              RateShopLine.Surcharge := FedExShipment."Total Surcharge";
              RateShopLine."Rebate Amount" := FedExShipment."Total Rebate Amount";
              RateShopLine."Discount Amount" := FedExShipment."Total Discount";
            END;

          RateShopLine.Markup :=
            Shipping.GetMarkup(
              CurrentShippingAgentService,RateShopLine."Shipping Cost",
              0,"Sell-to Customer No.","Ship-to Code");
          RateShopLine."Shipping Charge" :=
            RateShopLine."Shipping Cost" + RateShopLine.Markup + "Additional Shipping Charge";
          TestAndTransferToThirdPartyRS(
            RateShopHeader,RateShopLine,FedExOptionPage,CurrentShippingAgentService);

          IF "No. of Packages" > 1 THEN BEGIN
            IF COD AND
               (ShippingAgentAccount."COD Rule" = ShippingAgentAccount."COD Rule"::"All on Last Package")
            THEN BEGIN
              RateShopLineCOD := RateShopLine;
              COD := FALSE;

              FedExTrans.RateShop(RateShopHeader,RateShopLine,CurrentShippingAgentService);
              RateShopLine.DELETE;

              RateShopLine.DivideCharges("No. of Packages");
              RateShopLine.MultiplyCharges("No. of Packages" - 1);
              RateShopLine.AddCharges(RateShopLineCOD);

              COD := TRUE;
            END ELSE
              RateShopLine.MultiplyCharges("No. of Packages");
          END;

          IF "Value (Price)" <> 0 THEN
            RateShopLine."Order Amount" := "Value (Price)"
          ELSE
            RateShopLine."Order Amount" := "Override Value";
          RateShopLine."Total Amount" :=
            RateShopLine."Order Amount" + RateShopLine."Shipping Charge";
          RateShopLine.INSERT;
        END;
      END;
    END;

    LOCAL PROCEDURE TransferFromOptionPage@42(VAR CurrentFedExShipment@1240030000 : Record 14000783;VAR CurrentFedExIntlShipment@1240030001 : Record 14000785;FedExOptionPage@1240030002 : Record 14000781;RateShop@1240030003 : Boolean;GiveError@1240030004 : Boolean;ResidentialDelivery@1240030006 : Boolean);
    VAR
      CurrentFedExShipment2@1240030005 : Record 14000789;
    BEGIN
      WITH CurrentFedExShipment DO BEGIN
        IF NOT CurrentFedExShipment2.GET("Transaction Type","Transaction ID") THEN BEGIN
          CurrentFedExShipment2.INIT;
          CurrentFedExShipment2."Transaction Type" := "Transaction Type";
          CurrentFedExShipment2."Transaction ID" := "Transaction ID";
          CurrentFedExShipment2.INSERT;
        END;
        CASE FedExOptionPage."Dimension Units" OF
          FedExOptionPage."Dimension Units"::Inches:
            "Dim Units" := 'I';
          FedExOptionPage."Dimension Units"::Centimeters:
            "Dim Units" := 'C';
        END;
        IF Carrier = Carrier::"FedEx Express" THEN BEGIN
          CASE FedExOptionPage."FedEx Packaging Type" OF
            FedExOptionPage."FedEx Packaging Type"::"Customer Packaging":
              "Packaging Type" := '01';
            FedExOptionPage."FedEx Packaging Type"::"FedEx” Pak":
              "Packaging Type" := '02';
            FedExOptionPage."FedEx Packaging Type"::"FedEx” Box":
              "Packaging Type" := '03';
            FedExOptionPage."FedEx Packaging Type"::"FedEx” Tube":
              "Packaging Type" := '04';
            FedExOptionPage."FedEx Packaging Type"::"FedEx” Envelope":
              "Packaging Type" := '06';
            FedExOptionPage."FedEx Packaging Type"::"FedEx” 10kg Box":
              "Packaging Type" := '15';
            FedExOptionPage."FedEx Packaging Type"::"FedEx” 25kg Box":
              "Packaging Type" := '25';
          END;
        END ELSE
          "Packaging Type" := '01';
        "Residential Delivery Flag" := ResidentialDelivery;
        IF (NOT ResidentialDelivery) AND ("Service Code" = '90') THEN
          "Residential Delivery Flag" := TRUE;  // Home delivery is residential delivery, but not the other
                                                // way around.
        "Inside Pickup" := FedExOptionPage."Inside Pick Up";
        "Inside Delivery" := FedExOptionPage."Inside Delivery";
        CurrentFedExIntlShipment."Broker Select Flag" := FedExOptionPage."Include Broker Info.";
        //"Hold at Location" := FedExOptionPage."Hold At Location";
        "Saturday Delivery" := FedExOptionPage."Saturday Delivery";
        "Saturday Pickup" := FedExOptionPage."Saturday Pickup";
        "Dry Ice" := FedExOptionPage."Dry Ice";
        {CASE FedExOptionPage."Dangerous Goods Type" OF
          FedExOptionPage."Dangerous Goods Type"::Accessible:
            "Dangerous Goods Type" := 'A';
           FedExOptionPage."Dangerous Goods Type"::Inaccessible:
            "Dangerous Goods Type" := 'I';
        END;}
        CASE FedExOptionPage."Drop Off Type" OF
          FedExOptionPage."Drop Off Type"::"Regular Pickup":
            "Drop Off Type" := '1';
          FedExOptionPage."Drop Off Type"::"Request Courier":
            "Drop Off Type" := '2';
          FedExOptionPage."Drop Off Type"::"Drop Box":
            "Drop Off Type" := '3';
          FedExOptionPage."Drop Off Type"::"Drop at BSC":
            "Drop Off Type" := '4';
          FedExOptionPage."Drop Off Type"::"Drop at Station":
            "Drop Off Type" := '5';
        END;
        Autopod := FedExOptionPage.AutoPod;
        {IF "Service Code" = '90' THEN BEGIN
          IF GiveError THEN BEGIN
            IF (NOT RateShop) AND
               ((FedExOptionPage."FedEx Home Delivery Type" =
                 FedExOptionPage."FedEx Home Delivery Type"::"FedEx Date Certain Home Delivery”") OR
                (FedExOptionPage."FedEx Home Delivery Type" =
                 FedExOptionPage."FedEx Home Delivery Type"::"FedEx Appointment Home Delivery”"))
            THEN BEGIN
              FedExOptionPage.TESTFIELD("FedEx Home Delivery Phone No.");
               IF FedExOptionPage."FedEx Home Delivery Type" =
                  FedExOptionPage."FedEx Home Delivery Type"::"FedEx Date Certain Home Delivery”"
               THEN
                 FedExOptionPage.TESTFIELD("FedEx Home Delivery Date");
            END ELSE
              IF RateShop THEN
                FedExOptionPage.TESTFIELD("FedEx Home Delivery Type");
          END;}
          {CASE FedExOptionPage."FedEx Home Delivery Type" OF
            FedExOptionPage."FedEx Home Delivery Type"::"FedEx Date Certain Home Delivery”":
              "Home Delivery Type" := '1';
            FedExOptionPage."FedEx Home Delivery Type"::"FedEx Evening Home Delivery”":
              "Home Delivery Type" := '2';
            FedExOptionPage."FedEx Home Delivery Type"::"FedEx Appointment Home Delivery”":
              "Home Delivery Type" := '3';
          END;}
          IF NOT RateShop THEN BEGIN
            IF FedExOptionPage."FedEx Home Delivery Date" <> 0D THEN
              "Home Delivery Date - Integer" := Date2Integer(FedExOptionPage."FedEx Home Delivery Date");
            "Home Delivery Phone No." := FedExOptionPage."FedEx Home Delivery Phone No.";
          END;
        END;
        CASE FedExOptionPage."Delivery Signature Options" OF
          FedExOptionPage."Delivery Signature Options"::" ":
            CurrentFedExShipment2."Signature Option" := '';
          FedExOptionPage."Delivery Signature Options"::"Indirect Signature":
            CurrentFedExShipment2."Signature Option" := '2';
          FedExOptionPage."Delivery Signature Options"::"Deliver without Signature":
            CurrentFedExShipment2."Signature Option" := '1';
          FedExOptionPage."Delivery Signature Options"::"Direct Signature":
            CurrentFedExShipment2."Signature Option" := '3';
          FedExOptionPage."Delivery Signature Options"::"Adult Signature":
            CurrentFedExShipment2."Signature Option" := '4';
        END;

        IF NOT RateShop THEN BEGIN
          {IF "International Shipment" THEN
            CurrentFedExIntlShipment."Total Customs Value" :=
              ROUND(FedExOptionPage."Export Declared Value",0.01);}
      // Special Service Alcohol
          {IF FedExOptionPage.Alcohol THEN BEGIN
            "Alcohol Flag" := TRUE;
            CASE FedExOptionPage."Alcohol Type" OF
              FedExOptionPage."Alcohol Type"::Beer:
                CurrentFedExShipment2."Alcohol Type" := 'B';
              FedExOptionPage."Alcohol Type"::Wine:
                CurrentFedExShipment2."Alcohol Type" := 'W';
              FedExOptionPage."Alcohol Type"::"Distilled Spirits":
                CurrentFedExShipment2."Alcohol Type" := 'S';
              FedExOptionPage."Alcohol Type"::Ale:
                CurrentFedExShipment2."Alcohol Type" := 'A';
              FedExOptionPage."Alcohol Type"::"Light Wine":
                CurrentFedExShipment2."Alcohol Type" := 'L';
            END;}
            CASE FedExOptionPage."Alcohol Packaging" OF
              FedExOptionPage."Alcohol Packaging"::Barrel:
                CurrentFedExShipment2."Alcohol Packaging" := 'BL';
              FedExOptionPage."Alcohol Packaging"::Bottle:
                CurrentFedExShipment2."Alcohol Packaging" := 'BT';
              FedExOptionPage."Alcohol Packaging"::"Case":
                CurrentFedExShipment2."Alcohol Packaging" := 'CS';
              FedExOptionPage."Alcohol Packaging"::Carton:
                CurrentFedExShipment2."Alcohol Packaging" := 'CN';
              FedExOptionPage."Alcohol Packaging"::Other:
                CurrentFedExShipment2."Alcohol Packaging" := 'OT';
            END;
            CurrentFedExShipment2."Alcohol Packages" := FedExOptionPage."Alcohol Package Count";
            CurrentFedExShipment2."Alcohol Volume" := FedExOptionPage."Alcohol Volume (liters)";
          END;
      // Special Service Hold At Location
          {IF FedExOptionPage."Hold At Location" THEN BEGIN
            "Hold at Location" := TRUE;
            "HAL Station Address 1" := FedExOptionPage."HAL FedEx Location Address";
            "HAL City" := FedExOptionPage."HAL FedEx Location City";
            "HAL State" := FixState(FedExOptionPage."HAL FedEx Location State");
            "HAL Zip Code" := FixZIPCode(FedExOptionPage."HAL FedEx Location Zip");
            "HAL Phone Number" := FixPhoneNo(FedExOptionPage."HAL Recipient Phone No.");
          END;}
      // Special Service Dry Ice
          {IF FedExOptionPage."Dry Ice" THEN BEGIN
            "Dry Ice" := TRUE;
            FedExOptionPage.TESTFIELD("Dry Ice Weight");
            "Dry Ice Weight" := ROUND(FedExOptionPage."Dry Ice Weight",1);
          END;}
      // Ship Alert
          {IF (FedExOptionPage."Ship Notification")
          THEN BEGIN
            IF FedExOptionPage."Ship Notification" THEN
              "Ship Alert" := TRUE;
            IF GiveError AND
               (((Carrier = Carrier::"FedEx Ground") AND
                 (FedExOptionPage."Ship Notification Fax No." = '')) OR
                (Carrier = Carrier::"FedEx Express"))
            THEN
                FedExOptionPage.TESTFIELD("Ship Notification Email");
            IF FedExOptionPage."Ship Notification Memo" <> '' THEN
              "Ship Alert Message" := FedExOptionPage."Ship Notification Memo";
            IF FedExOptionPage."Ship Notification Email" <> '' THEN
              "Ship Alert Email Address 1" := FedExOptionPage."Ship Notification Email"
            ELSE
              "Ship Alert Fax No." := FedExOptionPage."Ship Notification Fax No.";
            IF FedExOptionPage."Ship Notification Email 2" <> '' THEN
              "Ship Alert Email Address 2" := FedExOptionPage."Ship Notification Email 2";
            IF FedExOptionPage."Ship Notification Email 3" <> '' THEN
              "Ship Alert Email Address 3" := FedExOptionPage."Ship Notification Email 3";
          END; }
          CASE TRUE OF
            FedExOptionPage."Shipper Delivery Notification":
              CurrentFedExShipment2."Shipper Delivery Notification" :=
                FedExOptionPage."Shipper Delivery Notification";
            FedExOptionPage."Shipper Ship Notification":
              CurrentFedExShipment2."Shipper Ship Notification" :=
                FedExOptionPage."Shipper Ship Notification";
            FedExOptionPage."Recipient Delivery Notif.":
              CurrentFedExShipment2."Recipient Delivery Notif." :=
                FedExOptionPage."Recipient Delivery Notif.";
            FedExOptionPage."Recipient Ship Notification":
              CurrentFedExShipment2."Recipient Ship Notification" :=
                FedExOptionPage."Recipient Ship Notification";
            FedExOptionPage."Broker Delivery Notification":
              CurrentFedExIntlShipment."Broker Delivery Notification" :=
                FedExOptionPage."Broker Delivery Notification";
            FedExOptionPage."Broker Ship Notification":
              CurrentFedExIntlShipment."Broker Ship Notification" :=
                FedExOptionPage."Broker Ship Notification";
          END;
      // Special Service - Signature Release
          //"Release Authorization No." := FedExOptionPage."Signature Release Auth.";
          //"Signature Release Flag" := FedExOptionPage."Signature Release";

          {IF "International Shipment" THEN BEGIN
            IF FedExOptionPage."Recipient Related" THEN
              CurrentFedExIntlShipment."Consignee Related" := TRUE;
            CurrentFedExIntlShipment."Document Flag" := FedExOptionPage."Non-dutiable Document";
            CurrentFedExIntlShipment."NAFTA Flag" := FedExOptionPage.NAFTA;
      //      IF ("Package Sequence" = 1) AND GiveError THEN
      //        FedExOptionPage.TESTFIELD("Shipper Load and Count");
            IF FedExOptionPage."Shipper Load and Count" <> 0 THEN
              CurrentFedExIntlShipment."Shipper Load and Count" :=
                FedExOptionPage."Shipper Load and Count"
            ELSE
              CurrentFedExIntlShipment."Shipper Load and Count" := "Package Count";
            CurrentFedExIntlShipment."Booking Confirmation No." :=
              FedExOptionPage."Booking Confimation No.";
          END;}
          IF FedExOptionPage."Packaging List Enclosed" THEN
            CurrentFedExShipment2."Packing List Enclosed" := TRUE;

        //END;
        CurrentFedExShipment2.MODIFY;
      //END;
    END;

    LOCAL PROCEDURE SetCommodityFields@43(VAR CurrentFedExIntlShipment@1240030000 : Record 14000785;CurrentPackage@1240030001 : Record 14000701);
    VAR
      PackageLine@1240030002 : Record 14000702;
      PackingRule@1240030003 : Record 14000715;
    BEGIN
      WITH CurrentFedExIntlShipment DO BEGIN
        PackageLine.RESET;
        PackageLine.SETRANGE("Package No.",CurrentPackage."No.");
        IF PackageLine.FIND('-') THEN BEGIN
          "Commodity No. of Pieces 1" := PackageLine.Quantity;
          "Commodity Description 1" := COPYSTR(PackageLine.Description,1,30);
          "Commodity Country of Manf. 1" := GetFedExCountryCode(PackageLine."Country of Manufacture");
          IF PackageLine."Export License Required" THEN BEGIN
            PackageLine.TESTFIELD("Schedule B code");
            "Commodity Harmonized Code 1" := PackageLine."Schedule B code";
            "Commodity Export License No. 1" :=PackingStation."Export License No.";
            "Export License Exp. 1 - Int" :=
              Date2Integer(PackingStation."Export License Expiration Date");
            "License Exception Symbol 1" := PackingStation."Export License Exception";
          END;
          "Commodity Unit Quantity 1" := PackageLine."Qty. per Unit of Measure";
          "Commodity Unit of Measure 1" := FixUnitOfMeasure(PackageLine."Unit of Measure Code");
          "Export Control Class No. 1" := PackageLine."Export Controls Class No.";
          "Commodity Weight 1" := PackageLine."Net Weight";
          IF PackageLine."Qty. per Unit of Measure" <> 0 THEN
            "Commodity Unit Value 1" :=
              PackageLine."Value (Price)" / PackageLine."Qty. per Unit of Measure"
          ELSE
            "Commodity Unit Value 1" := PackageLine."Value (Price)";
          "Commodity Customs Value 1" := PackageLine."Value (Price)";
          IF PackageLine.NEXT <> 0 THEN BEGIN
            "Commodity No. of Pieces 2" := PackageLine.Quantity;
            "Commodity Description 2" := COPYSTR(PackingStation.Description,1,30);
            "Commodity Country of Manf. 2" := GetFedExCountryCode(PackageLine."Country of Manufacture");
            IF PackageLine."Export License Required" THEN BEGIN
              PackageLine.TESTFIELD("Schedule B code");
              "Commodity Harmonized Code 2" := PackageLine."Schedule B code";
              "Commodity Export License No. 2" := PackingStation."Export License No.";
              "Export License Exp. 2 - Int" :=
                Date2Integer(PackingStation."Export License Expiration Date");
              "License Exception Symbol 2" := PackingStation."Export License Exception";
            END;
            "Commodity Unit Quantity 2" := PackageLine."Qty. per Unit of Measure";
            "Commodity Unit of Measure 2" := FixUnitOfMeasure(PackageLine."Unit of Measure Code");
            "Export Control Class No. 2" := PackageLine."Export Controls Class No.";
            "Commodity Weight 2" := PackageLine."Net Weight";
            IF PackageLine."Qty. per Unit of Measure" <> 0 THEN
              "Commodity Unit Value 2" :=
                PackageLine."Value (Price)" / PackageLine."Qty. per Unit of Measure"
            ELSE
              "Commodity Unit Value 2" := PackageLine."Value (Price)";
            "Commodity Customs Value 2" := PackageLine."Value (Price)";
            IF PackageLine.NEXT <> 0 THEN BEGIN
              "Commodity No. of Pieces 3" := PackageLine.Quantity;
              "Commodity Description 3" := COPYSTR(PackingStation.Description,1,30);
              "Commodity Country of Manf. 3" := GetFedExCountryCode(PackageLine."Country of Manufacture");
              IF PackageLine."Export License Required" THEN BEGIN
                PackageLine.TESTFIELD("Schedule B code");
                "Commodity Harmonized Code 3" := PackageLine."Schedule B code";
                "Commodity Export License No. 3" := PackingStation."Export License No.";
                "Export License Exp. 3 - Int" :=
                  Date2Integer(PackingStation."Export License Expiration Date");
                "License Exception Symbol 3" :=
                  PackingStation."Export License Exception";
              END;

              "Commodity Unit Quantity 3" := PackageLine."Qty. per Unit of Measure";
              "Commodity Unit of Measure 3" := FixUnitOfMeasure(PackageLine."Unit of Measure Code");
              "Export Control Class No. 3" := PackageLine."Export Controls Class No.";
              "Commodity Weight 3" := PackageLine."Net Weight";
              IF PackageLine."Qty. per Unit of Measure" <> 0 THEN
                "Commodity Unit Value 3" :=
                  PackageLine."Value (Price)" / PackageLine."Qty. per Unit of Measure"
              ELSE
                "Commodity Unit Value 3" := PackageLine."Value (Price)";
              "Commodity Customs Value 3" := PackageLine."Value (Price)";
              IF PackageLine.NEXT <> 0 THEN BEGIN
                "Commodity No. of Pieces 4" := PackageLine.Quantity;
                "Commodity Description 4" := COPYSTR(PackageLine.Description,1,30);
                "Commodity Country of Manf. 4" :=
                  GetFedExCountryCode(PackageLine."Country of Manufacture");
                IF PackageLine."Export License Required" THEN BEGIN
                  PackageLine.TESTFIELD("Schedule B code");
                  "Commodity Harmonized Code 4" := PackageLine."Schedule B code";
                  "Commodity Export License No. 4" := PackingStation."Export License No.";
                  "Export License Exp. 4 - Int" :=
                    Date2Integer(PackingStation."Export License Expiration Date");
                  "License Exception Symbol 4" :=
                    PackingStation."Export License Exception";
                END;
                "Commodity Unit Quantity 4" := PackageLine."Qty. per Unit of Measure";
                "Commodity Unit of Measure 4" :=
                  FixUnitOfMeasure(PackageLine."Unit of Measure Code");
                "Export Control Class No. 4" := PackageLine."Export Controls Class No.";
                "Commodity Weight 4" := PackageLine."Net Weight";
                IF PackageLine."Qty. per Unit of Measure" <> 0 THEN
                  "Commodity Unit Value 4" :=
                    PackageLine."Value (Price)" / PackageLine."Qty. per Unit of Measure"
                ELSE
                  "Commodity Unit Value 4" := PackageLine."Value (Price)";
                "Commodity Customs Value 4" := PackageLine."Value (Price)";
              END;
            END;
          END;
        END ELSE BEGIN
          GetShippingSetup;
          GetShippingAgent(CurrentPackage."Shipping Agent Code");
          PackingRule.GetPackingRule(
            CurrentPackage."Ship-to Type",CurrentPackage."Ship-to No.",CurrentPackage."Ship-to Code");
          IF NOT PackingRule.PackDetail(
                   CurrentPackage."Source Type",CurrentPackage."Source Subtype",
                   CurrentPackage."Shipping Agent Code")
          THEN BEGIN
            "Commodity No. of Pieces 1" := 1;
            "Commodity Description 1" :=
              COPYSTR(STRSUBSTNO(Text004,CurrentPackage."Source ID"),1,30);
            "Commodity Country of Manf. 1" := 'US';
            "Commodity Unit Quantity 1" := 1;
            "Commodity Unit of Measure 1" := 'EA';
            "Commodity Weight 1" := CurrentPackage."Calculation Weight (LBS)";
            "Commodity Unit Value 1" := CurrentPackage."Calculation Value";
            "Commodity Customs Value 1" := CurrentPackage."Calculation Value";
          END ELSE
            ERROR(Text005);
        END;
      END;
    END;

    PROCEDURE SetExportDocumentation@4(VAR CurrentFedExIntlShipment@1240030000 : Record 14000785;FedExOptionPage@1240030001 : Record 14000781;CurrentPackage@1240030002 : Record 14000701);
    BEGIN
      WITH CurrentFedExIntlShipment DO BEGIN
        CASE FedExOptionPage."International Terms of Sale" OF
          FedExOptionPage."International Terms of Sale"::"Freight On Board":
            "Terms of Sale" := '1';
          FedExOptionPage."International Terms of Sale"::"Cost-Insurance-Freight":
            BEGIN
              "Terms of Sale" := '2';
              "Commercial Inv. Freight Chg." := FedExOptionPage."Freight Charge";
              "Commercial Inv. Insurance Chg." := FedExOptionPage."Insurance Charge";
            END;
          FedExOptionPage."International Terms of Sale"::"Cost and Freight":
            BEGIN
              "Terms of Sale" := '3';
              "Commercial Inv. Freight Chg." := FedExOptionPage."Freight Charge";
            END;
          FedExOptionPage."International Terms of Sale"::"Free Carrier":
            "Terms of Sale" := '1';
          FedExOptionPage."International Terms of Sale"::"Carriage Insurance Paid":
            "Terms of Sale" := '2';
          FedExOptionPage."International Terms of Sale"::"Carrier Paid To":
            "Terms of Sale" := '3';
          FedExOptionPage."International Terms of Sale"::"Ex Works":
            "Terms of Sale" := '4';
          FedExOptionPage."International Terms of Sale"::"Delivered Duty Unpaid":
            "Terms of Sale" := '5';
          FedExOptionPage."International Terms of Sale"::"Delivered Duty Paid":
            "Terms of Sale" := '6';
        END;
        IF FedExOptionPage."Include Broker Info." THEN BEGIN
          "Broker Name" := FedExOptionPage."Broker Name";
          "Broker Phone No." := FedExOptionPage."Broker Phone No.";
          IF FedExOptionPage."Broker FDX Account No." <> '' THEN
            "Broker FDX Account No." := FedExOptionPage."Broker FDX Account No.";
          IF FedExOptionPage."Broker Company Name" <> '' THEN
            "Broker Company Name" := FedExOptionPage."Broker Company Name";
          IF FedExOptionPage."Broker Address 1" <> '' THEN
            "Broker Address 1" := FedExOptionPage."Broker Address 1";
          IF FedExOptionPage."Broker Address 2" <> '' THEN
            "Broker Address 2" := FedExOptionPage."Broker Address 2";
          "Broker City" := FedExOptionPage."Broker City";
          IF FedExOptionPage."Broker State" <> '' THEN
            "Broker State" := FedExOptionPage."Broker State";
          "Broker Postal Code" := FedExOptionPage."Broker Postal Code";
          "Broker Country Code" := FedExOptionPage."Broker Country Code";
          IF FedExOptionPage."Broker SSN/EIN" <> '' THEN
            "Broker SSN/EIN" := FedExOptionPage."Broker SSN/EIN";
          IF FedExOptionPage."Broker Email Address" <> '' THEN
            "Broker Email Address" := FedExOptionPage."Broker Email Address";
          IF FedExOptionPage."Broker Fax No." <> '' THEN
            "Broker Fax No." := FedExOptionPage."Broker Fax No.";
        END;
        IF FedExOptionPage."AES Filing Status" = FedExOptionPage."AES Filing Status"::Shipper THEN
          "AES Filing Status" := 'S'
        ELSE
          "AES Filing Status" := 'C';

        CASE FedExOptionPage."Export Agent / Routing Ind." OF
          FedExOptionPage."Export Agent / Routing Ind."::"Forwarding Agent":
            BEGIN
              "Forwarding Agent Indicator" := '2';
              IF FedExOptionPage."Exporter EIN/SSN Indicator" =
                 FedExOptionPage."Exporter EIN/SSN Indicator"::EIN
              THEN
                "Exporter EIN/SSN Indicator" := 'E'
              ELSE
                "Exporter EIN/SSN Indicator" := 'S';
            END;
          FedExOptionPage."Export Agent / Routing Ind."::"Forwarding Agent with Routed Export":
            "Forwarding Agent Indicator" := '3';
        END;
        CASE FedExOptionPage."Sender EIN/SSN Indicator" OF
          FedExOptionPage."Sender EIN/SSN Indicator"::EIN:
            "Sender EIN/SSN Indicator" := 'E';
          FedExOptionPage."Sender EIN/SSN Indicator"::SSN:
            "Sender EIN/SSN Indicator" := 'S';
          FedExOptionPage."Sender EIN/SSN Indicator"::DUNS:
            "Sender EIN/SSN Indicator" := 'D';
        END;

        "Client Revision Indicator" := '2';  // Must be 2
        IF CurrentPackage."AES ITN No." <> '' THEN
          "AES/FTSR Exemption No." := CurrentPackage."AES ITN No."
        ELSE
          "AES/FTSR Exemption No." := FedExOptionPage."FTSR Exemption";

        IF "Forwarding Agent Indicator" = '2' THEN BEGIN
          "Exporter/PPI Name" := FedExOptionPage."Exporter Name";
          IF FedExOptionPage."Exporter Company Name" <> '' THEN
            "Exporter/PPI Company Name" := FedExOptionPage."Exporter Company Name";
          "Exporter/PPI Address Line 1" := FedExOptionPage."Exporter Address 1";
          IF FedExOptionPage."Exporter Address 2" <> '' THEN
            "Exporter/PPI Address Line 2" := FedExOptionPage."Exporter Address 2";
          "Exporter/PPI City" := FedExOptionPage."Exporter City";
          "Exporter/PPI State" := FedExOptionPage."Exporter State";
          "Exporter/PPI Postal Code" := FedExOptionPage."Exporter Postal Code";
          "Exporter/PPI Country" := FedExOptionPage."Exporter Country";
          "Exporter/PPI Phone No." := FedExOptionPage."Exporter Phone No.";
          "Exporter/PPI SSN/EIN No." := FedExOptionPage."Exporter SSN/EIN No.";
        END;
        IF FedExOptionPage."Interm. Consignee Company" <> '' THEN BEGIN
          "Interm. Consignee Company" := FedExOptionPage."Interm. Consignee Company";
          IF FedExOptionPage."Interm. Consignee Contact" <> '' THEN
            "Interm. Consignee Contact" := FedExOptionPage."Interm. Consignee Contact";
          "Interm. Consignee Address 1" := FedExOptionPage."Interm. Consignee Address 1";
          IF FedExOptionPage."Interm. Consignee Address 2" <> '' THEN
            "Interm. Consignee Address 2" := FedExOptionPage."Interm. Consignee Address 2";
          "Interm. Consignee City" := FedExOptionPage."Interm. Consignee City";
          "Interm. Consignee State" := FedExOptionPage."Interm. Consignee State";
          "Interm. Consignee Postal Code" := FedExOptionPage."Interm. Consignee Postal Code";
          "Interm. Consignee Phone No." := FedExOptionPage."Interm. Consignee Phone No.";
          "Interm. Consignee Country" := FedExOptionPage."Interm. Consignee Country";
        END;

        IF FedExOptionPage."Include Commercial Invoice" THEN
          "Commercial Invoice Flag" := FedExOptionPage."Include Commercial Invoice";
        IF FedExOptionPage."Purpose of Shipment" <> '' THEN
          "Purpose of Shipment" := FedExOptionPage."Purpose of Shipment";
        IF FedExOptionPage."Customer Invoice No." <> '' THEN
          "Customer Invoice No." := FedExOptionPage."Customer Invoice No.";
        CurrentFedExIntlShipment."Commercial Inv. Misc. Chg." := FedExOptionPage."Taxes / Misc. Charge";
        IF FedExOptionPage."Importer Name" <> '' THEN BEGIN
          "Importer Country" := FedExOptionPage."Importer Country";
          "Importer Name" := FedExOptionPage."Importer Name";
          "Importer Company" := FedExOptionPage."Importer Company";
          "Importer Address Line 1" := FedExOptionPage."Importer Address 1";
          IF FedExOptionPage."Importer Address 2" <> '' THEN
            "Importer Address Line 2" := FedExOptionPage."Importer Address 2";
          "Importer City" := FedExOptionPage."Importer City";
          "Importer State" := FedExOptionPage."Importer State";
          "Importer Postal Code" := FedExOptionPage."Importer Postal Code";
          IF FedExOptionPage."Importer Account No." <> '' THEN
            "Importer Account No." := FedExOptionPage."Importer Account No.";
          "Importer Phone No." := FedExOptionPage."Importer Phone No.";
          IF FedExOptionPage."Importer SSN/EIN No." <> '' THEN
            "Importer SSN/EIN No." := FedExOptionPage."Importer SSN/EIN No.";
        END;
      END;
    END;

    LOCAL PROCEDURE SetFDXAPIDomReqFields@46(CurrentFedExShipment@1240030000 : Record 14000783;TransactionID@1240030001 : Code[40];RateShop@1240030002 : Boolean;GiveError@1240030003 : Boolean);
    VAR
      CurrentFedExShipment2@1240030004 : Record 14000789;
    BEGIN
      WITH CurrentFedExShipment DO BEGIN
        IF NOT CurrentFedExShipment2.GET("Transaction Type","Transaction ID") THEN BEGIN
          CurrentFedExShipment2.INIT;
          CurrentFedExShipment2."Transaction Type" := "Transaction Type";
          CurrentFedExShipment2."Transaction ID" := "Transaction ID";
        END;
      {  CLEAR(FDXAPIClient);
        CREATE(FDXAPIClient);
        FDXAPIClient.ApiClear;
        GetGlobalShipperInfo;

        IF RateShop THEN
          FDXAPIClient.SetTransactionType('022')
        ELSE
          FDXAPIClient.SetTransactionType('021');

        FDXAPIClient.SetField('1',TransactionID);
        FDXAPIClient.SetField('10',"Shipper Account No.");
        FDXAPIClient.SetField('498',"Meter Number");
        IF ShippingAgentAccount."Rate Option" <> ShippingAgentAccount."Rate Option"::Default THEN
          FDXAPIClient.SetField('1529','2');
        IF Carrier = Carrier::"FedEx Express" THEN
          FDXAPIClient.SetField('3025','FDXE')
        ELSE
          FDXAPIClient.SetField('3025','FDXG');

      // Origin
        IF NOT RateShop THEN BEGIN
          IF (FedExGlobalRegistration."Shipper Company Name" = '') AND
             (FedExGlobalRegistration."Shipper Contact" = '')
          THEN
            IF GiveError THEN
              ERROR(Text006)
            ELSE
              FedExGlobalRegistration."Shipper Company Name" := COMPANYNAME;
          IF FedExGlobalRegistration."Shipper Company Name" <> '' THEN
            FDXAPIClient.SetField('4',FedExGlobalRegistration."Shipper Company Name");
          IF FedExGlobalRegistration."Shipper Contact" <> '' THEN
            FDXAPIClient.SetField('32',FedExGlobalRegistration."Shipper Contact");
          FDXAPIClient.SetField('5',FedExGlobalRegistration."Shipper Address 1");
          IF FedExGlobalRegistration."Shipper Address 2" <> '' THEN
            FDXAPIClient.SetField('6',FedExGlobalRegistration."Shipper Address 2");
          IF Carrier = Carrier::"FedEx Ground" THEN
            FDXAPIClient.SetField('7',COPYSTR(FedExGlobalRegistration."Shipper City",1,20))
          ELSE
            FDXAPIClient.SetField('7',FedExGlobalRegistration."Shipper City");
          FDXAPIClient.SetField('183',FixPhoneNo(FedExGlobalRegistration."Shipper Phone Number"));
          IF FedExGlobalRegistration."Shipper FAX Number" <> '' THEN
            FDXAPIClient.SetField('1103',FixPhoneNo(FedExGlobalRegistration."Shipper FAX Number"));
          IF FedExGlobalRegistration."Email Address" <> '' THEN
            FDXAPIClient.SetField('1201',FedExGlobalRegistration."Email Address");
        END;
        FDXAPIClient.SetField('8',FixState(FedExGlobalRegistration."Shipper State"));
        FDXAPIClient.SetField('9',FixZIPCode(FedExGlobalRegistration."Shipper ZIP Code"));
        FDXAPIClient.SetField('117',FedExGlobalRegistration."Shipper Country Code");

      // Destination
        IF NOT RateShop THEN BEGIN
          IF "Destination Company Name" <> '' THEN
            FDXAPIClient.SetField('11',"Destination Company Name");
          IF "Destination Contact Name" <> '' THEN
            FDXAPIClient.SetField('12',"Destination Contact Name");
          FDXAPIClient.SetField('13',"Destination Address 1");
          IF "Destination Address 2" <> '' THEN
            FDXAPIClient.SetField('14',"Destination Address 2");
          IF Carrier = Carrier::"FedEx Ground" THEN
            FDXAPIClient.SetField('15',COPYSTR("Destination City",1,20))
          ELSE
            FDXAPIClient.SetField('15',"Destination City");
          FDXAPIClient.SetField('18',"Destination Phone Number");
          IF "Recipient Department" <> '' THEN
            FDXAPIClient.SetField('1145',"Recipient Department");
        END;
        IF ("Destination Country Code" = 'CA') AND ("Destination State" = 'QC') AND
          (CurrentFedExShipment.Carrier = CurrentFedExShipment.Carrier::"FedEx Express")
        THEN
          FDXAPIClient.SetField('16','PQ')
        ELSE
          FDXAPIClient.SetField('16',"Destination State");
        FDXAPIClient.SetField('17',"Destination Zip Code");
        FDXAPIClient.SetField('50',"Destination Country Code");

      // Shipment Date
        FDXAPIClient.SetField('24',Integer2Text("Shipment Date - Integer"));
        FDXAPIClient.SetField('1119',Boolean2YN("Future Day Ship"));

      // Payment
        IF NOT RateShop THEN BEGIN
          IF "Payor Account Number" <> '' THEN
            FDXAPIClient.SetField('20',"Payor Account Number");
          FDXAPIClient.SetField('23',"Payment Code");
          IF "Payment Code" = '4' THEN BEGIN  // Bill Credit Card
            FDXAPIClient.SetField('1101',CurrentFedExShipment2."Payer Credit Card Number");
            FDXAPIClient.SetField('1102',CurrentFedExShipment2."Payer Credit Card Type");
            FDXAPIClient.SetField('1104',CurrentFedExShipment2."Payer Cr. Card Exp. Date");
          END;
        END ELSE
          FDXAPIClient.SetField('23','1');
        IF Carrier = Carrier::"FedEx Ground" THEN
          FDXAPIClient.SetField('68','USD');
      // Multiple Piece Shipping
        FDXAPIClient.SetField('116',Integer2Text("Package Count"));
        IF "Package Count" > 1 THEN BEGIN
          IF NOT RateShop THEN BEGIN
            FDXAPIClient.SetField('1117',Integer2Text("Package Sequence"));
            IF "Package Sequence" > 1 THEN BEGIN
              FDXAPIClient.SetField('1123',CurrentFedExShipment2."Shipment Master Tracking No.");
              FDXAPIClient.SetField('1124',CurrentFedExShipment2."Master Form ID");
            END;
          END;
        END;

      // Shipment/Package Information
        IF NOT RateShop THEN BEGIN
          IF ("Declared Value" > 0) THEN
            IF NOT ShippingAgentService."World Wide Service" THEN
              FDXAPIClient.SetField('1415',Decimal2Text("Declared Value",2))
            ELSE
              IF "Package Sequence" = 1 THEN
                FDXAPIClient.SetField('1415',Decimal2Text("Declared Value",2));
          IF "Reference Notes" <> '' THEN
            FDXAPIClient.SetField('25',"Reference Notes");
          IF Carrier = Carrier::"FedEx Ground" THEN BEGIN
            IF "Ground Purchase Order No." <> '' THEN
              FDXAPIClient.SetField('3001',"Ground Purchase Order No.");
            IF "Ground Invoice No." <> '' THEN
              FDXAPIClient.SetField('3002',"Ground Invoice No.");
            IF "Ground Customer Reference No." <> '' THEN
              FDXAPIClient.SetField('3003',"Ground Customer Reference No.");
          END;
        END;
        IF "Package Height" <> 0 THEN
          FDXAPIClient.SetField('57',Decimal2Text("Package Height",0));
        IF "Package Width" <> 0 THEN
          FDXAPIClient.SetField('58',Decimal2Text("Package Width",0));
        IF "Package Length" <> 0 THEN
          FDXAPIClient.SetField('59',Decimal2Text("Package Length",0));
        FDXAPIClient.SetField('75',"Weight Units");
        IF "Dim Units" <> '' THEN
          FDXAPIClient.SetField('1116',"Dim Units");
        FDXAPIClient.SetField('1273',"Packaging Type");
        FDXAPIClient.SetField('1274',"Service Code");
        FDXAPIClient.SetField('1401',Decimal2Text("Package Weight",1));

      // Special Service
        // COD
        IF "COD Flag" THEN BEGIN
          FDXAPIClient.SetField('27','Y');
          FDXAPIClient.SetField('1432',Decimal2Text("COD Amount",2));  //COD
          FDXAPIClient.SetField('3000',"COD Collection Type");
          IF NOT RateShop THEN BEGIN
            IF "Add Freight Charges" THEN BEGIN
              IF ShippingAgentAccount."Rate Option" = ShippingAgentAccount."Rate Option"::Discount THEN
                FDXAPIClient.SetField('186','1');
              IF ShippingAgentAccount."Rate Option" = ShippingAgentAccount."Rate Option"::List THEN
                FDXAPIClient.SetField('186','2');
              IF ShippingAgentAccount."Rate Option" = ShippingAgentAccount."Rate Option"::Default THEN
                FDXAPIClient.SetField('186',Boolean2YN("Add Freight Charges"));
            END ELSE
              FDXAPIClient.SetField('186',Boolean2YN("Add Freight Charges"));
            IF "Package Sequence" = "Package Count" THEN
              FDXAPIClient.SetField('28',"COD Return Tracking No.");
            FDXAPIClient.SetField('439',"COD Return Contact Name");
            FDXAPIClient.SetField('1237',FixPhoneNo("COD Return Phone"));
            FDXAPIClient.SetField('1238',"COD Return Company");
            IF "COD Return Department" <> '' THEN
              FDXAPIClient.SetField('1239',"COD Return Department");
            FDXAPIClient.SetField('1240',"COD Return Address 1");
            IF "COD Return Address 2" <> '' THEN
              FDXAPIClient.SetField('1241',"COD Return Address 2");
            FDXAPIClient.SetField('1242',"COD Return City");
            FDXAPIClient.SetField('1243',FixState("COD Return State"));
            FDXAPIClient.SetField('1244',FixZIPCode("COD Return Postal Code"));
            IF CurrentFedExShipment2."COD Return Reference Indicator" <> '' THEN
              FDXAPIClient.SetField('3045',CurrentFedExShipment2."COD Return Reference Indicator");
          END;
        END;
        // Home Delivery
        FDXAPIClient.SetField('3019',Boolean2YN("Home Signature Delivery Flag"));
        FDXAPIClient.SetField('3020',"Home Delivery Type");
        IF (NOT RateShop) AND (("Home Delivery Type" = '1') OR ("Home Delivery Type" = '3')) THEN BEGIN
          FDXAPIClient.SetField('3024',FixPhoneNo("Home Delivery Phone No."));
          IF "Home Delivery Type" = '1' THEN
            FDXAPIClient.SetField('3023',Integer2Text("Home Delivery Date - Integer"));
        END;
        // Alcohol
        IF NOT RateShop THEN BEGIN
          FDXAPIClient.SetField('1332',Boolean2YN("Alcohol Flag"));
          IF "Alcohol Flag" THEN BEGIN
            FDXAPIClient.SetField('40',CurrentFedExShipment2."Alcohol Type");
            FDXAPIClient.SetField('41',CurrentFedExShipment2."Alcohol Packaging");
            FDXAPIClient.SetField('52',Integer2Text(CurrentFedExShipment2."Alcohol Packages"));
            FDXAPIClient.SetField('1405',Decimal2Text(CurrentFedExShipment2."Alcohol Volume",3));
          END;
        END;
        // Hold At Location
        FDXAPIClient.SetField('1200',Boolean2YN("Hold at Location"));
        IF "Hold at Location" AND (NOT RateShop) THEN BEGIN
          FDXAPIClient.SetField('44',"HAL Station Address 1");
          FDXAPIClient.SetField('46',"HAL City");
          FDXAPIClient.SetField('47',FixState("HAL State"));
          FDXAPIClient.SetField('48',FixZIPCode("HAL Zip Code"));
          FDXAPIClient.SetField('49',FixPhoneNo("HAL Phone Number"));
        END;
        // Dangerous Goods
        IF "Dangerous Goods Type" <> '' THEN
          FDXAPIClient.SetField('1331',"Dangerous Goods Type");
        // Dry Ice
        IF "Dry Ice" THEN BEGIN
          FDXAPIClient.SetField('1268','Y');
          IF NOT RateShop THEN
            FDXAPIClient.SetField('1406',Decimal2Text("Dry Ice Weight",1));
        END;
        // Alerts
        IF NOT RateShop THEN BEGIN
          IF "Ship Alert Message" <> '' THEN
            FDXAPIClient.SetField('1203',"Ship Alert Message");
          IF Carrier = Carrier::"FedEx Express" THEN BEGIN
            IF "Ship Alert"  THEN BEGIN
              IF "Ship Alert" THEN
                FDXAPIClient.SetFieldInstance('1206',0,'Y');
              FDXAPIClient.SetFieldInstance('1204',0,"Ship Alert Email Address 1");
              IF "Ship Alert Email Address 2" <> '' THEN BEGIN
                IF "Ship Alert" THEN
                  FDXAPIClient.SetFieldInstance('1206',1,'Y');
                FDXAPIClient.SetFieldInstance('1204',1,"Ship Alert Email Address 2");
                IF "Ship Alert Email Address 3" <> '' THEN BEGIN
                  IF "Ship Alert" THEN
                    FDXAPIClient.SetFieldInstance('1206',2,'Y');
                  FDXAPIClient.SetFieldInstance('1204',2,"Ship Alert Email Address 3");
                END;
              END;
            END;
            IF CurrentFedExShipment2."Shipper Delivery Notification" THEN
              FDXAPIClient.SetField('1553','Y');
            IF CurrentFedExShipment2."Shipper Ship Notification" THEN
              FDXAPIClient.SetField('1554','Y');
            IF CurrentFedExShipment2."Recipient Delivery Notif." THEN
              FDXAPIClient.SetField('1556','Y');
            IF CurrentFedExShipment2."Recipient Ship Notification" THEN
              FDXAPIClient.SetField('1557','Y');
          END ELSE BEGIN
            IF "Ship Alert" THEN
              FDXAPIClient.SetField('1206','Y');
            IF "Ship Alert Email Address 1" <> '' THEN
              FDXAPIClient.SetField('1204',"Ship Alert Email Address 1")
            ELSE
              FDXAPIClient.SetField('3035',FixPhoneNo("Ship Alert Fax No."));
          END;
        END;
        // Signature Release
        IF "Signature Release Flag" AND (NOT RateShop) THEN BEGIN
          IF GiveError THEN
            TESTFIELD("Release Authorization No.");
          FDXAPIClient.SetField('51','Y');
          FDXAPIClient.SetField('1118',"Release Authorization No.");
        END;
        // Other
        IF "Residential Delivery Flag" THEN
          FDXAPIClient.SetField('440','Y');
        IF "Inside Pickup" THEN
          FDXAPIClient.SetField('1120','Y');
        IF "Inside Delivery" THEN
          FDXAPIClient.SetField('1121','Y');
        IF CurrentFedExShipment2."Signature Option" <> '' THEN
          FDXAPIClient.SetField('2399',CurrentFedExShipment2."Signature Option");
        IF "Saturday Delivery" THEN
          FDXAPIClient.SetField('1266','Y');
        IF "Saturday Pickup" THEN
          FDXAPIClient.SetField('1267','Y');
        FDXAPIClient.SetField('1333',"Drop Off Type");
        IF Autopod THEN
          FDXAPIClient.SetField('3008','Y');

      // Return Specific
        IF (CurrentFedExShipment2."Return Shipment Indicator" <> '') AND
           (Carrier = Carrier::"FedEx Ground")
        THEN
          FDXAPIClient.SetField('2382',CurrentFedExShipment2."Return Shipment Indicator");
      // Freight Specific
        IF CurrentFedExShipment2."Packing List Enclosed" THEN
          FDXAPIClient.SetField('1253','Y');
      // Configurable Doc Tab
        IF "Label Media Type" = '3' THEN BEGIN
          FDXAPIClient.SetField('2973','1');
          FDXAPIClient.SetField('1607','Invoice');
          FDXAPIClient.SetField('1624','1297');
          FDXAPIClient.SetField('1608','Customer');
          FDXAPIClient.SetField('1625','25');
          FDXAPIClient.SetField('1609','Dept.');
          FDXAPIClient.SetField('1626','1145');
          FDXAPIClient.SetField('1611','Date');
          FDXAPIClient.SetField('1628','24');
          FDXAPIClient.SetField('1612','Weight');
          FDXAPIClient.SetField('1629','1401');
          FDXAPIClient.SetField('1613','COD');
          FDXAPIClient.SetField('1630','1433');
          FDXAPIClient.SetField('1614','DV');
          FDXAPIClient.SetField('1631','1415');
          FDXAPIClient.SetField('1615','Shipping');
          FDXAPIClient.SetField('1632','1416');
          FDXAPIClient.SetField('1616','Special');
          FDXAPIClient.SetField('1633','1417');
          FDXAPIClient.SetField('1617','Handling');
          FDXAPIClient.SetField('1634','3107');
          FDXAPIClient.SetField('1618','Total');
          FDXAPIClient.SetField('1635','1419');
        END;
      // Forms / Printers
        FDXAPIClient.SetField('1368',"Label Type");
        FDXAPIClient.SetField('1369',"Label Printer Type");
        FDXAPIClient.SetField('1370',"Label Media Type");}
      END;
    END;

    PROCEDURE SetFDXAPIIntlReqFields@2(CurrentFedExIntlShipment@1240030000 : Record 14000785;DestinationCountry@1240030001 : Code[2];PackageSequence@1240030002 : Integer;PackageCount@1240030003 : Integer;Freight@1240030004 : Boolean;GiveError@1240030005 : Boolean);
    BEGIN
      WITH CurrentFedExIntlShipment DO BEGIN
      {  FDXAPIClient.SetField('1139',"Shipper IRS/EIN No.");
        FDXAPIClient.SetField('118',"Destination IRS/EIN Number");
        IF "Declared Value Currency Type" = '' THEN
          "Declared Value Currency Type" := 'USD';
        FDXAPIClient.SetField('68',"Declared Value Currency Type");
        IF NOT "Document Flag" THEN BEGIN
          FDXAPIClient.SetField('70',"Duties Pay Type");
          IF "Duties Payer Account No." <> '' THEN
            FDXAPIClient.SetField('71',"Duties Payer Account No.");
          IF "Duties Payer Country Code" <> '' THEN
            FDXAPIClient.SetField('1032',"Duties Payer Country Code");
          IF (PackageCount > 1) AND (PackageSequence = 1) THEN
            FDXAPIClient.SetField('1400',Decimal2Text("Total Shipment Weight",1));
          FDXAPIClient.SetField('72',"Terms of Sale");
          FDXAPIClient.SetField('190','N');
        END ELSE
          FDXAPIClient.SetField('190','Y');
        FDXAPIClient.SetField('73',Boolean2YN("Consignee Related"));
        FDXAPIClient.SetField('74',DestinationCountry);
        FDXAPIClient.SetField('413',Boolean2YN("NAFTA Flag"));
        FDXAPIClient.SetField('1411',Decimal2Text("Total Customs Value",2));
        //IF (PackageCount > 1) AND (PackageSequence = 1) THEN
        //  FDXAPIClient.SetField('1415',Decimal2Text("Total Customs Value",2));
        IF "Broker Delivery Notification" THEN
          FDXAPIClient.SetField('1559','Y');
        IF "Broker Ship Notification" THEN
          FDXAPIClient.SetField('1560','Y');
        IF Freight THEN BEGIN
          IF PackageSequence = 1 THEN
            FDXAPIClient.SetField('1271',Integer2Text("Shipper Load and Count"));
          FDXAPIClient.SetField('1272',"Booking Confirmation No.");
        END;
      // Broker
        IF "Broker Select Flag" THEN BEGIN
          IF GiveError THEN BEGIN
            TESTFIELD("Broker Name");
            TESTFIELD("Broker Phone No.");
            TESTFIELD("Broker City");
            TESTFIELD("Broker Country Code");
            IF "Broker Country Code" <> DestinationCountry THEN
              ERROR(
                Text007,
                DestinationCountry);
            IF ("Broker Country Code" = 'US') OR
               ("Broker Country Code" = '') OR
               ("Broker Country Code" = 'CA') OR
               ("Broker Country Code" = 'MX')
            THEN BEGIN
              TESTFIELD("Broker State");
              TESTFIELD("Broker Postal Code");
              FDXAPIClient.SetField('1184',"Broker State");
              FDXAPIClient.SetField('1185',"Broker Postal Code");
            END;
          END;
          FDXAPIClient.SetField('1174','Y');
          FDXAPIClient.SetField('66',"Broker Name");
          FDXAPIClient.SetField('67',"Broker Phone No.");
          IF "Broker FDX Account No." <> '' THEN
            FDXAPIClient.SetField('1179',"Broker FDX Account No.");
          IF "Broker Company Name" <> '' THEN
            FDXAPIClient.SetField('1180',"Broker Company Name");
          IF "Broker Address 1" <> '' THEN
            FDXAPIClient.SetField('1181',"Broker Address 1");
          IF "Broker Address 2" <> '' THEN
            FDXAPIClient.SetField('1182',"Broker Address 2");
          FDXAPIClient.SetField('1183',"Broker City");
          FDXAPIClient.SetField('1186',"Broker Country Code");
          IF "Broker SSN/EIN" <> '' THEN
            FDXAPIClient.SetField('1187',"Broker SSN/EIN");
          IF "Broker Email Address" <> '' THEN
            FDXAPIClient.SetField('1343',"Broker Email Address");
          IF "Broker Fax No." <> '' THEN
            FDXAPIClient.SetField('1344',"Broker Fax No.");
        END;
        IF "Commodity No. of Pieces 1" > 0 THEN BEGIN
          FDXAPIClient.SetFieldInstance('76',0,Integer2Text("Commodity No. of Pieces 1"));
          FDXAPIClient.SetFieldInstance('79',0,CONVERTSTR("Commodity Description 1",'"',' '));
          FDXAPIClient.SetFieldInstance('80',0,"Commodity Country of Manf. 1");
          IF "Commodity Harmonized Code 1" <> '' THEN
            FDXAPIClient.SetFieldInstance('81',0,"Commodity Harmonized Code 1");
          FDXAPIClient.SetFieldInstance('82',0,Integer2Text("Commodity Unit Quantity 1"));
          IF "Commodity Export License No. 1" <> '' THEN BEGIN
            FDXAPIClient.SetFieldInstance('83',0,"Commodity Export License No. 1");
            FDXAPIClient.SetFieldInstance('84',0,Integer2Text("Export License Exp. 1 - Int"));
          END;
          IF "CI Marks and Numbers 1" <> '' THEN
            FDXAPIClient.SetFieldInstance('120',0,"CI Marks and Numbers 1");
          IF "License Exception Symbol 1" <> '' THEN
            FDXAPIClient.SetFieldInstance('404',0,"License Exception Symbol 1");
          FDXAPIClient.SetFieldInstance('414',0,"Commodity Unit of Measure 1");
          IF "Export Control Class No. 1" <> '' THEN
            FDXAPIClient.SetFieldInstance('528',0,"Export Control Class No. 1");
          FDXAPIClient.SetFieldInstance('1407',0,Decimal2Text("Commodity Weight 1",1));
          FDXAPIClient.SetFieldInstance('1408',0,Decimal2Text("Commodity Unit Value 1",6));
          FDXAPIClient.SetFieldInstance('1410',0,Decimal2Text("Commodity Customs Value 1",6));
        END;
        IF "Commodity No. of Pieces 2" > 0 THEN BEGIN
          FDXAPIClient.SetFieldInstance('76',1,Integer2Text("Commodity No. of Pieces 2"));
          FDXAPIClient.SetFieldInstance('79',1,CONVERTSTR("Commodity Description 2",'"',' '));
          FDXAPIClient.SetFieldInstance('80',1,"Commodity Country of Manf. 2");
          IF "Commodity Harmonized Code 2" <> '' THEN
            FDXAPIClient.SetFieldInstance('81',1,"Commodity Harmonized Code 2");
          FDXAPIClient.SetFieldInstance('82',1,Integer2Text("Commodity Unit Quantity 2"));
          IF "Commodity Export License No. 2" <> '' THEN BEGIN
            FDXAPIClient.SetFieldInstance('83',1,"Commodity Export License No. 2");
            FDXAPIClient.SetFieldInstance('84',1,Integer2Text("Export License Exp. 2 - Int"));
          END;
          IF "CI Marks and Numbers 2" <> '' THEN
            FDXAPIClient.SetFieldInstance('120',1,"CI Marks and Numbers 2");
          IF "License Exception Symbol 2" <> '' THEN
            FDXAPIClient.SetFieldInstance('404',1,"License Exception Symbol 2");
          FDXAPIClient.SetFieldInstance('414',1,"Commodity Unit of Measure 2");
          IF "Export Control Class No. 2" <> '' THEN
            FDXAPIClient.SetFieldInstance('528',1,"Export Control Class No. 2");
          FDXAPIClient.SetFieldInstance('1407',1,Decimal2Text("Commodity Weight 2",1));
          FDXAPIClient.SetFieldInstance('1408',1,Decimal2Text("Commodity Unit Value 2",6));
          FDXAPIClient.SetFieldInstance('1410',1,Decimal2Text("Commodity Customs Value 2",6));
        END;
        IF "Commodity No. of Pieces 3" > 0 THEN BEGIN
          FDXAPIClient.SetFieldInstance('76',2,Integer2Text("Commodity No. of Pieces 3"));
          FDXAPIClient.SetFieldInstance('79',2,CONVERTSTR("Commodity Description 3",'"',' '));
          FDXAPIClient.SetFieldInstance('80',2,"Commodity Country of Manf. 3");
          IF "Commodity Harmonized Code 3" <> '' THEN
            FDXAPIClient.SetFieldInstance('81',2,"Commodity Harmonized Code 3");
          FDXAPIClient.SetFieldInstance('82',2,Integer2Text("Commodity Unit Quantity 3"));
          IF "Commodity Export License No. 3" <> '' THEN BEGIN
            FDXAPIClient.SetFieldInstance('83',2,"Commodity Export License No. 3");
            FDXAPIClient.SetFieldInstance('84',2,Integer2Text("Export License Exp. 3 - Int"));
          END;
          IF "CI Marks and Numbers 3" <> '' THEN
            FDXAPIClient.SetFieldInstance('120',2,"CI Marks and Numbers 3");
          IF "License Exception Symbol 3" <> '' THEN
            FDXAPIClient.SetFieldInstance('404',2,"License Exception Symbol 3");
          FDXAPIClient.SetFieldInstance('414',2,"Commodity Unit of Measure 3");
          IF "Export Control Class No. 3" <> '' THEN
            FDXAPIClient.SetFieldInstance('528',2,"Export Control Class No. 3");
          FDXAPIClient.SetFieldInstance('1407',2,Decimal2Text("Commodity Weight 3",1));
          FDXAPIClient.SetFieldInstance('1408',2,Decimal2Text("Commodity Unit Value 3",6));
          FDXAPIClient.SetFieldInstance('1410',2,Decimal2Text("Commodity Customs Value 3",6));
        END;
        IF "Commodity No. of Pieces 4" > 0 THEN BEGIN
          FDXAPIClient.SetFieldInstance('76',3,Integer2Text("Commodity No. of Pieces 4"));
          FDXAPIClient.SetFieldInstance('79',3,CONVERTSTR("Commodity Description 4",'"',' '));
          FDXAPIClient.SetFieldInstance('80',3,"Commodity Country of Manf. 4");
          IF "Commodity Harmonized Code 4" <> '' THEN
            FDXAPIClient.SetFieldInstance('81',3,"Commodity Harmonized Code 4");
          FDXAPIClient.SetFieldInstance('82',3,Integer2Text("Commodity Unit Quantity 4"));
          IF "Commodity Export License No. 4" <> '' THEN BEGIN
            FDXAPIClient.SetFieldInstance('83',3,"Commodity Export License No. 4");
            FDXAPIClient.SetFieldInstance('84',3,Integer2Text("Export License Exp. 4 - Int"));
          END;
          IF "CI Marks and Numbers 4" <> '' THEN
            FDXAPIClient.SetFieldInstance('120',3,"CI Marks and Numbers 4");
          IF "License Exception Symbol 4" <> '' THEN
            FDXAPIClient.SetFieldInstance('404',3,"License Exception Symbol 4");
          FDXAPIClient.SetFieldInstance('414',3,"Commodity Unit of Measure 4");
          IF "Export Control Class No. 4" <> '' THEN
            FDXAPIClient.SetFieldInstance('528',3,"Export Control Class No. 4");
          FDXAPIClient.SetFieldInstance('1407',3,Decimal2Text("Commodity Weight 4",1));
          FDXAPIClient.SetFieldInstance('1408',3,Decimal2Text("Commodity Unit Value 4",6));
          FDXAPIClient.SetFieldInstance('1410',3,Decimal2Text("Commodity Customs Value 4",6));
        END;
      // Shipper's Export Declaration (SED)
        IF "AES Filing Status" <> '' THEN
          FDXAPIClient.SetField('1349',"AES Filing Status");
      //  IF "SED Required" THEN BEGIN
          IF "Forwarding Agent Indicator" <> '' THEN BEGIN
            FDXAPIClient.SetField('600',"Forwarding Agent Indicator");
            IF "Forwarding Agent Indicator" = '2' THEN
              FDXAPIClient.SetField('602',"Exporter EIN/SSN Indicator");
          END;
          FDXAPIClient.SetField('1352',"Sender EIN/SSN Indicator");
          IF "AES/FTSR Exemption No." <> '' THEN
            FDXAPIClient.SetField('1358',"AES/FTSR Exemption No.");
          FDXAPIClient.SetField('1391',"Client Revision Indicator");
          IF "AES Entry No." <> '' THEN
            FDXAPIClient.SetField('1399',"AES Entry No.");
      //SED - Exporter / US Principal Party Of Interest
      //    IF "Forwarding Agent Indicator" = '2' THEN BEGIN
            FDXAPIClient.SetField('1286',"Exporter/PPI Name");
            IF "Exporter/PPI Company Name" <> '' THEN
              FDXAPIClient.SetField('1287',"Exporter/PPI Company Name");
            FDXAPIClient.SetField('1288',"Exporter/PPI Address Line 1");
            IF "Exporter/PPI Address Line 2" <> '' THEN
              FDXAPIClient.SetField('1289',"Exporter/PPI Address Line 2");
            FDXAPIClient.SetField('1290',"Exporter/PPI City");
            FDXAPIClient.SetField('1291',"Exporter/PPI State");
            FDXAPIClient.SetField('1292',"Exporter/PPI Postal Code");
            FDXAPIClient.SetField('1293',"Exporter/PPI Country");
            FDXAPIClient.SetField('1294',"Exporter/PPI Phone No.");
            FDXAPIClient.SetField('1295',"Exporter/PPI SSN/EIN No.");
      //    END;
      // SED - Intermediate Consignee
          IF "Interm. Consignee Company" <> '' THEN BEGIN
            FDXAPIClient.SetField('603',"Interm. Consignee Company");
            IF "Interm. Consignee Contact" <> '' THEN
              FDXAPIClient.SetField('604',"Interm. Consignee Contact");
            FDXAPIClient.SetField('605',"Interm. Consignee Address 1");
            IF "Interm. Consignee Address 2" <> '' THEN
              FDXAPIClient.SetField('606',"Interm. Consignee Address 2");
            FDXAPIClient.SetField('607',"Interm. Consignee City");
            IF "Interm. Consignee State" <> '' THEN
              FDXAPIClient.SetField('608',"Interm. Consignee State");
            IF "Interm. Consignee Postal Code" <> '' THEN
              FDXAPIClient.SetField('609',"Interm. Consignee Postal Code");
            FDXAPIClient.SetField('610',"Interm. Consignee Phone No.");
            FDXAPIClient.SetField('611',"Interm. Consignee Country");
          END;
      //  END;
        IF "Commercial Invoice Flag" THEN BEGIN
      // Commercial Invoice
          FDXAPIClient.SetField('113',Boolean2YN("Commercial Invoice Flag"));
          IF "Purpose of Shipment" <> '' THEN
            FDXAPIClient.SetField('1210',"Purpose of Shipment");
          IF "Customer Invoice No." <> '' THEN
            FDXAPIClient.SetField('1297',"Customer Invoice No.");
          FDXAPIClient.SetField('1412',Decimal2Text("Commercial Inv. Freight Chg.",2));
          FDXAPIClient.SetField('1413',Decimal2Text("Commercial Inv. Insurance Chg.",2));
          IF "Commercial Inv. Misc. Chg." > 0 THEN
            FDXAPIClient.SetField('1414',Decimal2Text("Commercial Inv. Misc. Chg.",2));
      // Commercial Invoice Importer
          IF ("Importer Name" <> '') OR ("Importer Company" <> '') THEN BEGIN
            FDXAPIClient.SetField('169',"Importer Country");
            FDXAPIClient.SetField('170',"Importer Name");
            FDXAPIClient.SetField('171',"Importer Company");
            FDXAPIClient.SetField('172',"Importer Address Line 1");
            IF "Importer Address Line 2" <> '' THEN
              FDXAPIClient.SetField('173',"Importer Address Line 2");
            FDXAPIClient.SetField('174',"Importer City");
            IF "Importer State" <> '' THEN
              FDXAPIClient.SetField('175',"Importer State");
            IF "Importer Postal Code" <> '' THEN
              FDXAPIClient.SetField('176',"Importer Postal Code");
            IF "Importer Account No." <> '' THEN
              FDXAPIClient.SetField('177',"Importer Account No.");
            FDXAPIClient.SetField('178',"Importer Phone No.");
            IF "Importer SSN/EIN No." <> '' THEN
              FDXAPIClient.SetField('180',"Importer SSN/EIN No.");
          END;
        END;}
      END;
    END;

    LOCAL PROCEDURE ShipPackage@9(VAR CurrentFedExShipment@1240030001 : Record 14000783;CurrentPackage@1240030002 : Record 14000701;ShowSoftErrors@1240030003 : Boolean) ErrorMessage@1240030000 : Text[250];
    VAR
      CurrentFedExShipment2@1240030004 : Record 14000789;
      FedExShipment@1240030005 : Record 14000783;
      FedExShipment2@1240030006 : Record 14000789;
      CurrentFedEXIntlShipment@1240030007 : Record 14000785;
      LabelFileName@1240030008 : Text[250];
      Freight@1240030011 : Boolean;
      SoftType@1240030012 : Code[20];
      UniversalTransactionID@1240030013 : Integer;
    BEGIN
      GetShippingSetup;
      WITH CurrentFedExShipment DO BEGIN
        IF NOT CurrentFedExShipment2.GET("Transaction Type","Transaction ID") THEN BEGIN
          CurrentFedExShipment2.INIT;
          CurrentFedExShipment2."Transaction Type" :="Transaction Type";
          CurrentFedExShipment2."Transaction ID" := "Transaction ID";
        END;
        IF Carrier = Carrier::"FedEx Express" THEN
          UniversalTransactionID := 2016
        ELSE
          UniversalTransactionID := 3000;


        SetFDXAPIDomReqFields(CurrentFedExShipment,"Transaction ID",FALSE,TRUE);
        IF "International Shipment" THEN BEGIN
          CurrentFedEXIntlShipment.GET("Transaction Type","Transaction ID");
          IF ("Service Code" = '70') OR ("Service Code" = '86') THEN
            Freight := TRUE
          ELSE
            Freight := FALSE;
          SetFDXAPIIntlReqFields(
            CurrentFedEXIntlShipment,"Destination Country Code","Package Sequence",
            "Package Count",Freight,TRUE);
        END;

        Window.OPEN(Text001);
      {  FDXAPIClient.ApiBuild;
        FDXAPIClient.SaveBuffer(BufferFileName);
        FDXAPIClient.FEDEXAPITransaction(
          UniversalTransactionID,CarrierPackingStation."Proxy Address",
          Text2Integer(CarrierPackingStation."Proxy Port"));
        FDXAPIClient.SaveBuffer(BufferFileName);
        FDXAPIClient.ApiParse;
        Window.CLOSE;

        FedExShipment.INIT;
        FedExShipment.COPY(CurrentFedExShipment);
        FedExShipment2.INIT;
        FedExShipment2.COPY(CurrentFedExShipment2);
        FedExShipment."Transaction Type" := 121;
        FedExShipment."Transaction ID" := "Transaction ID";
        FedExShipment."Error Code" := FDXAPIClient.GetField('2');
        FedExShipment."Error Message" := FDXAPIClient.GetField('3');
        FedExShipment2."Soft Error Type" := FDXAPIClient.GetField('557');
        FedExShipment2."Soft Error Message Code" := FDXAPIClient.GetField('558');
        FedExShipment2."Soft Error Message" := FDXAPIClient.GetField('559');
        FedExShipment."COD Return Tracking No." := FDXAPIClient.GetField('28');
        FedExShipment."Master Tracking No." := FDXAPIClient.GetField('29');
        FedExShipment."Tracking Form ID" := FDXAPIClient.GetField('526');
        FedExShipment."COD Return Tracking Form ID" := FDXAPIClient.GetField('527');
        FedExShipment2."Shipment Master Tracking No." := FDXAPIClient.GetField('1123');
        FedExShipment2."Master Form ID" := FDXAPIClient.GetField('1124');
      // Rating Info
        FedExShipment."DIM Weight Used Flag" := YN2Boolean(FDXAPIClient.GetField('431'));
        FedExShipment."Rate Scale" := FDXAPIClient.GetField('1089');
        FedExShipment."Rate Currency Type" := FDXAPIClient.GetField('1090');
        FedExShipment2."Rate Zone" := FDXAPIClient.GetField('1092');
        FedExShipment."Billed Weight" := Text2Decimal(FDXAPIClient.GetField('1402'));
        FedExShipment."Dim Weight" := Text2Decimal(FDXAPIClient.GetField('1403'));
        FedExShipment."COD Amount" := Text2Decimal(FDXAPIClient.GetField('1433'));
        FedExShipment."Base Charge" := Text2Decimal(FDXAPIClient.GetField('1416'));
        FedExShipment."Total Surcharge" := Text2Decimal(FDXAPIClient.GetField('1417'));
        FedExShipment."Total Discount" := Text2Decimal(FDXAPIClient.GetField('1418'));
        FedExShipment."Net Charge" := Text2Decimal(FDXAPIClient.GetField('1419'));
        FedExShipment."Total Rebate Amount" := Text2Decimal(FDXAPIClient.GetField('1420'));
      // Routing/Astra
        FedExShipment."URSA Code" := FDXAPIClient.GetField('30');
        FedExShipment."Service Area" := FDXAPIClient.GetField('33');
        FedExShipment."ASTRA Bar Code Data" := FDXAPIClient.GetField('65');
        FedExShipment."Delivery Day" := FDXAPIClient.GetField('194');
        FedExShipment."Routing Location ID" := FDXAPIClient.GetField('195');
        FedExShipment."Delivery Date - Text" := FDXAPIClient.GetField('409');
        FedExShipment."COD Return ASTRA Barcode" := FDXAPIClient.GetField('535');
        FedExShipment."COD Return Service Area" := FDXAPIClient.GetField('536');
      // Label Buffer
        FedExShipment."Buffer File Name" := BufferFileName;
        IF "Label Printer Type" = '1' THEN
          LabelFileName := GetLabelFileName(FedExShipment."Master Tracking No.") + '.png'
        ELSE
          LabelFileName := GetLabelFileName(FedExShipment."Master Tracking No.") + '.txt';
        FedExShipment."Gif Label File Name" := LabelFileName;
        IF ShippingAgentAccount."Rate Option" <> ShippingAgentAccount."Rate Option"::Default THEN BEGIN
          FedExShipment2."List Base Rate" := Text2Decimal(FDXAPIClient.GetField('1530'));
          FedExShipment2."List Total Surcharge" := Text2Decimal(FDXAPIClient.GetField('1507'));
          FedExShipment2."Effective Net Discount" := Text2Decimal(FDXAPIClient.GetField('1525'));
          FedExShipment2."List Net Charge" := Text2Decimal(FDXAPIClient.GetField('1528'));
          FedExShipment2."List Total Rebate Amount" := Text2Decimal(FDXAPIClient.GetField('1532'));
        END;}
        FedExShipment.INSERT;
        IF NOT FedExShipment2.INSERT THEN
          FedExShipment2.MODIFY;
        ErrorMessage := FedExShipment."Error Message";
        IF ShowSoftErrors AND (FedExShipment2."Soft Error Message Code" <> '') THEN BEGIN
          CASE FedExShipment2."Soft Error Type" OF
            '01':
              SoftType := Text008;
            '02':
              SoftType := Text009;
            '03':
              SoftType := Text010;
            '04':
              SoftType := Text011;
            '05':
              SoftType := Text012;
            '06':
              SoftType := Text013;
            '07':
              SoftType := Text014;
          END;
          MESSAGE(
            Text015 + Text016 + Text017 + '%3',
            SoftType,
            FedExShipment2."Soft Error Message Code",
            FedExShipment2."Soft Error Message");
        END;
      END;
    END;

    PROCEDURE ClosePackage@7(VAR CurrentPackage@1240030000 : Record 14000701;VAR MultiDocPackageTmp@1240030001 : Record 14000701;CurrentShippingAgent@1240030002 : Record 291;PrintLabel@1240030003 : Boolean);
    VAR
      FedExOptionPage@1240030004 : Record 14000781;
      FedExShipment@1240030005 : Record 14000783;
      FedExIntlShipment@1240030006 : Record 14000785;
      Package@1240030007 : Record 14000701;
      Package2@1240030026 : Record 14000701;
      FirstPackageTransaction@1240030008 : Record 14000783;
      CompanyInfo@1240030010 : Record 79;
      FedExShipment2@1240030011 : Record 14000789;
      MultiDocPackageMgt@1240030012 : Codeunit 14000703;
      ErrorMessage@1240030015 : Text[250];
      TextPos@1240030016 : Integer;
      LabelFileName@1240030017 : Text[250];
      Sequence@1240030018 : Integer;
      TextLabel@1240030020 : Boolean;
      TransactionID@1240030021 : Code[40];
      Reference@1240030024 : Code[30];
      CODMarkup@1240030025 : Decimal;
      MasterTrackingNumber@1240030027 : Code[20];
      MasterFormID@1240030028 : Code[4];
    BEGIN
      WITH CurrentPackage DO BEGIN
        TESTFIELD(Closed,FALSE);
        IF "Manual Shipment" THEN BEGIN
          IF CurrentShippingAgent."Enter Ext. Track. No. on Close" THEN
            Shipping.EnterExternalTrackingNo(CurrentPackage,FALSE);

          "Closed by Packing Station Code" := PackingStation.Code;
          ClearTotalValueFields;
          VALIDATE("Calculation Weight",GetWeight);
          GetCalculationFields(1,'>');
          "Packing Date" := WORKDATE;
          "Packing Time" := TIME;
          "Packed By" := USERID;
          "Shipping Cost" := 0;
          Markup := 0;
          IF "Override Shipping Charge" <> 0 THEN
            "Shipping Charge" := "Override Shipping Charge"
          ELSE
            "Shipping Charge" := "Shipping Cost" + Markup + "Additional Shipping Charge";
          Closed := TRUE;
          MODIFY;
          COMMIT;

          IF "Multi Document Package" THEN BEGIN
            GetShippingSetup;
            GetPackingStation;
            MultiDocPackageMgt.SplitMultiDocPackage(
              CurrentPackage,MultiDocPackageTmp,PackingStation,ShippingSetup);
            COMMIT;
          END;

          EXIT;
        END;

        GetShippingSetup;
        GetPackingStation;
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        IF PrintLabel THEN
          CarrierPackingStation.TESTFIELD("FedEx Label Printer Port");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");
        GetShippingAgentService("Shipping Agent Code","Shipping Agent Service","World Wide Service");
        GetGlobalShipperInfo;
        FedExOptionPage.GET(FedExOptionPage.Type::Package,"No.",0,0);

        GetShippingAgent("Shipping Agent Code");
        CheckName(
          ShippingAgent,0,"Ship-to Name","Ship-to Name 2","Ship-to Contact",
          FIELDCAPTION("Ship-to Name"),FIELDCAPTION("Ship-to Name 2"),FIELDCAPTION("Ship-to Contact"));
        CheckAddress(
          ShippingAgent,0,"Ship-to Address","Ship-to Address 2","Ship-to City",
          "Ship-to ZIP Code","Ship-to State","Ship-to Country Code",
          FIELDCAPTION("Ship-to Address"),FIELDCAPTION("Ship-to Address 2"),
          FIELDCAPTION("Ship-to City"),FIELDCAPTION("Ship-to ZIP Code"),
          FIELDCAPTION("Ship-to State"),FIELDCAPTION("Ship-to Country Code"));

        TestWEBAPI(ShippingAgentAccount);

        TransactionID := GetTransactionID;
        "Closed by Packing Station Code" := PackingStation.Code;
        ClearTotalValueFields;
        VALIDATE("Calculation Weight",GetWeight);
        TESTFIELD("Calculation Weight");
        GetCalculationFields(1,'>');
        TESTFIELD("Calculation Value");

        CarrierPackingStation.TESTFIELD("FedEx Label Printer Type");
        CarrierPackingStation.TESTFIELD("FedEx Label Media Type");

      // Test for options no longer supported
        IF FedExOptionPage."Signature Required" THEN
          ERROR(Text043);
        IF FedExOptionPage."Acknowledgement of Delivery" THEN
          ERROR(Text044);

      // Test for Puerto Rico Shipment
        IF ("Ship-to State" = 'PR') OR (COPYSTR("Ship-to State",1,2) = 'PU') THEN
          "World Wide Service" := TRUE;

        IF NOT "World Wide Service" THEN BEGIN
          TESTFIELD("Ship-to State");
          TESTFIELD("Ship-to ZIP Code");
        END;
        IF ("Ship-to Name" = '') AND (CurrentPackage."Ship-to Contact" = '') THEN
          ERROR(Text018);
        TESTFIELD("Ship-to Address");
        TESTFIELD("Ship-to City");
        IF "Ship-to Phone No." = '' THEN
          "Ship-to Phone No." := FixPhoneNo(PackingStation."Phone No. to use If Blank");
        TESTFIELD("Ship-to Phone No.");
        TESTFIELD("Service Indicator");

        IF "World Wide Service" AND (FedExOptionPage."Export Declared Value" = 0) THEN
        CASE ShippingAgentAccount."Export Declare Value As" OF
          ShippingAgentAccount."Export Declare Value As"::Cost:
            BEGIN
              FedExOptionPage."Export Declared Value" := TotalValueCost;
              FedExOptionPage.MODIFY;
            END;
          ShippingAgentAccount."Export Declare Value As"::Price:
            BEGIN
              FedExOptionPage."Export Declared Value" := TotalValuePrice;
              FedExOptionPage.MODIFY;
            END;
        END;

      //  Multi package
        IF ("Total Packages" > 1) AND (NOT Miscellaneous) THEN
          IF "Package No." = 1 THEN
            "First Package No." := "No."
          ELSE BEGIN
            Package2.RESET;
            Package2.SETCURRENTKEY("Source Type","Source Subtype","Source ID");
            Package2.SETRANGE("Source Type","Source Type");
            Package2.SETRANGE("Source Subtype","Source Subtype");
            IF "Multi Document Package" THEN
              Package2.SETFILTER("Source ID","Multi Document No.")
            ELSE
              Package2.SETRANGE("Source ID","Source ID");
            Package2.SETFILTER("Package No.",'1');
            Package2.SETRANGE("Total Packages","Total Packages");
            IF Package2.FIND('-') THEN
              "First Package No." := Package2."No."
            ELSE BEGIN
              "Package No." := 1;
              "Total Packages" := 1;
              "First Package No." := '';
            END;
          END;
      //

        FedExShipment.INIT;
        FedExShipment."Transaction Type" := 21;
        FedExShipment."Transaction ID" := TransactionID;
        FedExShipment2.INIT;
        FedExShipment2."Transaction Type" := 21;
        FedExShipment2."Transaction ID" := TransactionID;

        IF "World Wide Service" THEN BEGIN
          FedExShipment."International Shipment" := TRUE;
          FedExIntlShipment.INIT;
          FedExIntlShipment."Transaction Type" := FedExShipment."Transaction Type";
          FedExIntlShipment."Transaction ID" := FedExShipment."Transaction ID";
          ShippingAgentAccount.TESTFIELD("IRS EIN No.");
          FedExIntlShipment."Shipper IRS/EIN No." := ShippingAgentAccount."IRS EIN No.";
        END;
        FedExShipment."Shipper Account No." := FedExGlobalRegistration."Shipper Account No.";
        FedExShipment."Meter Number" := FedExGlobalRegistration."Meter Number";
        FedExShipment."Shipper Company Name" := FedExGlobalRegistration."Shipper Company Name";
        FedExShipment."Shipper Contact" := FedExGlobalRegistration."Shipper Contact";
        FedExShipment."Shipper Address 1" := FedExGlobalRegistration."Shipper Address 1";
        IF FedExGlobalRegistration."Shipper Address 2" <> '' THEN
          FedExShipment."Shipper Address 2" := FedExGlobalRegistration."Shipper Address 2";
        FedExShipment."Shipper City" := FedExGlobalRegistration."Shipper City";
        FedExShipment."Shipper State" := FixState(FedExGlobalRegistration."Shipper State");
        FedExShipment."Shipper Zip Code" := FixZIPCode(FedExGlobalRegistration."Shipper ZIP Code");
        FedExShipment."Shipper Country Code" := FedExGlobalRegistration."Shipper Country Code";
        FedExShipment."Shipper Phone Number" :=
          FixPhoneNo(FedExGlobalRegistration."Shipper Phone Number");

        IF (ShippingAgentService."Service Indicator" = '90') OR
           (ShippingAgentService."Service Indicator" = '92')
        THEN
          FedExShipment.Carrier := FedExShipment.Carrier::"FedEx Ground"
        ELSE
          FedExShipment.Carrier := FedExShipment.Carrier::"FedEx Express";
      // Destination
        IF ("Ship-to Name" = '') AND ("Ship-to Contact" = '') THEN
          ERROR(Text019);
        FedExShipment."Destination Company Name" := "Ship-to Name";
        FedExShipment."Destination Contact Name" := "Ship-to Contact";
        FedExShipment."Destination Address 1" := "Ship-to Address";
        FedExShipment."Destination Address 2" := "Ship-to Address 2";
        FedExShipment."Destination City" := "Ship-to City";
        FedExShipment."Destination State" := FixState("Ship-to State");
        FedExShipment."Destination Zip Code" := FixZIPCode("Ship-to ZIP Code");
        FedExShipment."Destination Phone Number" := FixPhoneNo("Ship-to Phone No.");
        FedExShipment."Destination Country Code" := GetFedExCountryCode("Ship-to Country Code");

      // Shipment Date/Time Stamp
        IF "Packing Date" = 0D THEN
          "Packing Date" := WORKDATE;
        FedExShipment."Shipment Date - Integer" := Date2Integer("Packing Date");
        EVALUATE(FedExShipment."Ship Time - Integer",Time2Text(TIME));
        IF "Packing Date" > TODAY THEN BEGIN
          IF ("Packing Date" - TODAY) >= 10 THEN
            ERROR(Text020);
          FedExShipment."Future Day Ship" := TRUE;
        END;

      // Payment
        CASE "Shipping Payment Type" OF
          "Shipping Payment Type"::Prepaid:
            FedExShipment."Payment Code" := '1';
          "Shipping Payment Type"::"Third Party":
            BEGIN
              TESTFIELD("Third Party Ship. Account No.");
              FedExShipment."Payor Account Number" := "Third Party Ship. Account No.";
              FedExShipment."Payment Code" := '3';
            END;
          "Shipping Payment Type"::"Freight Collect":
            BEGIN
              TESTFIELD("Third Party Ship. Account No.");
              FedExShipment."Payor Account Number" := "Third Party Ship. Account No.";
              IF FedExShipment.Carrier = FedExShipment.Carrier::"FedEx Express" THEN
                FedExShipment."Payment Code" := '2'
              ELSE
                FedExShipment."Payment Code" := '5';
            END;
          "Shipping Payment Type"::Consignee:
            BEGIN
              IF FedExShipment.Carrier = FedExShipment.Carrier::"FedEx Express" THEN
                ERROR(Text021);
              FedExShipment."Payment Code" := '2';
            END;
          "Shipping Payment Type"::"4":
            BEGIN
              FedExOptionPage.TESTFIELD("Payer Credit Card No.");
              FedExOptionPage.TESTFIELD("Payer Credit Card Type");
              FedExOptionPage.TESTFIELD("Payer Credit Card Exp. Date");
              FedExShipment2."Payer Credit Card Number" := FedExOptionPage."Payer Credit Card No.";
              CASE FedExOptionPage."Payer Credit Card Type" OF
                FedExOptionPage."Payer Credit Card Type"::"Master Card":
                  FedExShipment2."Payer Credit Card Type" := 'M';
                FedExOptionPage."Payer Credit Card Type"::Visa:
                  FedExShipment2."Payer Credit Card Type" := 'V';
                FedExOptionPage."Payer Credit Card Type"::"American Express":
                  FedExShipment2."Payer Credit Card Type" := 'A';
              END;
              FedExShipment2."Payer Cr. Card Exp. Date" := FedExOptionPage."Payer Credit Card Exp. Date";
            END;
        END;
        IF "World Wide Service" THEN BEGIN
          FedExIntlShipment."Declared Value Currency Type" := 'USD';  // Required to be USD by FedEX
          FedExIntlShipment."Destination IRS/EIN Number" := FedExOptionPage."IRS EIN Number";
          IF NOT FedExOptionPage."Non-dutiable Document" THEN BEGIN
            {CASE FedExOptionPage."Duties Payer" OF
              FedExOptionPage."Duties Payer"::Shipper:
                FedExIntlShipment."Duties Pay Type" := '1';
              FedExOptionPage."Duties Payer"::Recipient:
                FedExIntlShipment."Duties Pay Type" := '2';
              FedExOptionPage."Duties Payer"::"Third Party":
                BEGIN
                  FedExIntlShipment."Duties Pay Type" := '3';
                  IF (FedExOptionPage."Duties Payer Account No." = '') AND
                     ("Third Party Ship. Account No." = '')
                  THEN
                    ERROR(Text022)
                  ELSE
                    IF FedExOptionPage."Duties Payer Account No." ='' THEN
                      FedExIntlShipment."Duties Payer Account No." := "Third Party Ship. Account No."
                    ELSE
                        FedExIntlShipment."Duties Payer Account No." :=
                          FedExOptionPage."Duties Payer Account No.";
                END;
              ELSE
                CASE "Shipping Payment Type" OF
                  "Shipping Payment Type"::Prepaid:
                    FedExIntlShipment."Duties Pay Type" := '1';
                  "Shipping Payment Type"::"Freight Collect",
                  "Shipping Payment Type"::Consignee:
                    FedExIntlShipment."Duties Pay Type" := '2';
                  "Shipping Payment Type"::"Third Party":
                    BEGIN
                      FedExIntlShipment."Duties Pay Type" := '3';
                      FedExIntlShipment."Duties Payer Account No." := "Third Party Ship. Account No.";
                    END;
                  ELSE
                    ERROR(Text023);
                END;
            END;}
          END;
        END;

      // Multiple Piece Shipping for International Master labels
        IF ((FedExShipment."Destination Country Code" <> '') AND (FedExShipment."Destination Country Code" <> 'US')) OR
          ("Service Indicator" = '92')
        THEN BEGIN
          FedExShipment."Package Sequence" := "Package No." ;
          FedExShipment."Package Count" := "Total Packages";
        END ELSE BEGIN
          FedExShipment."Package Count" := 1;
          FedExShipment."Package Sequence" := 1;
        END;
      // Implemented for International Master labels
        IF FedExShipment."Package Sequence" > 1 THEN BEGIN
          FirstPackageTransaction.INIT;
          GetFirstPackageTransaction(CurrentPackage,MasterTrackingNumber,MasterFormID);
          FedExShipment2."Shipment Master Tracking No." := MasterTrackingNumber;
          FedExShipment2."Master Form ID" := MasterFormID;
        END;
        IF (FedExShipment."Package Count" > 1) AND
           (FedExShipment."Package Sequence" = 1) AND
           (FedExShipment.Carrier = FedExShipment.Carrier::"FedEx Express") AND
           "World Wide Service"
        THEN BEGIN
          FedExIntlShipment."Total Shipment Weight" := FedExOptionPage."Total Shipment Weight";
          FedExShipment."Dry Ice Weight" := FedExOptionPage."Dry Ice Weight";
        END;

      // Shipment/Package Information
        FedExShipment."Reference Notes" := "Ship-to No.";//to print Customer No. on Doc Tab
        FedExShipment."Ground Customer Reference No." := COPYSTR(Description,1,30);
        FedExShipment."Ground Purchase Order No." := "External Document No.";
        IF ShippingSetup."Default Weight Units" =
           ShippingSetup."Default Weight Units"::LBS
        THEN
          FedExShipment."Weight Units" := 'LBS'
        ELSE
          FedExShipment."Weight Units" := 'KGS';

        FedExShipment."Service Code" := "Service Indicator";
        FedExShipment."Package Weight" := ROUND("Calculation Weight",0.1);
        FedExShipment."Declared Value" := ROUND("Calculation Insured Value",0.01);
        FedExShipment."Package Length" := "Calculation Length";
        FedExShipment."Package Width" := "Calculation Width";
        FedExShipment."Package Height" := "Calculation Height";

      // Special Service - COD
        IF COD THEN BEGIN
          CompanyInfo.GET;
          CompanyInfo.TESTFIELD("COD Phone No.");
          CompanyInfo.TESTFIELD("COD Address 1");
          CompanyInfo.TESTFIELD("COD City");
          CompanyInfo.TESTFIELD("COD State");
          CompanyInfo.TESTFIELD("COD Zip Code");
          FedExShipment."COD Return Phone" := COPYSTR(FixPhoneNo(CompanyInfo."COD Phone No."),1,15);
          FedExShipment."COD Return Company" := COPYSTR(CompanyInfo.Name,1,35);
          FedExShipment."COD Return Department" := COPYSTR(CompanyInfo."COD Department",1,10);
          FedExShipment."COD Return Address 1" := CompanyInfo."COD Address 1";
          FedExShipment."COD Return Address 2" := CompanyInfo."COD Address 2";
          FedExShipment."COD Return City" := CompanyInfo."COD City";
          FedExShipment."COD Return State" := COPYSTR(FixState(CompanyInfo."COD State"),1,14);
          FedExShipment."COD Return Postal Code" := COPYSTR(FixZIPCode(CompanyInfo."COD Zip Code"),1,9);
          FedExShipment."COD Flag" := TRUE;
          TESTFIELD("COD Amount");
          IF (FedExShipment."Package Sequence" > 1) AND
             (FedExShipment."Package Sequence" = FedExShipment."Package Count")
          THEN BEGIN
            FirstPackageTransaction.INIT;
            GetFirstPackageTransaction(CurrentPackage,MasterTrackingNumber,MasterFormID);
            FedExShipment."COD Return Tracking No." := MasterTrackingNumber;
          END;
          IF "Add Shipping Charge to COD Amt" THEN BEGIN
            CODMarkup := 0;
            CASE ShippingAgentService."Markup Type" OF
              ShippingAgentService."Markup Type"::Amount:
                BEGIN
                  "COD Amount" :=
                    "COD Amount" + ShippingAgentService."Additional Markup" +
                    "Additional Shipping Charge";
                  CODMarkup := ShippingAgentService."Additional Markup";
                END;
              ShippingAgentService."Markup Type"::Percent:
                BEGIN
                  GetShippingCharge(CurrentPackage,FALSE);
                  "COD Amount" := "COD Amount" + Markup + "Additional Shipping Charge";
                  CODMarkup := Markup;
                END;
              ELSE
                "COD Amount" := "COD Amount" + "Additional Shipping Charge";
            END;
          END;
          FedExShipment."COD Amount" := "COD Amount";
          IF "COD Cashiers Check" THEN
            FedExShipment."COD Collection Type" := '2'
          ELSE
            FedExShipment."COD Collection Type" := '1';
          FedExShipment."Add Freight Charges" := "Add Shipping Charge to COD Amt";
        END;

      // Transfer to Option Page
        IF NOT FedExShipment2.INSERT THEN
          FedExShipment2.MODIFY;
        TransferFromOptionPage(
          FedExShipment,FedExIntlShipment,FedExOptionPage,FALSE,TRUE,"Residential Delivery");
        //FedExShipment."Label Type" := '1'; // Standard Label
        FedExShipment."Label Type" := '2'; // 2D Common
        CASE CarrierPackingStation."FedEx Label Printer Type" OF
          CarrierPackingStation."FedEx Label Printer Type"::"1":
            BEGIN
              FedExShipment."Label Printer Type" := '1';
              TextLabel := FALSE;
            END;
          CarrierPackingStation."FedEx Label Printer Type"::"Eltron (EPL)":
            BEGIN
              FedExShipment."Label Printer Type" := '2';
              TextLabel := TRUE;
            END;
          CarrierPackingStation."FedEx Label Printer Type"::"3":
            BEGIN
              FedExShipment."Label Printer Type" := '3';
              TextLabel := TRUE;
            END;
          CarrierPackingStation."FedEx Label Printer Type"::"Zebra (ZPL)":
            BEGIN
              FedExShipment."Label Printer Type" := '4';
              TextLabel := TRUE;
            END;
        END;
        IF TextLabel THEN BEGIN
          CASE CarrierPackingStation."FedEx Label Media Type" OF
            CarrierPackingStation."FedEx Label Media Type"::"4X6 with Trailing Doc Tab":
              FedExShipment."Label Media Type" := '3';
            CarrierPackingStation."FedEx Label Media Type"::"4X6 W/O Doc Tab":
              FedExShipment."Label Media Type" := '4';
          END;
        END ELSE
          FedExShipment."Label Media Type" := '5';

        IF "World Wide Service" THEN BEGIN
          SetCommodityFields(FedExIntlShipment,CurrentPackage);
          SetExportDocumentation(FedExIntlShipment,FedExOptionPage,CurrentPackage);
        END;
        FedExShipment."Shipping Agent Code" := "Shipping Agent Code";
        FedExShipment."Source ID" := "Source ID";
        FedExShipment."Package No." := "No.";

        FedExShipment.INSERT;
        IF "World Wide Service" THEN
          FedExIntlShipment.INSERT;

        ErrorMessage := ShipPackage(FedExShipment,CurrentPackage,ShippingAgentAccount."Show Soft Errors");
        FedExShipment.GET(121,TransactionID);
        FedExShipment2.GET(21,TransactionID);
        IF ErrorMessage <> '' THEN
          ERROR(ErrorMessage);
        "External Tracking No." := FedExShipment."Master Tracking No.";
        "Dimensional Weight" := FedExShipment."Dim Weight";
        IF NOT CurrentShippingAgent."Disable Rate Calculation" THEN BEGIN
          IF ShippingAgentAccount."Rate Option" = ShippingAgentAccount."Rate Option"::Default THEN BEGIN
            "Shipping Cost" := FedExShipment."Net Charge";
            "Base Charge" := FedExShipment."Base Charge";
            Surcharge := FedExShipment."Total Surcharge";
            "Rebate Amount" := FedExShipment."Total Rebate Amount";
            "Discount Amount" := FedExShipment."Total Discount";
          END ELSE
            IF (ShippingAgentAccount."Rate Option" = ShippingAgentAccount."Rate Option"::List) AND
              (NOT "World Wide Service")
            THEN BEGIN
              "Shipping Cost" := FedExShipment2."List Net Charge";
              "Base Charge" := FedExShipment2."List Base Rate";
              Surcharge := FedExShipment2."List Total Surcharge";
              "Rebate Amount" := FedExShipment2."List Total Rebate Amount";
              "Discount Amount" := FedExShipment2."Effective Net Discount";
            END ELSE BEGIN
              "Shipping Cost" := FedExShipment."Net Charge";
              "Base Charge" := FedExShipment."Base Charge";
              Surcharge := FedExShipment."Total Surcharge";
              "Rebate Amount" := FedExShipment."Total Rebate Amount";
              "Discount Amount" := FedExShipment."Total Discount";
            END;
        END;
        IF (FedExShipment."Package Count" > 1) AND(FedExShipment."Package Sequence" = 1)
        THEN BEGIN
          FedExOptionPage."Master Tracking No." := FedExShipment."Master Tracking No.";
          FedExOptionPage."Tracking Form ID" := FedExShipment."Tracking Form ID";
          FedExOptionPage.MODIFY;
        END;

        IF NOT Closed THEN BEGIN
          Markup :=
            Shipping.GetMarkup(
              ShippingAgentService,"Shipping Cost","Ship-to Type","Ship-to No.","Ship-to Code");
          IF COD AND "Add Shipping Charge to COD Amt" THEN
            Markup := CODMarkup;
          IF "Override Shipping Charge" <> 0 THEN
            "Shipping Charge" := "Override Shipping Charge"
          ELSE
            "Shipping Charge" := "Shipping Cost" + Markup + "Additional Shipping Charge";
        END;
        TestAndTransferToThirdParty(CurrentPackage,FedExOptionPage,ShippingAgentService);

        IF COD THEN
          "COD Amount" := FedExShipment."COD Amount";
        "Expected Delivery Date" := 0D;
        "FedEx Transaction ID" := TransactionID;
        "Packing Date" := WORKDATE;
        "Packing Time" := TIME;
        "Packed By" := USERID;
        Closed := TRUE;
        MODIFY;
        COMMIT;

        IF "Multi Document Package" THEN BEGIN
          GetShippingSetup;
          GetPackingStation;
          MultiDocPackageMgt.SplitMultiDocPackage(
            CurrentPackage,MultiDocPackageTmp,PackingStation,ShippingSetup);
          COMMIT;
        END;
        CarrierPackingStation.TESTFIELD("FedEx Buffer Directory");
        IF TextLabel THEN BEGIN
          CarrierPackingStation.TESTFIELD("FedEx Label Printer Port");
      //    FedExShipment."Gif Label File Name" :=
      //      FDXAPIClient.SaveCurrThermalLabel(CarrierPackingStation."FedEx Buffer Directory");
          IF COPYSTR(
               CarrierPackingStation."FedEx Buffer Directory",
               STRLEN(CarrierPackingStation."FedEx Buffer Directory"),1) =
               '\'
          THEN
            FedExShipment."Gif Label File Name" :=
              CarrierPackingStation."FedEx Buffer Directory" + FedExShipment."Gif Label File Name"
          ELSE
            FedExShipment."Gif Label File Name" :=
              CarrierPackingStation."FedEx Buffer Directory" + '\' +
              FedExShipment."Gif Label File Name";
          ReformatTextLabel(CurrentPackage,FedExShipment."Gif Label File Name",FALSE);

          InsertLabelFile(
            CarrierPackingStation."FedEx Label Buffer File",Text024,12,
            CarrierPackingStation."FedEx Label Printer Port",PackingStation.Code,
            NOT PackingStation."No Label Printer",PackingStation."Do Not Import Label File");
          IF PrintLabel THEN BEGIN
            PackingStation.PrintLabelFile(
              CarrierPackingStation."FedEx Label Buffer File",
              CarrierPackingStation."FedEx Label Printer Port",
              PackingStation."No Label Printer",PackingStation."Auto Delete Label Buffer File");
            IF COD THEN BEGIN
              LabelFileName := FedExShipment."Gif Label File Name";
              TextPos := STRPOS(LabelFileName,FedExShipment."Master Tracking No.");
              LabelFileName :=
                COPYSTR(LabelFileName,1,TextPos - 1) + 'CR' +
                COPYSTR(LabelFileName,TextPos,STRLEN(LabelFileName));
              IF EXISTS(LabelFileName) THEN BEGIN
                ReformatTextLabel(CurrentPackage,LabelFileName,TRUE);
                InsertLabelFile(
                  CarrierPackingStation."FedEx Label Buffer File",Text025,12,
                  CarrierPackingStation."FedEx Label Printer Port",PackingStation.Code,
                  NOT PackingStation."No Label Printer",PackingStation."Do Not Import Label File");
                PackingStation.PrintLabelFile(
                  CarrierPackingStation."FedEx Label Buffer File",
                  CarrierPackingStation."FedEx Label Printer Port",
                  PackingStation."No Label Printer",PackingStation."Auto Delete Label Buffer File");
              END;
            END;
          END;
        END ELSE BEGIN
      //    FedExShipment."Gif Label File Name" :=
      //      FDXAPIClient.SaveCurrLabelToFile(
      //      Text026,CarrierPackingStation."FedEx Buffer Directory");
          IF COPYSTR(
               CarrierPackingStation."FedEx Buffer Directory",
               STRLEN(CarrierPackingStation."FedEx Buffer Directory"),1) =
               '\'
          THEN
            FedExShipment."Gif Label File Name" :=
              CarrierPackingStation."FedEx Buffer Directory" + FedExShipment."Gif Label File Name"
          ELSE
            FedExShipment."Gif Label File Name" :=
              CarrierPackingStation."FedEx Buffer Directory" + '\' +
              FedExShipment."Gif Label File Name";
      //    FDXAPIClient.DisplayCurrLabelinBrowser(
      //      CarrierPackingStation."FedEx Label Template Directory",
      //      CarrierPackingStation."FedEx Buffer Directory");
        END;
        FedExShipment.MODIFY;
      END;
    END;

    PROCEDURE OpenPackage@16(VAR CurrentPackage@1240030000 : Record 14000701);
    VAR
      FedExShipment@1240030001 : Record 14000783;
      FedExDeletePackage@1240030003 : Record 14000787;
      TransactionID@1240030004 : Code[40];
    BEGIN
      WITH CurrentPackage DO BEGIN
        TESTFIELD(Closed);
        TESTFIELD("Manifest No.",'');

        IF "Manual Shipment" THEN BEGIN
          Closed := FALSE;
          MODIFY;
          COMMIT;

          EXIT;
        END;

        GetPackingStation;
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");

        TestWEBAPI(ShippingAgentAccount);

        TransactionID := GetTransactionID;
        GetPackingStation;
        FedExDeletePackage.INIT;
        FedExShipment.GET(121,"FedEx Transaction ID");
        FedExDeletePackage.TRANSFERFIELDS(FedExShipment);
        FedExDeletePackage."Transaction Type" := 23;
        FedExDeletePackage."Transaction ID" := TransactionID;
        FedExDeletePackage.INSERT;
        DeleteRequest(FedExDeletePackage);

        GET("No.");

        IF COD AND "Add Shipping Charge to COD Amt" THEN
          "COD Amount" := "COD Amount" - "Shipping Charge";
        "External Tracking No." := '';
        "FedEx Transaction ID" := '';
        Closed := FALSE;
        MODIFY;
        COMMIT;
      END;
    END;

    PROCEDURE ReOpenPostedPackage@50(VAR CurrentPostedPackage@1240030000 : Record 14000704);
    VAR
      FedExShipment@1240030001 : Record 14000783;
      FedExDeletePackage@1240030003 : Record 14000787;
      TransactionID@1240030004 : Code[40];
    BEGIN
      WITH CurrentPostedPackage DO BEGIN
        TESTFIELD(Closed);
        TESTFIELD("Manifest No.",'');

        IF "Manual Shipment" THEN BEGIN
          Closed := FALSE;
          MODIFY;
          COMMIT;

          EXIT;
        END;

        GetPackingStation;
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");
        TestWEBAPI(ShippingAgentAccount);

        TransactionID := GetTransactionID;
        GetPackingStation;
        FedExDeletePackage.INIT;
        FedExShipment.GET(121,"FedEx Transaction ID");
        FedExDeletePackage.TRANSFERFIELDS(FedExShipment);
        FedExDeletePackage."Transaction Type" := 23;
        FedExDeletePackage."Transaction ID" := TransactionID;
        FedExDeletePackage.INSERT;
        DeleteRequest(FedExDeletePackage);

        GET("No.");

        IF COD AND "Add Shipping Charge to COD Amt" THEN
          "COD Amount" := "COD Amount" - "Shipping Charge";
        "External Tracking No." := '';
        "FedEx Transaction ID" := '';
        Closed := FALSE;
        MODIFY;
        COMMIT;
      END;
    END;

    PROCEDURE PrintPackageLabel@20(VAR CurrentPackage@1240030000 : Record 14000701);
    VAR
      FedExOptionPage@1240030001 : Record 14000781;
      FedExShipment@1240030002 : Record 14000783;
      TextPos@1240030003 : Integer;
      FileName@1240030006 : Text[250];
    BEGIN
      WITH CurrentPackage DO BEGIN
        IF "Manual Shipment" THEN
          EXIT;

        TESTFIELD(Closed);

        GetPackingStation;
        GetShippingAgentService("Shipping Agent Code","Shipping Agent Service","World Wide Service");
        FedExOptionPage.GET(FedExOptionPage.Type::Package,"No.",0,0);
        FedExShipment.GET(121,"FedEx Transaction ID");
      {  CLEAR(FDXAPIClient);
        CREATE(FDXAPIClient);

        IF FedExShipment."Buffer File Name" <> '' THEN BEGIN
          FDXAPIClient.LoadBuffer(FedExShipment."Buffer File Name");
          IF CarrierPackingStation."FedEx Label Printer Type" =
             CarrierPackingStation."FedEx Label Printer Type"::"1"
          THEN BEGIN
            Window.OPEN(Text001);
            FDXAPIClient.DisplayCurrLabelinBrowser(
              CarrierPackingStation."FedEx Label Template Directory"
              ,CarrierPackingStation."FedEx Buffer Directory");
            Window.CLOSE;
          END ELSE BEGIN
            CarrierPackingStation.TESTFIELD("FedEx Label Printer Port");
            ReformatTextLabel(CurrentPackage,FedExShipment."Gif Label File Name",FALSE);

            InsertLabelFile(
              CarrierPackingStation."FedEx Label Buffer File",Text024,12,
              CarrierPackingStation."FedEx Label Printer Port",PackingStation.Code,
              NOT PackingStation."No Label Printer",PackingStation."Do Not Import Label File");
            PackingStation.PrintLabelFile(
              CarrierPackingStation."FedEx Label Buffer File",
              CarrierPackingStation."FedEx Label Printer Port",
              PackingStation."No Label Printer",PackingStation."Auto Delete Label Buffer File");
            IF COD THEN BEGIN
              FileName := FedExShipment."Gif Label File Name";
              TextPos := STRPOS(FileName,FedExShipment."Master Tracking No.");
              FileName :=
                COPYSTR(FileName,1,TextPos - 1) + 'CR' + COPYSTR(FileName,TextPos,STRLEN(FileName));
              IF EXISTS(FileName) THEN BEGIN
                ReformatTextLabel(CurrentPackage,FileName,TRUE);
                InsertLabelFile(
                  CarrierPackingStation."FedEx Label Buffer File",Text025,12,
                  CarrierPackingStation."FedEx Label Printer Port",PackingStation.Code,
                  NOT PackingStation."No Label Printer",PackingStation."Do Not Import Label File");
                PackingStation.PrintLabelFile(
                  CarrierPackingStation."FedEx Label Buffer File",
                  CarrierPackingStation."FedEx Label Printer Port",
                  PackingStation."No Label Printer",PackingStation."Auto Delete Label Buffer File");
              END;
            END;
          END;
        END ELSE
          ERROR(Text027);}
      END;
    END;

    PROCEDURE RePrintPostedPackageLabel@21(VAR CurrentPostedPackage@1240030000 : Record 14000704);
    VAR
      FedExShipment@1240030001 : Record 14000783;
      FedExPostedOptionPage@1240030002 : Record 14000782;
      CurrentPackage@1240030003 : Record 14000701;
      TextPos@1240030004 : Integer;
      FileName@1240030008 : Text[250];
    BEGIN
      WITH CurrentPostedPackage DO BEGIN
        IF "Manual Shipment" THEN
          EXIT;

        GetPackingStation;
        GetShippingAgentService("Shipping Agent Code","Shipping Agent Service","World Wide Service");
        FedExPostedOptionPage.GET(CurrentPostedPackage."No.");
        FedExShipment.GET(121,"FedEx Transaction ID");
        CurrentPackage.TRANSFERFIELDS(CurrentPostedPackage);
      {  CLEAR(FDXAPIClient);
        CREATE(FDXAPIClient);
        IF FedExShipment."Buffer File Name" <> '' THEN BEGIN
          FDXAPIClient.LoadBuffer(FedExShipment."Buffer File Name");
          IF CarrierPackingStation."FedEx Label Printer Type" =
             CarrierPackingStation."FedEx Label Printer Type"::"1"
          THEN BEGIN
            Window.OPEN(Text001);
            FDXAPIClient.DisplayCurrLabelinBrowser(
              CarrierPackingStation."FedEx Label Template Directory",
              CarrierPackingStation."FedEx Buffer Directory");
            Window.CLOSE;
          END ELSE BEGIN
            CarrierPackingStation.TESTFIELD("FedEx Label Printer Port");
            ReformatTextLabel(CurrentPackage,FedExShipment."Gif Label File Name",FALSE);

            InsertLabelFile(
              CarrierPackingStation."FedEx Label Buffer File",Text024,12,
              CarrierPackingStation."FedEx Label Printer Port",PackingStation.Code,
              NOT PackingStation."No Label Printer",PackingStation."Do Not Import Label File");
            PackingStation.PrintLabelFile(
              CarrierPackingStation."FedEx Label Buffer File",
              CarrierPackingStation."FedEx Label Printer Port",
              PackingStation."No Label Printer",PackingStation."Auto Delete Label Buffer File");
            IF COD THEN BEGIN
              FileName := FedExShipment."Gif Label File Name";
              TextPos := STRPOS(FileName,FedExShipment."Master Tracking No.");
              FileName :=
                COPYSTR(FileName,1,TextPos - 1) + 'CR' + COPYSTR(FileName,TextPos,STRLEN(FileName));
              IF EXISTS(FileName) THEN BEGIN
                ReformatTextLabel(CurrentPackage,FileName,TRUE);
                InsertLabelFile(
                  CarrierPackingStation."FedEx Label Buffer File",Text025,12,
                  CarrierPackingStation."FedEx Label Printer Port",PackingStation.Code,
                  NOT PackingStation."No Label Printer",PackingStation."Do Not Import Label File");
                PackingStation.PrintLabelFile(
                  CarrierPackingStation."FedEx Label Buffer File",
                  CarrierPackingStation."FedEx Label Printer Port",
                  PackingStation."No Label Printer",PackingStation."Auto Delete Label Buffer File");
              END;
            END;

          END;
        END ELSE
          ERROR(Text027);}
      END;
    END;

    LOCAL PROCEDURE PrintInternationalShipTerms@26();
    BEGIN
      //FedEx.PrintTerms;
    END;

    LOCAL PROCEDURE GetGlobalShipperInfo@30();
    BEGIN
      GetPackingStation;
      IF CarrierPackingStation."FedEx Global Registration No." <> '' THEN
        FedExGlobalRegistration.GET(211,CarrierPackingStation."FedEx Global Registration No.")
      ELSE
        ERROR(Text028);
    END;

    PROCEDURE CreateManifest@49(CurrentShippingAgentAccount@1240030000 : Record 14000788);
    VAR
      ManifestHeader@1240030001 : Record 14000712;
    BEGIN
      WITH CurrentShippingAgentAccount DO BEGIN
        ShippingAgent.RESET;
        ShippingAgent.SETRANGE("Shipper Type",ShippingAgent."Shipper Type"::FEDEX);
        ShippingAgent.FIND('-');

        CLEAR(ManifestHeader);
        ManifestHeader.INSERT(TRUE);
        ManifestHeader."Shipping Agent Code" := ShippingAgent.Code;
        ManifestHeader."Shipping Agent Account" := "Account No.";
        ManifestHeader.MODIFY(TRUE);

        ManifestHeader.GetSuggestedLines;

        COMMIT;

      //  FORM.RUNMODAL(FORM::Manifest,ManifestHeader);
      END;
    END;

    PROCEDURE CloseManifest@47(VAR CurrentManifestHeader@1240030000 : Record 14000712);
    VAR
      ManifestLine@1240030001 : Record 14000713;
      FedExShippingAgentAccountTmp@1240030002 : TEMPORARY Record 14000788;
      AccountsManifested@1240030003 : Integer;
    BEGIN
      WITH CurrentManifestHeader DO BEGIN
        TESTFIELD(Posted);
        TESTFIELD("FedEx Processing Required");

        FedExShippingAgentAccountTmp.DELETEALL;

        ManifestLine.RESET;
        ManifestLine.SETRANGE("Manifest No.","No.");
        ManifestLine.SETRANGE(Type,ManifestLine.Type::Summary);
        IF ManifestLine.FIND('-') THEN
          REPEAT
            IF NOT FedExShippingAgentAccountTmp.GET(ManifestLine."Shipping Agent Account No.") THEN
              IF ShippingAgentAccount.GET(ManifestLine."Shipping Agent Account No.") THEN BEGIN
                FedExShippingAgentAccountTmp := ShippingAgentAccount;
                FedExShippingAgentAccountTmp.INSERT;

                TestWEBAPI(ShippingAgentAccount);
              END;
          UNTIL ManifestLine.NEXT = 0;

        AccountsManifested := 0;
        IF FedExShippingAgentAccountTmp.FIND('-') THEN BEGIN
          ManifestLine.RESET;
          ManifestLine.SETRANGE("Manifest No.","No.");
          IF NOT ManifestLine.FIND('+') THEN
            ManifestLine."Manifest No." := "No.";

          REPEAT
            AccountsManifested := AccountsManifested + 1;

            ManifestLine.INIT;
            ManifestLine."Line No." := ManifestLine."Line No." + 10000;
            ManifestLine.Type := ManifestLine.Type::"FedEx Summary";
            ManifestLine.Description :=
              STRSUBSTNO(Text029,FedExShippingAgentAccountTmp."Account No.");

            ManifestLine.SummarizeAccount(FedExShippingAgentAccountTmp."Account No.");

            ManifestLine."Shipping Agent Account No." := FedExShippingAgentAccountTmp."Account No.";
            ManifestLine."FedEx Manifest File No." :=
              CreateOnlineManifest(CurrentManifestHeader,FedExShippingAgentAccountTmp,FALSE);
            ManifestLine.INSERT;
          UNTIL FedExShippingAgentAccountTmp.NEXT = 0;
        END;

        IF AccountsManifested <> 0 THEN
          MESSAGE(Text030,AccountsManifested);

        LOCKTABLE;
        FIND;
        "FedEx Processing Required" := FALSE;
        MODIFY;
        COMMIT;
      END;
    END;

    PROCEDURE OpenManifest@48(VAR CurrentManifestHeader@1240030000 : Record 14000712);
    BEGIN
      WITH CurrentManifestHeader DO BEGIN
        TESTFIELD(Posted,FALSE);
        TESTFIELD("FedEx Processing Required");

        LOCKTABLE;
        FIND;
        "FedEx Processing Required" := FALSE;
        MODIFY;
        COMMIT;
      END;
    END;

    LOCAL PROCEDURE CreateOnlineManifest@10(CurrentManifestHeader@1240030000 : Record 14000712;CurrentShippingAgentAccount@1240030001 : Record 14000788;ManifestOnly@1240030002 : Boolean) : Integer;
    VAR
      FedExManifest@1240030003 : Record 14000784;
      TransactionID@1240030004 : Code[40];
      BufferPath@1240030005 : Text[250];
      UniversalTransactionID@1240030006 : Integer;
    BEGIN
      WITH CurrentShippingAgentAccount DO BEGIN

        TestWEBAPI(CurrentShippingAgentAccount);

        TransactionID := GetTransactionID;
        GetGlobalShipperInfo;
        IF FedExGlobalRegistration."Shipper Account No." <> "Account No." THEN BEGIN
          FedExGlobalRegistration.RESET;
          FedExGlobalRegistration.SETRANGE("Shipper Account No.","Account No.");
          CASE "Test Status" OF
            "Test Status"::Live:
              FedExGlobalRegistration.SETRANGE("Live Registration",TRUE);
            "Test Status"::Beta:
              FedExGlobalRegistration.SETRANGE("Live Registration",FALSE);
          END;
          FedExGlobalRegistration.SETFILTER("Meter Number" ,'<>%1','');
          IF NOT FedExGlobalRegistration.FIND('+') THEN BEGIN
            CASE "Test Status" OF
              "Test Status"::Live:
                ERROR(Text031,"Account No.");
              "Test Status"::Beta:
                ERROR(Text031,"Account No.");
              ELSE
                ERROR(Text032,"Account No.");
            END;
          END;
        END;
      {  CLEAR(FDXAPIClient);
        CREATE(FDXAPIClient);
        FDXAPIClient.ApiClear;
        UniversalTransactionID := 1002;
        FDXAPIClient.SetTransactionType('007');
        FDXAPIClient.SetField('1',TransactionID);
        FDXAPIClient.SetField('10',"Account No.");
        FDXAPIClient.SetField('498',FedExGlobalRegistration."Meter Number");
        FDXAPIClient.SetField('3025','FDXG');
        FDXAPIClient.SetField('1007',Integer2Text(Date2Integer(WORKDATE)));
        FDXAPIClient.SetField('1366',Time2Text(TIME));
        IF ManifestOnly THEN
          FDXAPIClient.SetField('1371','Y');

        Window.OPEN(Text001);
        FDXAPIClient.ApiBuild;
        FDXAPIClient.FEDEXAPITransaction(
          UniversalTransactionID,CarrierPackingStation."Proxy Address",
          Text2Integer(CarrierPackingStation."Proxy Port"));
        FDXAPIClient.SaveBuffer(BufferFileName);
        FDXAPIClient.ApiParse;
        Window.CLOSE;

        FedExManifest.INIT;
        FedExManifest."Manifest No." := CurrentManifestHeader."No.";
        FedExManifest."Transaction Type" := 107;
        FedExManifest."Transaction ID" := TransactionID;
        FedExManifest."Shipper Account" := "Account No.";
        FedExManifest."Meter Number" := FedExGlobalRegistration."Meter Number";
        FedExManifest.Carrier := FedExManifest.Carrier::"FedEx Ground";
        FedExManifest."Manifest Date - Integer" := Date2Integer(WORKDATE);
        EVALUATE(FedExManifest."Manifest Time - Integer",Time2Text(TIME));
        FedExManifest."Manifest Only" := ManifestOnly;
        FedExManifest."Error Code" := FDXAPIClient.GetField('2');
        FedExManifest."Error Message" := FDXAPIClient.GetField('3');
        IF (FedExManifest."Error Code" = '0') OR (FedExManifest."Error Code" = '') THEN BEGIN
          EVALUATE(FedExManifest."Manifest Total",FDXAPIClient.GetField('1372'));
          FedExManifest."First Manifest Series Name" :=
            FDXAPIClient.GetFieldInstance('1005',0) + '.txt';
        END;
        FedExManifest.INSERT;
        BufferPath := CarrierPackingStation."FedEx Buffer Directory";
        IF BufferPath[STRLEN(BufferPath)] <> '\' THEN
          BufferPath := BufferPath + '\';
        IF (FedExManifest."Error Code" = '0') OR (FedExManifest."Error Code" = '') THEN
          FDXAPIClient.SaveManifest(BufferPath);

        CASE FedExManifest."Error Code" OF
          '0',' ':
            BEGIN
              MESSAGE(Text033,"Account No.");

              EXIT(
                CurrentManifestHeader.InsertLabelFile(
                  BufferPath + FedExManifest."First Manifest Series Name",
                  STRSUBSTNO(Text034,"Account No."),
                  12,'',PackingStation.Code,FALSE,PackingStation."Do Not Import Label File"));
            END;
          '9804':
            BEGIN
              MESSAGE(
                Text035,
                "Account No.",FedExManifest."Error Message");

              EXIT(0);
            END;
          ELSE
            ERROR(
              Text036,
              "Account No.",FedExManifest."Error Message");
        END;}
      END;
    END;

    LOCAL PROCEDURE ReprintManifest@11(FedExManifest@1240030000 : Record 14000784);
    VAR
      BufferPath@1240030001 : Text[250];
    BEGIN
      WITH FedExManifest DO BEGIN
        GetPackingStation;
        BufferPath := CarrierPackingStation."FedEx Buffer Directory";
        IF BufferPath[STRLEN(BufferPath)] <> '\' THEN
          BufferPath := BufferPath + '\';
        BufferPath := BufferPath + "First Manifest Series Name";
        IF NOT EXISTS(BufferPath) THEN
          ERROR(Text037,BufferPath);
      END;
    END;

    LOCAL PROCEDURE FixPhoneNo@35(OriginalPhone@1240030001 : Text[30]) ReturnPhone@1240030000 : Text[30];
    VAR
      i@1240030003 : Integer;
    BEGIN
      FOR i := 1 TO STRLEN(OriginalPhone) DO BEGIN
        IF (OriginalPhone[i] >= 48) AND (OriginalPhone[i] <= 57) THEN
          ReturnPhone := ReturnPhone + STRSUBSTNO('%1',OriginalPhone[i]);
      END;
    END;

    LOCAL PROCEDURE FixZIPCode@34(ZIPCodeText@1240030000 : Text[30]) : Text[9];
    BEGIN
      EXIT(COPYSTR(DELCHR(ZIPCodeText,'=',' -'),1,9));
    END;

    LOCAL PROCEDURE FixState@19(StateText@1240030000 : Text[30]) : Text[2];
    BEGIN
      EXIT(COPYSTR(DELCHR(StateText,'>',' '),1,2));
    END;

    LOCAL PROCEDURE FixUnitOfMeasure@44(UnitOfMeasureText@1240030000 : Text[30]) : Text[3];
    BEGIN
      EXIT(COPYSTR(UnitOfMeasureText,1,3));
    END;

    LOCAL PROCEDURE ShowBrowserLabel@23();
    BEGIN
      GetPackingStation;
      {FDXAPIClient.LoadBuffer(BufferFileName);
      Window.OPEN(Text001);
      FDXAPIClient.DisplayCurrLabelinBrowser(
        CarrierPackingStation."FedEx Label Template Directory",
        CarrierPackingStation."FedEx Buffer Directory");}
      Window.CLOSE;
    END;

    PROCEDURE ReformatTextLabel@24(CurrentPackage@1240030000 : Record 14000701;LabelName@1240030001 : Text[250];CODLabel@1240030002 : Boolean);
    VAR
      CompanyInfo@1240030003 : Record 79;
      FedExLabelReplace@1240030010 : Record 14000790;
      FedExLabelReplaceTmp@1240030011 : TEMPORARY Record 14000790;
      TextFile@1240030004 : File;
      TempTextFile@1240030005 : File;
      TempLabelName@1240030006 : Text[250];
      LabelSearch@1240030007 : ARRAY [5] OF Text[250];
      LabelReplace@1240030008 : ARRAY [5] OF Text[250];
      TextLine@1240030009 : ARRAY [5] OF Text[250];
      PhoneNo@1240030014 : Text[30];
      Contact@1240030015 : Text[100];
      Company@1240030016 : Text[100];
      Address1@1240030017 : Text[100];
      Address2@1240030018 : Text[100];
      City@1240030019 : Text[100];
      State@1240030020 : Text[30];
      ZIPCode@1240030021 : Text[30];
      Quote@1240030022 : Text[10];
      LinePos@1240030023 : Integer;
      i@1240030024 : Integer;
      Changed@1240030025 : Boolean;
      ItemLabelInfo@1240030026 : ARRAY [10,8] OF Text[50];
      TempText@1240030027 : Text[250];
      LineEnd@1240030032 : Text[30];
      SkipLine@1240030028 : Boolean;
      Char@1240030012 : Char;
      j@1240030013 : Integer;
      LineCnt@1240030029 : Integer;
      BreakPos@1240030030 : Integer;
      SpacePos@1240030031 : Integer;
    BEGIN
      WITH CurrentPackage DO BEGIN
        IF NOT EXISTS(LabelName) THEN
          EXIT;

        GetPackingStation;
        GetShippingAgentService("Shipping Agent Code","Shipping Agent Service","World Wide Service");
        Changed := FALSE;
        Quote := '"';
        CASE CarrierPackingStation."FedEx Label Printer Type" OF
          CarrierPackingStation."FedEx Label Printer Type"::"Eltron (EPL)",
          CarrierPackingStation."FedEx Label Printer Type"::"3":
            BEGIN
              LabelSearch[1] := 'q819';
              LabelReplace[1] := 'q800';
              IF CarrierPackingStation."FedEx Print From" =
                 CarrierPackingStation."FedEx Print From"::Top
              THEN BEGIN
                LabelSearch[3] := 'ZT';
                LabelReplace[3] := 'ZB';
               END ELSE BEGIN
                LabelSearch[3] := 'ZB';
                LabelReplace[3] := 'ZT';
              END;
            END;
          CarrierPackingStation."FedEx Label Printer Type"::"Zebra (ZPL)":
            BEGIN
              IF CarrierPackingStation."FedEx Print From" =
                 CarrierPackingStation."FedEx Print From"::Top
              THEN BEGIN
                LabelSearch[3] := '^XA^CF,0,0,0^PR12^MD30^PW800^PON';
                LabelReplace[3] := '^XA^CF,0,0,0^PR12^MD30^PW800^POI';
              END ELSE BEGIN
                LabelSearch[3] := '^XA^CF,0,0,0^PR12^MD30^PW800^POI';
                LabelReplace[3] := '^XA^CF,0,0,0^PR12^MD30^PW800^PON';
              END;
            END;
        END;

        // Insert Defaults
        FedExLabelReplace.RESET;
        IF NOT FedExLabelReplace.FIND('-') THEN
          FedExLabelReplace.InsertDefaultLabelReplaces;

        // Change From Addresses
        IF NOT CODLabel THEN BEGIN
          IF "Blind Shipment" OR "Double Blind Shipment" THEN BEGIN
            Contact := "Blind Ship-from Contact";
            Company := "Blind Ship-from Name";
            Address1 := "Blind Ship-from Address";
            Address2 := "Blind Ship-from Address 2";
            City := "Blind Ship-from City";
            State := FixState("Blind Ship-from State");
            ZIPCode := FixZIPCode("Blind Ship-from ZIP Code");
            PhoneNo := FixPhoneNo("Blind Ship-from Phone No.");
          END ELSE BEGIN
            CompanyInfo.GET;
            Contact := '';
            Company := CompanyInfo.Name;
            Address1 := CompanyInfo."COD Address 1";
            Address2 := CompanyInfo."COD Address 2";
            City := CompanyInfo."COD City";
            State := FixState(CompanyInfo."COD State");
            ZIPCode := FixZIPCode(CompanyInfo."COD Zip Code");
            PhoneNo := FixPhoneNo(CompanyInfo."COD Phone No.");
          END;

          FedExLabelReplace.RESET;
          FedExLabelReplace.SETFILTER(
            Version,'%1|%2',
            FedExLabelReplace.Version::All,FedExLabelReplace.Version::"6.21.001");
          FedExLabelReplace.SETRANGE(Active,TRUE);
          IF "Blind Shipment" OR "Double Blind Shipment" THEN
            IF CurrentPackage."Total Packages" > 1 THEN
              FedExLabelReplace.SETFILTER(
                Usage,'%1|%2|%3',
                FedExLabelReplace.Usage::" ",FedExLabelReplace.Usage::"Blind Ship",
                FedExLabelReplace.Usage::"Package No.")
            ELSE
              FedExLabelReplace.SETFILTER(
                Usage,'%1|%2',
                FedExLabelReplace.Usage::" ",FedExLabelReplace.Usage::"Blind Ship")
          ELSE
            IF CurrentPackage."Total Packages" > 1 THEN
              FedExLabelReplace.SETFILTER(
                Usage,'%1|%2',
                FedExLabelReplace.Usage::" ",FedExLabelReplace.Usage::"Package No.")
            ELSE
              FedExLabelReplace.SETRANGE(Usage,FedExLabelReplace.Usage::" ");

          IF ShippingAgentService."Transport Method Type" =
             ShippingAgentService."Transport Method Type"::Ground
          THEN BEGIN
            CASE CarrierPackingStation."FedEx Label Media Type" OF
              CarrierPackingStation."FedEx Label Media Type"::"4X6 with Trailing Doc Tab":
                FedExLabelReplace.SETFILTER(
                  "Service Type",'%1|%2',
                  FedExLabelReplace."Service Type"::"Ground with Doc Tab",
                  FedExLabelReplace."Service Type"::Ground);
              CarrierPackingStation."FedEx Label Media Type"::"4X6 W/O Doc Tab":
                FedExLabelReplace.SETFILTER(
                  "Service Type",'%1|%2',
                  FedExLabelReplace."Service Type"::"Ground W/O Doc Tab",
                  FedExLabelReplace."Service Type"::Ground);
            END;
          END ELSE
            IF "World Wide Service" THEN
              FedExLabelReplace.SETRANGE(
                "Service Type",FedExLabelReplace."Service Type"::"World Wide")
            ELSE
              FedExLabelReplace.SETRANGE(
                "Service Type",FedExLabelReplace."Service Type"::Express);

          IF FedExLabelReplace.FIND('-') THEN
            REPEAT
              FedExLabelReplaceTmp := FedExLabelReplace;
              FedExLabelReplaceTmp.INSERT;
            UNTIL FedExLabelReplace.NEXT = 0;
        END;

        TempLabelName := LabelName + '.tmp.txt';
        TempTextFile.TEXTMODE(TRUE);
        TempTextFile.WRITEMODE(TRUE);
        TempTextFile.CREATE(TempLabelName);

        TextFile.TEXTMODE(FALSE);
        TextFile.WRITEMODE(TRUE);
        TextFile.OPEN(LabelName);
        LineCnt := 0;
        REPEAT
          LineCnt := LineCnt + 1;
          i := 1;
          j := 1;
          CLEAR(TextLine);
          SpacePos := 0;
          BreakPos := 0;
          REPEAT
            IF i = 250 THEN BEGIN
              i := 1;
              IF BreakPos = 0 THEN
                BreakPos := SpacePos;
              j := j + 1;
              TextLine[j] :=
                COPYSTR(TextLine[j - 1],BreakPos + 1,STRLEN(TextLine[j - 1]) - BreakPos) +
                TextLine[j];
              TextLine[j - 1] := COPYSTR(TextLine[j - 1],1,BreakPos);
            END;
            TextFile.READ(Char);
            IF Char = 32 THEN
              SpacePos := i;
            IF Char IN [4,28,29,30] THEN
              BreakPos := i;

            IF (Char <> 10) AND (Char <> 13) THEN
              TextLine[j] := TextLine[j] + FORMAT(Char);
            i := i + 1;
          UNTIL Char = 10;

          GetPackingStation;
          CASE CarrierPackingStation."FedEx Label Printer Type" OF
            CarrierPackingStation."FedEx Label Printer Type"::"Zebra (ZPL)":
              LineEnd := '^FS';
            ELSE
              LineEnd := '"';
          END;

          FOR i := 1 TO ARRAYLEN(LabelSearch) DO
            IF LabelSearch[i] <> '' THEN
            // change from <> 0 to =1
              IF STRPOS(TextLine[1],LabelSearch[i]) = 1 THEN
                TextLine[1] := LabelReplace[i];
          IF FedExLabelReplaceTmp.FIND('-') THEN
            REPEAT
              IF STRPOS(TextLine[1],FedExLabelReplaceTmp."Search String") = 1 THEN BEGIN
                TextLine[1] := FedExLabelReplaceTmp."Search String";

                CASE FedExLabelReplaceTmp."Additional Data" OF
                  FedExLabelReplaceTmp."Additional Data"::Company:
                    TextLine[1] := TextLine[1] + Company + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::Address1:
                    TextLine[1] := TextLine[1] + Address1 + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::Address2:
                    TextLine[1] := TextLine[1] + Address2 + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::City:
                    TextLine[1] := TextLine[1] + City + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::State:
                    TextLine[1] := TextLine[1] + State + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::"ZIP Code":
                    TextLine[1] := TextLine[1] + ZIPCode + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::"City State":
                    TextLine[1] := TextLine[1] + City + ' ' + State + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::"City State ZIP":
                    TextLine[1] := TextLine[1] + City + ' ' + State + ' ' + ZIPCode + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::"City State ZIP (US)":
                    TextLine[1] := TextLine[1] + City + ' ' + State + ' ' + ZIPCode + ' (US)"';
                  FedExLabelReplaceTmp."Additional Data"::Phone:
                    TextLine[1] := TextLine[1] + PhoneNo + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::Contact:
                    TextLine[1] := TextLine[1] + Contact + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::Blank:
                    TextLine[1] := TextLine[1] + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::"ORIGIN ID: MULA + Phone":
                    TextLine[1] := TextLine[1] + 'ORIGIN ID: MULA  ' + PhoneNo + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::"Space + Phone":
                    TextLine[1] := TextLine[1] + ' ' + PhoneNo + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::"Package No.":
                    TextLine[1] := TextLine[1] + FORMAT("Package No.") + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::"Total Packages":
                    TextLine[1] := TextLine[1] + FORMAT("Total Packages") + LineEnd;
                  FedExLabelReplaceTmp."Additional Data"::"Package No./Total Packages":
                    TextLine[1] := TextLine[1] + FORMAT("Package No.") + '/' + FORMAT("Total Packages") + LineEnd;
                  ELSE
                    TextLine[1] := TextLine[1] + LineEnd;
                END;
              END;
            UNTIL FedExLabelReplaceTmp.NEXT = 0;

          IF CarrierPackingStation."FedEx Add Item Info. on Label" THEN BEGIN
            SkipLine := FALSE;

            IF TextLine[1] <> '' THEN
              CASE COPYSTR(TextLine[1],1,1) OF
                'A':
                  BEGIN
                    LinePos := STRPOS(TextLine[1],',');
                    IF LinePos > 0 THEN BEGIN
                      TempText := COPYSTR(TextLine[1],LinePos + 1);
                      LinePos := STRPOS(TempText,',');
                      IF LinePos > 0 THEN BEGIN
                        TempText := COPYSTR(TempText,1,LinePos - 1);
                        IF EVALUATE(LinePos,TempText) THEN
                          SkipLine := LinePos > 1200;
                      END;
                    END;
                  END;
                'P':
                  BEGIN
                    Shipping.GetItemLabelInfo(CurrentPackage,ItemLabelInfo);
                    Shipping.DirectPrintOrionLabelInfo(TempTextFile,ItemLabelInfo);
                  END;
              END;

            IF NOT SkipLine THEN
              TempTextFile.WRITE(TextLine[1] + TextLine[2] + TextLine[3] + TextLine[4] + TextLine[5]);
          END ELSE
            TempTextFile.WRITE(TextLine[1] + TextLine[2] + TextLine[3] + TextLine[4] + TextLine[5]);

        UNTIL TextFile.POS >= TextFile.LEN - 1;
        TextFile.CLOSE;
        TempTextFile.CLOSE;
      END;


      IF EXISTS(CarrierPackingStation."FedEx Label Buffer File") THEN
        ERASE(CarrierPackingStation."FedEx Label Buffer File");
      COPY(TempLabelName,CarrierPackingStation."FedEx Label Buffer File");
      ERASE(TempLabelName);
    END;

    LOCAL PROCEDURE GetPackingStation@51();
    BEGIN
      IF PackingStation.Code = '' THEN
        PackingStation.GetPackingStation;
      CarrierPackingStation.GetPackingStation(PackingStation);
      CarrierPackingStation.TESTFIELD("Proxy Address");
      CarrierPackingStation.TESTFIELD("Proxy Port");
    END;

    LOCAL PROCEDURE GetShippingSetup@33();
    BEGIN
      IF NOT ShippingSetupRetrieved THEN BEGIN
        ShippingSetup.GET;
        ShippingSetupRetrieved := TRUE;
      END;
    END;

    LOCAL PROCEDURE GetShippingAgent@45(ShippingAgentCode@1240030000 : Code[10]);
    BEGIN
      IF (ShippingAgent.Code <> ShippingAgentCode) OR
         (ShippingAgentCode = '')
      THEN
        ShippingAgent.GET(ShippingAgentCode);
    END;

    LOCAL PROCEDURE GetShippingAgentService@15(ShippingAgentCode@1240030000 : Code[10];ShippingAgentServiceCode@1240030001 : Code[30];WorldWideService@1240030002 : Boolean);
    BEGIN
      IF (ShippingAgentService.Code <> ShippingAgentCode) OR
         (ShippingAgentService."World Wide Service" <> WorldWideService) OR
         (ShippingAgentService.Code <> ShippingAgentServiceCode) OR
         (ShippingAgentServiceCode = '')
      THEN
        ShippingAgentService.GET(ShippingAgentCode,ShippingAgentServiceCode,WorldWideService);
    END;

    LOCAL PROCEDURE Date2Integer@25(CalcDate@1240030000 : Date) : Integer;
    BEGIN
      EXIT(DATE2DMY(CalcDate,3) * 10000 + DATE2DMY(CalcDate,2) * 100 + DATE2DMY(CalcDate,1));
    END;

    LOCAL PROCEDURE Time2Text@37(CalcTime@1240030000 : Time) : Text[30];
    VAR
      TempText@1240030001 : Text[30];
    BEGIN
      TempText := FORMAT(CalcTime,0,'<Hours24,2><Minutes,2><Seconds,2>');
      IF TempText[1] = ' ' THEN
        TempText := '0' + COPYSTR(TempText,2,STRLEN(TempText));
      EXIT(TempText);
    END;

    LOCAL PROCEDURE Decimal2Text@36(CalcDecimal@1240030000 : Decimal;DecimalToShow@1240030001 : Integer) : Text[30];
    VAR
      TempText@1240030002 : Text[30];
      ThousandChar@1240030003 : Text[1];
    BEGIN
      ThousandChar := COPYSTR(FORMAT(1000.1),2,1);
      TempText := FORMAT(CalcDecimal);
      TempText := DELCHR(TempText,'=',ThousandChar);
      TempText := CONVERTSTR(TempText,',','.');

      IF DecimalToShow <> 0 THEN BEGIN
        IF STRPOS(TempText,'.') = 0 THEN
          TempText := TempText + '.000000'
        ELSE
          TempText := TempText + '00000';
        TempText := COPYSTR(TempText,1,STRPOS(TempText,'.') + DecimalToShow);

        IF (STRLEN(TempText) - STRPOS(TempText,'.') <> DecimalToShow) OR (STRPOS(TempText,'.') = 0) THEN
          ERROR(Text038,CalcDecimal,TempText,DecimalToShow);
      END;

      EXIT(TempText);
    END;

    LOCAL PROCEDURE Text2Decimal@29(CalcText@1240030000 : Text[30]) : Decimal;
    VAR
      TempDecimal@1240030001 : Decimal;
    BEGIN
      IF CalcText = '' THEN
        EXIT(0);

      EVALUATE(TempDecimal,CalcText);
      EXIT(TempDecimal);
    END;

    LOCAL PROCEDURE Integer2Text@38(CalcInteger@1240030000 : Integer) : Text[30];
    VAR
      TempText@1240030001 : Text[30];
      ThousandChar@1240030002 : Text[1];
    BEGIN
      ThousandChar := COPYSTR(FORMAT(1000.1),2,1);
      TempText := FORMAT(CalcInteger);
      TempText := DELCHR(TempText,'=',ThousandChar);
      TempText := CONVERTSTR(TempText,',','.');
      EXIT(TempText);
    END;

    LOCAL PROCEDURE Text2Integer@41(CalcText@1240030000 : Text[30]) : Integer;
    VAR
      TempInteger@1240030001 : Integer;
    BEGIN
      IF CalcText = '' THEN
        EXIT(0);

      EVALUATE(TempInteger,CalcText);
      EXIT(TempInteger);
    END;

    LOCAL PROCEDURE Boolean2YN@40(CalcBoolean@1240030000 : Boolean) : Text[1];
    BEGIN
      IF CalcBoolean THEN
        EXIT('Y')
      ELSE
        EXIT('N');
    END;

    LOCAL PROCEDURE YN2Boolean@39(CalcText@1240030000 : Text[30]) : Boolean;
    BEGIN
      EXIT(CalcText = 'Y');
    END;

    LOCAL PROCEDURE GetFedExCountryCode@27(CountryCode@1240030000 : Code[10]) : Code[10];
    VAR
      Country@1240030001 : Record 9;
    BEGIN
      IF CountryCode <> '' THEN BEGIN
        Country.GET(CountryCode);
        Country.TESTFIELD(FedEx);
        Country.TESTFIELD("ISO 2 char Country Code");
        EXIT(Country."ISO 2 char Country Code");
      END ELSE
        EXIT('US');
    END;

    LOCAL PROCEDURE TestAndTransferToThirdParty@60(VAR CurrentPackage@1240030000 : Record 14000701;FedExOptionPage@1240030001 : Record 14000781;CurrentShippingAgentService@1240030002 : Record 14000708);
    BEGIN
      WITH CurrentPackage DO BEGIN
        IF "Shipping Payment Type" <> "Shipping Payment Type"::Prepaid THEN
          TransferToThirdPartyCost(CurrentShippingAgentService."Markup on Zero Shipping Cost")
        ELSE
          ClearThirdPartyCost;
      END;
    END;

    LOCAL PROCEDURE TestAndTransferToThirdPartyRS@61(CurrentRateShopHeader@1240030000 : Record 14000741;VAR CurrentRateShopLine@1240030001 : Record 14000742;FedExOptionPage@1240030002 : Record 14000781;CurrentShippingAgentService@1240030003 : Record 14000708);
    BEGIN
      WITH CurrentRateShopLine DO BEGIN
        IF CurrentRateShopHeader."Shipping Payment Type" <>
           CurrentRateShopHeader."Shipping Payment Type"::Prepaid
        THEN
          TransferToThirdPartyCost(
            CurrentRateShopHeader,CurrentShippingAgentService."Markup on Zero Shipping Cost")
        ELSE
          ClearThirdPartyCost;
      END;
    END;

    LOCAL PROCEDURE TestWEBAPI@17(CurrentShippingAgentAccount@1240030000 : Record 14000788);
    VAR
      InputFile@1240030001 : File;
      FileName@1240030002 : Text[250];
      InputLine@1240030003 : Text[250];
      KeyHandle@1240030004 : Code[20];
      Section@1240030005 : Text[250];
      KeyName@1240030006 : Text[250];
      ResultValue@1240030007 : Text[250];
      Result@1240030008 : Integer;
    BEGIN
      IF CurrentShippingAgentAccount."Test Status" =
         CurrentShippingAgentAccount."Test Status"::"No Testing"
      THEN
        EXIT;
      {CLEAR(FDXAPIClient);
      CREATE(FDXAPIClient);
      KeyHandle := 'HKEY_LOCAL_MACHINE';
      Section := 'SYSTEM\CURRENTCONTROLSET\SERVICES\FDXAPISVC';
      KeyName := 'ImagePath';
      ResultValue := '';

      Result := FDXAPIClient.QueryRegistry(KeyHandle,Section,KeyName,ResultValue);}
      IF Result <> 0 THEN
        ERROR(Text039);
      FileName := COPYSTR(ResultValue,1,STRPOS(ResultValue,'AtomSvc.exe') - 1) + 'Config.ini';
      IF COPYSTR(FileName,1,1) = '"' THEN
        FileName := COPYSTR(FileName,2);

      InputFile.TEXTMODE(TRUE);
      InputFile.WRITEMODE(FALSE);
      IF NOT InputFile.OPEN(FileName) THEN
        ERROR(Text040,FileName);

      WHILE InputFile.READ(InputLine) > 0 DO
        IF STRLEN(InputLine) > 12 THEN
          IF COPYSTR(InputLine,1,12) = 'Server1_URL=' THEN BEGIN
            IF CurrentShippingAgentAccount."Test Status" =
               CurrentShippingAgentAccount."Test Status"::Live
            THEN
              IF (InputLine = 'Server1_URL=gateway.fedex.com:443') OR
                 (InputLine = 'Server1_URL=www.gateway.fedex.com:443')
              THEN
                EXIT;

            IF CurrentShippingAgentAccount."Test Status" =
               CurrentShippingAgentAccount."Test Status"::Beta
            THEN
              IF (InputLine = 'Server1_URL=gatewaybeta.fedex.com:443') OR
                 (InputLine = 'Server1_URL=www.gatewaybeta.fedex.com:443')
              THEN
                EXIT;

            ERROR(Text041,InputLine);
          END;

      ERROR(Text042,InputFile);
    END;

    LOCAL PROCEDURE GetFirstPackageTransaction@53(CurrentPackage@1240030000 : Record 14000701;VAR MasterTrackingNumber@1240030001 : Code[20];VAR MasterFormID@1240030002 : Code[4]);
    VAR
      FedExOptionPage@1240030003 : Record 14000781;
      FedExPostedOptionPage@1240030004 : Record 14000782;
      PackageTmp@1000000000 : TEMPORARY Record 14000701;
      Package2@1000000001 : Record 14000701;
      Package3@1000000002 : Record 14000701;
    BEGIN
      //GetFirstPackageTransaction
        WITH CurrentPackage DO BEGIN
          Package2.SETCURRENTKEY("Source Type","Source Subtype","Source ID");
          Package2.SETRANGE("Source Type","Source Type");
          Package2.SETRANGE("Source Subtype","Source Subtype");
          IF "Multi Document Package"  THEN
            Package2.SETRANGE("Multi Document No.","Multi Document No.")
          ELSE
            Package2.SETRANGE("Source ID","Source ID");
          IF Package2.FIND('-') THEN
            REPEAT
              IF Package2."Original Package No." <> '' THEN BEGIN
                Package3.GET(Package2."Original Package No.");
                PackageTmp := Package3;
              END ELSE
                PackageTmp := Package2;
              IF PackageTmp.INSERT THEN
                ;
            UNTIL Package2.NEXT = 0;
          PackageTmp.SETCURRENTKEY("No.");
          IF PackageTmp.FIND('-') THEN
            IF FedExOptionPage.GET(FedExOptionPage.Type::Package,PackageTmp."No.",0,0) THEN BEGIN
              MasterTrackingNumber := FedExOptionPage."Master Tracking No.";
              MasterFormID := FedExOptionPage."Tracking Form ID";
            END ELSE
              IF FedExPostedOptionPage.GET(PackageTmp."No.") THEN BEGIN
                MasterTrackingNumber := FedExPostedOptionPage."Master Tracking No.";
                MasterFormID := FedExPostedOptionPage."Tracking Form ID";
              END;
            END;
    END;

    LOCAL PROCEDURE GetLabelFileName@6(TrackingNo@1240030001 : Code[20]) LabelFileName@1240030000 : Text[250];
    BEGIN
      IF COPYSTR(
           CarrierPackingStation."FedEx Buffer Directory",
           STRLEN(CarrierPackingStation."FedEx Buffer Directory"),1) =
         '\'
      THEN
        LabelFileName := CarrierPackingStation."FedEx Buffer Directory" + TrackingNo
      ELSE
        LabelFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' + TrackingNo;
    END;

    PROCEDURE TrackPackage@1240030001(CurrentPackage@1240030000 : Record 14000701);
    VAR
      Country@1240030010 : Record 9;
    BEGIN
      WITH CurrentPackage DO BEGIN
        ShippingAgent.GET("Shipping Agent Code");

        Country.INIT;
        IF "Ship-to Country Code" <> '' THEN
          Country.GET("Ship-to Country Code");

        HYPERLINK(
          STRSUBSTNO(
            ShippingAgent."Internet Address","External Tracking No.",Country.Code,
            "Pickup Date",ShippingAgent."Account No."));
      END;
    END;

    PROCEDURE CheckName@1240030019(ShippingAgent@1240030010 : Record 291;FromType@1240030006 : 'Package,Document,Master Data';VAR Name@1240030001 : Text[100];VAR Name2@1240030002 : Text[100];VAR Contact@1240030005 : Text[100];NameCaption@1240030009 : Text[100];Name2Caption@1240030008 : Text[100];ContactCaption@1240030000 : Text[100]);
    VAR
      LongNameType@1240030004 : Integer;
    BEGIN
      LongNameType := NameAndAddressMgt.GetLongNameType(ShippingAgent,FromType);

      NameAndAddressMgt.CheckCorrectTextLen(Name,LongNameType,35,NameCaption);
      NameAndAddressMgt.CheckCorrectTextLen(Name2,LongNameType,35,Name2Caption);
      NameAndAddressMgt.CheckCorrectTextLen(Contact,LongNameType,35,ContactCaption);
    END;

    PROCEDURE CheckAddress@1240030000(ShippingAgent@1240030010 : Record 291;FromType@1240030016 : 'Package,Document,Master Data';VAR Address@1240030012 : Text[100];VAR Address2@1240030011 : Text[100];VAR City@1240030009 : Text[100];VAR PostCode@1240030008 : Code[100];VAR State@1240030007 : Text[100];VAR Country@1240030006 : Code[100];AddressCaption@1240030005 : Text[100];Address2Caption@1240030004 : Text[100];CityCaption@1240030003 : Text[100];PostCodeCaption@1240030002 : Text[100];StateCaption@1240030001 : Text[100];CountryCaption@1240030000 : Text[100]);
    VAR
      TempText@1240030013 : Text[100];
      LongAddressType@1240030015 : Integer;
    BEGIN
      LongAddressType := NameAndAddressMgt.GetLongAddressType(ShippingAgent,FromType);

      NameAndAddressMgt.CheckCorrectTextLen(Address,LongAddressType,35,AddressCaption);
      NameAndAddressMgt.CheckCorrectTextLen(Address2,LongAddressType,35,Address2Caption);
      NameAndAddressMgt.CheckCorrectTextLen(City,LongAddressType,35,CityCaption);
      TempText := PostCode;
      NameAndAddressMgt.CheckCorrectTextLen(TempText,LongAddressType,10,PostCodeCaption);
      PostCode := TempText;
      NameAndAddressMgt.CheckCorrectTextLen(State,LongAddressType,2,StateCaption);
    END;

    BEGIN
    {
      Retired with the introduction of webservices
      SE0.60.12 - commented out code referencing Hold At Location to enable the compiling of the object with the new
                  updates.
    }
    END.
  }
}

