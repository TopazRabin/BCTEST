OBJECT Codeunit 11123318 SC - Catalog Helper
{
  OBJECT-PROPERTIES
  {
    Date=11/03/21;
    Time=[ 7:23:20 AM];
    Modified=Yes;
    Version List=SCW19.2.0,001,TPZ3099,TPZ3109,005;
  }
  PROPERTIES
  {
    TableNo=11123302;
    OnRun=VAR
            Params@11123305 : TEMPORARY Record 11123310;
            RequestBuff@11123303 : TEMPORARY Record 11123303;
            ResponseBuff@11123302 : TEMPORARY Record 11123303;
            Context@11123304 : Codeunit 11123305;
          BEGIN
            Context.GetRequestBuff(RequestBuff);
            Context.GetResponseBuff(ResponseBuff);
            Context.GetParams(Params);

            CASE Code OF
              UPPERCASE('GetVariants') : GetVariants(Params);
              UPPERCASE('GetPrepacks') : GetPrepacks(Params);
              UPPERCASE('GetBOMComponents') : GetBOMComponents(Params);
              UPPERCASE('GetExtVariantComponents') : GetExtVariantComponents(Params);
              UPPERCASE('FindBarCode') : FindBarCode(Params);
              UPPERCASE('GetAvailableStockForItem') : GetAvailableStockForItem(Params);
              UPPERCASE('GetAvailableStockForVariant') : GetAvailableStockForVariant(Params);
              UPPERCASE('TestItemStatus') : TestItemStatus(Params);
            END;

            Context.SetParams(Params);
          END;

  }
  CODE
  {
    VAR
      Text11123303@11123307 : TextConst 'ENU=Requested field does not exist in table. Field: %1. Table: %2.';
      Text11123352@11123305 : TextConst 'ENU=Blocked by Pfs Item Status.';
      Text11123353@11123308 : TextConst 'ENU=Non orderable by stock.';
      Text11123354@11123302 : TextConst 'ENU=Undefined';
      Context@11123304 : Codeunit 11123305;
      PrepackCodeToInvGlobal@11123309 : Boolean;
      PrepToInvInitializedGlobal@11123303 : Boolean;
      Text11123390@11123306 : TextConst 'ENU="%1 = ''%2'' does not exist."';
      Text11123391@11123310 : TextConst 'ENU="Reserv must be Never on %1 = ''%2''."';
      Text11123392@11123312 : TextConst 'ENU="Status must be certified on %1 = ''%2''."';
      Text11123393@11123311 : TextConst 'ENU=Kit BOM component ''%1'' is non-orderable.';
      InvText@1000000000 : Text;
      ColorText@1000000001 : Text;

    PROCEDURE CreateProductXML@11123310(VAR ResultNodeBuff@11123302 : Record 11123303;Item@11123303 : Record 27;VAR Params@11123304 : Record 11123310);
    VAR
      RecRef@11123317 : RecordRef;
      DummyTempVariant@11123314 : TEMPORARY Record 5401;
      TempCurrencyList@11123319 : TEMPORARY Record 11123330;
      TempCalcValuesInfo@11123318 : TEMPORARY Record 11123319;
      Dispatcher@11123312 : Codeunit 11123306;
      EventMgt@11123311 : Codeunit 11123331;
      Settings@11123320 : Codeunit 11123311;
      CommonFunc@11123321 : Codeunit 11123309;
      LastDateTimeModify@11123316 : DateTime;
      Inventory@11123305 : Decimal;
      SalesPrice@11123313 : Decimal;
      ListPrice@11123309 : Decimal;
      TaxPercent@11123310 : Decimal;
      CategoryId@11123307 : Text[1024];
      CalcNonOrderableReason@11123308 : Text[250];
      CalcOrderable@11123306 : Boolean;
      CheckOrderabilityByStock@11123315 : Boolean;
    BEGIN
      Params.ProductId := Item."No.";
      Params.UnitOfMeasureId := GetItemUOM(Item);

      ResultNodeBuff.AddFieldElement('Id',Item."No.");

      ResultNodeBuff.AddFieldElement('ShortTermDescription',Item."Short Term Product Title"); //<TPZ2672>
      ResultNodeBuff.AddFieldElement('LongTermDescription',Item."Long Term Product Title"); //<TPZ2672>

      ResultNodeBuff.AddFieldElement('Title',Item.Description);
      AddProductTranslations(ResultNodeBuff,Item."No.",'','Title');
      AddProductExtendedTexts(ResultNodeBuff,Params,Item."No.");

      ResultNodeBuff.AddFieldElement('Visible',FORMAT(Item."Visible in Webshop",0,2));

      Params.ProductOrderable := IsItemOrderable(Item,TRUE,Params);
      CalcOrderable := Params.ProductOrderable;

      IF Params.CalculatePrices THEN BEGIN
        Settings.GetCurrencyList(TempCurrencyList);
        TempCurrencyList.SETRANGE(Value,Params.BaseCurrencyId);

        GetCalcValues(TempCalcValuesInfo,TempCurrencyList,DummyTempVariant,Params);

        SalesPrice := TempCalcValuesInfo."Unit Price";
        ListPrice := TempCalcValuesInfo."Unit List Price";

        Params.CalcOrderable := TempCalcValuesInfo.Orderable;
        Params.CalcErrorText := TempCalcValuesInfo."Non Orderable Reason";
        CalcOrderable := Params.CalcOrderable;
        CalcNonOrderableReason := Params.CalcErrorText;

        AddMultiCurrencyPrices(ResultNodeBuff,DummyTempVariant,TempCurrencyList,TempCalcValuesInfo,Params);

        CalcOrderable := Params.CalcOrderable;
        CalcNonOrderableReason := Params.CalcErrorText;
      END;

      ResultNodeBuff.AddFieldElement('Price',FORMAT(SalesPrice));
      ResultNodeBuff.AddFieldElement('ListPrice',FORMAT(ListPrice));

      CategoryId := GetCategoryId(Item);
      ResultNodeBuff.AddFieldElement('CategoryId',CategoryId);

      IF Params.CalculateInventory THEN
        IF Params.ProductOrderable THEN BEGIN
          Dispatcher.DispatchInternal('GetAvailableStockForItem',Params);
          Inventory := Params.Inventory;
        END;
      ResultNodeBuff.AddFieldElement('Inventory',FORMAT(Inventory));

      AddItemPhysicalDimensionsToXml(ResultNodeBuff,Item."No.",GetItemUOM(Item));

      IF NOT IsExcludeTaxPercent(Params) THEN BEGIN
        IF Params.AccountId <> '' THEN
          TaxPercent := GetVatPercentage(Item."VAT Prod. Posting Group",Params);
        ResultNodeBuff.AddFieldElement('TaxPercent',FORMAT(TaxPercent));
      END;

      EventMgt.OnGetProduct(ResultNodeBuff,Item,Params);

      ResultNodeBuff.AddFieldElement('UnitOfMeasureId',GetItemUOM(Item));
      AddItemUnitsOfMeasureToXML(ResultNodeBuff,Item,Params);

      AddVisibilityRulesToXml(ResultNodeBuff,Item,Params);

      GetRelatedSkus(ResultNodeBuff,TempCalcValuesInfo,Params);

      ResultNodeBuff.AddFieldElement('HasVariants',FORMAT(Params.HasVariants,0,2));
      ResultNodeBuff.AddFieldElement('HasPrepacks',FORMAT(Params.HasPrepacks,0,2));
      ResultNodeBuff.AddFieldElement('HasMaterials',FORMAT(Params.HasMaterials,0,2));

      AddProductExternalInfo(ResultNodeBuff,Params);

      CheckOrderabilityByStock := Params.ProductOrderable AND ((NOT Params.HasVariants) OR (NOT Params.LoadRelatedSkus));
      IF CheckOrderabilityByStock THEN
        IsOrderableByStock(Inventory,CalcOrderable,CalcNonOrderableReason,Params);

      AddOrderableFieldElementsToXml(ResultNodeBuff,Item."No.",'',Params.ProductOrderable,CalcOrderable,CalcNonOrderableReason);

      ResultNodeBuff.AddFieldElement('VariantComponentsCount',FORMAT(GetVariantComponentsCount(Params)));
      ResultNodeBuff.AddFieldElement('Blocked',FORMAT(FALSE,0,2));
      ResultNodeBuff.AddFieldElement('Barcodes',GetItemBarCode(Item));
      ResultNodeBuff.AddFieldNameValueTypeElement('IsIndoor',FORMAT(GetIndoorValuefromItemAttr(Item),0,2),'Boolean');//<TPZ3320>

      RecRef.GETTABLE(Item);
      LastDateTimeModify := GetLastDateTimeModify(RecRef);
      ResultNodeBuff.AddFieldElement('ModifiedDate',FORMAT(LastDateTimeModify,0,3));
      CommonFunc.AddAttachmentsToXml(ResultNodeBuff,RecRef,Params);
      RecRef.CLOSE;

      GetProductExtraFieldsXML(ResultNodeBuff,Item,Params);

      CreateRelatedProductsXML(ResultNodeBuff,Item."No.",Params);
      Context.SetXMLNodeBuff(ResultNodeBuff);
    END;

    PROCEDURE GetProductExtraFieldsXML@11123427(VAR ResultNodeBuff@11123303 : Record 11123303;VAR Item@11123302 : Record 27;VAR Params@11123319 : Record 11123310);
    VAR
      TempExtraFieldList@11123304 : TEMPORARY Record 11123330;
      CommonFunc@11123305 : Codeunit 11123309;
      RecRef@11123308 : RecordRef;
      FieldNo@11123306 : Integer;
      FieldName@11123307 : Text[250];
    BEGIN
      IF Params.ExtraFieldListIsEmpty THEN
        EXIT;

      Params.GetExtraFieldList(TempExtraFieldList);

      RecRef.GETTABLE(Item);

      IF TempExtraFieldList.FINDSET THEN
        REPEAT
          FieldName := TempExtraFieldList.Value;
          // START, SC  Specific functionality for NAV2017
          IF STRPOS(FieldName,'Attribute__') <> 0 THEN
            AddProductAttributeExtraField(ResultNodeBuff,Item,TempExtraFieldList)
          ELSE
          // END, SC
            IF NOT CommonFunc.IsRelationalField(FieldName) THEN BEGIN
              FieldNo := CommonFunc.GetFieldNoByName(RecRef.NUMBER,FieldName);
              IF FieldNo = 0 THEN
                ERROR(Text11123303,FieldName,RecRef.CAPTION);

              ResultNodeBuff.AddFieldElementByNo(RecRef,FieldNo);
            END ELSE
              CommonFunc.AddRelationalFieldXML(ResultNodeBuff,RecRef,FieldName);
        UNTIL TempExtraFieldList.NEXT = 0;
    END;

    PROCEDURE CreateCategoryXML@11123317(Category@11123302 : Record 5722;VAR InXmlNodeBuff@11123303 : Record 11123303;VAR ReturnNodeBuff@11123304 : Record 11123303;VAR Params@11123305 : Record 11123310);
    BEGIN
      InXmlNodeBuff.AddElement(ReturnNodeBuff,'Node','');
      ReturnNodeBuff.AddFieldElement('Id',Category.Code);
      ReturnNodeBuff.AddFieldElement('Title',Category.Description);
      ReturnNodeBuff.AddFieldElement('Visible',FORMAT(Category."Visible in Webshop",0,2));
      ReturnNodeBuff.AddFieldElement('SortId',FORMAT(Category."Sort No."));
      AddFieldTranslations(ReturnNodeBuff,DATABASE::"Item Category",Category.Code,'','','Description');
    END;

    PROCEDURE CreateProductGroupXML@11123319(ProductGroup@11123302 : Record 5723;VAR ParentNodeBuff@11123303 : Record 11123303;VAR ReturnNodeBuff@11123304 : Record 11123303;VAR Params@11123305 : Record 11123310);
    BEGIN
      ParentNodeBuff.AddElement(ReturnNodeBuff,'Node','');
      ReturnNodeBuff.AddFieldElement('Id',MakeProductGroupId(ProductGroup));
      ReturnNodeBuff.AddFieldElement('Title',ProductGroup.Description);
      ReturnNodeBuff.AddFieldElement('Visible',FORMAT(ProductGroup."Visible in Webshop",0,2));
      ReturnNodeBuff.AddFieldElement('SortId',FORMAT(ProductGroup."Sort No."));
      AddFieldTranslations(
        ReturnNodeBuff,DATABASE::"Product Group",ProductGroup."Item Category Code",ProductGroup.Code,'','Title');
    END;

    PROCEDURE CreateRelatedProductsXML@11123364(VAR RootNodeBuff@11123302 : Record 11123303;ItemNo@11123303 : Code[20];VAR Params@11123304 : Record 11123310);
    VAR
      ItemSubstitution@11123305 : Record 5715;
      Item@11123306 : Record 27;
      CollectionNodeBuff@11123309 : TEMPORARY Record 11123303;
      ResultNodeBuff@11123310 : TEMPORARY Record 11123303;
      FilterHelper@11123307 : Codeunit 11123321;
    BEGIN
      RootNodeBuff.AddElement(CollectionNodeBuff,'RelatedProducts','');

      IF NOT Params.LoadRelatedSkus THEN
        EXIT;

      FilterHelper.SetItemWebshopFilter(Item,Params);

      ItemSubstitution.RESET;
      ItemSubstitution.SETCURRENTKEY(Type,"No.",ItemSubstitution."Sort No.");
      ItemSubstitution.SETRANGE("No.",ItemNo);
      ItemSubstitution.SETRANGE("Substitute Type",ItemSubstitution."Substitute Type"::Item);
      IF ItemSubstitution.FINDSET THEN
        REPEAT
          Item.SETRANGE("No.",ItemSubstitution."Substitute No.");
          IF Item.FINDFIRST THEN BEGIN
            IF Item."Visible in Webshop" THEN BEGIN
              CollectionNodeBuff.AddElement(ResultNodeBuff,'RelatedProduct','');
              ResultNodeBuff.AddAttribute('id',ItemSubstitution."Substitute No.");
              ResultNodeBuff.AddAttribute('type',FORMAT(ItemSubstitution."Relation Type"));
              ResultNodeBuff.AddAttribute('sortId',ItemSubstitution."Sort No.");
            END;
          END;
        UNTIL ItemSubstitution.NEXT = 0;
    END;

    LOCAL PROCEDURE GetRelatedSkus@11123326(VAR ResultNodeBuff@11123303 : Record 11123303;VAR CalcValuesInfo@11123306 : Record 11123319;VAR Params@11123304 : Record 11123310);
    VAR
      Context@11123305 : Codeunit 11123305;
      Dispatcher@11123302 : Codeunit 11123306;
    BEGIN
      CalcValuesInfo.RESET;
      Context.SetCalcValuesInfo(CalcValuesInfo);

      Context.SetXMLNodeBuff(ResultNodeBuff);
      Dispatcher.DispatchInternal('GetVariants',Params);

      Context.SetXMLNodeBuff(ResultNodeBuff);
      Dispatcher.DispatchInternal('GetPrepacks',Params);

      Context.SetXMLNodeBuff(ResultNodeBuff);
      Dispatcher.DispatchInternal('GetBOMComponents',Params);

      Context.ClearCalcValuesInfo;
    END;

    PROCEDURE GetVariants@11123303(VAR Params@11123302 : Record 11123310);
    VAR
      Item@11123313 : Record 27;
      ItemVariant@11123303 : Record 5401;
      TempCalcValuesInfo@11123305 : TEMPORARY Record 11123319;
      RecMgt@11123304 : Codeunit 11123326;
      Context@11123306 : Codeunit 11123305;
      EventMgt@11123311 : Codeunit 11123331;
      ResultNodeBuff@11123307 : TEMPORARY Record 11123303;
      CollectionNodeBuff@11123308 : TEMPORARY Record 11123303;
      AtLeastOneVariantOrderable@11123309 : Boolean;
      VariantOrderable@11123310 : Boolean;
    BEGIN
      Context.GetXMLNodeBuff(ResultNodeBuff);
      Context.GetCalcValuesInfo(TempCalcValuesInfo);
      ResultNodeBuff.AddElement(CollectionNodeBuff,'Variants','');

      Params.HasVariants := FALSE;

      RecMgt.GetItem(Params.ProductId,Item,TRUE);
      IF NOT Item."Visible in Webshop" THEN
        EXIT;

      ItemVariant.RESET;
      ItemVariant.SETRANGE("Item No.",Params.ProductId);
      ItemVariant.SETRANGE("Visible in Webshop",TRUE);

      EventMgt.OnBeforeGetVariants(CollectionNodeBuff,ItemVariant,Params);

      Params.HasVariants := NOT ItemVariant.ISEMPTY;
      IF Params.HasVariants AND Params.LoadRelatedSkus THEN BEGIN
        AtLeastOneVariantOrderable := FALSE;
        IF ItemVariant.FINDSET THEN
          REPEAT
            RecMgt.AddVariantToCache(ItemVariant);

            VariantOrderable := CreateVariantXML(CollectionNodeBuff,ItemVariant,TempCalcValuesInfo,Params);
            IF VariantOrderable AND NOT AtLeastOneVariantOrderable THEN
              AtLeastOneVariantOrderable := TRUE;
          UNTIL ItemVariant.NEXT = 0;
        Params.ProductOrderable := Params.ProductOrderable AND AtLeastOneVariantOrderable;
      END;
    END;

    PROCEDURE CreateVariantXML@11123313(VAR ResultNodeBuff@11123302 : Record 11123303;VAR Variant@11123303 : Record 5401;VAR CalcValuesInfo@11123314 : Record 11123319;VAR Params@11123305 : Record 11123310) : Boolean;
    VAR
      RecRef@11123308 : RecordRef;
      Item@11123306 : Record 27;
      SubNodeBuff@11123310 : TEMPORARY Record 11123303;
      ComponentsNodeBuff@11123325 : TEMPORARY Record 11123303;
      TempCurrencyList@11123312 : TEMPORARY Record 11123330;
      CommonFunc@11123307 : Codeunit 11123309;
      Dispatcher@11123304 : Codeunit 11123306;
      RecMgt@11123321 : Codeunit 11123326;
      EventMgt@11123324 : Codeunit 11123331;
      Settings@11123313 : Codeunit 11123311;
      Inventory@11123315 : Decimal;
      ListPrice@11123316 : Decimal;
      SalesPrice@11123317 : Decimal;
      Orderable@11123318 : Boolean;
      VertComponentsExist@11123319 : Boolean;
      HorzComponentsExist@11123320 : Boolean;
      CalcOrderable@11123322 : Boolean;
      CalcNonOrderableReason@11123323 : Text[250];
      VariantTitle@11123398 : Text[1024];
      VariantTitle2@11123399 : Text[1024];
    BEGIN
      RecMgt.GetItem(Variant."Item No.",Item,TRUE);

      Params.ProductId := Item."No.";
      Params.VariantId := Variant.Code;

      ResultNodeBuff.AddElement(SubNodeBuff,'Variant','');
      SubNodeBuff.AddFieldElement('Id',Variant.Code);

      VariantTitle := Variant.Description;
      IF VariantTitle = '' THEN
        VariantTitle := Variant.Code;

      VariantTitle2 := Variant."Description 2";
      IF VariantTitle2 = '' THEN
        VariantTitle2 := Variant.Code;

      CASE Params.ItemDescriptionNo OF
        1 : SubNodeBuff.AddFieldElement('Title',VariantTitle);
        2 : SubNodeBuff.AddFieldElement('Title',VariantTitle2);
        3 :
          BEGIN
            SubNodeBuff.AddFieldElement('Title',VariantTitle);
            SubNodeBuff.AddFieldElement('Title2',VariantTitle2);
          END;
      END;

      AddProductTranslations(SubNodeBuff,Item."No.",Variant.Code,'Title');

      IF Params.ProductOrderable THEN BEGIN
        Orderable := IsItemVariantOrderable(Variant,TRUE,Params);
        CalcOrderable := Orderable;
      END;

      IF Params.CalculateSKUPrices THEN BEGIN
        IF Orderable THEN BEGIN
          Params.UnitOfMeasureId := '';

          Settings.GetCurrencyList(TempCurrencyList);
          TempCurrencyList.SETRANGE(Value,Params.BaseCurrencyId);

          GetCalcValues(CalcValuesInfo,TempCurrencyList,Variant,Params);

          SalesPrice := CalcValuesInfo."Unit Price";
          ListPrice := CalcValuesInfo."Unit List Price";

          Params.CalcOrderable := CalcValuesInfo.Orderable;
          Params.CalcErrorText := CalcValuesInfo."Non Orderable Reason";
          CalcOrderable := Params.CalcOrderable;
          CalcNonOrderableReason := Params.CalcErrorText;

          AddMultiCurrencyPrices(SubNodeBuff,Variant,TempCurrencyList,CalcValuesInfo,Params);

          CalcOrderable := Params.CalcOrderable;
          CalcNonOrderableReason := Params.CalcErrorText;
        END ELSE BEGIN
          SalesPrice := Item."Unit Price";
          ListPrice := Item."Unit Price";
        END;
      END;
      SubNodeBuff.AddFieldElement('Price',FORMAT(SalesPrice));
      SubNodeBuff.AddFieldElement('ListPrice',FORMAT(ListPrice));

      IF Params.CalculateSKUInventory THEN
        IF Orderable THEN BEGIN
          Dispatcher.DispatchInternal('GetAvailableStockForVariant',Params);
          Inventory := Params.Inventory;

          IsOrderableByStock(Inventory,CalcOrderable,CalcNonOrderableReason,Params);
        END;

      SubNodeBuff.AddFieldElement('Inventory',FORMAT(Inventory));
      SubNodeBuff.AddFieldElement('Barcodes',GetVariantBarCode(Variant,Item."Sales Unit of Measure"));
      AddOrderableFieldElementsToXml(SubNodeBuff,Variant."Item No.",Variant.Code,Orderable,CalcOrderable,CalcNonOrderableReason);

      RecRef.GETTABLE(Variant);
      CommonFunc.AddAttachmentsToXml(SubNodeBuff,RecRef,Params);
      RecRef.CLOSE;

      AddPfsVariantComponentsXML(SubNodeBuff,Variant,Params);

      EventMgt.OnGetVariant(SubNodeBuff,Variant,Params);

      AddVariantExternalInfo(SubNodeBuff,Params);
      EXIT(Orderable AND CalcOrderable);
    END;

    PROCEDURE AddPfsVariantComponentsXML@11123401(VAR SubNodeBuff@11123302 : Record 11123303;VAR Variant@11123305 : Record 5401;VAR Params@11123303 : Record 11123310);
    VAR
      ComponentsNodeBuff@11123309 : TEMPORARY Record 11123303;
      VertComponentsExist@11123308 : Boolean;
      HorzComponentsExist@11123307 : Boolean;
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    LOCAL PROCEDURE GetExtVariantComponents@11123312(VAR Params@11123302 : Record 11123310);
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE GetPrepacks@11123304(VAR Params@11123302 : Record 11123310);
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE CreatePrepackXML@11123391() : Boolean;
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE CreatePrepackVariantXML@11123392();
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE GetBOMComponents@11123305(VAR Params@11123302 : Record 11123310);
    VAR
      ComponentRecordRef@11123306 : RecordRef;
      BOMComp@11123303 : Record 90;
      ResultNodeBuff@11123305 : TEMPORARY Record 11123303;
      CollectionNodeBuff@11123304 : TEMPORARY Record 11123303;
    BEGIN
      IF IsExcludeBOMComp(Params) THEN
        EXIT;

      IF Context.IsNorthAmericaLocalization AND Context.SupportsKitBOM THEN
        GetKitBOMComponents(Params)
      ELSE BEGIN
       Context.GetXMLNodeBuff(ResultNodeBuff);

         BOMComp.RESET;
         BOMComp.SETRANGE("Parent Item No.",Params.ProductId);
         BOMComp.SETRANGE("Visible in Webshop",TRUE);
         Params.HasMaterials := NOT BOMComp.ISEMPTY;
         IF Params.HasMaterials AND Params.LoadRelatedSkus THEN BEGIN
           ResultNodeBuff.AddElement(CollectionNodeBuff,'Materials','');
           IF BOMComp.FINDSET THEN
             REPEAT
               ComponentRecordRef.GETTABLE(BOMComp);
               CreateComponentXML(CollectionNodeBuff,ComponentRecordRef,Params);
               ComponentRecordRef.CLOSE;
             UNTIL BOMComp.NEXT = 0;
         END;
      END;
    END;

    PROCEDURE GetKitBOMComponents@11123420(VAR Params@11123302 : Record 11123310);
    VAR
      ItemRecRef@11123313 : RecordRef;
      ProdBOMLineRecordRef@11123314 : RecordRef;
      ItemFieldRef@11123312 : FieldRef;
      Item@11123309 : Record 27;
      ResultNodeBuff@11123305 : TEMPORARY Record 11123303;
      CollectionNodeBuff@11123304 : TEMPORARY Record 11123303;
      ProdBOMHeader@11123307 : Record 99000771;
      ProdBOMLine@11123306 : Record 99000772;
      RecMgt@11123308 : Codeunit 11123326;
      ItemKitBomNo@11123311 : Code[20];
    BEGIN
      // DOES NOT IMPLEMENT IN CURRENT VERSION
    END;

    PROCEDURE CreateComponentXML@11123327(VAR OutXMLBuff@11123302 : Record 11123303;RecordRef@11123303 : RecordRef;VAR Params@11123304 : Record 11123310);
    VAR
      FieldRef@11123311 : FieldRef;
      Item@11123307 : Record 27;
      ItemVariant@11123308 : Record 5401;
      ResultNodeBuff@11123310 : TEMPORARY Record 11123303;
      RecMgt@11123314 : Codeunit 11123326;
      ComponentNo@11123305 : Code[20];
      VariantCode@11123309 : Code[10];
      QuantityPer@11123306 : Decimal;
    BEGIN
      CASE RecordRef.NUMBER OF
        90 : // "BOM Component" :
          BEGIN
            FieldRef := RecordRef.FIELD(4); // "No."
            ComponentNo := FieldRef.VALUE;
            FieldRef := RecordRef.FIELD(8); // "Quantity per"
            QuantityPer := FieldRef.VALUE;
            FieldRef := RecordRef.FIELD(5402); // "Variant Code"
            VariantCode := FieldRef.VALUE;
          END;
        DATABASE::"Production BOM Line" :
      BEGIN
            FieldRef := RecordRef.FIELD(11); // "No."
            ComponentNo := FieldRef.VALUE;
            FieldRef := RecordRef.FIELD(45); // "Quantity per"
            QuantityPer := FieldRef.VALUE;
            FieldRef := RecordRef.FIELD(21); // "Variant Code"
            VariantCode := FieldRef.VALUE;
          END;
      END;

      OutXMLBuff.AddElement(ResultNodeBuff,'Material','');
      ResultNodeBuff.AddFieldElement('Quantity',FORMAT(QuantityPer));
      ResultNodeBuff.AddFieldElement('ProductId',ComponentNo);
      ResultNodeBuff.AddFieldElement('VariantId',VariantCode);

      IF RecMgt.GetItem(ComponentNo,Item,FALSE) THEN BEGIN
        ResultNodeBuff.AddFieldElement('Title',Item.Description);
        AddProductTranslations(ResultNodeBuff,ComponentNo,'','Title');
      END;

      IF RecMgt.GetItemVariant(Item."No.",VariantCode,ItemVariant,FALSE) THEN BEGIN
        ResultNodeBuff.AddFieldElement('VariantTitle',ItemVariant.Description);
        AddProductTranslations(ResultNodeBuff,ComponentNo,VariantCode,'VariantTitle');
      END;
    END;

    PROCEDURE GetSalesPrice@11123316(Item@11123302 : Record 27;ItemVariant@11123303 : Record 5401;VAR Params@11123305 : Record 11123310) : Decimal;
    VAR
      CalcMgt@11123306 : Codeunit 11123325;
      EventMgt@11123304 : Codeunit 11123331;
      Visible@11123309 : Boolean;
      RecMgt@1000000003 : Codeunit 11123326;
      Customer@1000000002 : Record 18;
      SalesLineBuffer@1000000001 : TEMPORARY Record 50021;
      LineNo@1000000000 : Integer;
      LastSalesPrice@1000000007 : Record 50004;
      ItemDiv@1000000006 : Record 27;
      ItemUOM@1000000005 : Record 5404;
      SalesUOMCode@1000000004 : Code[10];
    BEGIN
      Params.CalcFunction := 'CalcSalesPrice';
      Params.ProductId := Item."No.";
      Params.VariantId := ItemVariant.Code;

      Params.VATProdPostGroup := Item."VAT Prod. Posting Group";

      Params.PrepackSpecific := FALSE;

      IF Params.UnitOfMeasureId = '' THEN
        Params.UnitOfMeasureId := GetItemUOM(Item);

      Params.Price := Item."Unit Price";

      Visible := Item."Visible in Webshop";
      IF Visible AND (ItemVariant.Code <> '') THEN
        Visible := ItemVariant."Visible in Webshop";

      IF Visible THEN BEGIN
        IF NOT CalcMgt.RUN(Params) THEN
          CalcMgt.GetError(Params);
      END;
      EventMgt.OnGetSalesPrice(Params);

      //<TPZ3352>
      IF GetCallForPricetemAttr(Item) = TRUE THEN  BEGIN
         Params.Price := 0;
      END ELSE BEGIN //</TPZ3352>
        ItemDiv.RESET;//<TPZ3099>
        IF ItemDiv.GET(Item."No.") AND (ItemDiv."Shortcut Dimension 5 Code" <> 'L') THEN BEGIN//<TPZ3099>
          //<TPZ2751>

        //<TPZ2751>
         RecMgt.GetCustomer(Params.AccountId,Customer,TRUE);
         LineNo+= 10000;
          SalesLineBuffer.INIT;
          SalesLineBuffer."Document Type" := SalesLineBuffer."Document Type"::Order;
          SalesLineBuffer."Document No." := '111';
          SalesLineBuffer."Line No." := LineNo;
          SalesLineBuffer.INSERT;
          SalesLineBuffer."Sell-to Customer No.":= Customer."No.";
          SalesLineBuffer.Type := SalesLineBuffer.Type::Item;
          SalesLineBuffer.VALIDATE("No.",Item."No.");
          SalesLineBuffer.MODIFY;
          Params.Price := ConvertPriceLCYToFCY(SalesLineBuffer."Recomm. Unit Price");
         // Params.Price := ConvertPriceLCYToFCY(SalesLineBuffer."Unit Price");
        //</TPZ2751>
        END ELSE BEGIN //<TPZ3099>
          RecMgt.GetCustomer(Params.AccountId,Customer,TRUE);
          LastSalesPrice.RESET;
          LastSalesPrice.ASCENDING;
          LastSalesPrice.SETCURRENTKEY("Sell-to Customer No.","Item No.","Document Date");
          LastSalesPrice.SETRANGE("Sell-to Customer No.",Customer."No.");
          LastSalesPrice.SETRANGE("Item No.",Item."No.");
          LastSalesPrice.SETRANGE("Document Type",LastSalesPrice."Document Type"::"Stock Status");
          LastSalesPrice.SETRANGE("Document Date",CALCDATE('-CM-12M',WORKDATE),WORKDATE);
          IF LastSalesPrice.FINDLAST THEN  //BEGIN
            Params.Price := LastSalesPrice."Last Unit Price"
          ELSE
              Params.Price := Item."High Unit Price";
        END;
      END;//<TPZ3352>
          SalesUOMCode := GetItemUOM(Item);
          ItemUOM.RESET;
          ItemUOM.SETRANGE("Item No.",Item."No.");
          //ItemUOM.SETFILTER(Code,'<>%1',SalesUOMCode); //<TPZ3319>
          ItemUOM.SETRANGE("Visible in Webshop",TRUE);
          IF ItemUOM.FINDSET THEN REPEAT
            IF ItemUOM.Code = Params.UnitOfMeasureId THEN BEGIN
             IF ItemUOM."Qty. per Unit of Measure" <> 1 THEN
              Params.Price := Params.Price * ItemUOM."Qty. per Unit of Measure";
            END;
          UNTIL ItemUOM.NEXT = 0;

             EXIT(Params.Price);
           // END;
      //END; //TPZ3099

      //EXIT(Params.Price);//<TPZ3099>
    END;

    PROCEDURE GetAvailableStockForItem@11123336(VAR Params@11123303 : Record 11123310);
    VAR
      ItemRecRef@11123307 : RecordRef;
      ItemFieldRef@11123308 : FieldRef;
      Item@11123305 : Record 27;
      EventMgt@11123302 : Codeunit 11123331;
      RecMgt@11123304 : Codeunit 11123326;
      Context@11123306 : Codeunit 11123305;
      ItemKitBomNo@11123309 : Code[20];
    BEGIN
      Params.Inventory := 0;

      IF Context.IsNorthAmericaLocalization AND Context.SupportsKitBOM THEN BEGIN
        RecMgt.GetItem(Params.ProductId,Item,TRUE);
        ItemRecRef.GETTABLE(Item);
        ItemFieldRef := ItemRecRef.FIELD(25000); // "Kit BOM No."
        ItemKitBomNo := ItemFieldRef.VALUE;
        ItemRecRef.CLOSE;
      END;

      IF STRLEN(ItemKitBomNo) <> 0 THEN
          Params.Inventory := AvailableStockForBOM(Item,Params)
        ELSE
          Params.Inventory :=  AvailableStockForItem(
          Params.ProductId,
          //GetAccountLocationCode(Params), //<TPZ2503>
          GetAccountLocationCodebyDivision(Params),//<TPZ2503>
          Params.UnitOfMeasureId,
          Params.WebsiteId,
          Params.RequestedDeliveryDate);

      EventMgt.OnGetAvailableStock(Params);
    END;

    PROCEDURE AvailableStockForItem@11123337(ItemNo@11123302 : Code[20];LocationCode@11123303 : Code[10];UOMCode@11123305 : Code[10];WebsiteId@11123310 : Code[50];DateFilter@11123311 : Date) : Decimal;
    VAR
      Item@11123304 : Record 27;
      Webshop@11123307 : Record 11123313;
      RecMgt@11123306 : Codeunit 11123326;
      Inventory@11123308 : Decimal;
      QtyPerUOM@11123309 : Decimal;
      BinContent@1000000001 : Record 7302;
      Location@1000000000 : Record 14;
    BEGIN
      RecMgt.GetItem(ItemNo,Item,TRUE);

      IF UOMCode = '' THEN
        UOMCode := GetItemUOM(Item);

      QtyPerUOM := GetQtyPerItemUOM(ItemNo,UOMCode);

      Item.SETRANGE("Location Filter",LocationCode);

      RecMgt.GetWebshop(WebsiteId,Webshop,FALSE);
      CASE Webshop."Inventory Calculation" OF
        Webshop."Inventory Calculation"::"Inventory - Qty. on Sales Orders" :
          BEGIN
            Item.CALCFIELDS(Inventory,"Qty. on Sales Order");
            Inventory := Item.Inventory - Item."Qty. on Sales Order";
          END;
        Webshop."Inventory Calculation"::"Projected Available Balance" :
          BEGIN
            CalcProjectedDateFilter(Webshop,DateFilter);
            Inventory := CalculateProjAvailBalance(Item,DateFilter);
          END;
      END;

      //<TPZ2503>
      //IF Location.GET(LocationCode) AND Location."Bin Mandatory" THEN BEGIN
      IF Location.GET(LocationCode) AND (Location.Type = Location.Type :: "Distribution Center") THEN BEGIN //<TPZ3109>
        Inventory := 0;
        BinContent.RESET;
        BinContent.SETRANGE("Location Code",LocationCode);
        BinContent.SETRANGE("Item No.",ItemNo);
        BinContent.SETFILTER("Bin Type Code",'%1|%2','PICKPUT', 'PICK');
        BinContent.SETFILTER("Block Movement",'<>%1&<>%2',BinContent."Block Movement"::Outbound,BinContent."Block Movement"::All);
        BinContent.SETFILTER("Bin Code", '<>%1&<>%2&<>%3&<>%4', 'RTV','MRB','QA','QC');
        IF BinContent.FINDSET THEN
        REPEAT
          BinContent.CALCFIELDS(Quantity,"Pick Qty.","Neg. Adjmt. Qty.");
          Inventory := Inventory + BinContent.Quantity - BinContent."Pick Qty." - BinContent."Neg. Adjmt. Qty.";
        UNTIL BinContent.NEXT = 0;
      END;
      //</TPZ2503>

      Inventory := ROUND(Inventory / QtyPerUOM,0.00001);
      EXIT(Inventory);
    END;

    PROCEDURE AvailableStockForBOM@1000000003(Item@1000000000 : Record 27;VAR Params@1000000010 : Record 11123310) : Decimal;
    VAR
      ItemRecRef@11123303 : RecordRef;
      ItemFieldRef@11123302 : FieldRef;
      ProdBOMHeader@1000000004 : Record 99000771;
      ProdBOMLine@1000000005 : Record 99000772;
      AvailableInventory@1000000006 : Decimal;
      AvailableInventoryPerQuantity@1000000007 : Decimal;
      MinInventory@1000000008 : Decimal;
      ItemKitBomNo@11123305 : Code[10];
      MinInventoryIsInitialized@1000000009 : Boolean;
      ItemAutoBuildKitBOM@11123304 : Boolean;
    BEGIN
      ItemRecRef.GETTABLE(Item);
      ItemFieldRef := ItemRecRef.FIELD(25000); // "Kit BOM No."
      ItemKitBomNo := ItemFieldRef.VALUE;
      ItemFieldRef := ItemRecRef.FIELD(25010); // "Automatic Build Kit BOM"
      ItemAutoBuildKitBOM := ItemFieldRef.VALUE;
      ItemRecRef.CLOSE;

      IF ItemAutoBuildKitBOM THEN
        IF ProdBOMHeader.GET(ItemKitBomNo) THEN BEGIN
          ProdBOMLine.RESET;
          ProdBOMLine.SETRANGE("Production BOM No.",ProdBOMHeader."No.");
          ProdBOMLine.SETRANGE(Type,ProdBOMLine.Type::Item);
          IF ProdBOMLine.FINDSET THEN BEGIN
            REPEAT
              IF ProdBOMLine."Variant Code" <> '' THEN
                AvailableInventory := AvailableStockForVariant(
                                        ProdBOMLine."No.",
                                        ProdBOMLine."Variant Code",
                                        GetAccountLocationCode(Params),
                                        Params.UnitOfMeasureId,
                                        Params.WebsiteId,
                                        Params.RequestedDeliveryDate)
              ELSE
                AvailableInventory := AvailableStockForItem(
                                        ProdBOMLine."No.",
                                        GetAccountLocationCode(Params),
                                        Params.UnitOfMeasureId,
                                        Params.WebsiteId,
                                        Params.RequestedDeliveryDate);

              AvailableInventoryPerQuantity := AvailableInventory DIV ProdBOMLine."Quantity per";

              IF (NOT MinInventoryIsInitialized) OR (AvailableInventoryPerQuantity < MinInventory) THEN BEGIN
                MinInventoryIsInitialized := TRUE;
                MinInventory := AvailableInventoryPerQuantity;
              END;
            UNTIL ProdBOMLine.NEXT = 0;
            EXIT(MinInventory);
          END;
        END;

      EXIT(AvailableStockForItem(
            Params.ProductId,
            GetAccountLocationCode(Params),
            Params.UnitOfMeasureId,
            Params.WebsiteId,
            Params.RequestedDeliveryDate));
    END;

    PROCEDURE GetAvailableStockForVariant@11123338(VAR Params@11123304 : Record 11123310);
    VAR
      Inventory@11123303 : Decimal;
    BEGIN
      Params.Inventory := 0;
      Inventory :=
        AvailableStockForVariant(
          Params.ProductId,
          Params.VariantId,
          GetAccountLocationCode(Params),
          Params.UnitOfMeasureId,
          Params.WebsiteId,
          Params.RequestedDeliveryDate);
      Params.Inventory := Inventory;
    END;

    PROCEDURE AvailableStockForVariant@11123339(ItemNo@11123302 : Code[20];VariantCode@11123303 : Code[10];LocationCode@11123304 : Code[10];UOMCode@11123306 : Code[10];WebsiteId@11123308 : Code[50];DateFilter@11123312 : Date) : Decimal;
    VAR
      ItemRecRef@11123314 : RecordRef;
      ItemFieldRef@11123316 : FieldRef;
      Item@11123305 : Record 27;
      Webshop@11123311 : Record 11123313;
      RecMgt@11123307 : Codeunit 11123326;
      Context@11123315 : Codeunit 11123305;
      Inventory@11123309 : Decimal;
      QtyPerUOM@11123310 : Decimal;
      QtyOnKitSalesLines@11123313 : Decimal;
      BinContent@1000000001 : Record 7302;
      Location@1000000000 : Record 14;
    BEGIN
      RecMgt.GetItem(ItemNo,Item,TRUE);

      IF UOMCode = '' THEN
        UOMCode := GetItemUOM(Item);

      QtyPerUOM := GetQtyPerItemUOM(ItemNo,UOMCode);

      Item.SETRANGE("Location Filter",LocationCode);
      Item.SETRANGE("Variant Filter",VariantCode);

      RecMgt.GetWebshop(WebsiteId,Webshop,FALSE);
      CASE Webshop."Inventory Calculation" OF
        Webshop."Inventory Calculation"::"Inventory - Qty. on Sales Orders" :
          BEGIN
            IF Context.IsNorthAmericaLocalization AND Context.SupportsKitBOM THEN BEGIN
              ItemRecRef.GETTABLE(Item);
              ItemFieldRef := ItemRecRef.FIELD(25008); //"Qty. on Kit Sales Lines"
              ItemFieldRef.CALCFIELD;
              QtyOnKitSalesLines := ItemFieldRef.VALUE;
              ItemRecRef.CLOSE;
            END;

            Item.CALCFIELDS(Inventory,"Qty. on Sales Order");
            Inventory := Item.Inventory - Item."Qty. on Sales Order" - QtyOnKitSalesLines;
          END;
        Webshop."Inventory Calculation"::"Projected Available Balance" :
          BEGIN
            CalcProjectedDateFilter(Webshop,DateFilter);
            Inventory := CalculateProjAvailBalance(Item,DateFilter);
          END;
      END;

      //<TPZ2503>
      //IF Location.GET(LocationCode) AND Location."Bin Mandatory" THEN BEGIN
      IF Location.GET(LocationCode) AND (Location.Type = Location.Type :: "Distribution Center") THEN BEGIN //<TPZ3109>
        Inventory := 0;
        BinContent.RESET;
        BinContent.SETRANGE("Location Code",LocationCode);
        BinContent.SETRANGE("Item No.",ItemNo);
        BinContent.SETFILTER("Bin Type Code",'%1|%2','PICKPUT', 'PICK');
        BinContent.SETFILTER("Block Movement",'<>%1&<>%2',BinContent."Block Movement"::Outbound,BinContent."Block Movement"::All);
        BinContent.SETFILTER("Bin Code", '<>%1&<>%2&<>%3&<>%4', 'RTV','MRB','QA','QC');
        IF BinContent.FINDSET THEN
        REPEAT
          BinContent.CALCFIELDS(Quantity,"Pick Qty.","Neg. Adjmt. Qty.");
          Inventory := Inventory + BinContent.Quantity - BinContent."Pick Qty." - BinContent."Neg. Adjmt. Qty.";
        UNTIL BinContent.NEXT = 0;
      END;
      //TPZ2503

      Inventory := ROUND(Inventory / QtyPerUOM,0.00001);
      EXIT(Inventory);
    END;

    PROCEDURE GetAvailableStockForPrepack@11123340(ItemNo@11123302 : Code[20];PrepackCode@11123303 : Code[20];VerticalCode@11123304 : Code[10];VAR Params@11123305 : Record 11123310) : Decimal;
    BEGIN
      EXIT(
        AvailableStockForPrepack(
          ItemNo,PrepackCode,VerticalCode,GetAccountLocationCode(Params),Params.WebsiteId,Params.RequestedDeliveryDate));
    END;

    PROCEDURE AvailableStockForPrepack@11123341(ItemNo@11123302 : Code[20];PrepackCode@11123303 : Code[20];VerticalCode@11123304 : Code[10];LocationCode@11123305 : Code[10];WebsiteId@11123312 : Code[50];DateFilter@11123313 : Date) : Decimal;
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE AvailableStockPrepackVariant@11123342(VAR PrepackVariant@11123302 : Record 5401;LocationCode@11123303 : Code[10]) : Decimal;
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE IsItemOrderable@11123344(Item@11123302 : Record 27;PerformRefresh@11123305 : Boolean;VAR Params@11123304 : Record 11123310) : Boolean;
    VAR
      ProductInfo@11123303 : Record 11123317;
      Orderable@11123306 : Boolean;
      NonOrderableReason@11123307 : Text[250];
    BEGIN
      ProductInfo.SETRANGE("Item No.",Item."No.");
      IF ProductInfo.ISEMPTY THEN
        IF PerformRefresh THEN
          RefreshProductInfo(Item,0,TRUE,Params)
        ELSE BEGIN
          Orderable := TestItem(Item,NonOrderableReason,FALSE);
          EXIT(Orderable);
        END;

      IF ProductInfo.GET(Item."No.") THEN
        EXIT(ProductInfo.Orderable);
    END;

    PROCEDURE IsItemVariantOrderable@11123348(ItemVariant@11123302 : Record 5401;PerformRefresh@11123305 : Boolean;VAR Params@11123304 : Record 11123310) : Boolean;
    VAR
      VariantInfo@11123303 : Record 11123318;
      Orderable@11123306 : Boolean;
      NonOrderableReason@11123307 : Text[250];
    BEGIN
      VariantInfo.SETRANGE("Item No.",ItemVariant."Item No.");
      VariantInfo.SETRANGE("Variant Code",ItemVariant.Code);
      IF VariantInfo.ISEMPTY THEN
        IF PerformRefresh THEN
          RefreshVariantInfo(ItemVariant,0,TRUE,Params)
        ELSE BEGIN
          Orderable := TestVariant(ItemVariant,NonOrderableReason,FALSE);
          EXIT(Orderable);
        END;

      IF VariantInfo.GET(ItemVariant."Item No.",ItemVariant.Code) THEN
        EXIT(VariantInfo.Orderable);
    END;

    PROCEDURE IsOrderableByStock@11123343(Inventory@11123302 : Decimal;VAR CalcOrderable@11123304 : Boolean;VAR CalcNonOrderableReason@11123306 : Text[250];VAR Params@11123303 : Record 11123310);
    BEGIN
      IF Params.CheckStock AND
         CalcOrderable
      THEN BEGIN
        CalcOrderable := IsOrderableRule(Inventory);
        IF NOT CalcOrderable THEN
          CalcNonOrderableReason := Text11123353;
      END;
    END;

    PROCEDURE IsOrderableRule@11123349(Inventory@11123302 : Decimal) : Boolean;
    BEGIN
      EXIT(Inventory > 0);
    END;

    PROCEDURE IsPrepackVariantOrderable@11123350(PrepackVariant@11123302 : Record 5401;VAR Params@11123304 : Record 11123310) : Boolean;
    VAR
      Orderable@11123303 : Boolean;
    BEGIN
      Orderable := IsItemVariantOrderable(PrepackVariant,FALSE,Params);
      IF (NOT IsPrepackCodeToInventory) AND Orderable THEN
        Orderable := ArePrepackVariantsOrderable(PrepackVariant,Params);

      EXIT(Orderable);
    END;

    PROCEDURE ArePrepackVariantsOrderable@11123351(PrepackVariant@11123302 : Record 5401;VAR Params@11123306 : Record 11123310) : Boolean;
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    LOCAL PROCEDURE IsOrderableByPfsItemStatus@11123352(ItemStatusCode@11123302 : Code[10];CheckFor@11123303 : Text[1024]) : Boolean;
    BEGIN
      EXIT(TRUE); // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE GetAccountLocationCode@11123353(VAR Params@11123302 : Record 11123310) : Code[10];
    VAR
      Customer@11123303 : Record 18;
      Webshop@11123307 : Record 11123313;
      RecMgt@11123306 : Codeunit 11123326;
      CustomerFunc@11123304 : Codeunit 11123313;
      ContactNo@11123305 : Code[20];
    BEGIN
      IF RecMgt.GetWebshop(Params.WebsiteId,Webshop,FALSE) THEN
        IF Webshop."Location Code Source" = Webshop."Location Code Source"::Webshop THEN
          EXIT(Webshop."Location Code");

      IF (Params.AccountId <> '') AND (Params.AccountType <> '') THEN
        IF CustomerFunc.IsAccountCustomer(Params.AccountType) THEN BEGIN
          IF RecMgt.GetCustomer(Params.AccountId,Customer,FALSE) THEN
            EXIT(Customer."Location Code");
        END ELSE BEGIN
          ContactNo := Params.AccountId;
          IF CustomerFunc.GetRelatedCustByContNo(ContactNo,Customer) THEN
            EXIT(Customer."Location Code");
        END;
    END;

    PROCEDURE GetItemPriceByCurrency@11123354(Item@11123302 : Record 27;CurrencyCode@11123303 : Code[10];VAR Params@11123310 : Record 11123310) : Decimal;
    VAR
      CalcMgt@11123304 : Codeunit 11123325;
    BEGIN
      Params.CalcFunction := 'CalcItemPriceByCurrency';
      Params.ProductId := Item."No.";
      Params.CurrentCurrencyId := CurrencyCode;
      IF Params.UnitOfMeasureId = '' THEN
        Params.UnitOfMeasureId := GetItemUOM(Item);

      IF NOT CalcMgt.RUN(Params) THEN;

      EXIT(Params.Price);
    END;

    PROCEDURE GetUnitPriceByCurrencyAndVAT@11123361(ItemNo@11123308 : Code[20];CurrentPrice@11123302 : Decimal;PriceIncludesVAT@11123303 : Boolean;VATProdPostingGroup@11123304 : Code[10];VATBusPostingGroupPrice@11123305 : Code[10];VAR Params@11123306 : Record 11123310) : Decimal;
    VAR
      CalcMgt@11123307 : Codeunit 11123325;
      EventMgt@11123309 : Codeunit 11123331;
    BEGIN
      Params.CalcFunction := 'CalcUnitPriceByCurrencyAndVAT';
      Params.ProductId := ItemNo;
      Params.Price := CurrentPrice;
      IF Params.CalcOrderable THEN BEGIN
        Params.PriceIncludesVAT := PriceIncludesVAT;
        Params.VATProdPostGroup := VATProdPostingGroup;
        Params.VATBusPostGroup := VATBusPostingGroupPrice;

        IF NOT CalcMgt.RUN(Params) THEN
          CalcMgt.GetError(Params);
      END;

      EventMgt.OnGetListPrice(Params);

      EXIT(Params.Price);
    END;

    PROCEDURE GetProductOrVariantDescription@11123302(ItemNo@11123302 : Code[20];VariantCode@11123303 : Code[10];VAR Params@11123304 : Record 11123310) : Text[1024];
    VAR
      Item@11123306 : Record 27;
      ItemVariant@11123307 : Record 5401;
      ItemTranslation@11123308 : Record 30;
      RecMgt@11123311 : Codeunit 11123326;
      Description1@11123309 : Text[1024];
      Description2@11123310 : Text[1024];
      DescriptionNo@11123305 : Integer;
    BEGIN
      IF ItemTranslation.GET(ItemNo,VariantCode,Params.LanguageId) THEN BEGIN
        Description1 := ItemTranslation.Description;
        Description2 := ItemTranslation."Description 2";
        IF Context.LsAddonIsUsed THEN
          Description2 := Description1;
      END ELSE
        IF VariantCode <> '' THEN BEGIN
          IF RecMgt.GetItemVariant(ItemNo,VariantCode,ItemVariant,FALSE) THEN BEGIN
            Description1 := ItemVariant.Description;
            Description2 := ItemVariant."Description 2";
          END;
        END ELSE BEGIN
          IF RecMgt.GetItem(ItemNo,Item,FALSE) THEN BEGIN
            Description1 := Item.Description;
            Description2 := Item."Description 2";
          END;
        END;

      DescriptionNo := Params.ItemDescriptionNo;
      IF VariantCode <> '' THEN
        DescriptionNo := Params.VariantDescriptionNo;

      CASE DescriptionNo OF
        1 : EXIT(Description1);
        2 : EXIT(Description2);
      END;
    END;

    PROCEDURE GetCategoryDescription@11123306(Category@11123302 : Record 5722;LanguageCode@11123303 : Code[10]) : Text[250];
    VAR
      Trans@11123304 : Record 11123306;
    BEGIN
      IF Trans.GET(DATABASE::"Item Category",Category.Code,'','',LanguageCode) THEN
        EXIT(Trans.Description);
      EXIT(Category.Description);
    END;

    PROCEDURE GetProductGroupDescription@11123307(Group@11123302 : Record 5723;LanguageCode@11123303 : Code[10]) : Text[250];
    VAR
      Trans@11123304 : Record 11123306;
    BEGIN
      IF Trans.GET(DATABASE::"Product Group", Group."Item Category Code",Group.Code,'',LanguageCode) THEN
        EXIT(Trans.Description);
      EXIT(Group.Description);
    END;

    PROCEDURE GetUOMDescription@11123377(UOMCode@11123302 : Code[10];LanguageCode@11123303 : Code[10]) : Text[1024];
    VAR
      UOMTranslation@11123304 : Record 5402;
      UOM@11123305 : Record 204;
      RecMgt@11123307 : Codeunit 11123326;
      Description@11123306 : Text[1024];
    BEGIN
      IF UOMCode = '' THEN
        EXIT;

        Description := UOMCode;
        IF RecMgt.GetUOM(UOMCode,UOM,FALSE) THEN BEGIN
          Description := UOM.Description;
          IF UOMTranslation.GET(UOMCode,LanguageCode) THEN
            Description := UOMTranslation.Description;
        END;

      EXIT(Description);
    END;

    PROCEDURE GetVariantDescription@11123333(ItemVariant@11123302 : Record 5401;LanguageCode@11123303 : Code[10];DescriptionNo@11123304 : Integer) : Text[250];
    VAR
      ItemTranslation@11123305 : Record 30;
      Description@11123306 : Text[250];
    BEGIN
      IF DescriptionNo = 1 THEN
        Description := ItemVariant.Description
      ELSE
        Description := ItemVariant."Description 2";

      IF ItemTranslation.GET(ItemVariant."Item No.",ItemVariant.Code,LanguageCode) THEN BEGIN
        IF DescriptionNo = 1 THEN
          Description := ItemTranslation.Description
        ELSE
          Description := ItemTranslation."Description 2";
      END;
      EXIT(Description);
    END;

    PROCEDURE AddProductTranslations@11123365(VAR RootNodeBuff@11123302 : Record 11123303;ItemNo@11123303 : Code[20];VariantCode@11123304 : Code[10];FieldName@11123309 : Text[1024]);
    VAR
      Languages@11123305 : Record 8;
      ItemTranslation@11123306 : Record 30;
      FieldKey@11123308 : Text[1024];
    BEGIN
      ItemTranslation.RESET;
      ItemTranslation.SETRANGE("Item No.",ItemNo);
      ItemTranslation.SETRANGE("Variant Code",VariantCode);
      IF ItemTranslation.FINDSET THEN
        REPEAT
          IF Languages.GET(ItemTranslation."Language Code") THEN BEGIN
            FieldKey := STRSUBSTNO('%1_%2',FieldName,Languages."Windows Language ID");
            RootNodeBuff.AddFieldElement(FieldKey,ItemTranslation.Description);
          END;
        UNTIL ItemTranslation.NEXT = 0;
    END;

    PROCEDURE AddFieldTranslations@11123367(VAR RootNodeBuff@11123302 : Record 11123303;TableNo@11123303 : Integer;"Key 1"@11123304 : Code[20];"Key 2"@11123305 : Code[20];"Key 3"@11123306 : Code[20];FieldName@11123307 : Text[1024]);
    VAR
      Translation@11123308 : Record 11123306;
    BEGIN
      Translation.SETRANGE(Table,TableNo);
      Translation.SETRANGE("Key 1","Key 1");
      Translation.SETRANGE("Key 2","Key 2");
      Translation.SETRANGE("Key 3","Key 3");
      AddTranslationsXml(RootNodeBuff,Translation,FieldName);
    END;

    PROCEDURE AddTranslationsXml@11123368(VAR RootNodeBuff@11123302 : Record 11123303;VAR Translation@11123303 : Record 11123306;FieldName@11123304 : Text[1024]);
    VAR
      Languages@11123305 : Record 8;
      FieldKey@11123307 : Text[1024];
    BEGIN
      IF Translation.FINDSET THEN
        REPEAT
          IF Languages.GET(Translation."Language Code") THEN BEGIN
            FieldKey := STRSUBSTNO('%1_%2',FieldName,Languages."Windows Language ID");
            RootNodeBuff.AddFieldElement(FieldKey,Translation.Description);
          END;
        UNTIL Translation.NEXT = 0;
    END;

    PROCEDURE AddVarComponentTranslations@11123369(VAR RootNodeBuff@11123302 : Record 11123303;ComponentTableNo@11123303 : Integer;ItemComponentTableNo@11123304 : Integer;ItemNo@11123305 : Code[20];ComponentGroup@11123306 : Code[10];ComponentCode@11123307 : Code[10];ComponentFieldName@11123308 : Text[1024]);
    VAR
      TempTranslation@11123309 : TEMPORARY Record 11123306;
    BEGIN
      GatherTranslations(ComponentTableNo,ComponentGroup,ComponentCode,'',TempTranslation);
      GatherTranslations(ItemComponentTableNo,ItemNo,ComponentGroup,ComponentCode,TempTranslation);
      AddTranslationsXml(RootNodeBuff,TempTranslation,ComponentFieldName);
    END;

    PROCEDURE GatherTranslations@11123370(TableNo@11123302 : Integer;Key1@11123303 : Code[20];Key2@11123304 : Code[20];Key3@11123305 : Code[20];VAR ToTranslation@11123306 : Record 11123306);
    VAR
      Translation@11123307 : Record 11123306;
    BEGIN
      Translation.SETRANGE(Table,TableNo);
      Translation.SETRANGE("Key 1",Key1);
      Translation.SETRANGE("Key 2",Key2);
      Translation.SETRANGE("Key 3",Key3);
      IF Translation.FINDSET THEN
        REPEAT
          ToTranslation.INIT;
          ToTranslation."Language Code" := Translation."Language Code";
          ToTranslation.Description := Translation.Description;
          IF ToTranslation.INSERT THEN;
        UNTIL Translation.NEXT = 0;
    END;

    PROCEDURE GetVatPercentage@11123371("Item VAT Posting Group"@11123302 : Code[10];VAR Params@11123303 : Record 11123310) : Decimal;
    VAR
      Customer@11123304 : Record 18;
      VATSetup@11123305 : Record 325;
      Contact@11123307 : Record 5050;
      CustomerTemplate@11123308 : Record 5105;
      RecMgt@11123306 : Codeunit 11123326;
      CustomerFunc@11123311 : Codeunit 11123313;
      BusPostingGroup@11123310 : Code[10];
    BEGIN
      IF NOT Params.CalculatePrices THEN
        EXIT(0);

      CustomerFunc.TestAccountType(Params);

      CASE Params.AccountType OF
        'Customer' :
          BEGIN
            RecMgt.GetCustomer(Params.AccountId,Customer,TRUE);
            BusPostingGroup := Customer."VAT Bus. Posting Group";
          END;
        'Contact' :
          BEGIN
            RecMgt.GetContact(Params.AccountId,Contact,TRUE);
            CustomerFunc.TestContact(Contact,TRUE);
            RecMgt.GetCustomerTemplate(Contact."Customer Template Code",CustomerTemplate,TRUE);
            BusPostingGroup := CustomerTemplate."VAT Bus. Posting Group";
          END;
      END;

      IF RecMgt.GetVATSetup(BusPostingGroup,"Item VAT Posting Group",VATSetup,FALSE) THEN
        EXIT(VATSetup."VAT %");
    END;

    PROCEDURE AddProductExtendedTexts@11123372(VAR ResultNodeBuff@11123302 : Record 11123303;VAR Params@11123303 : Record 11123310;ItemNo@11123304 : Code[20]);
    VAR
      ExtTextHeader@11123305 : Record 279;
      ExtTextLine@11123306 : Record 280;
      Languages@11123310 : Record 8;
      LanguageLCID@11123309 : Text[10];
      LineExpression@11123312 : Text[50];
      Expression@11123308 : Text[1024];
      LengthExpression@11123311 : Integer;
    BEGIN
      ExtTextHeader.SETCURRENTKEY(
        "Table Name","No.","Language Code","All Language Codes","Starting Date","Ending Date");
      ExtTextHeader.SETRANGE("No.",ItemNo);
      ExtTextHeader.SETRANGE("Starting Date",0D,TODAY);
      ExtTextHeader.SETFILTER("Ending Date",'%1..|%2',TODAY,0D);
      ExtTextHeader.SETRANGE("Visible in Webshop",TRUE);
      IF ExtTextHeader.FINDSET THEN BEGIN
        REPEAT
          IF ExtTextHeader."All Language Codes" OR (ExtTextHeader."Language Code" <> '') THEN BEGIN
            IF Languages.GET(ExtTextHeader."Language Code") THEN
              LanguageLCID := FORMAT(Languages."Windows Language ID")
            ELSE
              LanguageLCID := '';

            LineExpression := '';
            Expression := '';

            ExtTextLine.SETRANGE("Table Name",ExtTextHeader."Table Name");
            ExtTextLine.SETRANGE("No.",ExtTextHeader."No.");
            ExtTextLine.SETRANGE("Language Code",ExtTextHeader."Language Code");
            ExtTextLine.SETRANGE("Text No.",ExtTextHeader."Text No.");
            IF ExtTextLine.FINDSET THEN BEGIN
              REPEAT
                LineExpression := ExtTextLine.Text;
                LengthExpression := 1024;
                IF LengthExpression >= (STRLEN(Expression) + STRLEN(LineExpression) + STRLEN(' ')) THEN BEGIN
                  IF Expression = '' THEN
                    Expression := LineExpression
                  ELSE
                    Expression := Expression + ' ' + LineExpression;
                END;
              UNTIL ExtTextLine.NEXT = 0;

              IF ExtTextHeader."Language Code" = '' THEN
                ResultNodeBuff.AddFieldElement('Description',Expression)
              ELSE
                ResultNodeBuff.AddFieldElement(STRSUBSTNO('Description_%1',LanguageLCID),Expression);
            END;
          END;
        UNTIL ExtTextHeader.NEXT = 0;
      END;
    END;

    PROCEDURE AddMultiCurrencyPrices@11123366(VAR XMLNodeBuff@11123302 : Record 11123303;ItemVariant@11123321 : Record 5401;VAR CurrencyList@11123313 : Record 11123330;VAR CalcValuesInfo@11123318 : Record 11123319;VAR Params@11123304 : Record 11123310);
    BEGIN
      IF NOT CalculateMultiCurrencyPrices(Params) THEN
        EXIT;

      CurrencyList.RESET;
      GetCalcValues(CalcValuesInfo,CurrencyList,ItemVariant,Params);

      CalcValuesInfo.RESET;
      CalcValuesInfo.SETRANGE("Variant Code",ItemVariant.Code);
      IF CalcValuesInfo.FINDSET THEN
          REPEAT
          XMLNodeBuff.AddFieldNameValueTypeElement(
            STRSUBSTNO('Price_%1',CalcValuesInfo."Currency ISO Code"),FORMAT(CalcValuesInfo."Unit Price"),'Decimal');
        UNTIL CalcValuesInfo.NEXT = 0;
    END;

    LOCAL PROCEDURE CalculateMultiCurrencyPrices@11123314(VAR Params@11123303 : Record 11123310) : Boolean;
    BEGIN
      EXIT(Params.MultiCurrency  AND Params.ProductOrderable);
    END;

    PROCEDURE CreateVerticalComponentInfoXml@11123373();
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE CreateHorzComponentInfoXml@11123381();
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE RefreshProductInfo@11123374(Item@11123302 : Record 27;Action@11123305 : 'Read,Insert,Modify,Delete,Rename';CommitChanges@11123307 : Boolean;VAR Params@11123306 : Record 11123310);
    VAR
      ProductInfo@11123303 : Record 11123317;
      Exists@11123304 : Boolean;
    BEGIN
      CLEAR(ProductInfo);

      Exists := ProductInfo.GET(Item."No.");
      IF Exists AND (Action IN [Action::Delete,Action::Rename]) THEN
        ProductInfo.DELETE(TRUE);

      IF Action IN [Action::Delete,Action::Rename] THEN
        EXIT;

      ProductInfo.TRANSFERFIELDS(Item,FALSE);
      ProductInfo."Item No." := Item."No.";

      ProductInfo.Orderable := TestItem(Item,ProductInfo."Non Orderable Reason",FALSE);

      IF ProductInfo.Orderable THEN
        ProductInfo."Non Orderable Reason" := '';

      IF Exists THEN
        ProductInfo.MODIFY
      ELSE
        ProductInfo.INSERT;

      IF CommitChanges THEN
        COMMIT;
    END;

    PROCEDURE RefreshVariantInfo@11123376(ItemVariant@11123304 : Record 5401;Action@11123303 : 'Read,Insert,Modify,Delete,Rename';CommitChanges@11123307 : Boolean;VAR Params@11123302 : Record 11123310);
    VAR
      VariantInfo@11123306 : Record 11123318;
      Exists@11123305 : Boolean;
    BEGIN
      CLEAR(VariantInfo);

      Exists := VariantInfo.GET(ItemVariant."Item No.",ItemVariant.Code);
      IF Exists AND (Action IN [Action::Delete,Action::Rename]) THEN
        VariantInfo.DELETE(TRUE);

      IF Action IN [Action::Delete,Action::Rename] THEN
        EXIT;

      VariantInfo."Item No." := ItemVariant."Item No.";
      VariantInfo."Variant Code" := ItemVariant.Code;
      VariantInfo.Description := ItemVariant.Description;
      VariantInfo."Description 2" := ItemVariant."Description 2";
      VariantInfo."Visible in Webshop" := ItemVariant."Visible in Webshop";

      VariantInfo.Orderable := TestVariant(ItemVariant,VariantInfo."Non Orderable Reason",FALSE);

      IF VariantInfo.Orderable THEN
        VariantInfo."Non Orderable Reason" := '';

      IF Exists THEN
        VariantInfo.MODIFY
      ELSE
        VariantInfo.INSERT;

      IF CommitChanges THEN
        COMMIT;
    END;

    PROCEDURE AddOrderableFieldElementsToXml@11123334(VAR ResultNodeBuff@11123302 : Record 11123303;ItemNo@11123303 : Code[20];VariantCode@11123304 : Code[10];Orderable@11123305 : Boolean;CalcOrderable@11123306 : Boolean;CalcNonOrderableReason@11123307 : Text[250]);
    BEGIN
      DefineIsOrderableByPriority(ItemNo,VariantCode,Orderable,CalcOrderable,CalcNonOrderableReason);
      ResultNodeBuff.AddFieldElement('IsOrderable',FORMAT(CalcOrderable,0,2));
      IF NOT CalcOrderable AND (CalcNonOrderableReason <> '') THEN
        ResultNodeBuff.AddFieldElement('NonOrderableReason',CalcNonOrderableReason);
    END;

    PROCEDURE AddOrderableElementsToXml@11123315(VAR ResultNodeBuff@11123302 : Record 11123303;VAR OutXmlNodeBuff@11123303 : Record 11123303;ItemNo@11123304 : Code[20];VariantCode@11123305 : Code[10];Orderable@11123306 : Boolean;CalcOrderable@11123307 : Boolean;CalcNonOrderableReason@11123308 : Text[250]);
    BEGIN
      DefineIsOrderableByPriority(ItemNo,VariantCode,Orderable,CalcOrderable,CalcNonOrderableReason);
      ResultNodeBuff.AddElement(OutXmlNodeBuff,'IsOrderable',FORMAT(CalcOrderable,0,2));
      IF NOT CalcOrderable AND (CalcNonOrderableReason <> '') THEN
        ResultNodeBuff.AddElement(OutXmlNodeBuff,'NonOrderableReason',CalcNonOrderableReason);
    END;

    LOCAL PROCEDURE DefineIsOrderableByPriority@11123335(ItemNo@11123302 : Code[20];VariantCode@11123303 : Code[10];Orderable@11123304 : Boolean;VAR CalcOrderable@11123305 : Boolean;VAR CalcNonOrderableReason@11123306 : Text[250]);
    VAR
      ProductInfo@11123307 : Record 11123317;
      VariantInfo@11123308 : Record 11123318;
      OrderableToXml@11123309 : Boolean;
      NonOrderableReasonToXml@11123310 : Text[250];
    BEGIN
      OrderableToXml := TRUE;
      NonOrderableReasonToXml := '';

      IF NOT CalcOrderable THEN BEGIN
        OrderableToXml := CalcOrderable;
        NonOrderableReasonToXml := CalcNonOrderableReason;
      END;

      IF NOT Orderable THEN BEGIN
        OrderableToXml := Orderable;
        CASE TRUE OF
          VariantCode = '' :
            IF ProductInfo.GET(ItemNo) THEN
              NonOrderableReasonToXml := ProductInfo."Non Orderable Reason";
          VariantCode <> '' :
            IF VariantInfo.GET(ItemNo,VariantCode) THEN
              NonOrderableReasonToXml := VariantInfo."Non Orderable Reason"
        END;
      END;

      CalcOrderable := OrderableToXml;
      CalcNonOrderableReason := NonOrderableReasonToXml;

      IF NOT CalcOrderable THEN
        IF CalcNonOrderableReason = '' THEN
          CalcNonOrderableReason := Text11123354;
    END;

    LOCAL PROCEDURE AddPhysicalDimensionsToXml@11123383(VAR ResultNodeBuff@11123302 : Record 11123303;Weight@11123306 : Decimal;Length@11123305 : Decimal;Width@11123304 : Decimal;Height@11123303 : Decimal);
    BEGIN
      ResultNodeBuff.AddFieldElement('GrossWeight',FORMAT(Weight));
      ResultNodeBuff.AddFieldElement('Length',FORMAT(Length));
      ResultNodeBuff.AddFieldElement('Width',FORMAT(Width));
      ResultNodeBuff.AddFieldElement('Height',FORMAT(Height));
    END;

    PROCEDURE AddItemPhysicalDimensionsToXml@11123328(VAR ResultNodeBuff@11123302 : Record 11123303;ItemNo@11123303 : Code[20];UOMCode@11123304 : Code[10]);
    VAR
      Weight@11123307 : Decimal;
      Length@11123308 : Decimal;
      Width@11123309 : Decimal;
      Height@11123310 : Decimal;
    BEGIN
      GetItemPhysicalDimensions(ItemNo,UOMCode,Weight,Length,Width,Height);
      AddPhysicalDimensionsToXml(ResultNodeBuff,Weight,Length,Width,Height);
    END;

    PROCEDURE GetItemPhysicalDimensions@11123330(ItemNo@11123302 : Code[20];UOMCode@11123303 : Code[10];VAR Weight@11123307 : Decimal;VAR Length@11123306 : Decimal;VAR Width@11123305 : Decimal;VAR Height@11123304 : Decimal);
    VAR
      ItemUnitOfMeasure@11123308 : Record 5404;
    BEGIN
      IF ItemUnitOfMeasure.GET(ItemNo,UOMCode) THEN BEGIN
        Weight := ItemUnitOfMeasure.Weight;
        Length := ItemUnitOfMeasure.Length;
        Width := ItemUnitOfMeasure.Width;
        Height := ItemUnitOfMeasure.Height;
      END;
    END;

    PROCEDURE GetItemUOM@11123345(Item@11123302 : Record 27) : Code[10];
    VAR
      WebshopDefaultUOM@1000000000 : Code[10];
    BEGIN
      //<TPZ3319>
      WebshopDefaultUOM := GetWebShopDefaultUOM(Item);
      IF WebshopDefaultUOM <> '' THEN
        EXIT(WebshopDefaultUOM);
      //</TPZ3319>

      IF Item."Sales Unit of Measure" <> '' THEN
        EXIT(Item."Sales Unit of Measure");
      EXIT(Item."Base Unit of Measure");
    END;

    PROCEDURE AddPrepackPhysicalDimToXml@11123347(VAR ResultNodeBuff@11123304 : Record 11123303;ItemNo@11123303 : Code[20];PrepackCode@11123305 : Code[20]);
    VAR
      Weight@11123309 : Decimal;
      Length@11123308 : Decimal;
      Width@11123307 : Decimal;
      Height@11123306 : Decimal;
    BEGIN
      GetPrepackPhysicalDim(ItemNo,PrepackCode,Weight,Length,Width,Height);
      AddPhysicalDimensionsToXml(ResultNodeBuff,Weight,Length,Width,Height);
    END;

    PROCEDURE GetPrepackPhysicalDim@11123356(ItemNo@11123302 : Code[20];PrepackCode@11123303 : Code[20];VAR Weight@11123307 : Decimal;VAR Length@11123306 : Decimal;VAR Width@11123305 : Decimal;VAR Height@11123304 : Decimal);
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE GetCartonTypeSize@11123386(CartonTypeCode@11123302 : Code[10];VAR Length@11123305 : Decimal;VAR Width@11123304 : Decimal;VAR Height@11123303 : Decimal);
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE TestAddonItemStatus@11123346(RecRef@11123302 : RecordRef;VAR ErrorText@11123308 : Text[250]) : Boolean;
    VAR
      ParamsLocal@11123309 : TEMPORARY Record 11123310;
      CommonFunc@11123304 : Codeunit 11123309;
      Dispatcher@11123305 : Codeunit 11123306;
      TableNumber@11123303 : Integer;
      TestSucceed@11123307 : Boolean;
    BEGIN
      TestSucceed := TRUE;
      TableNumber := CommonFunc.GetCorrectTableNoFromRecRef(RecRef);

      ParamsLocal.InitializeEmptyParams;

      CASE TableNumber OF
        DATABASE::Item :
          BEGIN
            ParamsLocal.ProductId := CommonFunc.GetFieldValueByNo(RecRef,1);

            Dispatcher.DispatchInternal('TestItemStatus',ParamsLocal);

            TestSucceed := ParamsLocal.CalcOrderable;
            ErrorText := ParamsLocal.CalcErrorText;
          END;
        DATABASE::"Item Variant" :
          BEGIN
            ParamsLocal.VariantId := CommonFunc.GetFieldValueByNo(RecRef,1);
            ParamsLocal.ProductId := CommonFunc.GetFieldValueByNo(RecRef,2);

            Dispatcher.DispatchInternal('TestItemStatus',ParamsLocal);

            TestSucceed := ParamsLocal.CalcOrderable;
            ErrorText := ParamsLocal.CalcErrorText;
          END;
      END;

      EXIT(TestSucceed);
    END;

    LOCAL PROCEDURE TestItemStatus@11123329(VAR Params@11123302 : Record 11123310);
    VAR
      Item@11123305 : Record 27;
      ItemVariant@11123304 : Record 5401;
      RecMgt@11123303 : Codeunit 11123326;
    BEGIN
      Params.CalcErrorText := '';
      Params.CalcOrderable := TRUE;

      IF Params.VariantId <> '' THEN BEGIN
        IF RecMgt.GetItemVariant(Params.ProductId,Params.VariantId,ItemVariant,FALSE) THEN
          Params.CalcOrderable := IsOrderableByPfsItemStatus('','2');
      END ELSE BEGIN
        IF RecMgt.GetItem(Params.ProductId,Item,FALSE) THEN
          Params.CalcOrderable := IsOrderableByPfsItemStatus('','2');
      END;

      IF NOT Params.CalcOrderable THEN
        Params.CalcErrorText := Text11123352;
    END;

    PROCEDURE TestItem@11123355(Item@11123302 : Record 27;VAR ErrorText@11123306 : Text[250];ShowError@11123303 : Boolean) : Boolean;
    VAR
      Validation@11123304 : Codeunit 11123310;
      RecRef@11123305 : RecordRef;
      TestSucceed@11123307 : Boolean;
    BEGIN
      RecRef.GETTABLE(Item);
      TestSucceed := Validation.RunValidationTests(RecRef,ErrorText);
      IF NOT TestSucceed AND ShowError THEN
        ERROR(ErrorText);
      EXIT(TestSucceed);
    END;

    PROCEDURE TestVariant@11123357(ItemVariant@11123304 : Record 5401;VAR ErrorText@11123302 : Text[250];ShowError@11123303 : Boolean) : Boolean;
    VAR
      RecRef@11123305 : RecordRef;
      Validation@11123306 : Codeunit 11123310;
      TestSucceed@11123307 : Boolean;
    BEGIN
      RecRef.GETTABLE(ItemVariant);
      TestSucceed := Validation.RunValidationTests(RecRef,ErrorText);
      IF NOT TestSucceed AND ShowError THEN
        ERROR(ErrorText);
      EXIT(TestSucceed);
    END;

    PROCEDURE TestKitBOM@1000000000(RecRef@11123302 : RecordRef;VAR ErrorText@11123308 : Text[250]) : Boolean;
    VAR
      Item@11123303 : Record 27;
      CommonFunc@11123306 : Codeunit 11123309;
      TableNumber@11123305 : Integer;
      TestSucceed@11123307 : Boolean;
    BEGIN
      TestSucceed := TRUE;
      TableNumber := CommonFunc.GetCorrectTableNoFromRecRef(RecRef);
      IF TableNumber = DATABASE::Item THEN BEGIN
        RecRef.SETTABLE(Item);
        TestSucceed := CheckKitBOMComponentsOrderable(Item,ErrorText);
      END;

      EXIT(TestSucceed);
    END;

    PROCEDURE TestItemUOM@11123384(RecRef@11123302 : RecordRef;VAR ErrorText@11123308 : Text[250]) : Boolean;
    VAR
      Item@11123306 : Record 27;
      CommonFunc@11123305 : Codeunit 11123309;
      TableNumber@11123304 : Integer;
      TestSucceed@11123303 : Boolean;
    BEGIN
      TestSucceed := TRUE;
      TableNumber := CommonFunc.GetCorrectTableNoFromRecRef(RecRef);
      IF TableNumber = DATABASE::Item THEN BEGIN
        RecRef.SETTABLE(Item);
        TestSucceed := CheckItemUOM(Item,ErrorText);
      END;

      EXIT(TestSucceed);
    END;

    PROCEDURE CheckItemUOM@11123390(Item@11123305 : Record 27;VAR ErrorText@11123306 : Text[250]) : Boolean;
    VAR
      OriginalItem@11123308 : Record 27;
      ItemUOM@11123304 : Record 5404;
      RecMgt@11123303 : Codeunit 11123326;
      TestSucceed@11123307 : Boolean;
    BEGIN
      IF GetItemUOM(Item) = '' THEN
        EXIT(TRUE);

      IF RecMgt.GetItemSalesUOM(Item."No.",GetItemUOM(Item),ItemUOM,FALSE) THEN BEGIN
        TestSucceed := ItemUOM."Visible in Webshop";
        IF NOT TestSucceed THEN BEGIN
          RecMgt.GetItem(Item."No.",OriginalItem,TRUE);
          IF GetItemUOM(OriginalItem) = GetItemUOM(Item) THEN
            TestSucceed := TRUE
        END;
      END;

      EXIT(TestSucceed);
    END;

    LOCAL PROCEDURE AddVisibilityRulesToXml@11123359(VAR ResultNodeBuff@11123302 : Record 11123303;Item@11123303 : Record 27;VAR Params@11123304 : Record 11123310);
    VAR
      CollectionNodeBuff@11123308 : TEMPORARY Record 11123303;
      RuleNodeBuff@11123307 : TEMPORARY Record 11123303;
      TempCustAssort@11123305 : TEMPORARY Record 11123326;
    BEGIN
      IF NOT Params.LoadVisibilityRules THEN
        EXIT;

      FindItemCustomerAssortment(Item,TempCustAssort);
      IF TempCustAssort.FINDSET THEN BEGIN
        ResultNodeBuff.AddElement(CollectionNodeBuff,'VisibilityRules','');
        REPEAT
          CollectionNodeBuff.AddElement(RuleNodeBuff,'Rule','');

          RuleNodeBuff.AddAttribute('CustomerId',TempCustAssort."Sales Code");
          RuleNodeBuff.AddAttribute('Mode',FORMAT(TempCustAssort.Mode));

          CASE TempCustAssort."Sales Type" OF
            TempCustAssort."Sales Type"::Customer :
              RuleNodeBuff.AddAttribute('CustomerType','Customer');
            TempCustAssort."Sales Type"::"Customer Price Group" :
              RuleNodeBuff.AddAttribute('CustomerType','CustomerGroup');
          END;
        UNTIL TempCustAssort.NEXT = 0;
      END;
    END;

    PROCEDURE FindItemCustomerAssortment@11123389(Item@11123302 : Record 27;VAR TempCustAssort@11123303 : Record 11123326);
    VAR
      CustAssort@11123304 : Record 11123326;
    BEGIN
      CustAssort.RESET;
      CustAssort.SETRANGE(Type,CustAssort.Type::Item);
      CustAssort.SETRANGE(Code,Item."No.");
      IF CustAssort.FINDSET THEN
        REPEAT
          InsertItemCustomerAssortment(CustAssort,TempCustAssort);
        UNTIL CustAssort.NEXT = 0;

      CustAssort.RESET;
      CustAssort.SETRANGE(Type,CustAssort.Type::"Product Group");
      CustAssort.SETRANGE(Code,Item."Product Group Code");
      CustAssort.SETRANGE("Item Category Code (Internal)",Item."Item Category Code");
      IF CustAssort.FINDSET THEN
        REPEAT
          InsertItemCustomerAssortment(CustAssort,TempCustAssort);
        UNTIL CustAssort.NEXT = 0;

      CustAssort.RESET;
      CustAssort.SETRANGE(Type,CustAssort.Type::"Item Category");
      CustAssort.SETRANGE(Code,Item."Item Category Code");
      IF CustAssort.FINDSET THEN
        REPEAT
          InsertItemCustomerAssortment(CustAssort,TempCustAssort);
        UNTIL CustAssort.NEXT = 0;
    END;

    LOCAL PROCEDURE InsertItemCustomerAssortment@11123375(FromCustAssort@11123302 : Record 11123326;VAR ToCustAssort@11123303 : Record 11123326);
    BEGIN
      ToCustAssort.INIT;
      ToCustAssort := FromCustAssort;
      IF ToCustAssort.INSERT THEN;
    END;

    PROCEDURE AddUOMTranslations@11123360(VAR RootNodeBuff@11123302 : Record 11123303;UOMCode@11123303 : Code[20];FieldName@11123309 : Text[1024]);
    VAR
      Language@11123305 : Record 8;
      UOM@11123304 : Record 204;
      UOMTranslation@11123306 : Record 5402;
      RecMgt@11123310 : Codeunit 11123326;
      FieldKey@11123308 : Text[1024];
    BEGIN
      IF RecMgt.GetUOM(UOMCode,UOM,FALSE) THEN BEGIN
        RootNodeBuff.AddFieldElement(FieldName,UOM.Description);
        UOMTranslation.SETRANGE(Code,UOMCode);
        UOMTranslation.SETFILTER("Language Code",'<>%1','');
        IF UOMTranslation.FINDSET THEN
          REPEAT
            IF Language.GET(UOMTranslation."Language Code") THEN BEGIN
              FieldKey := STRSUBSTNO('%1_%2',FieldName,Language."Windows Language ID");
              RootNodeBuff.AddFieldElement(FieldKey,UOMTranslation.Description);
            END;
          UNTIL UOMTranslation.NEXT = 0;
      END;
    END;

    PROCEDURE GetItemBarCode@11123382(VAR Item@11123302 : Record 27) : Text[250];
    VAR
      TempParams@11123303 : TEMPORARY Record 11123310;
      Dispatcher@11123304 : Codeunit 11123306;
    BEGIN
      TempParams.InitializeEmptyParams;
      TempParams.ProductId := Item."No.";
      TempParams.VariantId := '';
      TempParams.UnitOfMeasureId := Item."Sales Unit of Measure";

      Dispatcher.DispatchInternal('FindBarCode',TempParams);

      EXIT(TempParams.Barcode);
    END;

    PROCEDURE GetVariantBarCode@11123388(VAR Variant@11123302 : Record 5401;UOMCode@11123303 : Code[10]) : Text[250];
    VAR
      TempParams@11123304 : TEMPORARY Record 11123310;
      Dispatcher@11123305 : Codeunit 11123306;
    BEGIN
      TempParams.InitializeEmptyParams;
      TempParams.ProductId := Variant."Item No.";
      TempParams.VariantId := Variant.Code;
      TempParams.UnitOfMeasureId := UOMCode;

      Dispatcher.DispatchInternal('FindBarCode',TempParams);

      EXIT(TempParams.Barcode);
    END;

    PROCEDURE FindBarCode@11123378(VAR Params@11123306 : Record 11123310);
    VAR
      ItemCrossRef@11123304 : Record 5717;
    BEGIN
      ItemCrossRef.SETCURRENTKEY(
        "Item No.","Variant Code","Unit of Measure",
        "Cross-Reference Type","Cross-Reference No.","Discontinue Bar Code");
      ItemCrossRef.SETRANGE("Item No.",Params.ProductId);
      ItemCrossRef.SETRANGE("Variant Code",Params.VariantId);
      ItemCrossRef.SETFILTER("Unit of Measure",'%1|%2','',Params.UnitOfMeasureId);
      ItemCrossRef.SETRANGE("Cross-Reference Type",ItemCrossRef."Cross-Reference Type"::"Bar Code");
      ItemCrossRef.SETRANGE("Discontinue Bar Code",FALSE);
      IF ItemCrossRef.FINDLAST THEN
        Params.Barcode := ItemCrossRef."Cross-Reference No.";
    END;

    PROCEDURE CheckKitBOMComponentsOrderable@11123499(Item@11123302 : Record 27;VAR ErrorText@11123308 : Text[250]) : Boolean;
    VAR
      ItemRecRef@11123309 : RecordRef;
      ItemFieldRef@11123312 : FieldRef;
      ProdBOMHeader@11123303 : Record 99000771;
      ProdBOMLine@11123304 : Record 99000772;
      Item2@11123305 : Record 27;
      Params@11123306 : TEMPORARY Record 11123310;
      RecMgt@11123307 : Codeunit 11123326;
      ItemKitBomNo@11123310 : Code[20];
      ItemAutoBuildKitBOM@11123311 : Boolean;
    BEGIN
      ItemRecRef.GETTABLE(Item);
      ItemFieldRef := ItemRecRef.FIELD(25000); // "Kit BOM No."
      ItemKitBomNo := ItemFieldRef.VALUE;
      ItemFieldRef := ItemRecRef.FIELD(25010); // "Automatic Build Kit BOM"
      ItemAutoBuildKitBOM := ItemFieldRef.VALUE;
      ItemRecRef.CLOSE;

      IF (ItemKitBomNo = '') OR (NOT ItemAutoBuildKitBOM) THEN
        EXIT(TRUE);

      IF NOT ProdBOMHeader.GET(ItemKitBomNo) THEN BEGIN
        ErrorText := STRSUBSTNO(Text11123390,ProdBOMHeader.TABLECAPTION,ItemKitBomNo);
        EXIT(FALSE);
      END;

      IF Item.Reserve <> Item.Reserve::Never THEN BEGIN
        ErrorText := STRSUBSTNO(Text11123391,Item.TABLECAPTION,Item."No.");
        EXIT(FALSE);
      END;

      IF ProdBOMHeader.Status <> ProdBOMHeader.Status::Certified THEN BEGIN
        ErrorText := STRSUBSTNO(Text11123392,ProdBOMHeader.TABLECAPTION,ProdBOMHeader."No.");
        EXIT(FALSE);
      END;

      Params.INIT;

      ProdBOMLine.SETRANGE("Production BOM No.",ProdBOMHeader."No.");
      ProdBOMLine.SETRANGE("Version Code",'');
      ProdBOMLine.SETRANGE(Type,ProdBOMLine.Type::Item);
      IF ProdBOMLine.FINDSET THEN
        REPEAT
          IF RecMgt.GetItem(ProdBOMLine."No.",Item2,FALSE) THEN
            IF NOT IsItemOrderable(Item2,TRUE,Params) THEN BEGIN
              ErrorText := STRSUBSTNO(Text11123393,Item2."No.");
              EXIT(FALSE);
            END;
        UNTIL ProdBOMLine.NEXT = 0;

      EXIT(TRUE);
    END;

    LOCAL PROCEDURE AddProductExternalInfo@11123321(VAR ResultNodeBuff@11123302 : Record 11123303;VAR Params@11123303 : Record 11123310);
    VAR
      Context@11123305 : Codeunit 11123305;
      Dispatcher@11123304 : Codeunit 11123306;
    BEGIN
      Context.SetXMLNodeBuff(ResultNodeBuff);

      Params.VariantId := '';

      IF Params.HasVariants AND Params.LoadRelatedSkus THEN
        Dispatcher.DispatchInternal('GetExtVariantComponents',Params);
    END;

    LOCAL PROCEDURE AddVariantExternalInfo@11123325(VAR ResultNodeBuff@11123302 : Record 11123303;VAR Params@11123303 : Record 11123310);
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE GetProductDescription@11123393(Item@11123302 : Record 27;DescriptionNo@11123303 : Integer;LanguageCode@11123304 : Code[10]) : Text[250];
    VAR
      ItemTranslation@11123305 : Record 30;
      Description@11123306 : Text[250];
    BEGIN
      IF DescriptionNo = 1 THEN
        Description := Item.Description
      ELSE
        Description := Item."Description 2";

      IF ItemTranslation.GET(Item."No.",'',LanguageCode) THEN BEGIN
        IF DescriptionNo = 1 THEN
          Description := ItemTranslation.Description
        ELSE
          Description := ItemTranslation."Description 2";
      END;
      EXIT(Description);
    END;

    PROCEDURE GetVertCompDescription@11123394() : Text[250];
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE GetHorzCompDescription@11123395() : Text[250];
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    LOCAL PROCEDURE AddItemUnitsOfMeasureToXML@11123332(VAR ResultNode@11123305 : Record 11123303;Item@11123302 : Record 27;VAR Params@11123306 : Record 11123310);
    VAR
      CollectionNodeBuff@11123304 : TEMPORARY Record 11123303;
      ItemUOM@11123308 : Record 5404;
      SalesUOMCode@11123312 : Code[10];
    BEGIN
      ResultNode.AddElement(CollectionNodeBuff,'UnitsOfMeasure','');

      SalesUOMCode := GetItemUOM(Item);

      IF ItemUOM.GET(Item."No.",SalesUOMCode) THEN
       // AddItemUOMtoXML(ItemUOM,CollectionNodeBuff);//<TPZ3099>
        AddItemUOMtoXMLTPZ(ItemUOM,CollectionNodeBuff);//<TPZ3099>

      ItemUOM.RESET;
      ItemUOM.SETRANGE("Item No.",Item."No.");
      ItemUOM.SETFILTER(Code,'<>%1',SalesUOMCode);
      ItemUOM.SETRANGE("Visible in Webshop",TRUE);
      IF ItemUOM.FINDSET THEN
        REPEAT
         // AddItemUOMtoXML(ItemUOM,CollectionNodeBuff);//<TPZ3099>
          AddItemUOMtoXMLTPZ(ItemUOM,CollectionNodeBuff);//<TPZ3099>
        UNTIL ItemUOM.NEXT = 0;
    END;

    LOCAL PROCEDURE AddItemUOMtoXML@11123387(ItemUOM@11123303 : Record 5404;VAR CollectionNodeBuff@11123302 : Record 11123303);
    VAR
      UOM@11123306 : Record 204;
      UnitOfMeasureNodeBuff@11123304 : TEMPORARY Record 11123303;
      RecMgt@11123307 : Codeunit 11123326;
    BEGIN
      IF RecMgt.GetUOM(ItemUOM.Code,UOM,FALSE) THEN BEGIN
        CollectionNodeBuff.AddElement(UnitOfMeasureNodeBuff,'UnitOfMeasure','');
        UnitOfMeasureNodeBuff.AddFieldElement('Id',ItemUOM.Code);
        AddUOMTranslations(UnitOfMeasureNodeBuff,UOM.Code,'Description');
        AddItemPhysicalDimensionsToXml(UnitOfMeasureNodeBuff,ItemUOM."Item No.",ItemUOM.Code);
      END;
    END;

    PROCEDURE GetQtyPerItemUOM@11123379(ItemNo@11123302 : Code[20];UOMCode@11123303 : Code[10]) : Decimal;
    VAR
      ItemUOM@11123304 : Record 5404;
      RecMgt@11123305 : Codeunit 11123326;
      QtyPerUOM@11123306 : Decimal;
    BEGIN
      IF UOMCode <> '' THEN
        IF RecMgt.GetItemSalesUOM(ItemNo,UOMCode,ItemUOM,FALSE) THEN
          QtyPerUOM := ItemUOM."Qty. per Unit of Measure";

      IF QtyPerUOM = 0 THEN
        QtyPerUOM := 1;

      EXIT(QtyPerUOM);
    END;

    PROCEDURE CreateVolumePricesXML@11123380(VAR CollectionNodeBuff@11123304 : Record 11123303;VAR VolumePriceDiscount@11123305 : Record 11123328;VAR Params@11123302 : Record 11123310);
    VAR
      VolumePriceNodeBuff@11123303 : TEMPORARY Record 11123303;
      Settings@11123306 : Codeunit 11123311;
    BEGIN
      VolumePriceDiscount.RESET;
      VolumePriceDiscount.SETCURRENTKEY("Unit of Measure Code","Minimum Quantity");
      IF VolumePriceDiscount.FINDSET THEN
        REPEAT
          CollectionNodeBuff.AddElement(VolumePriceNodeBuff,'VolumePrice','');
          VolumePriceNodeBuff.AddFieldElement('ProductId',VolumePriceDiscount."Item No.");
          VolumePriceNodeBuff.AddFieldElement('VariantId',VolumePriceDiscount."Variant Code");
          VolumePriceNodeBuff.AddFieldElement('UnitOfMeasureId',VolumePriceDiscount."Unit of Measure Code");
          VolumePriceNodeBuff.AddFieldElement('Quantity',FORMAT(VolumePriceDiscount."Minimum Quantity"));
          VolumePriceNodeBuff.AddFieldElement('Price',
            FORMAT(Settings.RoundPrice(VolumePriceDiscount."Unit Price",Params.CurrentCurrencyId)));
          VolumePriceNodeBuff.AddFieldElement('DiscountPercent',FORMAT(VolumePriceDiscount."Line Discount %"));
        UNTIL VolumePriceDiscount.NEXT = 0;
    END;

    PROCEDURE GetCategoryId@11123309(VAR Item@11123302 : Record 27) : Text[1024];
    VAR
      ProductFunc@11123304 : Codeunit 11123317;
      CategoryCode@11123303 : Code[30];
    BEGIN
      IF ProductFunc.HasChildCategories THEN BEGIN
        CategoryCode := GetCategoryHierarchyId(Item);
        EXIT(CategoryCode);
      END;

      IF Item."WebShop Item Category Code" <> '' THEN BEGIN
        CategoryCode := Item."WebShop Item Category Code"; //<TPZ1665>
        IF Item."WebShop Product Group Code" <> '' THEN
          CategoryCode := STRSUBSTNO('%1__%2',CategoryCode,Item."WebShop Product Group Code");//<TPZ1665>
      END;
      EXIT(CategoryCode);
    END;

    PROCEDURE MakeProductGroupId@11123323(VAR ProductGroup@11123302 : Record 5723) : Text[30];
    BEGIN
      EXIT(STRSUBSTNO('%1__%2',ProductGroup."Item Category Code",ProductGroup.Code));
    END;

    PROCEDURE SplitCategoryId@11123324(Id@11123302 : Text[1024];VAR CategoryId@11123303 : Code[10];VAR ProductGroupId@11123304 : Code[10]);
    VAR
      Pos@11123305 : Integer;
    BEGIN
      Pos := STRPOS(Id,'__');
      IF Pos > 0 THEN BEGIN
        CategoryId := COPYSTR(Id,1,Pos - 1);
        ProductGroupId := COPYSTR(Id,Pos + 2);
      END ELSE BEGIN
        CategoryId := Id;
        ProductGroupId := '';
      END;
    END;

    PROCEDURE IsPrepackCodeToInventory@11123399() : Boolean;
    VAR
      OrderBasketFunc@11123302 : Codeunit 11123320;
    BEGIN
      IF NOT PrepToInvInitializedGlobal THEN BEGIN
        PrepackCodeToInvGlobal := OrderBasketFunc.IsPrepackCodeToInventory;
        PrepToInvInitializedGlobal := TRUE;
      END;
      EXIT(PrepackCodeToInvGlobal);
    END;

    PROCEDURE PrepackHasVariants@11123398() : Boolean;
    BEGIN
      EXIT; // NOT IMPLEMENTED IN CURRENT VERSION
    END;

    PROCEDURE IsProductGroupEmpty@11123308(ItemCategoryCode@11123305 : Code[10];ProductGroupCode@11123302 : Code[10];VisibleOnly@11123304 : Boolean) : Boolean;
    VAR
      Item@11123303 : Record 27;
    BEGIN
      Item.SETCURRENTKEY("Visible in Webshop","WebShop Item Category Code","WebShop Product Group Code");  //<TPZ1665>
      Item.SETRANGE("WebShop Item Category Code",ItemCategoryCode); //<TPZ1665>
      Item.SETRANGE("WebShop Product Group Code",ProductGroupCode);  //<TPZ1665>
      IF VisibleOnly THEN
        Item.SETRANGE("Visible in Webshop",TRUE);
      EXIT(Item.ISEMPTY);
    END;

    PROCEDURE IsCategoryEmpty@11123320(ItemCategoryCode@11123302 : Code[10];VisibleOnly@11123305 : Boolean) : Boolean;
    VAR
      Item@11123304 : Record 27;
    BEGIN
      Item.SETCURRENTKEY("Visible in Webshop","WebShop Item Category Code","WebShop Product Group Code"); //<TPZ1665>
      Item.SETRANGE("WebShop Item Category Code",ItemCategoryCode); //<TPZ1665>
      IF VisibleOnly THEN
        Item.SETRANGE("Visible in Webshop",TRUE);
      EXIT(Item.ISEMPTY);
    END;

    PROCEDURE HasVolumePrice@11123311(VAR Params@11123305 : Record 11123310) : Boolean;
    VAR
      SalesPrice@11123302 : Record 7002;
      SalesLineDisc@11123303 : Record 7004;
    BEGIN
      SalesPrice.SETRANGE("Item No.",Params.ProductId);
      SalesPrice.SETFILTER("Ending Date",'%1|>=%2',0D,WORKDATE);
      IF NOT SalesPrice.ISEMPTY THEN
        EXIT(TRUE);

      SalesLineDisc.SETRANGE(Code,Params.ProductId);
      SalesLineDisc.SETFILTER("Ending Date",'%1|>=%2',0D,WORKDATE);
      IF NOT SalesLineDisc.ISEMPTY THEN
        EXIT(TRUE);

        EXIT(FALSE);
    END;

    LOCAL PROCEDURE CalculateProjAvailBalance@11123318(VAR Item@11123302 : Record 27;DateFilter@11123307 : Date) : Decimal;
    VAR
      ItemRecRef@11123310 : RecordRef;
      ItemFieldRef@11123309 : FieldRef;
      GrossRequirement@11123306 : Decimal;
      PlannedOrderReceipt@11123305 : Decimal;
      ScheduledReceipt@11123304 : Decimal;
      ProjAvailBalance@11123303 : Decimal;
      QtyOnKitSalesLines@11123308 : Decimal;
    BEGIN
      Item.SETRANGE("Date Filter",0D,DateFilter);

      IF Context.IsNorthAmericaLocalization AND Context.SupportsKitBOM THEN BEGIN
        ItemRecRef.GETTABLE(Item);
        ItemFieldRef := ItemRecRef.FIELD(25008); //"Qty. on Kit Sales Lines"
        ItemFieldRef.CALCFIELD;
        QtyOnKitSalesLines := ItemFieldRef.VALUE;
        ItemRecRef.CLOSE;
      END;

      Item.CALCFIELDS(
        "Qty. on Purch. Order",
        "Qty. on Sales Order",
        "Qty. on Service Order",
        Inventory,
        "Scheduled Need (Qty.)",
        "Planned Order Receipt (Qty.)",
        "FP Order Receipt (Qty.)",
        "Rel. Order Receipt (Qty.)",
        "Purch. Req. Receipt (Qty.)",
        "Planning Issues (Qty.)");

      IF Item.GETFILTER("Location Filter") <> '' THEN
        Item.CALCFIELDS(
          "Trans. Ord. Shipment (Qty.)",
          "Qty. in Transit",
          "Trans. Ord. Receipt (Qty.)");

      GrossRequirement :=
        Item."Qty. on Sales Order" +
        Item."Qty. on Service Order" +
        Item."Scheduled Need (Qty.)" +
        Item."Trans. Ord. Shipment (Qty.)" +
        Item."Planning Issues (Qty.)" +
        QtyOnKitSalesLines;
      PlannedOrderReceipt :=
        Item."Planned Order Receipt (Qty.)" +
        Item."Purch. Req. Receipt (Qty.)";
      ScheduledReceipt :=
        Item."FP Order Receipt (Qty.)" +
        Item."Rel. Order Receipt (Qty.)" +
        Item."Qty. on Purch. Order" +
        Item."Qty. in Transit" +
        Item."Trans. Ord. Receipt (Qty.)";

      ProjAvailBalance :=
        Item.Inventory +
        PlannedOrderReceipt +
        ScheduledReceipt -
        GrossRequirement;

      EXIT(ProjAvailBalance);
    END;

    PROCEDURE GetCalcValues@11123322(VAR CalcValuesInfo@11123307 : Record 11123319;VAR CurrencyList@11123303 : Record 11123330;ItemVariant@11123306 : Record 5401;VAR Params@11123302 : Record 11123310);
    VAR
      Item@11123305 : Record 27;
      RecMgt@11123304 : Codeunit 11123326;
      VATProdPostingGroup@11123308 : Code[10];
      UnitPrice@11123310 : Decimal;
      ListPrice@11123309 : Decimal;
      CalculatePrices@11123311 : Boolean;
    BEGIN
      RecMgt.GetItem(Params.ProductId,Item,TRUE);
      UnitPrice := Item."Unit Price";
      ListPrice := Item."Unit Price";

      IF CurrencyList.FINDSET THEN
        REPEAT
          CalculatePrices := TRUE;
          Params.CurrentCurrencyId := CurrencyList.Value;
          IF Params.ProductOrderable THEN BEGIN
            IF Params.PrepackId = '' THEN
              IF Params.VariantId <> '' THEN BEGIN
                CalculatePrices := VariantPriceExists(Params);
                IF NOT CalculatePrices THEN
                  GetCalculatedVariantPrices(CalcValuesInfo,Params,UnitPrice,ListPrice);
            END;

            IF CalculatePrices THEN BEGIN
              UnitPrice := GetSalesPrice(Item,ItemVariant,Params);
              ListPrice := UnitPrice;

              VATProdPostingGroup := Item."VAT Prod. Posting Group";

              IF Params.CalcOrderable THEN
                ListPrice :=
                  GetUnitPriceByCurrencyAndVAT(
                    Item."No.",
                    Item."Unit Price",
                    Item."Price Includes VAT",
                    VATProdPostingGroup,
                    Item."VAT Bus. Posting Gr. (Price)",
                    Params);
            END;
          //END;//<TPZ3099>
          END ELSE BEGIN
            UnitPrice := GetSalesPriceTPZ(Item,Params);
            ListPrice := UnitPrice;
          END;
          //</TPZ3099>

          DefineIsOrderableByPriority(
            Params.ProductId,
            Params.VariantId,
            Params.ProductOrderable,
            Params.CalcOrderable,
            Params.CalcErrorText);

          Params.ProductOrderable := Params.CalcOrderable;

          AddCalcValuesLine(CalcValuesInfo,CurrencyList.Key,UnitPrice,ListPrice,Params);
        UNTIL CurrencyList.NEXT = 0;
    END;

    PROCEDURE AddCalcValuesLine@11123331(VAR CalcValuesInfo@11123304 : Record 11123319;CurrencyISOCode@11123302 : Code[10];UnitPrice@11123306 : Decimal;ListPrice@11123305 : Decimal;VAR Params@11123303 : Record 11123310);
    BEGIN
      WITH CalcValuesInfo DO BEGIN
        INIT;
        "Item No." := Params.ProductId;
        "Variant Code" := Params.VariantId;
        "Prepack Code" := Params.PrepackId;
        "Vertical Component Code" := Params.VerticalId;
        "Unit of Measure Code" := Params.UnitOfMeasureId;
        "Currency Code" := Params.CurrentCurrencyId;
        "Currency ISO Code" := CurrencyISOCode;
        "Customer No." := Params.AccountId;
        "Unit Price" := UnitPrice;
        "Unit List Price" := ListPrice;
        Stock := Params.Inventory;
        Orderable := Params.ProductOrderable;
        "Non Orderable Reason" := Params.CalcErrorText;
      IF INSERT THEN;
      END;
    END;

    PROCEDURE VariantPriceExists@11123358(VAR Params@11123302 : Record 11123310) : Boolean;
    VAR
      SalesPrice@11123303 : Record 7002;
    BEGIN
      SalesPrice.SETRANGE("Item No.",Params.ProductId);
      SalesPrice.SETRANGE("Variant Code",Params.VariantId);
      EXIT(NOT SalesPrice.ISEMPTY);
    END;

    PROCEDURE GetCalculatedVariantPrices@11123362(VAR CalcValuesInfo@11123302 : Record 11123319;VAR Params@11123303 : Record 11123310;VAR UnitPrice@11123306 : Decimal;VAR ListPrice@11123308 : Decimal);
    BEGIN
      CalcValuesInfo.SETRANGE("Item No.",Params.ProductId);
      CalcValuesInfo.SETRANGE("Variant Code",'');
      CalcValuesInfo.SETRANGE("Currency Code",Params.CurrentCurrencyId);
      IF CalcValuesInfo.FINDFIRST THEN BEGIN
        UnitPrice := CalcValuesInfo."Unit Price";
        ListPrice := CalcValuesInfo."Unit List Price";
        Params.CalcOrderable := CalcValuesInfo.Orderable;
        Params.CalcErrorText := CalcValuesInfo."Non Orderable Reason";
      END;
      CalcValuesInfo.SETRANGE("Item No.");
      CalcValuesInfo.SETRANGE("Variant Code");
      CalcValuesInfo.SETRANGE("Currency Code");
    END;

    PROCEDURE CalcProjectedDateFilter@11123385(VAR Webshop@11123302 : Record 11123313;VAR DateFilter@11123303 : Date);
    BEGIN
      IF FORMAT(Webshop."Projected Date Calculation") <> '' THEN
        DateFilter := CALCDATE(Webshop."Projected Date Calculation",TODAY);

      IF DateFilter = 0D THEN
        DateFilter := DMY2DATE(31,12,9999);
    END;

    PROCEDURE IsExcludeTaxPercent@11123363(VAR Params@11123302 : Record 11123310) : Boolean;
    VAR
      Webshop@11123303 : Record 11123313;
      RecMgt@11123304 : Codeunit 11123326;
    BEGIN
      RecMgt.GetWebshop(Params.WebsiteId,Webshop,TRUE);
      EXIT(Webshop."Exclude Tax Percent");
    END;

    PROCEDURE IsExcludeBOMComp@11123396(VAR Params@11123303 : Record 11123310) : Boolean;
    VAR
      Webshop@11123302 : Record 11123313;
      RecMgt@11123304 : Codeunit 11123326;
    BEGIN
      RecMgt.GetWebshop(Params.WebsiteId,Webshop,TRUE);
      EXIT(Webshop."Exclude BOM Comp.");
    END;

    PROCEDURE GetVariantComponentsCount@11123397(VAR Params@11123303 : Record 11123310) Count : Integer;
    VAR
      Item@11123304 : Record 27;
      Dispatcher@11123302 : Codeunit 11123306;
      RecMgt@11123305 : Codeunit 11123326;
      HasVertComponnent@11123306 : Boolean;
      HasHorzComponnent@11123307 : Boolean;
    BEGIN
      Count := 0;
      IF Context.PfsAddonIsUsed THEN
        IF Params.HasVariants THEN BEGIN
          RecMgt.GetItem(Params.ProductId,Item,FALSE);
      // NOT IMPLEMENTED IN CURRENT VERSION
      //    HasVertComponnent := Item."PfsVert Component Group" <> '';
      //    HasHorzComponnent := Item."PfsHorz Component Group" <> '';
          IF HasVertComponnent OR HasHorzComponnent THEN
            Count := 1;
          IF HasVertComponnent AND HasHorzComponnent THEN
            Count := 2;
        END;

      IF Context.LsAddonIsUsed THEN
        IF Params.HasVariants THEN BEGIN
          Dispatcher.DispatchInternal('GetVariantCompCount',Params);
        Count := Params.VariantCompCount;
      END;

      EXIT(Count);
    END;

    PROCEDURE GetLastDateTimeModify@11123400(RecRef@11123303 : RecordRef) LastDateTimeModify : DateTime;
    VAR
      FieldRef@11123306 : FieldRef;
      RecInfo@11123305 : Record 11123331;
      Settings@11123307 : Codeunit 11123311;
      CodeId@11123304 : Code[20];
      TableId@11123302 : Integer;
    BEGIN
      FieldRef := RecRef.FIELD(1);
      TableId := RecRef.NUMBER;
      CodeId := FieldRef.VALUE;

      RecInfo.RESET;
      RecInfo.SETRANGE("Table ID",TableId);
      RecInfo.SETRANGE("Code ID",CodeId);
      IF RecInfo.FINDFIRST THEN
      // ---------------------------------------------------------------------------------
      // Comment line below and uncoment next one if You are going to use webservice setting "Server Time Zone"
      // ---------------------------------------------------------------------------------
        LastDateTimeModify := RecInfo."Last Date/Time Modified";
      //  LastDateTimeModify := Settings.DateToUtc(RecInfo."Last Date/Time Modified");
    END;

    PROCEDURE CreateProductSuggestionXML@11123402(VAR ResultNodeBuff@11123302 : Record 11123303;KeyExtraDecValue@11123304 : TEMPORARY Record 11123330;VAR Params@11123303 : Record 11123310);
    VAR
      ProductNodeBuff@11123305 : Record 11123303;
    BEGIN
      ResultNodeBuff.AddElement(ProductNodeBuff,'Product','');
      ProductNodeBuff.AddFieldElement('Id',KeyExtraDecValue.Key);
    END;

    PROCEDURE CreateProductImagesXML@11123405(VAR ResultNodeBuff@11123302 : Record 11123303;Item@11123303 : Record 27;VAR Params@11123304 : Record 11123310);
    VAR
      ProductNodeBuff@11123306 : Record 11123303;
    BEGIN
      ResultNodeBuff.AddElement(ProductNodeBuff,'ProductImage','');
      ProductNodeBuff.AddFieldElement('ProductId',Item."No.");
    END;

    PROCEDURE CreateProductImageFileXML@11123404(VAR ResultNodeBuff@11123302 : Record 11123303;Item@11123303 : Record 27;VAR Params@11123304 : Record 11123310);
    VAR
      TempBlob@11123305 : TEMPORARY Record 99008535;
      BlobInStream@11123306 : InStream;
      NameValueBuffer@11123312 : Record 823;
      TempNameValueBuffer@11123311 : TEMPORARY Record 823;
      FileManagement@11123310 : Codeunit 419;
      ToFile@11123309 : Text;
      ExportPath@11123308 : Text;
      FileName@11123314 : Text[1024];
    BEGIN
      // START, SC
      // The code commented below because of changes Item.Picture type in NAV 2017
      //--------------------------------------------------------------------------
      // Item.CALCFIELDS(Picture);
      // TempBlob.Blob := Item.Picture;
      //--------------------------------------------------------------------------
      NameValueBuffer.DELETEALL;
      ExportPath := TEMPORARYPATH + Item."No." + FORMAT(Item.Picture.MEDIAID);
      Item.Picture.EXPORTFILE(ExportPath);
      FileManagement.GetServerDirectoryFilesList(TempNameValueBuffer,TEMPORARYPATH);
      TempNameValueBuffer.SETFILTER(Name,STRSUBSTNO('%1*',ExportPath));
      IF TempNameValueBuffer.FINDFIRST THEN
        TempBlob.Blob.IMPORT(TempNameValueBuffer.Name);
      IF FileManagement.DeleteServerFile(TempNameValueBuffer.Name) THEN;
      //--------------------------------------------------------------------------
      // END, SC

      ResultNodeBuff.AddBlobElement('Image',TempBlob)
    END;

    PROCEDURE EnableDocumentDownloads@11123403(VAR Params@11123304 : Record 11123310) : Boolean;
    VAR
      Webshop@11123303 : Record 11123313;
      RecMgt@11123302 : Codeunit 11123326;
    BEGIN
      RecMgt.GetWebshop(Params.WebsiteId,Webshop,TRUE);
      EXIT(Webshop."Enable Document Downloads");
    END;

    PROCEDURE CreateProductCategoryXML@11123407(Category@11123302 : Record 5722;VAR ParentCategoryId@11123306 : Text;VAR ParentNodeBuff@11123303 : Record 11123303;VAR ReturnNodeBuff@11123304 : Record 11123303;VAR Params@11123305 : Record 11123310);
    BEGIN
      // Specific functionality for NAV2017
      ParentCategoryId := MakeCategoryGroupId(Category,ParentCategoryId);
      ParentNodeBuff.AddElement(ReturnNodeBuff,'Node','');
      ReturnNodeBuff.AddFieldElement('Id',ParentCategoryId);
      ReturnNodeBuff.AddFieldElement('Title',Category.Description);
      ReturnNodeBuff.AddFieldElement('Visible',FORMAT(Category."Visible in Webshop",0,2));
      ReturnNodeBuff.AddFieldElement('SortId',FORMAT(Category."Sort No."));
      AddFieldTranslations(
        ReturnNodeBuff,DATABASE::"Item Category",Category.Code,'','','Description');
    END;

    PROCEDURE MakeCategoryGroupId@11123406(VAR Category@11123302 : Record 5722;ParentCategoryId@11123303 : Text) : Text;
    BEGIN
      // Specific functionality for NAV2017
      EXIT(STRSUBSTNO('%1__%2',ParentCategoryId,Category.Code));
    END;

    LOCAL PROCEDURE AddProductAttributeExtraField@11123409(VAR ResultNodeBuff@11123302 : Record 11123303;Item@11123304 : Record 27;AttributeFieldList@11123303 : Record 11123330);
    VAR
      ItemAttrValueMapping@11123305 : Record 7505;
      AttributeId@11123306 : Integer;
    BEGIN
      // Specific functionality for NAV2017
      AttributeId := GetAttributeId(AttributeFieldList.Value);

      IF ItemAttrValueMapping.GET(DATABASE::Item,Item."No.",AttributeId) THEN
        AddProductAttributeExtraFieldXML(ResultNodeBuff,ItemAttrValueMapping);
    END;

    LOCAL PROCEDURE AddProductAttributeExtraFieldXML@11123418(VAR ResultNodeBuff@11123303 : Record 11123303;ItemAttributeValueMapping@11123304 : Record 7505);
    VAR
      CommonFunctions@11123302 : Codeunit 11123309;
      ItemAttributeName@11123305 : Text;
      ItemAttributeValue@11123306 : Text;
      ItemAttributeType@11123307 : Text;
    BEGIN
      // Specific functionality for NAV2017
      ItemAttributeName := CommonFunctions.MakeAttributeName(ItemAttributeValueMapping."Item Attribute ID");
      ItemAttributeType := GetItemAttributeType(ItemAttributeValueMapping);
      ItemAttributeValue := GetItemAttributeValue(ItemAttributeValueMapping);

      ResultNodeBuff.AddFieldNameValueTypeElement(ItemAttributeName,ItemAttributeValue,ItemAttributeType);
      AddItemAttrValueTranslations(ResultNodeBuff,ItemAttributeValueMapping,ItemAttributeName);
    END;

    LOCAL PROCEDURE AddItemAttrValueTranslations@11123414(VAR ResultNodeBuff@11123303 : Record 11123303;ItemAttrValueMapping@11123302 : Record 7505;ItemAttributeName@11123306 : Text);
    VAR
      ItemAttrValueTranslation@11123304 : Record 7503;
      Languages@11123305 : Record 8;
      FieldName@11123307 : Text;
      FieldKey@11123308 : Text;
    BEGIN
      // Specific functionality for NAV2017
      ItemAttrValueTranslation.SETRANGE("Attribute ID",ItemAttrValueMapping."Item Attribute ID");
      ItemAttrValueTranslation.SETRANGE(ID,ItemAttrValueMapping."Item Attribute Value ID");
      IF ItemAttrValueTranslation.FINDSET THEN
        REPEAT
          IF Languages.GET(ItemAttrValueTranslation."Language Code") THEN BEGIN
            FieldName := ItemAttributeName;
            FieldKey := STRSUBSTNO('%1_%2',FieldName,Languages."Windows Language ID");
            ResultNodeBuff.AddFieldElement(FieldKey,ItemAttrValueTranslation.Name);
          END;
        UNTIL ItemAttrValueTranslation.NEXT = 0;
    END;

    LOCAL PROCEDURE GetAttributeId@11123415(Value@11123302 : Text) : Integer;
    BEGIN
      // Specific functionality for NAV2017
      EXIT(ParceAttributeId(Value));
    END;

    LOCAL PROCEDURE ParceAttributeId@11123416(Value@11123303 : Text) : Integer;
    VAR
      IntValue@11123302 : Integer;
    BEGIN
      // Specific functionality for NAV2017
      EVALUATE(IntValue,COPYSTR(Value,STRPOS(Value,'__') + 2));
      EXIT(IntValue);
    END;

    LOCAL PROCEDURE GetItemAttributeValue@11123408(ItemAttributeValueMapping@11123304 : Record 7505) : Text;
    VAR
      ItemAttributeValue@11123302 : Record 7501;
    BEGIN
      // Specific functionality for NAV2017
      IF ItemAttributeValue.GET(ItemAttributeValueMapping."Item Attribute ID",ItemAttributeValueMapping."Item Attribute Value ID") THEN
        EXIT(ItemAttributeValue.Value);
    END;

    LOCAL PROCEDURE GetItemAttributeType@11123411(ItemAttributeValueMapping@11123304 : Record 7505) : Text;
    VAR
      CommonFunc@11123303 : Codeunit 11123309;
      ItemAttribute@11123302 : Record 7500;
    BEGIN
      // Specific functionality for NAV2017
      IF ItemAttribute.GET(ItemAttributeValueMapping."Item Attribute ID") THEN
        EXIT(CommonFunc.AttributeFieldTypeMapping(FORMAT(ItemAttribute.Type)));
    END;

    LOCAL PROCEDURE GetCategoryHierarchyId@11123410(VAR Item@11123303 : Record 27) : Text;
    VAR
      ItemCategory@11123305 : Record 5722;
      CategoryId@11123304 : Text;
      ParentCategoryId@11123306 : Text;
      CategoryHierarchyId@11123307 : Text;
    BEGIN
      // Specific functionality for NAV2017
      IF Item."WebShop Item Category Code" = '' THEN //<TPZ1665>
        EXIT;

      CategoryId := Item."WebShop Item Category Code";  //<TPZ1665>
      ItemCategory.GET(CategoryId);
      CategoryId := CreateCategoryHierarhyId(ItemCategory,CategoryId);

      EXIT(CategoryId);
    END;

    LOCAL PROCEDURE CreateCategoryHierarhyId@11123417(ItemCategory@11123307 : Record 5722;CategoryHierarchyId@11123304 : Text) : Text;
    VAR
      CategoryId@11123305 : Text;
      ParentCategoryId@11123303 : Text;
    BEGIN
      {// Specific functionality for NAV2017
      ParentCategoryId := ItemCategory."Parent Category";
      IF ParentCategoryId = '' THEN
        EXIT(CategoryHierarchyId);

      ItemCategory.GET(ParentCategoryId);
      CategoryHierarchyId := STRSUBSTNO('%1__%2',ItemCategory.Code,CategoryHierarchyId);
      CategoryHierarchyId := CreateCategoryHierarhyId(ItemCategory,CategoryHierarchyId);

      EXIT(CategoryHierarchyId);
      }
    END;

    PROCEDURE GetAccountLocationCodebyDivision@1000000001(VAR Params@11123302 : Record 11123310) : Code[10];
    VAR
      Customer@11123303 : Record 18;
      Webshop@11123307 : Record 11123313;
      RecMgt@11123306 : Codeunit 11123326;
      CustomerFunc@11123304 : Codeunit 11123313;
      ContactNo@11123305 : Code[20];
      CustomerDivision@1000000000 : Record 50007;
    BEGIN
      IF RecMgt.GetWebshop(Params.WebsiteId,Webshop,FALSE) THEN
        IF Webshop."Location Code Source" = Webshop."Location Code Source"::Webshop THEN
          EXIT(Webshop."Location Code");

      IF (Params.AccountId <> '') AND (Params.AccountType <> '') THEN
        IF CustomerFunc.IsAccountCustomer(Params.AccountType) THEN BEGIN
          IF RecMgt.GetCustomer(Params.AccountId,Customer,FALSE) THEN BEGIN
           IF CustomerDivision.GET(Params.AccountId,Params.Division) THEN //<TPZ2503>
             EXIT(CustomerDivision."Location Code")
           ELSE
             EXIT(Customer."Location Code");
          END;
        END ELSE BEGIN
          ContactNo := Params.AccountId;
          IF CustomerFunc.GetRelatedCustByContNo(ContactNo,Customer) THEN
            EXIT(Customer."Location Code");
        END;
    END;

    LOCAL PROCEDURE ConvertPriceLCYToFCY@6(UnitPrice@1001 : Decimal) : Decimal;
    VAR
      CurrExchRate@1000 : Record 330;
      GLSetup@1000000000 : Record 98;
    BEGIN
      //<TPZ2751>
      GLSetup.GET;
      EXIT(ROUND(UnitPrice,GLSetup."Unit-Amount Rounding Precision"));
      //</TPZ2751>
    END;

    LOCAL PROCEDURE AddItemUOMtoXMLTPZ@1000000002(ItemUOM@11123303 : Record 5404;VAR CollectionNodeBuff@11123302 : Record 11123303);
    VAR
      UOM@11123306 : Record 204;
      UnitOfMeasureNodeBuff@11123304 : TEMPORARY Record 11123303;
      RecMgt@11123307 : Codeunit 11123326;
      ItemRec@1000000000 : Record 27;
    BEGIN
      //<TPZ3099>
      IF RecMgt.GetUOM(ItemUOM.Code,UOM,FALSE) THEN BEGIN
        CollectionNodeBuff.AddElement(UnitOfMeasureNodeBuff,'UnitOfMeasure','');
        UnitOfMeasureNodeBuff.AddFieldElement('Id',ItemUOM.Code);
        //UnitOfMeasureNodeBuff.AddFieldElement('Id ',FORMAT(ItemUOM.Code) +' '+ FORMAT(ItemUOM."Qty. per Unit of Measure" ));//UTK
       // AddUOMTranslations(UnitOfMeasureNodeBuff,UOM.Code,'Description');
       IF (ItemRec.GET(ItemUOM."Item No.")) AND (ItemRec."Shortcut Dimension 5 Code" = 'L') THEN BEGIN //<TPZ3349>
        IF ItemUOM."Qty. per Unit of Measure" = 1 THEN
         UnitOfMeasureNodeBuff.AddFieldElement('Description',UOM.Description + ' ('+ FORMAT(ItemUOM."Qty. per Unit of Measure") +' unit)')
        ELSE
         UnitOfMeasureNodeBuff.AddFieldElement('Description',UOM.Description + ' ('+ FORMAT(ItemUOM."Qty. per Unit of Measure") +' units)');
       END; //<TPZ3349>
        AddItemPhysicalDimensionsToXml(UnitOfMeasureNodeBuff,ItemUOM."Item No.",ItemUOM.Code);
      END;
      //</TPZ3099>
    END;

    LOCAL PROCEDURE GetInvTextTpz@1000000004(ItemNo@1000000001 : Code[20];LocationCode@1000000000 : Code[10];InventStock@1000000002 : Decimal;UomCode@1000000009 : Code[10]) : Text;
    VAR
      Item@1000000008 : Record 27;
      RecMgt@1000000007 : Codeunit 11123326;
      Location@1000000006 : Record 14;
      EntInv@1000000005 : Decimal;
      MOS@1000000004 : Decimal;
      ItemManagement@1000000003 : Codeunit 50020;
      SalesUOMCode@1000000010 : Code[10];
      ItemUOM@1000000011 : Record 5404;
      MonthDmd@1000000012 : Decimal;
    BEGIN
      //<TPZ3109>
      RecMgt.GetItem(ItemNo,Item,TRUE);

      InvText := '';
      ColorText := '';
      SalesUOMCode := GetItemUOM(Item);
      IF SalesUOMCode = UomCode THEN BEGIN
         EntInv := ItemManagement.CalcEnterPriseInventory(Item);
         IF Item."Monthly Demand" <> 0 THEN
            MOS := (EntInv/Item."Monthly Demand");
      END ELSE BEGIN

        ItemUOM.RESET;
        IF ItemUOM.GET(ItemNo,UomCode) THEN
          IF ItemUOM."Qty. per Unit of Measure" <> 0 THEN BEGIN
           // InventStock := InventStock/ItemUOM."Qty. per Unit of Measure";
            EntInv := ItemManagement.CalcEnterPriseInventory(Item);
            EntInv := EntInv/ItemUOM."Qty. per Unit of Measure";
            MonthDmd := Item."Monthly Demand"/ItemUOM."Qty. per Unit of Measure";
           IF MonthDmd <> 0 THEN
            MOS := (EntInv/MonthDmd);
          END;
      END;

      IF EntInv <> 0 THEN BEGIN
        IF Location.GET(LocationCode) AND (Location.Type = Location.Type :: "Distribution Center") THEN BEGIN
          IF  (((3*InventStock*MOS)/EntInv) > 1) THEN BEGIN
             InvText := 'In Stock Locally';
             ColorText := '#3cb300';
           END ELSE IF (MOS > 2) THEN BEGIN
             InvText := 'In Stock (not Locally)';
             ColorText := '#3cb300';
           END ELSE IF (MOS>0) THEN BEGIN
             InvText := 'Call for availability';
             ColorText := '#cc0000';
           END ELSE BEGIN
             InvText := 'Out of stock  call for alternates';
             ColorText := '#cc0000';
           END;
        END ELSE BEGIN

           IF (((10*InventStock*MOS)/EntInv) > 1) THEN BEGIN
             InvText := 'In Stock Locally';
             ColorText := '#3cb300';
           END ELSE IF (MOS > 2) THEN BEGIN
             InvText := 'In Stock (not Locally)';
             ColorText := '#3cb300';
           END ELSE IF (MOS>0) THEN BEGIN
             InvText := 'Call for availability';
             ColorText := '#cc0000';
           END ELSE BEGIN
             InvText := 'Out of stock  call for alternates';
             ColorText := '#cc0000';
           END;

        END;
      END ELSE BEGIN
        InvText := 'Out of stock  call for alternates';
        ColorText := '#cc0000';
      END;

      EXIT(InvText);
      //</TPZ3109>
    END;

    LOCAL PROCEDURE GetSalesPriceTPZ@1000000005(Item@1000000009 : Record 27;VAR Params@1000000008 : Record 11123310) : Decimal;
    VAR
      RecMgt@1000000007 : Codeunit 11123326;
      Customer@1000000006 : Record 18;
      SalesLineBuffer@1000000005 : TEMPORARY Record 50021;
      LineNo@1000000004 : Integer;
      LastSalesPrice@1000000003 : Record 50004;
      ItemDiv@1000000002 : Record 27;
      ItemUOM@1000000001 : Record 5404;
      SalesUOMCode@1000000000 : Code[10];
    BEGIN
      //<TPZ3352>
      IF GetCallForPricetemAttr(Item) = TRUE THEN  BEGIN
         Params.Price := 0;
      END ELSE BEGIN//</TPZ3352>
        //<TPZ3099>
        ItemDiv.RESET;
        IF ItemDiv.GET(Item."No.") AND (ItemDiv."Shortcut Dimension 5 Code" <> 'L') THEN BEGIN
          RecMgt.GetCustomer(Params.AccountId,Customer,TRUE);
          LineNo+= 10000;
            SalesLineBuffer.INIT;
            SalesLineBuffer."Document Type" := SalesLineBuffer."Document Type"::Order;
            SalesLineBuffer."Document No." := '111';
            SalesLineBuffer."Line No." := LineNo;
            SalesLineBuffer.INSERT;
            SalesLineBuffer."Sell-to Customer No.":= Customer."No.";
            SalesLineBuffer.Type := SalesLineBuffer.Type::Item;
            SalesLineBuffer.VALIDATE("No.",Item."No.");
            SalesLineBuffer.MODIFY;
         // Params.Price := ConvertPriceLCYToFCY(SalesLineBuffer."Unit Price");
            Params.Price := ConvertPriceLCYToFCY(SalesLineBuffer."Recomm. Unit Price");
         // EXIT(Params.Price);
        END ELSE BEGIN
          RecMgt.GetCustomer(Params.AccountId,Customer,TRUE);
          LastSalesPrice.RESET;
          LastSalesPrice.ASCENDING;
          LastSalesPrice.SETCURRENTKEY("Sell-to Customer No.","Item No.","Document Date");
          LastSalesPrice.SETRANGE("Sell-to Customer No.",Customer."No.");
          LastSalesPrice.SETRANGE("Item No.",Item."No.");
          LastSalesPrice.SETRANGE("Document Type",LastSalesPrice."Document Type"::"Stock Status");
          LastSalesPrice.SETRANGE("Document Date",CALCDATE('-CM-12M',WORKDATE),WORKDATE);
          IF LastSalesPrice.FINDLAST THEN  //BEGIN
            Params.Price := LastSalesPrice."Last Unit Price"
          ELSE
              Params.Price := Item."High Unit Price";
        END;
      END;//<TPZ3352>
          SalesUOMCode := GetItemUOM(Item);
          ItemUOM.RESET;
          ItemUOM.SETRANGE("Item No.",Item."No.");
          //ItemUOM.SETFILTER(Code,'<>%1',SalesUOMCode);//<TPZ3319>
          ItemUOM.SETRANGE("Visible in Webshop",TRUE);
          IF ItemUOM.FINDSET THEN
           REPEAT
            IF ItemUOM.Code = Params.UnitOfMeasureId THEN BEGIN
             IF ItemUOM."Qty. per Unit of Measure" <> 1 THEN
              Params.Price := Params.Price * ItemUOM."Qty. per Unit of Measure";
            END;
           UNTIL ItemUOM.NEXT = 0;
            EXIT(Params.Price);
           // END;

       //</TPZ3099>
    END;

    PROCEDURE AddStockInfoFieldElementsToXmlTPZ@1000000006(VAR ResultNodeBuff@11123302 : Record 11123303;VAR Params@1000000000 : Record 11123310);
    BEGIN
      //<TPZ3109>
      GetInvTextTpz(Params.ProductId,GetAccountLocationCodebyDivision(Params),Params.Inventory,Params.UnitOfMeasureId);
      ResultNodeBuff.AddFieldElement('StockMessage',FORMAT(InvText));
      ResultNodeBuff.AddFieldElement('Color',FORMAT(ColorText));
      //</TPZ3109>
    END;

    PROCEDURE GetWebShopDefaultUOM@1000000007(Item@1000000000 : Record 27) : Code[10];
    VAR
      ItemUOM@1000000001 : Record 5404;
    BEGIN
      //<TPZ3319>
      ItemUOM.SETRANGE("Item No.",Item."No.");
      ItemUOM.SETRANGE("Webshop Default",TRUE);
      IF ItemUOM.FINDFIRST THEN
        EXIT(ItemUOM.Code);
      //</TPZ3319>
    END;

    LOCAL PROCEDURE GetCallForPricetemAttr@1000000009(VAR Item@1000000000 : Record 27) : Boolean;
    VAR
      ItemAttributeValueMapping@1000000001 : Record 7505;
    BEGIN
      //<TPZ3352>
      ItemAttributeValueMapping.RESET;
      ItemAttributeValueMapping.SETFILTER("Table ID",'27');
      ItemAttributeValueMapping.SETRANGE("No.",Item."No.");
      ItemAttributeValueMapping.SETFILTER("Item Attribute ID",'1063');//Call for Price
      ItemAttributeValueMapping.SETFILTER("Item Attribute Value ID",'6724'); //Call for Price-Yes
      IF ItemAttributeValueMapping.FINDFIRST THEN
        EXIT(TRUE);

      EXIT(FALSE);
      //</TPZ3352>
    END;

    LOCAL PROCEDURE GetIndoorValuefromItemAttr@1000000008(VAR Item@1000000000 : Record 27) : Boolean;
    VAR
      ItemAttributeValueMapping@1000000001 : Record 7505;
    BEGIN
      //<TPZ3320>
      ItemAttributeValueMapping.RESET;
      ItemAttributeValueMapping.SETFILTER("Table ID",'27');
      ItemAttributeValueMapping.SETRANGE("No.",Item."No.");
      ItemAttributeValueMapping.SETFILTER("Item Attribute ID",'1062');//Indoor
      ItemAttributeValueMapping.SETFILTER("Item Attribute Value ID",'6722'); //Indoor-Yes
      IF ItemAttributeValueMapping.FINDFIRST THEN
        EXIT(TRUE);

      EXIT(FALSE);
      //</TPZ3320>
    END;

    BEGIN
    {
      2016-08-23 TPZ1665 EBAGIM
        Re-map The Navigation to the new WebShop item category Code and WebShop product group code
      2019-05-20  TPZ2503 UCHOUHAN
        Added new function "GetAccountLocationCodebyDivision" and code for filtering according to division wise.
      2020-01-14 TPZ2672 UCHOUHAN
        Added code to update fields 'Long Term Product Title' and 'Short Term Product Title'.
      2020-02-19 TPZ2751 UCHOUHAN
        Added code to Show NAV pricing on sana before adding items to the cart.

      001 TPZ3099 UTK 03312021 - Added code for Sana Prices Topaz logic.
      001 TPZ3109 UTK 03312021 - Added code for Sana Stock message logic.
      002 TPZ3319 UTK 08192021 - Code Changed for SANA Default UOM.
      003 TPZ3349 UTK 09152021 - Added code to remove 'Unit' description from UOM for non Lighting Item.
      004 TPZ3352 UTK 09152021 - Price change to 0 for call for price item.
      005 TPZ3320 UTK 11032021 - Added code to get Indoor Attribute Value.
    }
    END.
  }
}

