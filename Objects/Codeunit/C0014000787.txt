OBJECT Codeunit 14000787 FedEx Transaction Web Services
{
  OBJECT-PROPERTIES
  {
    Date=07/13/20;
    Time=12:00:00 PM;
    Version List=SE0.62;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      Shipping@1240030007 : Codeunit 14000701;
      Window@1240030008 : Dialog;
      BufferFileName@1240030009 : Text[250];
      ShippingSetupRetrieved@1240030010 : Boolean;
      Text029@1029 : TextConst 'ENU=FEDEX Account %1';
      Text030@1030 : TextConst 'ENU=%1 account(s) has been manifested with FedEx';
      XMLDOMDocument@1240030012 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
      XMLRequestDocument@1240030017 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
      XMLDocOut@1240030019 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
      XMLEncode@1240030026 : Codeunit 14000786;
      XMLManagement@1240030000 : Codeunit 14000785;
      DocNameSpace@1240030015 : Text[50];
      CurrNode@1240030020 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
      XMLNsMgr@1240020001 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNamespaceManager";
      ShippingAgentService@1240030011 : Record 14000708;
      ShippingAgentAccount@1240030006 : Record 14000788;
      ShippingSetup@1240030004 : Record 14000707;
      ShippingAgent@1240030003 : Record 291;
      PackingStation@1240030002 : Record 14000709;
      FedExGlobalRegistration@1240030001 : Record 14000786;
      CarrierPackingStation@1240030005 : Record 14000729;
      HTTPResponse@1240030014 : Text[1024];
      TransactionResponse@1240030013 : Text[1024];
      TransactionStatus@1240030025 : Boolean;
      FedExPostedOptionPage@1240030027 : Record 14000782;
      NameAndAddressMgt@1240030018 : Codeunit 14000709;
      Text002@1002 : TextConst 'ENU=Use Package - Labels - Print Package Label to re-print labels';
      Text003@1003 : TextConst 'ENU=No Global Registration record.';
      Text005@1005 : TextConst 'ENU=Communicating with FedEx ...';
      Text008@1008 : TextConst 'ENU=Live FedEX Registration for account number %1 not found.';
      Text009@1009 : TextConst 'ENU=FedEx registration for account number %1 not found.';
      Text010@1010 : TextConst 'ENU=FedEx Manifest %1';
      Text011@1011 : TextConst 'ENU=Use Manifest -> Label Files -> Export Label -> Print: to re-print manifests';
      Text012@1012 : TextConst 'ENU="Error: "';
      Text013@1013 : TextConst 'ENU=Shipping Payment Type is not set as prepaid. Charges will not be displayed.';
      Text001@1001 : TextConst 'ENU=Transaction Failed. Refer to response xml for further detail.';
      Text004@1004 : TextConst 'ENU=No Tracking Information Recieved. Please verify response and try again.';
      Text006@1006 : TextConst 'ENU=Transaction Failed. Refer to Failed_HTTP_Response.xml for further details.';
      Text007@1007 : TextConst 'ENU=FedEx SmartPost Indicia must be specified when shipment is FedEx SmartPost';
      Text014@1014 : TextConst 'ENU="ERROR: "';
      Text015@1015 : TextConst 'ENU=Please correct shipment errors and reprocess.';
      Text016@1240020000 : TextConst 'ENU=End of Day Close/Print Manifest\- There are no Ground shipments to close.\- There is no FedEx Ground Pickup Manifest to print.';
      Text017@1240020101 : TextConst 'ENU=OP_950 PDF %1';
      Text018@1240020003 : TextConst 'ENU=Manifest %1';
      Text019@1240020002 : TextConst 'ENU=Return Label for %1';
      Text020@1240020004 : TextConst 'ENU=FedEx BOL cannot be created from %1.  Invalid Source Document.';
      Text021@1240020005 : TextConst 'ENU=Invalid Sales Order %1 on Bill of Lading %2';
      Text022@1240020006 : TextConst 'ENU=Invalid Package %1 on Bill of Lading %2.';
      Text023@1240020007 : TextConst 'ENU=Miscellaneous Package %1 is no longer associated\with Bill of Lading %2.\';
      Text024@1240020008 : TextConst 'ENU=\Please discard/destroy FedEx Bill Of Lading\with Tracking No. %3.';
      Text025@1240020009 : TextConst 'ENU=FedEx Freight Package %1%2 has been Re-Opened.\';
      Text026@1240020010 : TextConst 'ENU=FedEx Option Page for Bill of Lading %1 not found.';
      FedExService@1240020011 : Text[50];
      Text027@1240020012 : TextConst 'ENU=Invalid Sales Shipment %1 on Bill of Lading %2.';
      Text028@1240020013 : TextConst 'ENU=The existing FedEx BOL has been deleted.\\';
      URLSuffix@1240020014 : Text[30];

    PROCEDURE GlobalRegistrationRequest@1(VAR CurrentFedExGlobalRegistration@1240030000 : Record 14000786);
    BEGIN
      WITH CurrentFedExGlobalRegistration DO BEGIN
        ShippingAgentAccount.GET("Shipper Account No.");

        TESTFIELD("FedEx EULA Accepted");
        TESTFIELD("Shipper Company Name");
        TESTFIELD("Shipper Address 1");
        TESTFIELD("Shipper City");
        TESTFIELD("Shipper State");
        TESTFIELD("Shipper ZIP Code");
        TESTFIELD("Shipper Country Code");
        TESTFIELD("Shipper Account No.");
        TESTFIELD("Shipper Contact");
        TESTFIELD("Shipper Phone Number");
        TESTFIELD("Billing Address 1");
        TESTFIELD("Billing City");
        TESTFIELD("Billing State");
        TESTFIELD("Billing ZIP Code");
        TESTFIELD("Billing Country Code");

        "Error Code" := '';
        "Error Message" := '';
        MODIFY;

        // Process CSP Request
        IF ISNULL(XMLRequestDocument) THEN
          XMLRequestDocument := XMLRequestDocument.XmlDocument;
        IF ISNULL(XMLDocOut) THEN
          XMLDocOut := XMLDocOut.XmlDocument;

        DocNameSpace := '';
        BufferFileName := GetBufferFile();
        XMLEncode.CreateSOAPRequest(XMLRequestDocument,'RegistrationService',BufferFileName);
        XMLEncode.CreateRequestHeader('RegistrationService','CSPUserRequest',
          XMLRequestDocument,ShippingAgentAccount,CurrentFedExGlobalRegistration,'');
        XMLEncode.CreateRegistrationRequest(
          XMLRequestDocument,CurrentFedExGlobalRegistration,'CSPUserRequest');
        HTTPResponse := HTTPRequest(XMLRequestDocument,XMLDocOut,TRUE,FALSE);

        IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN BEGIN
          XMLRequestDocument.Save(CarrierPackingStation."FedEx Buffer Directory" + '\' +
            XMLManagement.FormatDateYYYYMMDD(TODAY)+'_T' +
              FormatTimeForFileOutput(TIME) + '_RegisterWebUser_Request.xml');
          XMLDocOut.Save(CarrierPackingStation."FedEx Buffer Directory" + '\' +
            XMLManagement.FormatDateYYYYMMDD(TODAY)+'_T' +
              FormatTimeForFileOutput(TIME) + '_RegisterWebUser_Response.xml');
        END;

        IF HTTPResponse <> '' THEN BEGIN
          ERROR(HTTPResponse);
        END ELSE BEGIN
          XMLNsMgr := XMLNsMgr.XmlNamespaceManager(XMLDocOut.NameTable);
          DocNameSpace := XMLEncode.VersionCheck('RegistrationService','');
          XMLNsMgr.AddNamespace(DocNameSpace,XMLEncode.GetNameSpaceURI('RegistrationService',''));
          CheckXMLResponseError(XMLDocOut,DocNameSpace,TRUE);
        END;

        WITH XMLManagement DO BEGIN
          DocNameSpace := XMLEncode.VersionCheck('RegistrationService','');
          CurrNode := XMLDocOut.DocumentElement;
          IF FindNode(CurrNode,'//'+DocNameSpace+':Credential/'+DocNameSpace+':Key',CurrNode,XMLNsMgr) THEN
            IF STRLEN(CurrNode.InnerText) > 0 THEN
              "User Key" := CurrNode.InnerText;
            CurrNode := XMLDocOut.DocumentElement;
          IF FindNode(CurrNode,'//'+DocNameSpace+':Credential/'+DocNameSpace+':Password',CurrNode,XMLNsMgr) THEN
            IF STRLEN(CurrNode.InnerText) > 0 THEN
              "User Password" := CurrNode.InnerText;
            CurrNode := XMLDocOut.DocumentElement;
          MODIFY;
        END;

        CLEAR(BufferFileName);
        CLEAR(XMLRequestDocument);
        CLEAR(XMLDocOut);
        CLEAR(TransactionResponse);

        // Process Subscription Request
        IF ISNULL(XMLRequestDocument) THEN
          XMLRequestDocument := XMLRequestDocument.XmlDocument;
        IF ISNULL(XMLDocOut) THEN
          XMLDocOut := XMLDocOut.XmlDocument;

        DocNameSpace := '';
        BufferFileName := GetBufferFile();
        XMLEncode.CreateSOAPRequest(XMLRequestDocument,'RegistrationService',BufferFileName);
        XMLEncode.CreateRequestHeader('RegistrationService','SubscriptionRequest',
          XMLRequestDocument,ShippingAgentAccount,CurrentFedExGlobalRegistration,'');
        XMLEncode.CreateRegistrationRequest(
          XMLRequestDocument,CurrentFedExGlobalRegistration,'SubscriptionRequest');
        HTTPResponse := HTTPRequest(XMLRequestDocument,XMLDocOut,TRUE,FALSE);

        IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN BEGIN
          XMLRequestDocument.Save(CarrierPackingStation."FedEx Buffer Directory" + '\' +
                                    XMLManagement.FormatDateYYYYMMDD(TODAY)+'_T' +
                                    FormatTimeForFileOutput(TIME) + '_Subscription_Request.xml');
          XMLDocOut.Save(CarrierPackingStation."FedEx Buffer Directory" + '\' +
                                    XMLManagement.FormatDateYYYYMMDD(TODAY)+'_T' +
                                    FormatTimeForFileOutput(TIME) + '_Subscription_Response.xml');
        END;

        IF HTTPResponse <> '' THEN BEGIN
          ERROR(HTTPResponse);
        END ELSE BEGIN
          XMLNsMgr := XMLNsMgr.XmlNamespaceManager(XMLDocOut.NameTable);
          DocNameSpace := XMLEncode.VersionCheck('RegistrationService','');
          XMLNsMgr.AddNamespace(DocNameSpace,XMLEncode.GetNameSpaceURI('RegistrationService',''));
          CheckXMLResponseError(XMLDocOut,DocNameSpace,TRUE);
        END;

        WITH XMLManagement DO BEGIN
          DocNameSpace := XMLEncode.VersionCheck('RegistrationService','');
          CurrNode := XMLDocOut.DocumentElement;
          IF FindNode(CurrNode,'//'+DocNameSpace+':MeterNumber',CurrNode,XMLNsMgr) THEN
            IF STRLEN(CurrNode.InnerText) > 0 THEN
              "Meter Number" := CurrNode.InnerText;
            CurrNode := XMLDocOut.DocumentElement;
            MODIFY;
        END;

        CLEAR(BufferFileName);
        CLEAR(XMLRequestDocument);
        CLEAR(XMLDocOut);
        CLEAR(TransactionResponse);

        // Process Version Capture Request
        IF ISNULL(XMLRequestDocument) THEN
          XMLRequestDocument := XMLRequestDocument.XmlDocument;
        IF ISNULL(XMLDocOut) THEN
          XMLDocOut := XMLDocOut.XmlDocument;

        DocNameSpace := '';
        BufferFileName := GetBufferFile();
        XMLEncode.CreateSOAPRequest(XMLRequestDocument,'RegistrationService',BufferFileName);
        XMLEncode.CreateRequestHeader('RegistrationService','VersionCapture',
          XMLRequestDocument,ShippingAgentAccount,CurrentFedExGlobalRegistration,'');
        XMLEncode.CreateRegistrationRequest(
          XMLRequestDocument,CurrentFedExGlobalRegistration,'VersionCapture');
        HTTPResponse := HTTPRequest(XMLRequestDocument,XMLDocOut,TRUE,FALSE);

        IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN BEGIN
          XMLRequestDocument.Save(CarrierPackingStation."FedEx Buffer Directory" + '\' +
                                    XMLManagement.FormatDateYYYYMMDD(TODAY)+'_T' +
                                    FormatTimeForFileOutput(TIME) + '_VersionCapture_Request.xml');
          XMLDocOut.Save(CarrierPackingStation."FedEx Buffer Directory" + '\' +
                                    XMLManagement.FormatDateYYYYMMDD(TODAY)+'_T' +
                                    FormatTimeForFileOutput(TIME) + '_VersionCapture_Response.xml');
        END;

        IF HTTPResponse <> '' THEN BEGIN
          ERROR(HTTPResponse);
        END ELSE BEGIN
          XMLNsMgr := XMLNsMgr.XmlNamespaceManager(XMLDocOut.NameTable);
          DocNameSpace := XMLEncode.VersionCheck('RegistrationService','');
          XMLNsMgr.AddNamespace(DocNameSpace,XMLEncode.GetNameSpaceURI('RegistrationService',''));
          CheckXMLResponseError(XMLDocOut,DocNameSpace,TRUE);
        END;

        CLEAR(BufferFileName);
        CLEAR(XMLRequestDocument);
        CLEAR(XMLDocOut);
        CLEAR(TransactionResponse);

        IF ShippingAgentAccount."Test Status" = ShippingAgentAccount."Test Status"::Live THEN
          "Live Registration" := TRUE;

        "Error Code" := '';
        "Error Message" := 'Registration Successful';

        MODIFY;
      END;
    END;

    LOCAL PROCEDURE GetBufferFile@3() BufferFileName : Text[250];
    BEGIN
      GetShippingSetup;
      GetPackingStation;

      CarrierPackingStation.TESTFIELD("FedEx Buffer Directory");
      IF COPYSTR(
           CarrierPackingStation."FedEx Buffer Directory",
           STRLEN(CarrierPackingStation."FedEx Buffer Directory"),1) =
         '\'
      THEN
        BufferFileName := CarrierPackingStation."FedEx Buffer Directory" + 'buffer.xml'
      ELSE
        BufferFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' + 'buffer.xml';
    END;

    PROCEDURE GetShippingCharge@12(VAR CurrentPackage@1240030000 : Record 14000701;ShowAllAgents@1240030001 : Boolean) TransactionStatus : Boolean;
    VAR
      FedExOptionPage@1240030002 : Record 14000781;
      FedExXMLControl@1240030007 : Record 14000791;
      FedExXMLControlExt@1240030015 : Record 14000792;
      FedExXMLControl3@1240020009 : Record 14000796;
      FedExFreightXMLControl@1240020007 : Record 14000795;
      XMLNodeList@1240020006 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNodeList";
      ChildNode@1240020005 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
      FoundNode@1240020004 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
      Loop@1240020003 : Integer;
      CurrRateType@1240020002 : Text[30];
      DesiredRateType@1240020001 : Text[30];
      RateTypeText@1240020000 : Text[30];
    BEGIN
      WITH CurrentPackage DO BEGIN
        TESTFIELD(Closed,FALSE);
        FedExService := 'RateService';
        URLSuffix := 'rate';
        GetShippingAgent("Shipping Agent Code");
        IF ShippingAgent."Disable Rate Calculation" THEN
          EXIT;

        "Shipping Charge" := 0;
        "Accessorial Charge" := 0;
        Surcharge := 0;
        "Rebate Amount" := 0;
        "Discount Amount" := 0;
        "Shipping Cost" := 0;

        GetShippingSetup;
        GetPackingStation;
        CarrierPackingStation.GetPackingStation(PackingStation);
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");
        GetShippingAgentService("Shipping Agent Code","Shipping Agent Service","World Wide Service");
        FedExOptionPage.GET(FedExOptionPage.Type::Package,"No.",0,0);
        GetGlobalShipperInfo;

        ClearTotalValueFields;
        VALIDATE("Calculation Weight",GetWeight);
        IF FedExOptionPage."Non-dutiable Document" THEN
          IF "Calculation Weight" = 0 THEN
            VALIDATE("Calculation Weight",1);
        TESTFIELD("Calculation Weight");
        GetCalculationFields(0,'=');

        IF "Packing Date" < WORKDATE THEN
          "Packing Date" := WORKDATE;

        IF ISNULL(XMLRequestDocument) THEN
          XMLRequestDocument := XMLRequestDocument.XmlDocument;
        IF ISNULL(XMLDocOut) THEN
          XMLDocOut := XMLDocOut.XmlDocument;

        FedExXMLControl.INIT;
        FedExXMLControl."Request Type" := FedExXMLControl."Request Type"::ShipService;
        FedExXMLControl."Source No." := "No.";
        FedExXMLControl."Shipper Account No." := FedExGlobalRegistration."Shipper Account No.";
        FedExXMLControl."Meter Number" := FedExGlobalRegistration."Meter Number";
        FedExXMLControlExt.INIT;
        FedExXMLControlExt."Request Type" := FedExXMLControl."Request Type"::ShipService;
        FedExXMLControl3.INIT;
        FedExXMLControl3."Request Type" := FedExXMLControl."Request Type"::ShipService;
        FedExFreightXMLControl.INIT;
        FedExFreightXMLControl."Request Type" := FedExXMLControl."Request Type"::ShipService;

        TransferPackageToXMLControl(
          CurrentPackage,FedExGlobalRegistration,CarrierPackingStation,TRUE,
            FedExXMLControl,FedExXMLControlExt,FedExXMLControl3,FedExFreightXMLControl);

        BufferFileName := GetBufferFile();
        XMLEncode.CreateSOAPRequest(XMLRequestDocument,'RateService',BufferFileName);
        XMLEncode.CreateRequestHeader(
          'RateService','RateRequest',XMLRequestDocument,ShippingAgentAccount,FedExGlobalRegistration,'');
        XMLEncode.CreateShippingRequest(
          FedExXMLControl,FedExXMLControlExt,FedExXMLControl3,FedExFreightXMLControl,
          XMLRequestDocument,TRUE,ShippingAgentService,XMLEncode.GetNameSpaceURI('RateService',''),FALSE);
        HTTPResponse := HTTPRequest(XMLRequestDocument,XMLDocOut,TRUE,FALSE);

        IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN BEGIN
          XMLRequestDocument.Save(
            CarrierPackingStation."FedEx Buffer Directory" + '\' +
            XMLManagement.FormatDateYYYYMMDD(
              TODAY) + '_T' + FormatTimeForFileOutput(TIME) + '_rateshop_buffer.xml');
          XMLDocOut.Save(
            CarrierPackingStation."FedEx Buffer Directory" + '\' +
            XMLManagement.FormatDateYYYYMMDD(
              TODAY) + '_T' + FormatTimeForFileOutput(TIME) + '_rateshop_response.xml');
        END;

        IF HTTPResponse <> '' THEN BEGIN
          ERROR(HTTPResponse);
        END ELSE BEGIN
          XMLNsMgr := XMLNsMgr.XmlNamespaceManager(XMLDocOut.NameTable);
          DocNameSpace := XMLEncode.VersionCheck('RateService','');
          XMLNsMgr.AddNamespace(DocNameSpace,XMLEncode.GetNameSpaceURI('RateService',''));
          CheckXMLResponseError(XMLDocOut,DocNameSpace,TRUE);
        END;

        WITH XMLManagement DO BEGIN
          DocNameSpace := XMLEncode.VersionCheck('RateService','');
          CurrNode := XMLDocOut.DocumentElement;
          CASE FedExXMLControl."Rate Request Type" OF
            'LIST':
              DesiredRateType := 'PAYOR_LIST';
            'PREFERRED':
              DesiredRateType := 'PAYOR_ACCOUNT';
            'NONE':
              DesiredRateType := 'PAYOR_ACCOUNT';
          END;

          XMLNodeList :=
            XMLDocOut.SelectNodes('//'+
              DocNameSpace+':RatedShipmentDetails/'+
              DocNameSpace+':ShipmentRateDetail',XMLNsMgr);

          FOR Loop := 0 TO XMLNodeList.Count - 1 DO BEGIN
            CurrNode := XMLNodeList.Item(Loop);
            ChildNode := CurrNode.FirstChild;
            CurrRateType := ChildNode.InnerText;
            IF STRPOS(CurrRateType,DesiredRateType) <> 0 THEN
              IF NOT ((ShippingAgentAccount."Do Not Use MultiWeight Rates") AND
                      (CurrRateType = 'PAYOR_ACCOUNT_SHIPMENT')) THEN BEGIN
              Surcharge := 0;
              "Base Charge" := 0;
              "Discount Amount" := 0;
              "Shipping Cost" := 0;
              "Rebate Amount" := 0;

              IF FindNode(CurrNode,DocNameSpace+':RateType',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  RateTypeText := FoundNode.InnerText;

              IF FindNode(CurrNode,DocNameSpace+':TotalSurcharges/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  Surcharge := Text2Decimal(FoundNode.InnerText);

              IF FindNode(CurrNode,DocNameSpace+':TotalBaseCharge/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  "Base Charge" := Text2Decimal(FoundNode.InnerText);

              IF FindNode(CurrNode,DocNameSpace+':TotalFreightDiscounts/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  "Discount Amount" := Text2Decimal(FoundNode.InnerText);

              IF FindNode(CurrNode,DocNameSpace+':TotalNetCharge/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  "Shipping Cost" := Text2Decimal(FoundNode.InnerText);

              IF FindNode(CurrNode,DocNameSpace+':TotalRebates/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  "Rebate Amount" := Text2Decimal(FoundNode.InnerText);
            END;
          END;
        END;

        IF NOT Closed THEN BEGIN
          Markup :=
            Shipping.GetMarkup(
              ShippingAgentService,"Shipping Cost","Ship-to Type","Ship-to No.","Ship-to Code");
          IF "Override Shipping Charge" <> 0 THEN
            "Shipping Charge" := "Override Shipping Charge"
          ELSE
            "Shipping Charge" := "Shipping Cost" + Markup + "Additional Shipping Charge";
        END;

        CLEAR(BufferFileName);
        CLEAR(XMLRequestDocument);
        CLEAR(XMLDocOut);
        CLEAR(TransactionResponse);

      END;
    END;

    PROCEDURE RateShop@14(RateShopHeader@1240030000 : Record 14000741;VAR RateShopLine@1240030001 : Record 14000742;CurrentShippingAgentService@1240030002 : Record 14000708);
    VAR
      FedExOptionPage@1240030004 : Record 14000781;
      FedExOptionPageExt@1240020008 : Record 14000793;
      RateShopLineCOD@1240030006 : Record 14000742;
      FedExTrans@1240030008 : Codeunit 14000782;
      InsureThroughShippingAgent@1240030010 : Boolean;
      FedExXMLControl@1240030013 : Record 14000791;
      FedExXMLControlExt@1240030009 : Record 14000792;
      FedExXMLControl3@1240020009 : Record 14000796;
      FedExFreightXMLControl@1240020007 : Record 14000795;
      XMLNodeList@1240020006 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNodeList";
      ChildNode@1240020005 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
      FoundNode@1240020004 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
      Loop@1240020003 : Integer;
      CurrRateType@1240020002 : Text[30];
      DesiredRateType@1240020001 : Text[30];
      RateTypeText@1240020000 : Text[30];
      TempShippingCost@1240020010 : Decimal;
      NewShippingCost@1240020011 : Decimal;
    BEGIN
      WITH RateShopHeader DO BEGIN
        FedExService := 'RateService';
        URLSuffix := 'rate';
        IF CurrentShippingAgentService."Transport Method Type" = CurrentShippingAgentService."Transport Method Type"::Freight THEN
          RateShopHeader."No. of Packages" := 1;
        IF (CurrentShippingAgentService."Service Indicator" = '70') OR
           (CurrentShippingAgentService."Service Indicator" = '80') OR
           (CurrentShippingAgentService."Service Indicator" = '83') THEN
           RateShopHeader."No. of Packages" := 1;
        GetShippingAgent(CurrentShippingAgentService."Shipping Agent Code");
        IF ShippingAgent."Disable Rate Calculation" THEN
          EXIT;

        GetShippingSetup;
        CLEAR(PackingStation);
        IF "Rate Shop Packing Station Code" <> '' THEN
          PackingStation.GET("Rate Shop Packing Station Code")
        ELSE
          GetPackingStation;
        CarrierPackingStation.GET(PackingStation."Carrier Packing Station Code");
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");
        GetGlobalShipperInfo;

        IF NOT FedExOptionPage.GET(FedExOptionPage.Type::"Rate Shop",RateShopHeader."No.",0,0) THEN
          IF NOT FedExOptionPage.GET(
            FedExOptionPage.Type::Package,RateShopHeader."Package No.",0,0) THEN
            IF NOT FedExOptionPage.GET(
                     FedExOptionPage.Type::Document,RateShopHeader."Source ID",
                     RateShopHeader."Source Type",RateShopHeader."Source Subtype")
            THEN
              IF NOT FedExOptionPage.GET(
                       FedExOptionPage.Type::"Bill of Lading",RateShopHeader."Bill of Lading No.",0,0)
              THEN BEGIN
                FedExOptionPage.RESET;
                FedExOptionPage.SETCURRENTKEY(
                  Type,"Shipping Agent Code","Shipping Agent Service","World Wide Service");
                FedExOptionPage.SETRANGE(Type,FedExOptionPage.Type::Setup);
                FedExOptionPage.SETRANGE(
                  "Shipping Agent Code",CurrentShippingAgentService."Shipping Agent Code");
                FedExOptionPage.SETRANGE("Shipping Agent Service",CurrentShippingAgentService.Code);
                FedExOptionPage.SETRANGE(
                  "World Wide Service",CurrentShippingAgentService."World Wide Service");
                IF NOT FedExOptionPage.FIND('-') THEN
                  FedExOptionPage.INIT;
              END;

        IF NOT FedExOptionPageExt.GET(FedExOptionPageExt.Type::"Rate Shop",RateShopHeader."No.",0,0) THEN
          IF NOT FedExOptionPageExt.GET(
            FedExOptionPageExt.Type::Package,RateShopHeader."Package No.",0,0) THEN
            IF NOT FedExOptionPageExt.GET(
                     FedExOptionPageExt.Type::Document,RateShopHeader."Source ID",
                     RateShopHeader."Source Type",RateShopHeader."Source Subtype")
            THEN
              IF NOT FedExOptionPageExt.GET(
                       FedExOptionPageExt.Type::"Bill of Lading",RateShopHeader."Bill of Lading No.",0,0)
              THEN BEGIN
                FedExOptionPageExt.RESET;
                FedExOptionPageExt.SETCURRENTKEY(
                  Type,"Shipping Agent Code","Shipping Agent Service","World Wide Service");
                FedExOptionPageExt.SETRANGE(Type,FedExOptionPageExt.Type::Setup);
                FedExOptionPageExt.SETRANGE(
                  "Shipping Agent Code",CurrentShippingAgentService."Shipping Agent Code");
                FedExOptionPageExt.SETRANGE("Shipping Agent Service",CurrentShippingAgentService.Code);
                FedExOptionPageExt.SETRANGE(
                  "World Wide Service",CurrentShippingAgentService."World Wide Service");
                IF NOT FedExOptionPageExt.FIND('-') THEN
                  FedExOptionPageExt.INIT;
              END;
        IF FedExOptionPageExt.Palletized THEN
          IF FedExOptionPageExt."No. of Pallets" > "No. of Packages" THEN BEGIN
            "No. of Packages" := FedExOptionPageExt."No. of Pallets";
          END;
        IF "No. of Packages" < 1 THEN
          "No. of Packages" := 1;
        VALIDATE("Calculation Weight",GetWeight / "No. of Packages");
        IF FedExOptionPage."Non-dutiable Document" THEN
          IF "Calculation Weight" = 0 THEN
            VALIDATE("Calculation Weight",1);
        TESTFIELD("Calculation Weight");

        "Calculation Value" := GetValue / "No. of Packages";

        CASE "Shipping Insurance" OF
          "Shipping Insurance"::" ":
            IF "Shipping Payment Type" = "Shipping Payment Type"::Prepaid THEN
              InsureThroughShippingAgent := ShippingAgentAccount."Insure Through Carrier"
            ELSE
              InsureThroughShippingAgent := ShippingAgentAccount."Insured Third Party/Collect";
          "Shipping Insurance"::Never:
            InsureThroughShippingAgent := FALSE;
          "Shipping Insurance"::Always:
            InsureThroughShippingAgent := TRUE;
        END;
        "Calculation Insured Value" := GetInsuredValue(InsureThroughShippingAgent) / "No. of Packages";

        "Calculation Volume" := GetVolume / "No. of Packages";

        IF ShippingAgentAccount."COD Rule" <>
           ShippingAgentAccount."COD Rule"::"All on Last Package"
        THEN
          "COD Amount" := "COD Amount" / "No. of Packages";

        IF ISNULL(XMLRequestDocument) THEN
          XMLRequestDocument := XMLRequestDocument.XmlDocument;
        IF ISNULL(XMLDocOut) THEN
          XMLDocOut := XMLDocOut.XmlDocument;

        FedExXMLControl.INIT;
        FedExXMLControl."Request Type" := FedExXMLControl."Request Type"::RateService;
        FedExXMLControl."Source No." := "No.";
        FedExXMLControl."Shipper Account No." := FedExGlobalRegistration."Shipper Account No.";
        FedExXMLControl."Meter Number" := FedExGlobalRegistration."Meter Number";
        FedExXMLControl."World Wide Service" := CurrentShippingAgentService."World Wide Service";
        FedExXMLControl."Payment Type" := 'SENDER';
        FedExXMLControlExt.INIT;
        FedExXMLControlExt."Request Type" := FedExXMLControl."Request Type"::RateService;
        FedExXMLControl3.INIT;
        FedExXMLControl3."Request Type" := FedExXMLControl."Request Type"::RateService;
        FedExFreightXMLControl.INIT;
        FedExFreightXMLControl."Request Type" := FedExXMLControl."Request Type"::RateService;

        ShippingAgentService.COPY(CurrentShippingAgentService);
        TransferRateHdrToXMLControl(
          RateShopHeader,CurrentShippingAgentService,FedExGlobalRegistration,
            FedExXMLControl,FedExXMLControlExt,FedExXMLControl3,FedExFreightXMLControl,FALSE);

        BufferFileName := GetBufferFile();
        XMLEncode.CreateSOAPRequest(XMLRequestDocument,'RateService',BufferFileName);
        XMLEncode.CreateRequestHeader('RateService','RateRequest',XMLRequestDocument,ShippingAgentAccount,FedExGlobalRegistration,'');
        XMLEncode.CreateShippingRequest(FedExXMLControl,FedExXMLControlExt,FedExXMLControl3,FedExFreightXMLControl,
          XMLRequestDocument,TRUE,ShippingAgentService,XMLEncode.GetNameSpaceURI('RateService',''),TRUE);
        SLEEP(1000);
        HTTPResponse := HTTPRequest(XMLRequestDocument,XMLDocOut,TRUE,FALSE);

        IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN BEGIN
          XMLRequestDocument.Save(
            CarrierPackingStation."FedEx Buffer Directory" + '\' +
            XMLManagement.FormatDateYYYYMMDD(
              TODAY) + '_T' + FormatTimeForFileOutput(TIME) + '_rateshop_buffer - ' +
              FORMAT(
                CurrentShippingAgentService.Code) +'.xml');
          XMLDocOut.Save(
            CarrierPackingStation."FedEx Buffer Directory" + '\' +
            XMLManagement.FormatDateYYYYMMDD(
              TODAY) + '_T' + FormatTimeForFileOutput(TIME) + '_rateshop_response - ' +
              FORMAT(
                CurrentShippingAgentService.Code) +'.xml');
        END;

        XMLNsMgr := XMLNsMgr.XmlNamespaceManager(XMLDocOut.NameTable);
        DocNameSpace := XMLEncode.VersionCheck('RateService','');
        XMLNsMgr.AddNamespace(DocNameSpace,XMLEncode.GetNameSpaceURI('RateService',''));
        TransactionResponse := CheckXMLResponseError(XMLDocOut,DocNameSpace,FALSE);

        RateShopLine.INIT;
        RateShopLine."Rate Shop No." := "No.";
        RateShopLine."Shipping Agent Code" := CurrentShippingAgentService."Shipping Agent Code";
        RateShopLine."World Wide Service" := CurrentShippingAgentService."World Wide Service";
        RateShopLine."Shipping Agent Service" := CurrentShippingAgentService.Code;
        RateShopLine."Insure Through Shipping Agent" := InsureThroughShippingAgent;
        RateShopLine.Sorting := CurrentShippingAgentService."Rateshop Sorting";
        RateShopLine."Service Description" := CurrentShippingAgentService.Description;
        RateShopLine."Service Error Message" := TransactionResponse;

        IF TransactionResponse = '' THEN
          IF "Shipping Payment Type" <> "Shipping Payment Type"::Prepaid THEN
            RateShopLine."Service Error Message" := Text013;

        WITH XMLManagement DO BEGIN
          DocNameSpace := XMLEncode.VersionCheck('RateService','');
          CurrNode := XMLDocOut.DocumentElement;
          CASE FedExXMLControl."Rate Request Type" OF
            'LIST':
              DesiredRateType := 'PAYOR_LIST';
            'PREFERRED':
              DesiredRateType := 'PAYOR_ACCOUNT';
            'NONE':
              DesiredRateType := 'PAYOR_ACCOUNT';
          END;

          IF FindNode(CurrNode,'//'+DocNameSpace+':RateReplyDetails/'+
            DocNameSpace+':TransitTime',FoundNode,XMLNsMgr) THEN
              RateShopLine."Transit Time" := FoundNode.InnerText;

          IF RateShopLine."Transit Time" = '' THEN BEGIN
            IF FindNode(CurrNode,'//'+DocNameSpace+':RateReplyDetails/'+
              DocNameSpace+':DeliveryDayOfWeek',FoundNode,XMLNsMgr) THEN
            RateShopLine."Transit Time" := FoundNode.InnerText;
          END;

          CurrNode := XMLDocOut.DocumentElement;
          XMLNodeList :=
            XMLDocOut.SelectNodes('//'+
              DocNameSpace+':RatedShipmentDetails/'+
              DocNameSpace+':ShipmentRateDetail',XMLNsMgr);

          FOR Loop := 0 TO XMLNodeList.Count - 1 DO BEGIN
            CurrNode := XMLNodeList.Item(Loop);
            ChildNode := CurrNode.FirstChild;
            CurrRateType := ChildNode.InnerText;

            IF STRPOS(CurrRateType,DesiredRateType) <> 0 THEN BEGIN
              RateShopLine.Surcharge := 0;
              RateShopLine."Base Charge" := 0;
              RateShopLine."Discount Amount" := 0;
              RateShopLine."Shipping Cost" := 0;
              RateShopLine."Rebate Amount" := 0;

              IF FindNode(CurrNode,DocNameSpace+':RateType',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  RateTypeText := FoundNode.InnerText;

              IF FindNode(CurrNode,DocNameSpace+':TotalSurcharges/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  RateShopLine.Surcharge := Text2Decimal(FoundNode.InnerText);

              IF FindNode(CurrNode,DocNameSpace+':TotalBaseCharge/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  RateShopLine."Base Charge" := Text2Decimal(FoundNode.InnerText);

              IF FindNode(CurrNode,DocNameSpace+':TotalFreightDiscounts/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  RateShopLine."Discount Amount" := Text2Decimal(FoundNode.InnerText);

              IF FindNode(CurrNode,DocNameSpace+':TotalNetCharge/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  RateShopLine."Shipping Cost" := Text2Decimal(FoundNode.InnerText);

              IF FindNode(CurrNode,DocNameSpace+':TotalRebates/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  RateShopLine."Rebate Amount" := Text2Decimal(FoundNode.InnerText);
            END;
          END;
        END;

        RateShopLine.Markup :=
          Shipping.GetMarkup(
            CurrentShippingAgentService,RateShopLine."Shipping Cost",
            0,"Sell-to Customer No.","Ship-to Code");
        RateShopLine."Shipping Charge" :=
          RateShopLine."Shipping Cost" + RateShopLine.Markup + "Additional Shipping Charge";
        TestAndTransferToThirdPartyRS(
          RateShopHeader,RateShopLine,FedExOptionPage,CurrentShippingAgentService);

        IF "No. of Packages" > 1 THEN BEGIN
          IF COD AND
             (ShippingAgentAccount."COD Rule" = ShippingAgentAccount."COD Rule"::"All on Last Package")
          THEN BEGIN
            RateShopLineCOD := RateShopLine;
            COD := FALSE;
            FedExTrans.RateShop(RateShopHeader,RateShopLine,CurrentShippingAgentService);
            RateShopLine.DELETE;
            RateShopLine.DivideCharges("No. of Packages");
            RateShopLine.MultiplyCharges("No. of Packages" - 1);
            RateShopLine.AddCharges(RateShopLineCOD);
            COD := TRUE;
          END ELSE
            RateShopLine.MultiplyCharges("No. of Packages");
        END;

        IF "Value (Price)" <> 0 THEN
          RateShopLine."Order Amount" := "Value (Price)"
        ELSE
          RateShopLine."Order Amount" := "Override Value";
        RateShopLine."Total Amount" :=
          RateShopLine."Order Amount" + RateShopLine."Shipping Charge";
        RateShopLine.INSERT;

        CLEAR(BufferFileName);
        CLEAR(XMLRequestDocument);
        CLEAR(XMLDocOut);
        CLEAR(TransactionResponse);

      END;
    END;

    PROCEDURE ClosePackage@7(VAR CurrentPackage@1240030000 : Record 14000701;VAR MultiDocPackageTmp@1240030001 : Record 14000701;CurrentShippingAgent@1240030002 : Record 291;PrintLabel@1240030003 : Boolean);
    VAR
      FedExOptionPage@1240030004 : Record 14000781;
      Package@1240030007 : Record 14000701;
      Package2@1240030026 : Record 14000701;
      MultiDocPackageMgt@1240030012 : Codeunit 14000703;
      CODMarkup@1240030025 : Decimal;
      LabelStream@1240030006 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.MemoryStream";
      PdfStream@1240020012 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.MemoryStream";
      XMLNodeList@1240030005 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNodeList";
      PdfNodeList@1240020013 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNodeList";
      PartNodeList@1240020010 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNodeList";
      ChildNode@1240030010 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
      Convert@1240020005 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Convert";
      Bytes@1240020006 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Array";
      MemoryStream@1240020007 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.MemoryStream";
      TempOutstream@1240020008 : OutStream;
      Tempfile@1240020009 : File;
      FedExXMLControl@1240030013 : Record 14000791;
      FedExXMLControlExt@1240030008 : Record 14000792;
      FedExXMLControl3@1240021008 : Record 14000796;
      FedExFreightXMLControl@1240020017 : Record 14000795;
      LabelFileName@1240030011 : Text[250];
      PdfFileName@1240020014 : Text[250];
      ExportSourceLine@1240030009 : Record 14000983;
      Loop@1240030014 : Integer;
      PdfLoop@1240020015 : Integer;
      PartLoop@1240020011 : Integer;
      FoundNode@1240020004 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
      CurrRateType@1240020003 : Text[30];
      DesiredRateType@1240020002 : Text[30];
      RateTypeText@1240020001 : Text[30];
      XMLNodeListLength@1240020000 : Integer;
      ShipmentDocType@1240020080 : Text[30];
      PackageDocType@1240020016 : Text[50];
      ElectronicDocName@1240020105 : Text[50];
      ElectronicDocID@1240020106 : Text[50];
      FedExOptionPageExt@1240020107 : Record 14000793;
      SaveFileName@1240020018 : Text[250];
      TempFileLength@1240020020 : Integer;
      CodFileName@1240020021 : Text[250];
      RatedWeightMethod@1240020019 : Text[30];
      ExportDoc@1240020022 : Record 14000981;
      RateMethod@1240020023 : 'Package,Shipment';
      CustTransId@1240021018 : Text[50];
      CurrentPackage2@1240020024 : Record 14000701;
      FedExFreight@1240020025 : Boolean;
      OnBOL@1240020026 : Boolean;
    BEGIN
      WITH CurrentPackage DO BEGIN
        TESTFIELD(Closed,FALSE);
        FedExOptionPage.GET(FedExOptionPage.Type::Package,"No.",0,0);
        FedExOptionPageExt.GET(FedExOptionPageExt.Type::Package,"No.",0,0);
        FedExService := 'ShipService';
        URLSuffix := 'ship';
        IF (CurrentPackage."Service Indicator" = 'FEF1') OR
           (CurrentPackage."Service Indicator" = 'FEF2') THEN BEGIN
             CurrentPackage."Package No." := 1;
             CurrentPackage."Total Packages" := 1;
             FedExFreight := TRUE;
             OnBOL := CheckForBillOfLading(CurrentPackage);
          END;

        IF "Manual Shipment" THEN BEGIN
          IF CurrentShippingAgent."Enter Ext. Track. No. on Close" THEN
            Shipping.EnterExternalTrackingNo(CurrentPackage,FALSE);

          "Closed by Packing Station Code" := PackingStation.Code;
          ClearTotalValueFields;
          VALIDATE("Calculation Weight",GetWeight);
          IF FedExOptionPage."Non-dutiable Document" THEN
            IF "Calculation Weight" = 0 THEN
              VALIDATE("Calculation Weight",1);
          GetCalculationFields(0,'=');
          "Packing Date" := WORKDATE;
          "Packing Time" := TIME;
          "Packed By" := USERID;
          "Shipping Cost" := 0;
          Markup := 0;
          IF "Override Shipping Charge" <> 0 THEN
            "Shipping Charge" := "Override Shipping Charge"
          ELSE
            "Shipping Charge" := "Shipping Cost" + Markup + "Additional Shipping Charge";
          Closed := TRUE;
          MODIFY;
          COMMIT;

          IF "Multi Document Package" THEN BEGIN
            GetShippingSetup;
            GetPackingStation;
            MultiDocPackageMgt.SplitMultiDocPackage(
              CurrentPackage,MultiDocPackageTmp,PackingStation,ShippingSetup);
            COMMIT;
          END;

          EXIT;
        END;

        GetShippingSetup;
        GetPackingStation;
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        IF PrintLabel THEN
          CarrierPackingStation.TESTFIELD("FedEx Label Printer Port");
        GetShippingAgent("Shipping Agent Code");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");
        GetShippingAgentService("Shipping Agent Code","Shipping Agent Service","World Wide Service");
        GetGlobalShipperInfo;
        CheckName(
          ShippingAgent,0,"Ship-to Name","Ship-to Name 2","Ship-to Contact",
          FIELDCAPTION("Ship-to Name"),FIELDCAPTION("Ship-to Name 2"),FIELDCAPTION("Ship-to Contact"));
        CheckAddress(
          ShippingAgent,0,"Ship-to Address","Ship-to Address 2","Ship-to City",
          "Ship-to ZIP Code","Ship-to State","Ship-to Country Code",
          FIELDCAPTION("Ship-to Address"),FIELDCAPTION("Ship-to Address 2"),
          FIELDCAPTION("Ship-to City"),FIELDCAPTION("Ship-to ZIP Code"),
          FIELDCAPTION("Ship-to State"),FIELDCAPTION("Ship-to Country Code"));

        CarrierPackingStation.TESTFIELD("FedEx Label Buffer File");
        LabelFileName := PackingStation.CalcLabelFileName(
          CarrierPackingStation."FedEx Label Buffer File");

        IF CurrentShippingAgent."Enter Ext. Track. No. on Close" THEN
          Shipping.EnterExternalTrackingNo(CurrentPackage,FALSE);

        "Closed by Packing Station Code" := PackingStation.Code;
        ClearTotalValueFields;
        VALIDATE("Calculation Weight",GetWeight);
        IF FedExOptionPage."Non-dutiable Document" THEN
          IF "Calculation Weight" = 0 THEN
            VALIDATE("Calculation Weight",1);
        TESTFIELD("Calculation Weight");
        GetCalculationFields(1,'=');

        IF "World Wide Service" THEN
          CASE ShippingAgentAccount."Export Declare Value As" OF
            ShippingAgentAccount."Export Declare Value As"::Cost:
              BEGIN
                IF TotalValueCost > FedExOptionPage."Export Declared Value" THEN
                FedExOptionPage."Export Declared Value" := TotalValueCost;
                FedExOptionPage.MODIFY;
              END;
            ShippingAgentAccount."Export Declare Value As"::Price:
              BEGIN
                IF TotalValuePrice > FedExOptionPage."Export Declared Value" THEN
                FedExOptionPage."Export Declared Value" := TotalValuePrice;
                FedExOptionPage.MODIFY;
              END;
          END;

        CarrierPackingStation.TESTFIELD("FedEx Label Printer Type");
        CarrierPackingStation.TESTFIELD("FedEx Label Media Type");

        IF "Packing Date" < WORKDATE THEN
          "Packing Date" := WORKDATE;

        FedExXMLControl.INIT;
        FedExXMLControl."Request Type" := FedExXMLControl."Request Type"::ShipService;
        FedExXMLControl."Source No." := "No.";
        FedExXMLControl."Shipper Account No." := FedExGlobalRegistration."Shipper Account No.";
        FedExXMLControl."Meter Number" := FedExGlobalRegistration."Meter Number";
        FedExXMLControlExt.INIT;
        FedExXMLControlExt."Request Type" := FedExXMLControl."Request Type"::ShipService;
        FedExXMLControl3.INIT;
        FedExXMLControl3."Request Type" := FedExXMLControl."Request Type"::ShipService;

        IF "World Wide Service" AND ("Package No." = 1) THEN
          IF "Export Document No." <> '' THEN BEGIN
            ExportDoc.GET("Export Document No.");
            IF NOT ExportDoc.Submitted THEN
            ExportSourceLine.ReCreateAllSrceLinesFromPkgs("Export Document No.",ShippingSetup,TRUE);
          END;

        TransferPackageToXMLControl(
          CurrentPackage,FedExGlobalRegistration,CarrierPackingStation,FALSE,
            FedExXMLControl,FedExXMLControlExt,FedExXMLControl3,FedExFreightXMLControl);

        FedExOptionPage.GET(FedExOptionPage.Type::Package,"No.",0,0);
        FedExOptionPageExt.GET(FedExOptionPageExt.Type::Package,"No.",0,0);
        // Multi package
        IF ("Total Packages" > 1) AND (NOT Miscellaneous) THEN
          IF "Package No." = 1 THEN
            "First Package No." := "No."
          ELSE BEGIN
            Package2.RESET;
            Package2.SETCURRENTKEY("Source Type","Source Subtype","Source ID");
            Package2.SETRANGE("Source Type","Source Type");
            Package2.SETRANGE("Source Subtype","Source Subtype");
            IF "Multi Document Package" THEN
              Package2.SETFILTER("Source ID","Multi Document No.")
            ELSE
              Package2.SETRANGE("Source ID","Source ID");
            Package2.SETFILTER("Package No.",'1');
            Package2.SETRANGE("Total Packages","Total Packages");
            IF Package2.FIND('-') THEN
              "First Package No." := Package2."No."
            ELSE BEGIN
              "Package No." := 1;
              "Total Packages" := 1;
              "First Package No." := '';
            END;
          END;

        IF "Packing Date" < WORKDATE THEN
          "Packing Date" := WORKDATE;

        IF ISNULL(XMLRequestDocument) THEN
          XMLRequestDocument := XMLRequestDocument.XmlDocument;
        IF ISNULL(XMLDocOut) THEN
          XMLDocOut := XMLDocOut.XmlDocument;

        BufferFileName := GetBufferFile();
        XMLEncode.CreateSOAPRequest(XMLRequestDocument,'ShipService',BufferFileName);
        IF FedExOptionPageExt."Call Tag Request" THEN BEGIN
          XMLEncode.CreateRequestHeader(
            'ShipService','ProcessTagRequest',
            XMLRequestDocument,ShippingAgentAccount,
            FedExGlobalRegistration,'');
        END ELSE
          XMLEncode.CreateRequestHeader(
            'ShipService','ProcessShipmentRequest',XMLRequestDocument,ShippingAgentAccount,
            FedExGlobalRegistration,'');

        XMLEncode.CreateShippingRequest(
          FedExXMLControl,FedExXMLControlExt,FedExXMLControl3,FedExFreightXMLControl,XMLRequestDocument,
          FALSE,ShippingAgentService,XMLEncode.GetNameSpaceURI('ShipService',''),FALSE);

        HTTPResponse := HTTPRequest(XMLRequestDocument,XMLDocOut,TRUE,FALSE);

        IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN BEGIN
          XMLRequestDocument.Save(CarrierPackingStation."FedEx Buffer Directory" + '\' +
                                    XMLManagement.FormatDateYYYYMMDD(TODAY)+'_T' +
                                    FormatTimeForFileOutput(
                                      TIME) + '-' + "No." + '-' +
                                      FORMAT(
                                        "Package No.") + 'of' +
                                        FORMAT(
                                          "Total Packages") + '_ship_buffer.xml');

            XMLDocOut.Save(CarrierPackingStation."FedEx Buffer Directory" + '\' +
                             XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                             FormatTimeForFileOutput(
                               TIME) + '-' + "No." + '-' +
                               FORMAT(
                                 "Package No.") + 'of' +
                                 FORMAT(
                                   "Total Packages") + '_ship_response.xml');
        END;

        IF HTTPResponse <> '' THEN BEGIN
          ERROR(HTTPResponse);
        END ELSE BEGIN
          IF XMLDocOut.HasChildNodes <> TRUE THEN
            ERROR(Text001);

          XMLNsMgr := XMLNsMgr.XmlNamespaceManager(XMLDocOut.NameTable);
          DocNameSpace := XMLEncode.VersionCheck('ShipService','');
          XMLNsMgr.AddNamespace(DocNameSpace,XMLEncode.GetNameSpaceURI('ShipService',''));
          CheckXMLResponseError(XMLDocOut,DocNameSpace,TRUE);
        END;

        Surcharge := 0;
        "Base Charge" := 0;
        "Discount Amount" := 0;
        "Shipping Cost" := 0;
        "Rebate Amount" := 0;

        WITH XMLManagement DO BEGIN
          DocNameSpace := XMLEncode.VersionCheck('ShipService','');
          CurrNode := XMLDocOut.DocumentElement;
          IF FindNode(
            CurrNode,'//'+DocNameSpace+':MasterTrackingId/'+DocNameSpace+':TrackingNumber',CurrNode,XMLNsMgr)
            THEN
            IF STRLEN(CurrNode.InnerText) > 0 THEN BEGIN
              FedExOptionPage."Master Tracking No." := CurrNode.InnerText;
              FedExOptionPage.MODIFY;
              IF "Package No." = 1 THEN
                "External Tracking No." := CurrNode.InnerText;
                IF CurrNode.InnerText = '' THEN
                  ERROR(Text004);
              CurrNode := XMLDocOut.DocumentElement;
            END;
          IF FindNode(
            CurrNode,'//'+DocNameSpace+':MasterTrackingId/'+DocNameSpace+':FormId',CurrNode,XMLNsMgr)
            THEN
            IF STRLEN(CurrNode.InnerText) > 0 THEN BEGIN
              FedExOptionPage."Tracking Form ID" := CurrNode.InnerText;
              FedExOptionPage.MODIFY;
            END;
            CurrNode := XMLDocOut.DocumentElement;
          IF FindNode(CurrNode,'//'+DocNameSpace+':CodRoutingDetail/'+DocNameSpace+':AstraDetails/'+
            DocNameSpace+':TrackingId/'+DocNameSpace+':TrackingNumber',CurrNode,XMLNsMgr) THEN
            IF STRLEN(CurrNode.InnerText) > 0 THEN BEGIN
              FedExOptionPage."COD Return Tracking No." := CurrNode.InnerText;
              FedExOptionPage.MODIFY;
              IF "Package No." = 1 THEN
                "External Tracking No." := CurrNode.InnerText;
              CurrNode := XMLDocOut.DocumentElement;
            END;
          IF FindNode(CurrNode,'//'+DocNameSpace+':CodRoutingDetail/'+DocNameSpace+':AstraDetails/'+
            DocNameSpace+':TrackingId/'+DocNameSpace+':FormId',CurrNode,XMLNsMgr) THEN
            IF STRLEN(CurrNode.InnerText) > 0 THEN BEGIN
              FedExOptionPage."COD Return Form ID" := CurrNode.InnerText;
              FedExOptionPage.MODIFY;
            END;

          CurrNode := XMLDocOut.DocumentElement;
          CASE FedExXMLControl."Rate Request Type" OF
            'LIST':
              DesiredRateType := 'PAYOR_LIST';
            'PREFERRED':
              DesiredRateType := 'PAYOR_ACCOUNT';
            'NONE':
              DesiredRateType := 'PAYOR_ACCOUNT';
          END;

          XMLNodeList :=
            XMLDocOut.SelectNodes('//'+
              DocNameSpace+':CompletedShipmentDetail/'+
              DocNameSpace+':CompletedPackageDetails/'+
              DocNameSpace+':PackageRating',XMLNsMgr);
          IF XMLNodeList.Count > 0 THEN
            FOR Loop := 0 TO XMLNodeList.Count - 1 DO BEGIN
              CurrNode := XMLNodeList.Item(Loop);
              ChildNode := CurrNode.FirstChild;
              RateMethod := RateMethod::Package;
            END;
          XMLNodeList :=
            XMLDocOut.SelectNodes('//'+
              DocNameSpace+':CompletedShipmentDetail/'+
              DocNameSpace+':ShipmentRating',XMLNsMgr);
          IF XMLNodeList.Count > 0 THEN
            FOR Loop := 0 TO XMLNodeList.Count - 1 DO BEGIN
              CurrNode := XMLNodeList.Item(Loop);
              ChildNode := CurrNode.FirstChild;
              RateMethod := RateMethod::Shipment;
            END;
          CASE RateMethod OF
            RateMethod::Package:
              XMLNodeList :=
                XMLDocOut.SelectNodes('//'+
                  DocNameSpace+':CompletedShipmentDetail/'+
                  DocNameSpace+':CompletedPackageDetails/'+
                  DocNameSpace+':PackageRating/'+
                  DocNameSpace+':PackageRateDetails',XMLNsMgr);
            RateMethod::Shipment:
              XMLNodeList :=
                XMLDocOut.SelectNodes('//'+
                  DocNameSpace+':CompletedShipmentDetail/'+
                  DocNameSpace+':ShipmentRating/'+
                  DocNameSpace+':ShipmentRateDetails',XMLNsMgr);
          END;

          FOR Loop := 0 TO XMLNodeList.Count - 1 DO BEGIN
            CurrNode := XMLNodeList.Item(Loop);
            ChildNode := CurrNode.FirstChild;
            CurrRateType := ChildNode.InnerText;

            IF STRPOS(CurrRateType,DesiredRateType) <> 0 THEN BEGIN
              Surcharge := 0;
              "Base Charge" := 0;
              "Discount Amount" := 0;
              "Shipping Cost" := 0;
              "Rebate Amount" := 0;

              IF FindNode(CurrNode,DocNameSpace+':RateType',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  RateTypeText := FoundNode.InnerText;
              IF FindNode(CurrNode,DocNameSpace+':RatedWeightMethod',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  RatedWeightMethod := FoundNode.InnerText;
              IF RatedWeightMethod = 'DIM' THEN BEGIN
                "Use Dim Weight" := TRUE;
                IF FindNode(CurrNode,DocNameSpace+':TotalDimWeight/'+
                  DocNameSpace+':Value',FoundNode,XMLNsMgr) THEN
                    IF STRLEN(FoundNode.InnerText) > 0 THEN BEGIN
                      "Calculation Weight" := Text2Decimal(FoundNode.InnerText);
                      "Dimensional Weight" := "Calculation Weight";
                    END;
              END ELSE
                "Use Dim Weight" := FALSE;

              IF FindNode(CurrNode,DocNameSpace+':TotalSurcharges/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  Surcharge := Text2Decimal(FoundNode.InnerText);

              IF FindNode(CurrNode,DocNameSpace+':TotalBaseCharge/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  "Base Charge" := Text2Decimal(FoundNode.InnerText);

              IF FindNode(CurrNode,DocNameSpace+':TotalFreightDiscounts/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  "Discount Amount" := Text2Decimal(FoundNode.InnerText);

              IF FindNode(CurrNode,DocNameSpace+':TotalNetCharge/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  "Shipping Cost" := Text2Decimal(FoundNode.InnerText);

              IF FindNode(CurrNode,DocNameSpace+':TotalRebates/'+DocNameSpace+':Amount',FoundNode,XMLNsMgr) THEN
                IF STRLEN(FoundNode.InnerText) > 0 THEN
                  "Rebate Amount" := Text2Decimal(FoundNode.InnerText);
            END;
          END;

          CurrNode := XMLDocOut.DocumentElement;

          IF FedExOptionPageExt."Call Tag Request" THEN BEGIN
            IF FindNode(CurrNode,'//'+DocNameSpace+':ProcessTagReply/'+DocNameSpace+':TrackingIds/'
            +DocNameSpace+':TrackingNumber',CurrNode,XMLNsMgr) THEN
              IF STRLEN(CurrNode.InnerText) > 0 THEN
                "External Tracking No." := CurrNode.InnerText;
            CurrNode := XMLDocOut.DocumentElement;

            FedExOptionPage."Return Confirmation No." := "External Tracking No.";
            FedExOptionPage.MODIFY;
            CurrNode := XMLDocOut.DocumentElement;
          END ELSE BEGIN
            XMLNodeList :=
              XMLDocOut.SelectNodes('//'+DocNameSpace+':CompletedPackageDetails/'+DocNameSpace+
              ':TrackingIds',XMLNsMgr);
            IF XMLNodeList.Count > 1 THEN BEGIN
              FOR Loop := 0 TO XMLNodeList.Count - 1 DO BEGIN
                CurrNode := XMLNodeList.Item(Loop);
                ChildNode := CurrNode.FirstChild;
                IF  ChildNode.InnerText = 'GROUND' THEN BEGIN
                  ChildNode := CurrNode.LastChild;
                  "External Tracking No." := ChildNode.InnerText;
                END;
                IF ChildNode.InnerText = 'USPS' THEN BEGIN
                  ChildNode := CurrNode.LastChild;
                  "USPS Tracking ID" := ChildNode.InnerText;
                END;
              END;
            END ELSE
              IF FindNode(CurrNode,'//'+DocNameSpace+':CompletedPackageDetails/'+DocNameSpace+
                ':TrackingIds/'+DocNameSpace+':TrackingNumber',CurrNode,XMLNsMgr) THEN
                IF STRLEN(CurrNode.InnerText) > 0 THEN
                  "External Tracking No." := CurrNode.InnerText;
            CurrNode := XMLDocOut.DocumentElement;
            FedExOptionPage."FedEx Tracking No." := "External Tracking No.";
            FedExOptionPage.MODIFY;
          END;

          FedExOptionPageExt.GET(FedExOptionPageExt.Type::Package,"No.",0,0);
          CurrNode := XMLDocOut.DocumentElement;
          XMLNodeList :=
            XMLDocOut.SelectNodes('//'+
              DocNameSpace+':CompletedShipmentDetail/'+
              DocNameSpace+':CompletedEtdDetail/'+
              DocNameSpace+':UploadDocumentReferenceDetails',XMLNsMgr);

          FOR Loop := 0 TO XMLNodeList.Count - 1 DO BEGIN
            CurrNode := XMLNodeList.Item(Loop);
            ChildNode := CurrNode.FirstChild;
            ElectronicDocName := ChildNode.InnerText;

            IF FindNode(CurrNode,DocNameSpace+':DocumentType',FoundNode,XMLNsMgr) THEN
              IF STRLEN(FoundNode.InnerText) > 0 THEN
                ElectronicDocName := FoundNode.InnerText;

            CASE ElectronicDocName OF
              'ETD_LABEL':
                IF FindNode(CurrNode,DocNameSpace+':DocumentId',FoundNode,XMLNsMgr) THEN
                  IF STRLEN(FoundNode.InnerText) > 0 THEN
                    FedExOptionPageExt."ETD Reference ID" := FoundNode.InnerText;
              'CERTIFICATE_OF_ORIGIN':
                IF FindNode(CurrNode,DocNameSpace+':DocumentId',FoundNode,XMLNsMgr) THEN
                  IF STRLEN(FoundNode.InnerText) > 0 THEN
                    FedExOptionPageExt."ETD Certificate of Origin ID" := FoundNode.InnerText;
              'PRO_FORMA_INVOICE':
                IF FindNode(CurrNode,DocNameSpace+':DocumentId',FoundNode,XMLNsMgr) THEN
                  IF STRLEN(FoundNode.InnerText) > 0 THEN
                    FedExOptionPageExt."ETD Pro Forma Invoice ID" := FoundNode.InnerText;
              'COMMERCIAL_INVOICE':
                IF FindNode(CurrNode,DocNameSpace+':DocumentId',FoundNode,XMLNsMgr) THEN
                  IF STRLEN(FoundNode.InnerText) > 0 THEN
                    FedExOptionPageExt."ETD Commercial Invoice ID":= FoundNode.InnerText;
              'NAFTA_CERTIFICATE_OF_ORIGIN':
                IF FindNode(CurrNode,DocNameSpace+':DocumentId',FoundNode,XMLNsMgr) THEN
                  IF STRLEN(FoundNode.InnerText) > 0 THEN
                    FedExOptionPageExt."ETD NAFTA Cert. of Origin ID" := FoundNode.InnerText;
            END;
            FedExOptionPageExt.MODIFY;
          END;

          IF ERASE(LabelFileName) THEN;
          LabelFileName := PackingStation.CalcLabelFileName(CarrierPackingStation."FedEx Label Buffer File");

          IF FindNode(CurrNode,'//'+DocNameSpace+':CompletedPackageDetails/'+DocNameSpace+
            ':Label/'+DocNameSpace+':Parts/'+DocNameSpace+':Image',CurrNode,XMLNsMgr) THEN BEGIN
                 Bytes := Convert.FromBase64String(CurrNode.InnerText);
                 MemoryStream := MemoryStream.MemoryStream(Bytes);
                 Tempfile.CREATE(LabelFileName);
                 Tempfile.CREATEOUTSTREAM(TempOutstream);
                 MemoryStream.WriteTo(TempOutstream);
                 Tempfile.CLOSE;
                 MemoryStream.Flush;
                 MemoryStream.Close;

            IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
              FILE.COPY(LabelFileName,CarrierPackingStation."FedEx Buffer Directory" + '\' +
                XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' + FormatTimeForFileOutput(TIME) +
                '-' + "No." + '-' +
                FORMAT(
                  "Package No.") + 'of' +
                  FORMAT(
                    "Total Packages") + '_label_buffer.txt');

            IF CarrierPackingStation."FedEx Reduce Label Density" THEN
              ReduceLabelDensity(LabelFileName);
            CurrentPackage.InsertLabelFile(
              LabelFileName,'FedEx Label',12,CarrierPackingStation."FedEx Label Printer Port",
              PackingStation.Code,NOT PackingStation."No Label Printer" AND PrintLabel,
              PackingStation."Do Not Import Label File");
            IF PrintLabel THEN
              PackingStation.PrintLabelFile(
                LabelFileName,CarrierPackingStation."FedEx Label Printer Port",
                PackingStation."No Label Printer",PackingStation."Auto Delete Label Buffer File");
          END;

          // COD Return Label - Ground
          CurrNode := XMLDocOut.DocumentElement;
          CodFileName := '';
          IF FindNode(CurrNode,'//'+DocNameSpace+
            ':CodReturnDetail/'+DocNameSpace+':Label/'+
              DocNameSpace+':Parts/'+DocNameSpace+':Image',CurrNode,XMLNsMgr) THEN BEGIN
            CodFileName := STRSUBSTNO('%1\CodLabels.txt',
              CarrierPackingStation."FedEx Buffer Directory");
            IF ERASE(CodFileName) THEN;
            Bytes := Convert.FromBase64String(CurrNode.InnerText);
            MemoryStream := MemoryStream.MemoryStream(Bytes);
            Tempfile.CREATE(CodFileName);
            Tempfile.CREATEOUTSTREAM(TempOutstream);
            MemoryStream.WriteTo(TempOutstream);
            Tempfile.CLOSE;
            MemoryStream.Flush;
            MemoryStream.Close;

            IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
              IF CodFileName <> '' THEN
                FILE.COPY(CodFileName,CarrierPackingStation."FedEx Buffer Directory" + '\' +
                XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' + FormatTimeForFileOutput(TIME) +
                '-' + "No." + '-' +
                FORMAT(
                  "Package No.") + 'of' +
                  FORMAT(
                      "Total Packages") + '_COD_RETURN_LABEL_buffer.txt');
            IF CodFileName <> '' THEN
              CurrentPackage.InsertLabelFile(
                CodFileName,'FedEx COD Label',12,CarrierPackingStation."FedEx Label Printer Port",
                PackingStation.Code,NOT PackingStation."No Label Printer" AND PrintLabel,
                PackingStation."Do Not Import Label File");
            IF (PrintLabel AND (CodFileName <> '')) THEN
              PackingStation.PrintLabelFile(
                CodFileName,CarrierPackingStation."FedEx Label Printer Port",
                PackingStation."No Label Printer",PackingStation."Auto Delete Label Buffer File");
            END;

            // COD Return Label - Express
            CurrNode := XMLDocOut.DocumentElement;
            CodFileName := '';
            IF FindNode(CurrNode,'//'+
              DocNameSpace+':AssociatedShipments/'+
              DocNameSpace+':Label/'+
              DocNameSpace+':Type',CurrNode,XMLNsMgr) THEN BEGIN

              ChildNode := CurrNode.FirstChild;
              PackageDocType := ChildNode.InnerText;

              CASE PackageDocType OF
                'COD_RETURN_LABEL': // EXPRESS
                  BEGIN
                    IF FindNode(CurrNode,'//'+
                      DocNameSpace+':AssociatedShipments/'+
                      DocNameSpace+':Label/'+
                      DocNameSpace+':Parts/'+
                      DocNameSpace+':Image',CurrNode,XMLNsMgr) THEN BEGIN

                      CodFileName := STRSUBSTNO('%1\CodLabels.txt',
                        CarrierPackingStation."FedEx Buffer Directory");
                      IF ERASE(CodFileName) THEN;
                      Bytes := Convert.FromBase64String(CurrNode.InnerText);
                      MemoryStream := MemoryStream.MemoryStream(Bytes);
                      Tempfile.CREATE(CodFileName);
                      Tempfile.CREATEOUTSTREAM(TempOutstream);
                      MemoryStream.WriteTo(TempOutstream);
                      Tempfile.CLOSE;
                      MemoryStream.Flush;
                      MemoryStream.Close;

                      IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
                        IF CodFileName <> '' THEN
                          FILE.COPY(CodFileName,CarrierPackingStation."FedEx Buffer Directory" + '\' +
                            XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                              FormatTimeForFileOutput(TIME) + '-' + "No." + '-' +
                                FORMAT("Package No.") + 'of' +
                                  FORMAT("Total Packages") + '_cod_label_buffer.txt');
                      IF CodFileName <> '' THEN
                        CurrentPackage.InsertLabelFile(
                          CodFileName,'FedEx COD Label',12,CarrierPackingStation."FedEx Label Printer Port",
                            PackingStation.Code,NOT PackingStation."No Label Printer" AND PrintLabel,
                              PackingStation."Do Not Import Label File");
                      IF (PrintLabel AND (CodFileName <> '')) THEN
                        PackingStation.PrintLabelFile(
                          CodFileName,CarrierPackingStation."FedEx Label Printer Port",
                            PackingStation."No Label Printer",PackingStation."Auto Delete Label Buffer File");
                    END;
                  END;
              END;
            END;

            CurrNode := XMLDocOut.DocumentElement;
            IF FindNode(CurrNode,'//'
              +DocNameSpace+':CompletedShipmentDetail/'
              +DocNameSpace+':Label/'+DocNameSpace+
              ':Parts/'+DocNameSpace+':Image',CurrNode,XMLNsMgr) THEN BEGIN
                 Bytes := Convert.FromBase64String(CurrNode.InnerText);
                 MemoryStream := MemoryStream.MemoryStream(Bytes);
                 Tempfile.CREATE(LabelFileName);
                 Tempfile.CREATEOUTSTREAM(TempOutstream);
                 MemoryStream.WriteTo(TempOutstream);
                 Tempfile.CLOSE;
                 MemoryStream.Flush;
                 MemoryStream.Close;

              IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
                FILE.COPY(LabelFileName,CarrierPackingStation."FedEx Buffer Directory" + '\' +
                  XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' + FormatTimeForFileOutput(TIME) +
                  '-' + "No." + '-' +
                  FORMAT(
                    "Package No.") + 'of' +
                    FORMAT(
                      "Total Packages") + '_label_buffer.txt');

            CurrentPackage.InsertLabelFile(
              LabelFileName,'FedEx Label',12,CarrierPackingStation."FedEx Label Printer Port",
              PackingStation.Code,NOT PackingStation."No Label Printer" AND PrintLabel,
              PackingStation."Do Not Import Label File");
              IF PrintLabel THEN
              PackingStation.PrintLabelFile(
                LabelFileName,CarrierPackingStation."FedEx Label Printer Port",
                PackingStation."No Label Printer",PackingStation."Auto Delete Label Buffer File");
          END;

          CurrNode := XMLDocOut.DocumentElement;
          XMLNodeList :=
            XMLDocOut.SelectNodes('//'+
              DocNameSpace+':PackageDocuments',XMLNsMgr);

          FOR Loop := 0 TO XMLNodeList.Count - 1 DO BEGIN
            CurrNode := XMLNodeList.Item(Loop);
            ChildNode := CurrNode.FirstChild;
            PackageDocType := ChildNode.InnerText;

            CASE PackageDocType OF
              'DANGEROUS_GOODS_SHIPPERS_DECLARATION':
                BEGIN
                  PdfFileName := STRSUBSTNO('%1\DG_Shippers_Declaration.pdf',
                    CarrierPackingStation."FedEx Buffer Directory");
                  IF ERASE(PdfFileName) THEN;
                  PdfNodeList := CurrNode.ChildNodes;
                  FOR PdfLoop := 0 TO PdfNodeList.Count - 1 DO BEGIN
                    CurrNode := PdfNodeList.Item(PdfLoop);
                    IF STRPOS(CurrNode.Name,'Parts') <> 0 THEN BEGIN
                      PartNodeList := CurrNode.ChildNodes;
                      FOR PartLoop := 0 TO PartNodeList.Count -1 DO BEGIN
                        CurrNode := PartNodeList.Item(PartLoop);
                        IF STRPOS(CurrNode.Name,'Image') <> 0 THEN BEGIN
                          Bytes := Convert.FromBase64String(CurrNode.InnerText);
                          MemoryStream := MemoryStream.MemoryStream(Bytes);
                          Tempfile.CREATE(PdfFileName);
                          Tempfile.CREATEOUTSTREAM(TempOutstream);
                          MemoryStream.WriteTo(TempOutstream);
                          Tempfile.CLOSE;
                          MemoryStream.Flush;
                          MemoryStream.Close;
                          IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
                          SaveFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' +
                             XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                               FormatTimeForFileOutput(TIME) + '-' + "No." + '-' +
                              FORMAT(
                                "Package No.") + 'of' +
                                FORMAT(
                                  "Total Packages") + '_DG_ShippersDeclaration_buffer.pdf';
                          IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
                            FILE.COPY(PdfFileName,SaveFileName);
                          CurrentPackage.InsertLabelFile(
                            PdfFileName,STRSUBSTNO('FedEx DG Shippers Declaration'),28,
                              CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation.Code,NOT PackingStation."No Label Printer" AND PrintLabel,
                                  PackingStation."Do Not Import Label File");
                          IF PrintLabel THEN
                            PackingStation.PrintPDFFile(
                              SaveFileName,CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation."No Label Printer");
                        END;
                      END;
                    END;
                  END;
                END;
              'OP_900':
                BEGIN
                  PdfFileName := STRSUBSTNO('%1\OP_900.pdf',
                    CarrierPackingStation."FedEx Buffer Directory");
                  IF ERASE(PdfFileName) THEN;

                  PdfNodeList := CurrNode.ChildNodes;
                  FOR PdfLoop := 0 TO PdfNodeList.Count - 1 DO BEGIN
                    CurrNode := PdfNodeList.Item(PdfLoop);

                    IF STRPOS(CurrNode.Name,'Parts') <> 0 THEN BEGIN
                      PartNodeList := CurrNode.ChildNodes;
                      FOR PartLoop := 0 TO PartNodeList.Count -1 DO BEGIN
                        CurrNode := PartNodeList.Item(PartLoop);
                        IF STRPOS(CurrNode.Name,'Image') <> 0 THEN BEGIN
                          Bytes := Convert.FromBase64String(CurrNode.InnerText);
                          MemoryStream := MemoryStream.MemoryStream(Bytes);
                          Tempfile.CREATE(PdfFileName);
                          Tempfile.CREATEOUTSTREAM(TempOutstream);
                          MemoryStream.WriteTo(TempOutstream);
                          Tempfile.CLOSE;
                          MemoryStream.Flush;
                          MemoryStream.Close;

                          IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
                          SaveFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' +
                             XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                               FormatTimeForFileOutput(TIME) + '-' + "No." + '-' +
                              FORMAT(
                                "Package No.") + 'of' +
                                FORMAT(
                                  "Total Packages") + '_OP_900.pdf';

                          IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
                            FILE.COPY(PdfFileName,SaveFileName);

                          CurrentPackage.InsertLabelFile(
                            PdfFileName,STRSUBSTNO('FedEx %1',PackageDocType),28,
                              CarrierPackingStation."FedEx Label Printer Port",
                            PackingStation.Code,NOT PackingStation."No Label Printer" AND PrintLabel,
                            PackingStation."Do Not Import Label File");
                        END;
                      END;
                    END;
                  END;
                END;
            END;
          END;

          IF ERASE(PdfFileName) THEN;
          PdfFileName := STRSUBSTNO('%1\BillOfLading.pdf',
            CarrierPackingStation."FedEx Buffer Directory");
          IF ERASE(PdfFileName) THEN;

          CurrNode := XMLDocOut.DocumentElement;
          XMLNodeList :=
            XMLDocOut.SelectNodes('//'+
              DocNameSpace+':ShipmentDocuments',XMLNsMgr);

          FOR Loop := 0 TO XMLNodeList.Count - 1 DO BEGIN
            CurrNode := XMLNodeList.Item(Loop);
            ChildNode := CurrNode.FirstChild;
            ShipmentDocType := ChildNode.InnerText;

            CASE ShipmentDocType OF
              'FREIGHT_ADDRESS_LABEL':
                BEGIN
                  FindNode(CurrNode,'//'+DocNameSpace+
                   ':ShipmentDocuments/'+DocNameSpace+
                   ':Parts/'+DocNameSpace+
                   ':Image',CurrNode,XMLNsMgr);
                  Bytes := Convert.FromBase64String(CurrNode.InnerText);
                  MemoryStream := MemoryStream.MemoryStream(Bytes);
                  Tempfile.CREATE(LabelFileName);
                  Tempfile.CREATEOUTSTREAM(TempOutstream);
                  MemoryStream.WriteTo(TempOutstream);
                  Tempfile.CLOSE;
                  MemoryStream.Flush;
                  MemoryStream.Close;

                  SaveFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' +
                             XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                               FormatTimeForFileOutput(TIME) + '-' + "No." + '-' +
                                FORMAT(
                                  "Package No.") + 'of' +
                                  FORMAT(
                                    "Total Packages") + '_Freight_Label.txt';

                  FILE.COPY(LabelFileName,SaveFileName);

                  CurrentPackage.InsertLabelFile(
                    LabelFileName,'FedEx Label',12,CarrierPackingStation."FedEx Label Printer Port",
                    PackingStation.Code,NOT PackingStation."No Label Printer" AND PrintLabel,
                    PackingStation."Do Not Import Label File");

                  IF PrintLabel AND NOT (OnBOL AND FedExFreight) THEN BEGIN
                    IF FedExFreightXMLControl."No. of FedEx Freight Labels" = 0 THEN
                      FedExFreightXMLControl."No. of FedEx Freight Labels" := 1;
                    FOR PdfLoop := 1 TO FedExFreightXMLControl."No. of FedEx Freight Labels" DO BEGIN
                      FILE.COPY(SaveFileName,LabelFileName);
                      PackingStation.PrintLabelFile(
                        LabelFileName,CarrierPackingStation."FedEx Label Printer Port",
                          PackingStation."No Label Printer",PackingStation."Auto Delete Label Buffer File");
                    END;
                  IF NOT CarrierPackingStation."FedEx Save RateShop Buffers" THEN
                    ERASE(SaveFileName);
                  END;
                END;

              'OUTBOUND_LABEL': // Bill of Lading
                IF NOT (OnBOL AND FedExFreight) THEN BEGIN
                  PdfFileName := STRSUBSTNO('%1\BOL.pdf',CarrierPackingStation."FedEx Buffer Directory");
                  IF ERASE(PdfFileName) THEN;

                  PdfNodeList := CurrNode.ChildNodes;
                  FOR PdfLoop := 0 TO PdfNodeList.Count - 1 DO BEGIN
                    CurrNode := PdfNodeList.Item(PdfLoop);

                    IF STRPOS(CurrNode.Name,'Parts') <> 0 THEN BEGIN
                      PartNodeList := CurrNode.ChildNodes;
                      FOR PartLoop := 0 TO PartNodeList.Count -1 DO BEGIN
                        CurrNode := PartNodeList.Item(PartLoop);
                        IF STRPOS(CurrNode.Name,'Image') <> 0 THEN BEGIN
                          Bytes := Convert.FromBase64String(CurrNode.InnerText);
                          MemoryStream := MemoryStream.MemoryStream(Bytes);
                          Tempfile.CREATE(PdfFileName);
                          Tempfile.CREATEOUTSTREAM(TempOutstream);
                          MemoryStream.WriteTo(TempOutstream);
                          Tempfile.CLOSE;
                          MemoryStream.Flush;
                          MemoryStream.Close;

                          SaveFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' +
                             XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                               FormatTimeForFileOutput(TIME) + '-' + "No." + '-' +
                                FORMAT(
                                  "Package No.") + 'of' +
                                  FORMAT(
                                    "Total Packages") + '_FXFreight_BOL.pdf';
                          FILE.COPY(PdfFileName,SaveFileName);
                          CurrentPackage.InsertLabelFile(
                            SaveFileName,'FedEx Bill of Lading',28,
                              CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation.Code,PrintLabel,
                                    PackingStation."Do Not Import Label File");
                        END;
                      END;
                    END;
                  END;
                  IF PrintLabel AND NOT (OnBOL AND FedExFreight) THEN BEGIN
                    IF FedExFreightXMLControl."No. of FedEx Freight BOLs" = 0 THEN
                      FedExFreightXMLControl."No. of FedEx Freight BOLs" := 1;
                    FOR PdfLoop := 1 TO FedExFreightXMLControl."No. of FedEx Freight BOLs" DO BEGIN
                      FILE.COPY(SaveFileName,PdfFileName);
                      PackingStation.PrintPDFFile(
                        PdfFileName,'',PackingStation."No Label Printer");
                    END;
                  END;
                END;

              'CERTIFICATE_OF_ORIGIN':
                BEGIN
                  PdfFileName := STRSUBSTNO('%1\CertOfOrigin.pdf',
                    CarrierPackingStation."FedEx Buffer Directory");
                  IF ERASE(PdfFileName) THEN;

                  PdfNodeList := CurrNode.ChildNodes;
                  FOR PdfLoop := 0 TO PdfNodeList.Count - 1 DO BEGIN
                    CurrNode := PdfNodeList.Item(PdfLoop);

                    IF STRPOS(CurrNode.Name,'Parts') <> 0 THEN BEGIN
                      PartNodeList := CurrNode.ChildNodes;
                      FOR PartLoop := 0 TO PartNodeList.Count -1 DO BEGIN
                        CurrNode := PartNodeList.Item(PartLoop);
                        IF STRPOS(CurrNode.Name,'Image') <> 0 THEN BEGIN
                          Bytes := Convert.FromBase64String(CurrNode.InnerText);
                          MemoryStream := MemoryStream.MemoryStream(Bytes);
                          Tempfile.CREATE(PdfFileName);
                          Tempfile.CREATEOUTSTREAM(TempOutstream);
                          MemoryStream.WriteTo(TempOutstream);
                          Tempfile.CLOSE;
                          MemoryStream.Flush;
                          MemoryStream.Close;

                          SaveFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' +
                             XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                               FormatTimeForFileOutput(TIME) + '-' + "No." + '_Cert_Of_Origin.pdf';
                          FILE.COPY(PdfFileName,SaveFileName);

                          CurrentPackage.InsertLabelFile(
                            SaveFileName,'FedEx Certificate of Origin',28,
                              CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation.Code,
                                  NOT PackingStation."No Label Printer" AND PrintLabel,
                                    PackingStation."Do Not Import Label File");
                            IF PrintLabel THEN BEGIN
                              PackingStation.PrintPDFFile(
                                SaveFileName,CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation."No Label Printer");
                            END;
                        END;
                      END;
                    END;
                  END;
                END;

              'COMMERCIAL_INVOICE':
                BEGIN
                  PdfFileName := STRSUBSTNO('%1\Commercial_Invoice.pdf',
                    CarrierPackingStation."FedEx Buffer Directory");
                  IF ERASE(PdfFileName) THEN;

                  PdfNodeList := CurrNode.ChildNodes;
                  FOR PdfLoop := 0 TO PdfNodeList.Count - 1 DO BEGIN
                    CurrNode := PdfNodeList.Item(PdfLoop);

                    IF STRPOS(CurrNode.Name,'Parts') <> 0 THEN BEGIN
                      PartNodeList := CurrNode.ChildNodes;
                      FOR PartLoop := 0 TO PartNodeList.Count -1 DO BEGIN
                        CurrNode := PartNodeList.Item(PartLoop);
                        IF STRPOS(CurrNode.Name,'Image') <> 0 THEN BEGIN
                          Bytes := Convert.FromBase64String(CurrNode.InnerText);
                          MemoryStream := MemoryStream.MemoryStream(Bytes);
                          Tempfile.CREATE(PdfFileName);
                          Tempfile.CREATEOUTSTREAM(TempOutstream);
                          MemoryStream.WriteTo(TempOutstream);
                          Tempfile.CLOSE;
                          MemoryStream.Flush;
                          MemoryStream.Close;

                          SaveFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' +
                             XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                               FormatTimeForFileOutput(TIME) + '-' + "No." + '_Commercial_Invoice.pdf';
                          FILE.COPY(PdfFileName,SaveFileName);
                          CurrentPackage.InsertLabelFile(
                            SaveFileName,'FedEx Commercial Invoice',28,
                              CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation.Code,
                                  NOT PackingStation."No Label Printer" AND PrintLabel,
                                    PackingStation."Do Not Import Label File");
                          IF PrintLabel THEN
                              PackingStation.PrintPDFFile(
                                SaveFileName,CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation."No Label Printer");
                          IF NOT CarrierPackingStation."FedEx Save RateShop Buffers" THEN
                            IF EXISTS(SaveFileName) THEN
                              ERASE(SaveFileName);
                        END;
                      END;
                    END;
                  END;
                END;

              'GENERAL_AGENCY_AGREEMENT':
                BEGIN
                  PdfFileName := STRSUBSTNO('%1\Gen_Agency_Agreement.pdf',
                    CarrierPackingStation."FedEx Buffer Directory");
                  IF ERASE(PdfFileName) THEN;

                  PdfNodeList := CurrNode.ChildNodes;
                  FOR PdfLoop := 0 TO PdfNodeList.Count - 1 DO BEGIN
                    CurrNode := PdfNodeList.Item(PdfLoop);

                    IF STRPOS(CurrNode.Name,'Parts') <> 0 THEN BEGIN
                      PartNodeList := CurrNode.ChildNodes;
                      FOR PartLoop := 0 TO PartNodeList.Count -1 DO BEGIN
                        CurrNode := PartNodeList.Item(PartLoop);
                        IF STRPOS(CurrNode.Name,'Image') <> 0 THEN BEGIN
                          Bytes := Convert.FromBase64String(CurrNode.InnerText);
                          MemoryStream := MemoryStream.MemoryStream(Bytes);
                          Tempfile.CREATE(PdfFileName);
                          Tempfile.CREATEOUTSTREAM(TempOutstream);
                          MemoryStream.WriteTo(TempOutstream);
                          Tempfile.CLOSE;
                          MemoryStream.Flush;
                          MemoryStream.Close;

                          SaveFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' +
                             XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                               FormatTimeForFileOutput(TIME) + '-' + "No." + '_Gen_Agency_Agreement.pdf';

                          IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
                            FILE.COPY(PdfFileName,SaveFileName);

                          CurrentPackage.InsertLabelFile(
                            SaveFileName,'FedEx Gen. Agency Agreement',28,
                              CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation.Code,
                                  NOT PackingStation."No Label Printer" AND PrintLabel,
                                    PackingStation."Do Not Import Label File");
                            IF PrintLabel THEN BEGIN
                              PackingStation.PrintPDFFile(
                                SaveFileName,CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation."No Label Printer");
                            END;
                        END;
                      END;
                    END;
                  END;
                END;

              'PRO_FORMA_INVOICE':
                BEGIN
                  PdfFileName := STRSUBSTNO('%1\Pro_Forma_Inv.pdf',
                    CarrierPackingStation."FedEx Buffer Directory");
                  IF ERASE(PdfFileName) THEN;

                  PdfNodeList := CurrNode.ChildNodes;
                  FOR PdfLoop := 0 TO PdfNodeList.Count - 1 DO BEGIN
                    CurrNode := PdfNodeList.Item(PdfLoop);

                    IF STRPOS(CurrNode.Name,'Parts') <> 0 THEN BEGIN
                      PartNodeList := CurrNode.ChildNodes;
                      FOR PartLoop := 0 TO PartNodeList.Count -1 DO BEGIN
                        CurrNode := PartNodeList.Item(PartLoop);
                        IF STRPOS(CurrNode.Name,'Image') <> 0 THEN BEGIN
                          Bytes := Convert.FromBase64String(CurrNode.InnerText);
                          MemoryStream := MemoryStream.MemoryStream(Bytes);
                          Tempfile.CREATE(PdfFileName);
                          Tempfile.CREATEOUTSTREAM(TempOutstream);
                          MemoryStream.WriteTo(TempOutstream);
                          Tempfile.CLOSE;
                          MemoryStream.Flush;
                          MemoryStream.Close;

                          SaveFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' +
                             XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                               FormatTimeForFileOutput(TIME) + '-' + "No." + '_Pro_Forma_Invoice.pdf';

                          IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
                            FILE.COPY(PdfFileName,SaveFileName);

                          CurrentPackage.InsertLabelFile(
                            SaveFileName,'FedEx Pro Forma Invoice',28,
                              CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation.Code,
                                  NOT PackingStation."No Label Printer" AND PrintLabel,
                                    PackingStation."Do Not Import Label File");
                            IF PrintLabel THEN BEGIN
                              PackingStation.PrintPDFFile(
                                SaveFileName,CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation."No Label Printer");
                            END;
                        END;
                      END;
                    END;
                  END;
                END;

              'NAFTA_CERTIFICATE_OF_ORIGIN':
                BEGIN
                  PdfFileName := STRSUBSTNO('%1\NAFTA_Cert_Of_Origin.pdf',
                    CarrierPackingStation."FedEx Buffer Directory");
                  IF ERASE(PdfFileName) THEN;

                  PdfNodeList := CurrNode.ChildNodes;
                  FOR PdfLoop := 0 TO PdfNodeList.Count - 1 DO BEGIN
                    CurrNode := PdfNodeList.Item(PdfLoop);

                    IF STRPOS(CurrNode.Name,'Parts') <> 0 THEN BEGIN
                      PartNodeList := CurrNode.ChildNodes;
                      FOR PartLoop := 0 TO PartNodeList.Count -1 DO BEGIN
                        CurrNode := PartNodeList.Item(PartLoop);
                        IF STRPOS(CurrNode.Name,'Image') <> 0 THEN BEGIN
                          Bytes := Convert.FromBase64String(CurrNode.InnerText);
                          MemoryStream := MemoryStream.MemoryStream(Bytes);
                          Tempfile.CREATE(PdfFileName);
                          Tempfile.CREATEOUTSTREAM(TempOutstream);
                          MemoryStream.WriteTo(TempOutstream);
                          Tempfile.CLOSE;
                          MemoryStream.Flush;
                          MemoryStream.Close;

                          SaveFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' +
                             XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                               FormatTimeForFileOutput(TIME) + '-' + "No." + '_NAFTA_Cert_Of_Origin.pdf';

                          IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
                            FILE.COPY(PdfFileName,SaveFileName);

                          CurrentPackage.InsertLabelFile(
                            SaveFileName,'FedEx NAFTA Cert. of Origin',28,
                              CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation.Code,
                                  NOT PackingStation."No Label Printer" AND PrintLabel,
                                    PackingStation."Do Not Import Label File");
                            IF PrintLabel THEN BEGIN
                              PackingStation.PrintPDFFile(
                                SaveFileName,CarrierPackingStation."FedEx Label Printer Port",
                                PackingStation."No Label Printer");
                            END;
                        END;
                      END;
                    END;
                  END;
                END;
            END;
          END;
        END;

        IF (OnBOL AND FedExFreight) THEN
          "External Tracking No." := '';

        IF ShippingAgent."Disable Rate Calculation" THEN BEGIN
          Surcharge := 0;
          "Base Charge" := 0;
          "Discount Amount" := 0;
          "Shipping Cost" := 0;
          "Rebate Amount" := 0;
        END;

        IF NOT Closed AND NOT (OnBOL AND FedExFreight) THEN BEGIN
          Markup :=
            Shipping.GetMarkup(
              ShippingAgentService,"Shipping Cost","Ship-to Type","Ship-to No.","Ship-to Code");
          IF COD AND "Add Shipping Charge to COD Amt" THEN
            Markup := CODMarkup;
          IF "Override Shipping Charge" <> 0 THEN
            "Shipping Charge" := "Override Shipping Charge"
          ELSE
            "Shipping Charge" := "Shipping Cost" + Markup + "Additional Shipping Charge";
        END;
        TestAndTransferToThirdParty(CurrentPackage,FedExOptionPage,ShippingAgentService);

        IF COD AND "Add Shipping Charge to COD Amt" THEN
          "COD Amount" := "COD Amount" + "Shipping Charge";

        "Packing Date" := WORKDATE;
        "Packing Time" := TIME;
        "Packed By" := USERID;
        Closed := TRUE;
        MODIFY;
        COMMIT;

        IF "Multi Document Package" THEN BEGIN
          GetShippingSetup;
          GetPackingStation;
          MultiDocPackageMgt.SplitMultiDocPackage(
            CurrentPackage,MultiDocPackageTmp,PackingStation,ShippingSetup);
          COMMIT;
        END;

        CLEAR(BufferFileName);
        CLEAR(XMLRequestDocument);
        CLEAR(XMLDocOut);
        CLEAR(TransactionResponse);

      END;
    END;

    PROCEDURE OpenPackage@16(VAR CurrentPackage@1240030000 : Record 14000701);
    VAR
      FedExOptionPage@1240020001 : Record 14000781;
      FedExOptionPageExt@1240020100 : Record 14000793;
      MiscPackage@1240020002 : Record 14000701;
    BEGIN
      WITH CurrentPackage DO BEGIN
        TESTFIELD(Closed);
        TESTFIELD("Manifest No.",'');
        URLSuffix := 'ship';
        IF "Manual Shipment" THEN BEGIN
          Closed := FALSE;
          MODIFY;
          COMMIT;
          EXIT;
        END;
        CASE "Service Indicator" OF
          'FEF1','FEF2':
            BEGIN
              IF NOT CarrierPackingStation."Do Not Display BOL Delete Msg" THEN
                MESSAGE(Text025 + Text024,"No.",'',"External Tracking No.");
              "External Tracking No." := '';
              Closed := FALSE;
              MODIFY;
              COMMIT;
              EXIT;
            END;
        END;
        TESTFIELD("External Tracking No.");
        GetPackingStation;
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");

        FedExOptionPage.GET(FedExOptionPage.Type::Package,"No.",0,0);
        IF NOT (CurrentPackage.Miscellaneous) THEN
          IF FedExOptionPage."Return/Original Package No." <> '' THEN BEGIN
            MiscPackage.GET(FedExOptionPage."Return/Original Package No.");
            DeleteShipment(MiscPackage,FALSE);
            IF MiscPackage.Closed THEN
              Shipping.OpenPackage(MiscPackage);
            MiscPackage.DELETE(TRUE);
          END;

        DeleteShipment(CurrentPackage,FALSE);

        IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN BEGIN
          XMLRequestDocument.Save(CarrierPackingStation."FedEx Buffer Directory" + '\' +
            XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' + FormatTimeForFileOutput(TIME) +
            '-' + "No." + '-' +
            FORMAT(
              "Package No.") + 'of' +
              FORMAT(
                "Total Packages") + '_deleteshipment_buffer.xml');

            XMLDocOut.Save(CarrierPackingStation."FedEx Buffer Directory" + '\' +
            XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' + FormatTimeForFileOutput(TIME) +
            '-' + "No." + '-' +
            FORMAT(
              "Package No.") + 'of' +
              FORMAT(
                "Total Packages") + '_deleteshipment_response.xml');
        END;

        IF COD AND "Add Shipping Charge to COD Amt" THEN
          "COD Amount" := "COD Amount" - "Shipping Charge";
        "External Tracking No." := '';
        "USPS Tracking ID" := '';
        "FedEx Transaction ID" := '';

        Closed := FALSE;
        MODIFY;
        COMMIT;
        IF FedExOptionPageExt.GET(FedExOptionPageExt.Type::Package,"No.",0,0) THEN BEGIN
          FedExOptionPageExt."ETD Reference ID" := '';
          FedExOptionPageExt."ETD Certificate of Origin ID" := '';
          FedExOptionPageExt."ETD Gen. Agency Agreement ID" := '';
          FedExOptionPageExt."ETD NAFTA Cert. of Origin ID" := '';
          FedExOptionPageExt."ETD Pro Forma Invoice ID" := '';
          FedExOptionPageExt."ETD Commercial Invoice ID" := '';
          FedExOptionPageExt.MODIFY;
        END;

        CLEAR(BufferFileName);
        CLEAR(XMLRequestDocument);
        CLEAR(XMLDocOut);
        CLEAR(TransactionResponse);

      END;
    END;

    LOCAL PROCEDURE DeleteShipment@5(VAR CurrentPackage@1240030000 : Record 14000701;GiveError@1240030004 : Boolean);
    VAR
      FedExOptionPage@1240030001 : Record 14000781;
      FedExOptionPageExt@1240020000 : Record 14000793;
    BEGIN
      WITH CurrentPackage DO BEGIN
        URLSuffix := 'ship';
        GetShippingAgent("Shipping Agent Code");
        IF ShippingAgent."Disable Rate Calculation" THEN
          EXIT;

        GetShippingSetup;
        GetPackingStation;
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");
        GetShippingAgentService("Shipping Agent Code","Shipping Agent Service","World Wide Service");
        FedExOptionPage.GET(FedExOptionPage.Type::Package,"No.",0,0);
        FedExOptionPageExt.GET(FedExOptionPageExt.Type::Package,"No.",0,0);
        GetGlobalShipperInfo;

        IF ISNULL(XMLRequestDocument) THEN
          XMLRequestDocument := XMLRequestDocument.XmlDocument;
        IF ISNULL(XMLDocOut) THEN
          XMLDocOut := XMLDocOut.XmlDocument;

        BufferFileName := GetBufferFile();

        DocNameSpace := '';

        XMLEncode.CreateSOAPRequest(XMLRequestDocument,'ShipService',BufferFileName);

        IF FedExOptionPageExt."Call Tag Request" THEN BEGIN
          XMLEncode.CreateRequestHeader(
            'ShipService','DeleteTagRequest',XMLRequestDocument,
            ShippingAgentAccount,FedExGlobalRegistration,'');
          XMLEncode.CreateDeleteTagRequest(
            "External Tracking No.","Shipping Agent Account No.",
            XMLRequestDocument,DocNameSpace,GiveError);
        END ELSE BEGIN
          IF FedExOptionPage."FedEx SmartPost Shipment" THEN BEGIN
            XMLEncode.CreateRequestHeader(
              'ShipService','DeleteShipmentRequest',XMLRequestDocument,
              ShippingAgentAccount,FedExGlobalRegistration,'');
            XMLEncode.CreateDeleteShipmentRequest(
              "Packing Date","External Tracking No.",FedExOptionPage."Tracking Form ID",
              TRUE,ShippingAgentService,XMLRequestDocument,
                XMLEncode.GetNameSpaceURI('ShipService',''),GiveError);
          END ELSE BEGIN
            XMLEncode.CreateRequestHeader(
              'ShipService','DeleteShipmentRequest',XMLRequestDocument,
              ShippingAgentAccount,FedExGlobalRegistration,'');
            XMLEncode.CreateDeleteShipmentRequest(
              "Packing Date","External Tracking No.",FedExOptionPage."Tracking Form ID",
              FALSE,ShippingAgentService,XMLRequestDocument,XMLEncode.GetNameSpaceURI('ShipService',''),GiveError);
          END;
        END;
        HTTPResponse := HTTPRequest(XMLRequestDocument,XMLDocOut,TRUE,FALSE);

        IF HTTPResponse <> '' THEN BEGIN
          ERROR(HTTPResponse);
        END ELSE BEGIN
          XMLNsMgr := XMLNsMgr.XmlNamespaceManager(XMLDocOut.NameTable);
          DocNameSpace := XMLEncode.VersionCheck('ShipService','');
          XMLNsMgr.AddNamespace(DocNameSpace,XMLEncode.GetNameSpaceURI('ShipService',''));
          CheckXMLResponseError(XMLDocOut,DocNameSpace,TRUE);
        END;

      END;
    END;

    PROCEDURE ReOpenPostedPackage@50(VAR CurrentPostedPackage@1240030000 : Record 14000704);
    VAR
      FedExPostedOptionPage@1240030008 : Record 14000782;
    BEGIN
      WITH CurrentPostedPackage DO BEGIN
        TESTFIELD(Closed);
        TESTFIELD("Manifest No.",'');

        IF "Manual Shipment" THEN BEGIN
          Closed := FALSE;
          MODIFY;
          COMMIT;

          EXIT;
        END;
        URLSuffix := 'ship';
        GetShippingSetup;
        GetPackingStation;
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");
        GetShippingAgentService("Shipping Agent Code","Shipping Agent Service","World Wide Service");
        FedExPostedOptionPage.GET("No.");
        GetGlobalShipperInfo;

        IF ISNULL(XMLRequestDocument) THEN
          XMLRequestDocument := XMLRequestDocument.XmlDocument;
        IF ISNULL(XMLDocOut) THEN
          XMLDocOut := XMLDocOut.XmlDocument;

        BufferFileName := GetBufferFile();
        DocNameSpace := '';
        XMLEncode.CreateSOAPRequest(XMLRequestDocument,'ShipService',BufferFileName);
        XMLEncode.CreateRequestHeader(
          'ShipService','DeleteShipmentRequest',XMLRequestDocument,
          ShippingAgentAccount,FedExGlobalRegistration,'');
        XMLEncode.CreateDeleteShipmentRequest(
          "Packing Date","External Tracking No.",FedExPostedOptionPage."Tracking Form ID",
          FALSE,ShippingAgentService,XMLRequestDocument,XMLEncode.GetNameSpaceURI('ShipService',''),FALSE);

        HTTPResponse := HTTPRequest(XMLRequestDocument,XMLDocOut,TRUE,FALSE);

        IF HTTPResponse <> '' THEN BEGIN
          ERROR(HTTPResponse);
        END ELSE BEGIN
          XMLNsMgr := XMLNsMgr.XmlNamespaceManager(XMLDocOut.NameTable);
          DocNameSpace := XMLEncode.VersionCheck('ShipService','');
          XMLNsMgr.AddNamespace(DocNameSpace,XMLEncode.GetNameSpaceURI('ShipService',''));
          CheckXMLResponseError(XMLDocOut,DocNameSpace,TRUE);
        END;

        IF COD AND "Add Shipping Charge to COD Amt" THEN
          "COD Amount" := "COD Amount" - "Shipping Charge";
        "External Tracking No." := '';
        "USPS Tracking ID" := '';
        "FedEx Transaction ID" := '';

        Closed := FALSE;
        MODIFY;
        COMMIT;
      END;
    END;

    PROCEDURE PrintPackageLabel@20(VAR CurrentPackage@1240030000 : Record 14000701);
    VAR
      LabelFileName@1240020000 : Text[250];
      LabelFile@1240020001 : Record 14000710;
    BEGIN
      WITH CurrentPackage DO BEGIN
        IF "Manual Shipment" THEN
          EXIT;
        TESTFIELD(Closed);
        GetShippingSetup;
        GetPackingStation;
        IF PackingStation."No Label Printer" = FALSE THEN BEGIN
          CarrierPackingStation.TESTFIELD("FedEx Label Printer Port");
          CarrierPackingStation.TESTFIELD("FedEx Label Buffer File");
          LabelFileName := PackingStation.CalcLabelFileName(
            CarrierPackingStation."FedEx Label Buffer File");
          LabelFile.SETCURRENTKEY(Type,"No.","File Type");
          LabelFile.SETRANGE(Type,LabelFile.Type::Package);
          LabelFile.SETRANGE("No.","No.");
          IF LabelFile.FIND('-') THEN
            REPEAT
              LabelFile.CALCFIELDS("File (Binary)");
              IF ERASE(LabelFile."File Name") THEN;
                LabelFile.ExportFileBinary(LabelFile."File Name",FALSE);
            PackingStation.PrintLabelFile(
              LabelFile."File Name",CarrierPackingStation."FedEx Label Printer Port",
              PackingStation."No Label Printer",PackingStation."Auto Delete Label Buffer File");
            UNTIL LabelFile.NEXT = 0;
        END;
      END;
    END;

    PROCEDURE RePrintPostedPackageLabel@21(VAR CurrentPostedPackage@1240030000 : Record 14000704);
    BEGIN
      ERROR(Text002);
    END;

    LOCAL PROCEDURE GetGlobalShipperInfo@30();
    BEGIN
      GetPackingStation;
      IF CarrierPackingStation."FedEx Global Registration No." <> '' THEN
        FedExGlobalRegistration.GET(211,CarrierPackingStation."FedEx Global Registration No.")
      ELSE
        ERROR(Text003);
    END;

    PROCEDURE CreateManifest@49(CurrentShippingAgentAccount@1240030000 : Record 14000788);
    VAR
      ManifestHeader@1240030001 : Record 14000712;
    BEGIN
      WITH CurrentShippingAgentAccount DO BEGIN
        ShippingAgent.RESET;
        ShippingAgent.SETRANGE("Shipper Type",ShippingAgent."Shipper Type"::FEDEX);
        ShippingAgent.FIND('-');

        CLEAR(ManifestHeader);
        ManifestHeader.INSERT(TRUE);
        ManifestHeader."Shipping Agent Code" := ShippingAgent.Code;
        ManifestHeader."Shipping Agent Account" := "Account No.";
        ManifestHeader.MODIFY(TRUE);

        ManifestHeader.GetSuggestedLines;
        COMMIT;

        PAGE.RUNMODAL(PAGE::Manifest,ManifestHeader);
      END;
    END;

    PROCEDURE CloseManifest@47(VAR CurrentManifestHeader@1240030000 : Record 14000712);
    VAR
      ManifestLine@1240030001 : Record 14000713;
      FedExShippingAgentAccountTmp@1240030002 : TEMPORARY Record 14000788;
      AccountsManifested@1240030003 : Integer;
      HazMat@1240020000 : Boolean;
      FedExOptionPage@1240020001 : Record 14000781;
      FedExPostedOptionPage@1240020002 : Record 14000782;
    BEGIN
      WITH CurrentManifestHeader DO BEGIN
        TESTFIELD(Posted);
        TESTFIELD("FedEx Processing Required");

        FedExShippingAgentAccountTmp.DELETEALL;

        HazMat := FALSE;
        ManifestLine.RESET;
        ManifestLine.SETRANGE("Manifest No.","No.");
        ManifestLine.SETRANGE(Type,ManifestLine.Type::Package,
          ManifestLine.Type::"Miscellaneous Package");
        IF ManifestLine.FIND('-') THEN
          REPEAT
            IF ManifestLine."Posted / Closed" THEN BEGIN
              FedExPostedOptionPage.RESET;
              FedExPostedOptionPage.SETRANGE("No.",ManifestLine."No.");
              IF FedExPostedOptionPage.FIND('-') THEN
                IF FedExPostedOptionPage.Hazmat THEN
                  HazMat := TRUE;
            END ELSE BEGIN
              FedExOptionPage.RESET;
              FedExOptionPage.SETRANGE(Type,FedExOptionPage.Type::Package);
              FedExOptionPage.SETRANGE("Source ID",ManifestLine."No.");
              IF FedExOptionPage.FIND('-') THEN
                IF FedExOptionPage.Hazmat THEN
                  HazMat := TRUE;
            END;
          UNTIL (ManifestLine.NEXT = 0) OR HazMat;

        ManifestLine.RESET;
        ManifestLine.SETRANGE("Manifest No.","No.");
        ManifestLine.SETRANGE(Type,ManifestLine.Type::Summary);
        IF ManifestLine.FIND('-') THEN
          REPEAT
            IF NOT FedExShippingAgentAccountTmp.GET(ManifestLine."Shipping Agent Account No.") THEN
              IF ShippingAgentAccount.GET(ManifestLine."Shipping Agent Account No.") THEN BEGIN
                FedExShippingAgentAccountTmp := ShippingAgentAccount;
                FedExShippingAgentAccountTmp.INSERT;
              END;
          UNTIL ManifestLine.NEXT = 0;

        AccountsManifested := 0;
        IF FedExShippingAgentAccountTmp.FIND('-') THEN BEGIN
          ManifestLine.RESET;
          ManifestLine.SETRANGE("Manifest No.","No.");
          IF NOT ManifestLine.FIND('+') THEN
            ManifestLine."Manifest No." := "No.";

          REPEAT
            AccountsManifested := AccountsManifested + 1;

            ManifestLine.INIT;
            ManifestLine."Line No." := ManifestLine."Line No." + 10000;
            ManifestLine.Type := ManifestLine.Type::"FedEx Summary";
            ManifestLine.Description :=
              STRSUBSTNO(Text029,FedExShippingAgentAccountTmp."Account No.");
            ManifestLine.SummarizeAccount(FedExShippingAgentAccountTmp."Account No.");
            ManifestLine."Shipping Agent Account No." := FedExShippingAgentAccountTmp."Account No.";
            ManifestLine."FedEx Manifest File No." :=
              CreateOnlineManifest(CurrentManifestHeader,FedExShippingAgentAccountTmp,FALSE,HazMat);
            ManifestLine.INSERT;
          UNTIL FedExShippingAgentAccountTmp.NEXT = 0;
        END;

        IF AccountsManifested <> 0 THEN
          MESSAGE(Text030,AccountsManifested);

        LOCKTABLE;
        FIND;
        "FedEx Processing Required" := FALSE;
        MODIFY;
        COMMIT;
      END;
    END;

    PROCEDURE OpenManifest@48(VAR CurrentManifestHeader@1240030000 : Record 14000712);
    VAR
      ManifestLine@1240020000 : Record 14000713;
    BEGIN
      WITH CurrentManifestHeader DO BEGIN
        TESTFIELD(Posted,FALSE);
        TESTFIELD("FedEx Processing Required");

        LOCKTABLE;
        FIND;
        "FedEx Processing Required" := FALSE;
        MODIFY;
        COMMIT;

        ManifestLine.RESET;
        ManifestLine.SETRANGE("Manifest No.",CurrentManifestHeader."No.");
        ManifestLine.SETRANGE(Type,ManifestLine.Type::"FedEx Summary");
        ManifestLine.DELETEALL;
      END;
    END;

    LOCAL PROCEDURE CreateOnlineManifest@10(CurrentManifestHeader@1240030000 : Record 14000712;CurrentShippingAgentAccount@1240030001 : Record 14000788;ManifestOnly@1240030002 : Boolean;Hazmat@1240020005 : Boolean) : Integer;
    VAR
      ChildNode@1240020205 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
      LabelStream@1240030011 : Automation "{2A75196C-D9EB-4129-B803-931327F72D5C} 2.8:{00000566-0000-0010-8000-00AA006D2EA4}:'Microsoft ActiveX Data Objects 2.8 Library'.Stream";
      Convert@1240020009 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Convert";
      Bytes@1240020008 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Array";
      MemoryStream@1240020007 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.MemoryStream";
      TempOutstream@1240020006 : OutStream;
      Tempfile@1240020105 : File;
      LabelFileName@1240030006 : Text[250];
      SaveFileName@1240020011 : Text[250];
      XMLNodeList@1240030005 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNodeList";
      PdfStream@1240020107 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.MemoryStream";
      PdfNodeList@1240030105 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNodeList";
      PartNodeList@1240030205 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNodeList";
      PdfFileName@1240020103 : Text[250];
      PdfLoop@1240020092 : Integer;
      PartLoop@1240020081 : Integer;
      Loop@1240020108 : Integer;
      CloseDocType@1240020000 : Text[30];
    BEGIN
      WITH CurrentShippingAgentAccount DO BEGIN
        URLSuffix := 'close';
        GetGlobalShipperInfo;
        CarrierPackingStation.GET(PackingStation."Carrier Packing Station Code");
        LabelFileName := PackingStation.CalcLabelFileName(PackingStation."Label Buffer File");

        IF FedExGlobalRegistration."Shipper Account No." <> "Account No." THEN BEGIN
          FedExGlobalRegistration.RESET;
          FedExGlobalRegistration.SETRANGE("Shipper Account No.","Account No.");
          CASE "Test Status" OF
            "Test Status"::Live:
              FedExGlobalRegistration.SETRANGE("Live Registration",TRUE);
            "Test Status"::Beta:
              FedExGlobalRegistration.SETRANGE("Live Registration",FALSE);
          END;
          FedExGlobalRegistration.SETFILTER("Meter Number" ,'<>%1','');
          IF NOT FedExGlobalRegistration.FIND('+') THEN BEGIN
            CASE "Test Status" OF
              "Test Status"::Live:
                ERROR(Text008,"Account No.");
              "Test Status"::Beta:
                ERROR(Text008,"Account No.");
              ELSE
                ERROR(Text009,"Account No.");
            END;
          END;
        END;

        // Manifest SmartPost Shipments
        IF CurrentShippingAgentAccount."SmartPost Enabled Account" THEN BEGIN
          IF ISNULL(XMLRequestDocument) THEN
            XMLRequestDocument := XMLRequestDocument.XmlDocument;
          IF ISNULL(XMLDocOut) THEN
            XMLDocOut := XMLDocOut.XmlDocument;

          BufferFileName := GetBufferFile();
          XMLEncode.CreateSOAPRequest(XMLRequestDocument,'CloseService',BufferFileName);
          XMLEncode.CreateRequestHeader(
            'CloseService','SmartPostCloseRequest',XMLRequestDocument,ShippingAgentAccount,FedExGlobalRegistration,'');
          XMLEncode.CreateManifestRequest(
            XMLRequestDocument,CurrentManifestHeader,CurrentShippingAgentAccount,ManifestOnly,
            XMLEncode.GetNameSpaceURI('CloseService',''),TRUE);
          HTTPResponse := HTTPRequest(XMLRequestDocument,XMLDocOut,TRUE,FALSE);

          IF HTTPResponse <> '' THEN BEGIN
            ERROR(HTTPResponse);
          END ELSE BEGIN
            XMLNsMgr := XMLNsMgr.XmlNamespaceManager(XMLDocOut.NameTable);
            DocNameSpace := XMLEncode.VersionCheck('CloseService','');
            XMLNsMgr.AddNamespace(DocNameSpace,XMLEncode.GetNameSpaceURI('CloseService',''));
            CheckXMLResponseError(XMLDocOut,DocNameSpace,TRUE);
          END;

          DocNameSpace := XMLEncode.VersionCheck('CloseService','');

          WITH XMLManagement DO BEGIN
            IF ERASE(LabelFileName) THEN;
            IF FindNode(CurrNode,'//'+DocNameSpace+':Manifest/'+DocNameSpace+':File',CurrNode,XMLNsMgr) THEN BEGIN
              Bytes := Convert.FromBase64String(CurrNode.InnerText);
              MemoryStream := MemoryStream.MemoryStream(Bytes);
              Tempfile.CREATE(LabelFileName);
              Tempfile.CREATEOUTSTREAM(TempOutstream);
              MemoryStream.WriteTo(TempOutstream);
              Tempfile.CLOSE;
              MemoryStream.Flush;
              MemoryStream.Close;

              CurrentManifestHeader.InsertLabelFile(
                LabelFileName,
                STRSUBSTNO(Text010,"Account No."),
                12,'',PackingStation.Code,FALSE,PackingStation."Do Not Import Label File");
              PackingStation.ViewFile(LabelFileName);
            END;
          END;
        END;

        CLEAR(BufferFileName);
        CLEAR(XMLRequestDocument);
        CLEAR(XMLDocOut);
        CLEAR(TransactionResponse);

        //  Manifest Ground Shipments - If Available
        IF ISNULL(XMLRequestDocument) THEN
          XMLRequestDocument := XMLRequestDocument.XmlDocument;
        IF ISNULL(XMLDocOut) THEN
          XMLDocOut := XMLDocOut.XmlDocument;

        BufferFileName := GetBufferFile();

        IF NOT Hazmat THEN
          ManifestOnly := TRUE;
        IF ((ShippingAgentAccount."Close Manifest with Documents") AND Hazmat) THEN BEGIN
        XMLEncode.CreateSOAPRequest(XMLRequestDocument,'CloseService',BufferFileName);
          XMLEncode.CreateRequestHeader(
            'CloseService','GroundCloseWithDocumentsRequest',XMLRequestDocument,ShippingAgentAccount,
              FedExGlobalRegistration,'');
          XMLEncode.CreateManifestWithDocsRequest(
            XMLRequestDocument,CurrentManifestHeader,CurrentShippingAgentAccount,PackingStation,
            CarrierPackingStation,ManifestOnly, XMLEncode.GetNameSpaceURI('CloseService',''),FALSE);
          HTTPResponse := HTTPRequest(XMLRequestDocument,XMLDocOut,TRUE,FALSE);
        END ELSE BEGIN
          XMLEncode.CreateSOAPRequest(XMLRequestDocument,'CloseService',BufferFileName);
          XMLEncode.CreateRequestHeader(
            'CloseService','GroundCloseRequest',XMLRequestDocument,ShippingAgentAccount,FedExGlobalRegistration,'');
          XMLEncode.CreateManifestRequest(
            XMLRequestDocument,CurrentManifestHeader,CurrentShippingAgentAccount,ManifestOnly,
            XMLEncode.GetNameSpaceURI('CloseService',''),FALSE);
          HTTPResponse := HTTPRequest(XMLRequestDocument,XMLDocOut,TRUE,FALSE);
        END;

        IF HTTPResponse <> '' THEN BEGIN
          ERROR(HTTPResponse);
        END ELSE BEGIN
          XMLNsMgr := XMLNsMgr.XmlNamespaceManager(XMLDocOut.NameTable);
          DocNameSpace := XMLEncode.VersionCheck('CloseService','');
          XMLNsMgr.AddNamespace(DocNameSpace,XMLEncode.GetNameSpaceURI('CloseService',''));
          CheckXMLResponseError(XMLDocOut,DocNameSpace,TRUE);
        END;

        DocNameSpace := XMLEncode.VersionCheck('CloseService','');

        // Ground Manifest
        WITH XMLManagement DO BEGIN
          IF ERASE(LabelFileName) THEN;
          IF FindNode(CurrNode,'//'+DocNameSpace+':Manifest/'+DocNameSpace+':File',CurrNode,XMLNsMgr) THEN BEGIN
            Bytes := Convert.FromBase64String(CurrNode.InnerText);
            MemoryStream := MemoryStream.MemoryStream(Bytes);
            Tempfile.CREATE(LabelFileName);
            Tempfile.CREATEOUTSTREAM(TempOutstream);
            MemoryStream.WriteTo(TempOutstream);
            Tempfile.CLOSE;
            MemoryStream.Flush;
            MemoryStream.Close;

            SaveFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' +
              XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' + FormatTimeForFileOutput(TIME) +
              '-' + CurrentManifestHeader."No." + '_Manifest_buffer.txt';

            IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN BEGIN
              FILE.COPY(LabelFileName,SaveFileName);
            END;

            CurrentManifestHeader.InsertLabelFile(
              LabelFileName,STRSUBSTNO(Text010,"Account No."),
                12,'',PackingStation.Code,FALSE,PackingStation."Do Not Import Label File");
            PackingStation.ViewFile(LabelFileName);
          END;
        END;

        WITH XMLManagement DO BEGIN
          IF ERASE(LabelFileName) THEN;
          LabelFileName := PackingStation.CalcLabelFileName(
            CarrierPackingStation."FedEx Label Buffer File");

          CurrNode := XMLDocOut.DocumentElement;
          XMLNodeList :=
            XMLDocOut.SelectNodes('//'+
              DocNameSpace+':CloseDocuments',XMLNsMgr);

          FOR Loop := 0 TO XMLNodeList.Count - 1 DO BEGIN
            CurrNode := XMLNodeList.Item(Loop);
            ChildNode := CurrNode.FirstChild;
            CloseDocType := ChildNode.InnerText;

            CASE CloseDocType OF
              'MANIFEST':
                BEGIN
                  PdfNodeList := CurrNode.ChildNodes;
                  FOR PdfLoop := 0 TO PdfNodeList.Count - 1 DO BEGIN
                    CurrNode := PdfNodeList.Item(PdfLoop);
                    IF STRPOS(CurrNode.Name,'Parts') <> 0 THEN BEGIN
                      PartNodeList := CurrNode.ChildNodes;
                      FOR PartLoop := 0 TO PartNodeList.Count -1 DO BEGIN
                        CurrNode := PartNodeList.Item(PartLoop);
                        IF STRPOS(CurrNode.Name,'Image') <> 0 THEN BEGIN
                          Bytes := Convert.FromBase64String(CurrNode.InnerText);
                          MemoryStream := MemoryStream.MemoryStream(Bytes);
                          Tempfile.CREATE(LabelFileName);
                          Tempfile.CREATEOUTSTREAM(TempOutstream);
                          MemoryStream.WriteTo(TempOutstream);
                          Tempfile.CLOSE;
                          MemoryStream.Flush;
                          MemoryStream.Close;
                          SaveFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' +
                           XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                             FormatTimeForFileOutput(TIME) + '-' +
                               CurrentManifestHeader."No." + '_Manifest.txt';
                          CurrentManifestHeader.InsertLabelFile(
                            LabelFileName,STRSUBSTNO(Text018,CurrentManifestHeader."No."),
                              12,'',PackingStation.Code,FALSE,PackingStation."Do Not Import Label File");
                          PackingStation.ViewFile(LabelFileName);
                        END;
                      END;
                    END;
                  END;
                END;

              'OP_950':
                BEGIN
                  PdfFileName := STRSUBSTNO('%1\OP_950.pdf',
                    CarrierPackingStation."FedEx Buffer Directory");
                  IF ERASE(PdfFileName) THEN;
                  PdfNodeList := CurrNode.ChildNodes;
                  FOR PdfLoop := 0 TO PdfNodeList.Count - 1 DO BEGIN
                    CurrNode := PdfNodeList.Item(PdfLoop);

                    IF STRPOS(CurrNode.Name,'Parts') <> 0 THEN BEGIN
                      PartNodeList := CurrNode.ChildNodes;
                      FOR PartLoop := 0 TO PartNodeList.Count -1 DO BEGIN
                        CurrNode := PartNodeList.Item(PartLoop);
                        IF STRPOS(CurrNode.Name,'Image') <> 0 THEN BEGIN
                          Bytes := Convert.FromBase64String(CurrNode.InnerText);
                          MemoryStream := MemoryStream.MemoryStream(Bytes);
                          Tempfile.CREATE(PdfFileName);
                          Tempfile.CREATEOUTSTREAM(TempOutstream);
                          MemoryStream.WriteTo(TempOutstream);
                          Tempfile.CLOSE;
                          MemoryStream.Flush;
                          MemoryStream.Close;

                          SaveFileName := CarrierPackingStation."FedEx Buffer Directory" + '\' +
                             XMLManagement.FormatDateYYYYMMDD(TODAY) + '_T' +
                               FormatTimeForFileOutput(TIME) + '_OP950.pdf';

                          IF CarrierPackingStation."FedEx Save RateShop Buffers" THEN
                            FILE.COPY(PdfFileName,SaveFileName);

                          CurrentManifestHeader.InsertLabelFile(
                            PdfFileName,STRSUBSTNO(Text017,CurrentManifestHeader."No."),
                              28,'',PackingStation.Code,FALSE,PackingStation."Do Not Import Label File");
                          PackingStation.PrintPDFFile(PdfFileName,'',PackingStation."No Label Printer");
                        END;
                      END;
                    END;
                  END;
                END;
            END;
          END;
        END;

        CLEAR(BufferFileName);
        CLEAR(XMLRequestDocument);
        CLEAR(XMLDocOut);
        CLEAR(TransactionResponse);

      END;
    END;

    LOCAL PROCEDURE ReprintManifest@11();
    BEGIN

      ERROR(Text011);
    END;

    LOCAL PROCEDURE GetPackingStation@51();
    BEGIN
      IF PackingStation.Code = '' THEN
        PackingStation.GetPackingStation;
      CarrierPackingStation.GetPackingStation(PackingStation);
      CarrierPackingStation.TESTFIELD("Proxy Address");
      CarrierPackingStation.TESTFIELD("Proxy Port");
    END;

    LOCAL PROCEDURE GetShippingSetup@33();
    BEGIN
      IF NOT ShippingSetupRetrieved THEN BEGIN
        ShippingSetup.GET;
        ShippingSetupRetrieved := TRUE;
      END;
    END;

    LOCAL PROCEDURE GetShippingAgent@45(ShippingAgentCode@1240030000 : Code[10]);
    BEGIN
      IF (ShippingAgent.Code <> ShippingAgentCode) OR
         (ShippingAgentCode = '')
      THEN
        ShippingAgent.GET(ShippingAgentCode);
    END;

    LOCAL PROCEDURE GetShippingAgentService@15(ShippingAgentCode@1240030000 : Code[10];ShippingAgentServiceCode@1240030001 : Code[30];WorldWideService@1240030002 : Boolean);
    BEGIN
      IF (ShippingAgentService.Code <> ShippingAgentCode) OR
         (ShippingAgentService."World Wide Service" <> WorldWideService) OR
         (ShippingAgentService.Code <> ShippingAgentServiceCode) OR
         (ShippingAgentServiceCode = '')
      THEN
        ShippingAgentService.GET(ShippingAgentCode,ShippingAgentServiceCode,WorldWideService);
    END;

    LOCAL PROCEDURE GetFedExCountryCode@27(CountryCode@1240030000 : Code[10]) : Code[10];
    VAR
      Country@1240030001 : Record 9;
    BEGIN
      IF CountryCode <> '' THEN BEGIN
        Country.GET(CountryCode);
        Country.TESTFIELD(FedEx);
        Country.TESTFIELD("ISO 2 char Country Code");
        EXIT(Country."ISO 2 char Country Code");
      END ELSE
        EXIT('US');
    END;

    LOCAL PROCEDURE TestAndTransferToThirdParty@60(VAR CurrentPackage@1240030000 : Record 14000701;FedExOptionPage@1240030001 : Record 14000781;CurrentShippingAgentService@1240030002 : Record 14000708);
    BEGIN
      WITH CurrentPackage DO BEGIN
        IF "Shipping Payment Type" <> "Shipping Payment Type"::Prepaid THEN
          TransferToThirdPartyCost(CurrentShippingAgentService."Markup on Zero Shipping Cost")
        ELSE
          ClearThirdPartyCost;
      END;
    END;

    LOCAL PROCEDURE TestAndTransferToThirdPartyRS@61(CurrentRateShopHeader@1240030000 : Record 14000741;VAR CurrentRateShopLine@1240030001 : Record 14000742;FedExOptionPage@1240030002 : Record 14000781;CurrentShippingAgentService@1240030003 : Record 14000708);
    BEGIN
      WITH CurrentRateShopLine DO BEGIN
        IF CurrentRateShopHeader."Shipping Payment Type" <>
           CurrentRateShopHeader."Shipping Payment Type"::Prepaid
        THEN
          TransferToThirdPartyCost(
            CurrentRateShopHeader,CurrentShippingAgentService."Markup on Zero Shipping Cost")
        ELSE
          ClearThirdPartyCost;
      END;
    END;

    PROCEDURE HTTPRequest@1240030005(XMLRequest@1240030000 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";VAR XMLDocOut@1240030009 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";GiveError@1240030006 : Boolean;RateShop@1240030001 : Boolean) ErrorStatus : Text[1024];
    VAR
      XMLHTTPConn@1240030003 : DotNet "'System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Net.HttpWebRequest";
      XMLHTTPResponse@1240020000 : DotNet "'System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Net.HttpWebResponse";
      MemoryStream@1240020001 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.MemoryStream";
      XmlNode@1240020006 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
      XMLStreamReader@1240020007 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StreamReader";
      Enc@1240020010 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Text.Encoding";
      XMLFile@1240020011 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.File";
      TempFile@1240020003 : File;
      TempOutStream@1240020004 : OutStream;
      Window@1240030002 : Dialog;
      ServicePointMgr@1240020002 : DotNet "'System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Net.ServicePointManager";
      SecurityProtocolType@1240020005 : DotNet "'System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Net.SecurityProtocolType";
    BEGIN
      Window.OPEN(Text005);

      IF ISNULL(XMLHTTPConn) THEN
        XMLHTTPConn := XMLHTTPConn.HttpWebRequest;
      IF ISNULL(XMLHTTPResponse) THEN
        XMLHTTPResponse := XMLHTTPResponse.HttpWebResponse;

      ServicePointMgr.Expect100Continue := TRUE;
      ServicePointMgr.SecurityProtocol := SecurityProtocolType.Tls12;

      IF ShippingAgentAccount."Test Status" = ShippingAgentAccount."Test Status"::Live THEN
        XMLHTTPConn := XMLHTTPConn.Create('https://ws.fedex.com:443/web-services/' + URLSuffix)
      ELSE
        XMLHTTPConn := XMLHTTPConn.Create('https://wsbeta.fedex.com:443/web-services/' + URLSuffix);

      XMLHTTPConn.Timeout := 30000;
      XMLHTTPConn.UseDefaultCredentials(FALSE);
      XMLHTTPConn.ContentType := 'application/x-www-form-urlencoded';
      XMLHTTPConn.Accept := 'text/xml';
      XMLHTTPConn.Method := 'POST';
      XMLHTTPConn.AllowAutoRedirect := TRUE;
      XMLHTTPConn.UseDefaultCredentials;
      XMLHTTPConn.Headers.Add('SOAPAction','LoadTransaction');
      MemoryStream := XMLHTTPConn.GetRequestStream;
      XMLRequest.Save(BufferFileName);
      XMLRequest.Save(MemoryStream);
      MemoryStream.Flush;
      MemoryStream.Close;

      XMLHTTPResponse := XMLHTTPConn.GetResponse;
      MemoryStream := XMLHTTPResponse.GetResponseStream;
      XMLDocOut.Load(MemoryStream);
      MemoryStream.Flush;
      MemoryStream.Close;
      XMLHTTPResponse.Close;

      Window.CLOSE;

      IF XMLHTTPResponse.StatusCode <> 200 THEN BEGIN
        XMLDocOut.Save(CarrierPackingStation."FedEx Buffer Directory" + '\' + 'Failed_HTTP_Response.xml');
        ERROR(Text006);
      END ELSE BEGIN
        XMLDocOut.Save(CarrierPackingStation."FedEx Buffer Directory" + '\' + 'Valid_HTTP_Response.xml');
      END;
    END;

    PROCEDURE TransferPackageToXMLControl@1240030017(CurrentPackage@1240030004 : Record 14000701;FedExGlobalRegistration@1240030001 : Record 14000786;CarrierPackingStation@1240030015 : Record 14000729;RateRequest@1240030026 : Boolean;VAR FedExXMLControl@1240030002 : Record 14000791;VAR FedExXMLControlExt@1240030029 : Record 14000792;VAR FedExXMLControl3@1240020002 : Record 14000796;VAR FedExFreightXMLControl@1240020001 : Record 14000795);
    VAR
      CompanyInfo@1240030007 : Record 79;
      FedExOptionPage@1240030006 : Record 14000781;
      FedExOptionPageExt@1240020101 : Record 14000793;
      ShippingAccount@1240020000 : Record 14000714;
      MasterTrackingNumber@1240030005 : Code[20];
      MasterFormID@1240030008 : Code[4];
      ExportDoc@1240030010 : Record 14000981;
      InsureThroughShippingAgent@1240030003 : Boolean;
    BEGIN
      WITH CurrentPackage DO BEGIN
        GetShippingAgent("Shipping Agent Code");
        IF ShippingAgent."Disable Rate Calculation" THEN
          EXIT;

        GetShippingSetup;
        GetPackingStation;
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");
        GetShippingAgentService("Shipping Agent Code","Shipping Agent Service","World Wide Service");
        FedExOptionPage.GET(FedExOptionPage.Type::Package,"No.",0,0);
        IF NOT FedExOptionPageExt.GET(FedExOptionPageExt.Type::Package,"No.",0,0) THEN BEGIN
          FedExOptionPageExt.INIT;
          FedExOptionPageExt.Type := FedExOptionPageExt.Type::Package;
          FedExOptionPageExt."Source ID" := "No.";
          FedExOptionPageExt."Source Type" := 0;
          FedExOptionPageExt."Source Subtype" := 0;
          FedExOptionPageExt.INSERT(TRUE);
        END;
        GetGlobalShipperInfo;
        FedExXMLControl."World Wide Service" := "World Wide Service";
        IF "Currency Code" <> '' THEN
          FedExXMLControl."Package Currency Code" := "Currency Code"
        ELSE
          FedExXMLControl."Package Currency Code" := 'USD';
        IF "Intra Canadian Service" THEN
          FedExXMLControl."Package Currency Code" := 'CAD';

        IF "World Wide Service" THEN
          ExportDoc.GET("Export Document No.");

        CASE FedExOptionPage."Drop Off Type" OF
          FedExOptionPage."Drop Off Type"::"Regular Pickup":
            FedExXMLControl."Drop Off Type" := 'REGULAR_PICKUP';
          FedExOptionPage."Drop Off Type"::"Request Courier":
            FedExXMLControl."Drop Off Type" := 'REQUEST_COURIER';
          FedExOptionPage."Drop Off Type"::"Drop Box":
            FedExXMLControl."Drop Off Type" := 'DROP_BOX';
          FedExOptionPage."Drop Off Type"::"Drop at BSC":
            FedExXMLControl."Drop Off Type" := 'BUSINESS_SERVICE_CENTER';
          FedExOptionPage."Drop Off Type"::"Drop at Station":
            FedExXMLControl."Drop Off Type" := 'STATION';
          ELSE
            FedExXMLControl."Drop Off Type" := 'REGULAR_PICKUP'
        END;

        TESTFIELD("Service Indicator");
        FedExXMLControl."Service Indicator" := "Service Indicator";

        CASE FedExOptionPage."FedEx Packaging Type" OF
          FedExOptionPage."FedEx Packaging Type"::"Customer Packaging":
            FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Pak":
            FedExXMLControl."Packaging Type" := 'FEDEX_PAK';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_BOX';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Tube":
            FedExXMLControl."Packaging Type" := 'FEDEX_TUBE';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Envelope":
            FedExXMLControl."Packaging Type" := 'FEDEX_ENVELOPE';
          FedExOptionPage."FedEx Packaging Type"::"FedEx 10kg Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_10KG_BOX';
          FedExOptionPage."FedEx Packaging Type"::"FedEx 25kg Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_25KG_BOX';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Small Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_SMALL_BOX';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Medium Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_MEDIUM_BOX';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Large Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_LARGE_BOX';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Extra Large Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_EXTRA_LARGE_BOX';
        END;

        CASE "World Wide Service" OF
          "World Wide Service"::"1":
            CASE "Service Indicator" OF
              '70':
                BEGIN
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                  FedExOptionPage."FedEx Packaging Type" :=
                    FedExOptionPage."FedEx Packaging Type"::"Customer Packaging";
                  FedExOptionPage.MODIFY;
                END;
              '86':
                BEGIN
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                  FedExOptionPage."FedEx Packaging Type" :=
                    FedExOptionPage."FedEx Packaging Type"::"Customer Packaging";
                  FedExOptionPage.MODIFY;
                END;
              '92':
                BEGIN
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                  FedExOptionPage."FedEx Packaging Type" :=
                    FedExOptionPage."FedEx Packaging Type"::"Customer Packaging";
                  FedExOptionPage.MODIFY;
                END;
            END;
          "World Wide Service"::"0":
            CASE "Service Indicator" OF
              '70':
                BEGIN
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                  FedExOptionPage."FedEx Packaging Type" :=
                    FedExOptionPage."FedEx Packaging Type"::"Customer Packaging";
                  FedExOptionPage.MODIFY;
                END;
              '80':
                BEGIN
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                  FedExOptionPage."FedEx Packaging Type" :=
                    FedExOptionPage."FedEx Packaging Type"::"Customer Packaging";
                  FedExOptionPage.MODIFY;
                END;
              '83':
                BEGIN
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                  FedExOptionPage."FedEx Packaging Type" :=
                    FedExOptionPage."FedEx Packaging Type"::"Customer Packaging";
                  FedExOptionPage.MODIFY;
                END;
              '90':
                BEGIN
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                  FedExOptionPage."FedEx Packaging Type" :=
                    FedExOptionPage."FedEx Packaging Type"::"Customer Packaging";
                  FedExOptionPage.MODIFY;
                END;
              '92':
                BEGIN
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                  FedExOptionPage."FedEx Packaging Type" :=
                    FedExOptionPage."FedEx Packaging Type"::"Customer Packaging";
                  FedExOptionPage.MODIFY;
                END;
            END;
        END;

        CASE "World Wide Service" OF
          "World Wide Service"::"1":
            CASE "Service Indicator" OF
              '70':
                FedExXMLControl."Express Freight Shipment" := TRUE;
              '86':
                FedExXMLControl."Express Freight Shipment" := TRUE;
            END;
          "World Wide Service"::"0":
            CASE "Service Indicator" OF
              '70':
                FedExXMLControl."Express Freight Shipment" := TRUE;
              '80':
                FedExXMLControl."Express Freight Shipment" := TRUE;
              '83':
                FedExXMLControl."Express Freight Shipment" := TRUE;
            END;
        ELSE
          FedExXMLControl."Express Freight Shipment" := FALSE;
        END;

        CASE "Service Indicator" OF
          'FEF1','FEF2':
          BEGIN
            FedExXMLControl."FedEx Freight" := TRUE;
            FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
            FedExOptionPage."FedEx Packaging Type" :=
              FedExOptionPage."FedEx Packaging Type"::"Customer Packaging";
            FedExOptionPage.MODIFY;
          END
        ELSE
          FedExXMLControl."FedEx Freight" := FALSE;
        END;

        FedExXMLControl."Packing Date" := "Packing Date";

        FedExXMLControl."Calculation Length" := CurrentPackage."Calculation Length";
        FedExXMLControl."Calculation Width" := CurrentPackage."Calculation Width";
        FedExXMLControl."Calculation Height" := CurrentPackage."Calculation Height";
        IF FedExXMLControl."FedEx Freight" THEN
          IF FedExOptionPageExt.Palletized THEN BEGIN
            FedExFreightXMLControl."FX Freight Shipment Dim Length" :=
             FedExOptionPageExt."FX Freight Pallet Length";
            FedExFreightXMLControl."FX Freight Shipment Dim Width" :=
              FedExOptionPageExt."FX Freight Pallet Width";
            FedExFreightXMLControl."FX Freight Shipment Dim Height" :=
              FedExOptionPageExt."FX Freight Pallet Height";
            IF ShippingSetup."Default Size Units" = ShippingSetup."Default Size Units"::"IN"
              THEN
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'IN'
              ELSE
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'CM';
          END ELSE BEGIN
            FedExFreightXMLControl."FX Freight Shipment Dim Length" :=
              ROUND(CurrentPackage."Calculation Length",1);
            FedExFreightXMLControl."FX Freight Shipment Dim Width" :=
              ROUND(CurrentPackage."Calculation Width",1);
            FedExFreightXMLControl."FX Freight Shipment Dim Height" :=
              ROUND(CurrentPackage."Calculation Height",1);
            IF ShippingSetup."Default Size Units" = ShippingSetup."Default Size Units"::"IN"
              THEN
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'IN'
              ELSE
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'CM';
          END;
        IF ("Total Packages" > 1) AND ("Package No." = 1) AND "World Wide Service" THEN BEGIN
          FedExXMLControl."Total Shipment Weight" := ExportDoc.TotalPackageWeight;
          FedExXMLControl."Package Weight" := "Calculation Weight";
        END ELSE BEGIN
          FedExXMLControl."Total Shipment Weight" := "Calculation Weight";
          FedExXMLControl."Package Weight" := "Calculation Weight";
        END;
        IF FedExOptionPage."Total Shipment Weight" > 0 THEN
          FedExXMLControl."Total Shipment Weight" := FedExOptionPage."Total Shipment Weight";

        IF ShippingSetup."Default Weight Units" = ShippingSetup."Default Weight Units"::LBS
        THEN
          FedExXMLControl."Package Weight Units" := 'LB'
        ELSE
          FedExXMLControl."Package Weight Units" := 'KG';

        CASE "Shipping Insurance" OF
          "Shipping Insurance"::" ":
            IF "Shipping Payment Type" = "Shipping Payment Type"::Prepaid THEN
              InsureThroughShippingAgent := ShippingAgentAccount."Insure Through Carrier"
            ELSE
              InsureThroughShippingAgent := ShippingAgentAccount."Insured Third Party/Collect";
          "Shipping Insurance"::Never:
            InsureThroughShippingAgent := FALSE;
          "Shipping Insurance"::Always:
            InsureThroughShippingAgent := TRUE;
        END;

        IF InsureThroughShippingAgent THEN BEGIN
          IF ("Package No." = 1) AND "World Wide Service" THEN BEGIN
            FedExXMLControl."Total Shipment Insured Value" := ExportDoc.TotalPackageInsuranceValue;
            FedExXMLControl."Insured Value" := "Calculation Insured Value";
          END ELSE
            FedExXMLControl."Insured Value" := "Calculation Insured Value";
          FedExXMLControl."Insured Value Currency" := FedExXMLControl."Package Currency Code";
        END;

        FedExXMLControl."Export Document No." := "Export Document No.";

        IF FedExOptionPageExt."Call Tag Request" THEN BEGIN
          FedExXMLControl."Shipper Contact Name" := FedExOptionPageExt."Call Tag Contact";
          FedExXMLControl."Shipper Company Name" := FedExOptionPageExt."Call Tag Company Name";
          FedExXMLControl."Shipper Phone No." := FedExOptionPageExt."Call Tag Phone No.";
          FedExXMLControl."Shipper Address 1" := FedExOptionPageExt."Call Tag Address";
          FedExXMLControl."Shipper Address 2" := FedExOptionPageExt."Call Tag Address 2";
          FedExXMLControl."Shipper City" := FedExOptionPageExt."Call Tag City";
          FedExXMLControl."Shipper State" := FedExOptionPageExt."Call Tag State";
          FedExXMLControl."Shipper Zip Code" := FedExOptionPageExt."Call Tag ZIP Code";
          IF FedExOptionPageExt."Call Tag Country Code" <> '' THEN
            FedExXMLControl."Shipper Country Code" :=
              GetFedExCountryCode(FedExOptionPageExt."Call Tag Country Code")
          ELSE
            FedExXMLControl."Shipper Country Code" := 'US';
          FedExXMLControl."Shipper Return Residential" := FedExOptionPageExt."Call Tag Residential";
        END ELSE BEGIN
          FedExXMLControl."Shipper Account No." :=
            CarrierPackingStation."FedEx Shipping Agent Acc. No.";
          IF "World Wide Service" THEN BEGIN
            IF FedExOptionPage."Exporter EIN/SSN Indicator" <>
               FedExOptionPage."Exporter EIN/SSN Indicator"::" " THEN BEGIN
              CASE FedExOptionPage."Exporter EIN/SSN Indicator" OF
                FedExOptionPage."Exporter EIN/SSN Indicator"::SSN:
                  FedExXMLControl."Shipper TIN EIN/SSN Indicator" := 'PERSONAL_NATIONAL';
                FedExOptionPage."Exporter EIN/SSN Indicator"::EIN:
                  FedExXMLControl."Shipper TIN EIN/SSN Indicator" := 'BUSINESS_NATIONAL';
              END;
              FedExXMLControl."Shipper TIN EIN/SSN No." := FedExOptionPage."Exporter SSN/EIN No.";
            END ELSE BEGIN
              IF "Export Document No." <> '' THEN BEGIN
                CASE ExportDoc."PPI ID Type" OF
                  ExportDoc."PPI ID Type"::SSN:
                    FedExXMLControl."Shipper TIN EIN/SSN Indicator" := 'PERSONAL_NATIONAL';
                  ExportDoc."PPI ID Type"::EIN:
                    FedExXMLControl."Shipper TIN EIN/SSN Indicator" := 'BUSINESS_NATIONAL';
                END;
                FedExXMLControl."Shipper TIN EIN/SSN No." := ExportDoc."PPI ID";
              END;
            END;
          END;

          IF COD THEN BEGIN
            CompanyInfo.GET;
            FedExXMLControl."Shipper Contact Name" := CompanyInfo."COD Department";
            FedExXMLControl."Shipper Company Name" := CompanyInfo.Name;
            FedExXMLControl."Shipper Phone No." := XMLManagement.FixPhoneNo(CompanyInfo."COD Phone No.");
            FedExXMLControl."Shipper Address 1" := CompanyInfo."COD Address 1";
            FedExXMLControl."Shipper Address 2" := CompanyInfo."COD Address 2";
            FedExXMLControl."Shipper City" := CompanyInfo."COD City";
            FedExXMLControl."Shipper State" := XMLManagement.FixState(CompanyInfo."COD State");
            FedExXMLControl."Shipper Zip Code" := XMLManagement.FixZIPCode(CompanyInfo."COD Zip Code");
            IF CompanyInfo."Ship-to Country/Region Code" <> '' THEN
              FedExXMLControl."Shipper Country Code" :=
                GetFedExCountryCode(CompanyInfo."Ship-to Country/Region Code")
            ELSE
              FedExXMLControl."Shipper Country Code" := 'US';
            FedExXMLControl."Shipper Return Residential" := FALSE;
          END ELSE BEGIN
            FedExXMLControl."Shipper Contact Name" := PackingStation."Ship-from Contact";
            FedExXMLControl."Shipper Company Name" := PackingStation."Ship-from Company";
            FedExXMLControl."Shipper Phone No." := PackingStation."Ship-from Phone No.";
            FedExXMLControl."Shipper Address 1" := PackingStation."Ship-from Address";
            FedExXMLControl."Shipper Address 2" := PackingStation."Ship-from Address2";
            FedExXMLControl."Shipper City" := PackingStation."Ship-from City";
            FedExXMLControl."Shipper State" := PackingStation."Ship-from State";
            FedExXMLControl."Shipper Zip Code" := PackingStation."Ship-from ZIP Code";
            IF PackingStation."Ship-from Country Code" <> '' THEN
              FedExXMLControl."Shipper Country Code" :=
                GetFedExCountryCode(PackingStation."Ship-from Country Code")
            ELSE
              FedExXMLControl."Ship-to Country Code" := 'US';
            FedExXMLControl."Ship-to Residential" :=  FALSE;
          END;
        END;

        FedExXMLControl."Ship-to No." := "Ship-to No.";
        FedExXMLControl."Ship-to Code" := "Ship-to Code";
        FedExXMLControl."Ship-to Contact Name" := "Ship-to Contact";
        FedExXMLControl."Ship-to Company Name" := "Ship-to Name";
        IF "Ship-to Phone No." <> '' THEN BEGIN
          FedExXMLControl."Ship-to Phone No." := "Ship-to Phone No.";
        END ELSE
          IF PackingStation."Phone No. to use If Blank" <> '' THEN BEGIN
            FedExXMLControl."Ship-to Phone No." := PackingStation."Phone No. to use If Blank";
          END ELSE
            TESTFIELD("Ship-to Phone No.");

        FedExXMLControl."Ship-to Address 1" := "Ship-to Address";
        FedExXMLControl."Ship-to Address 2" := "Ship-to Address 2";
        FedExXMLControl."Ship-to City" := "Ship-to City";
        FedExXMLControl."Ship-to State" := "Ship-to State";
        FedExXMLControl."Ship-to Zip Code" := "Ship-to ZIP Code";
        IF "Ship-to Country Code" <> '' THEN
          FedExXMLControl."Ship-to Country Code" := GetFedExCountryCode("Ship-to Country Code")
        ELSE
          FedExXMLControl."Ship-to Country Code" := 'US';

        IF "Residential Delivery" THEN
          FedExXMLControl."Ship-to Residential" := TRUE;
        FedExXMLControl."Ship-to Email Address" := "Ship-to Email Address";

        IF FedExOptionPage."Return Shipment" OR FedExOptionPageExt."Call Tag Request" THEN BEGIN
          FedExXMLControl."Ship-to Contact Name" := PackingStation."Ship-from Contact";
          FedExXMLControl."Ship-to Company Name" := PackingStation."Ship-from Company";
          FedExXMLControl."Ship-to Phone No." := PackingStation."Ship-from Phone No.";
          FedExXMLControl."Ship-to Address 1" := PackingStation."Ship-from Address";
          FedExXMLControl."Ship-to Address 2" := PackingStation."Ship-from Address2";
          FedExXMLControl."Ship-to City" := PackingStation."Ship-from City";
          FedExXMLControl."Ship-to State" := PackingStation."Ship-from State";
          FedExXMLControl."Ship-to Zip Code" := PackingStation."Ship-from ZIP Code";
          IF PackingStation."Ship-from Country Code" <> '' THEN
            FedExXMLControl."Ship-to Country Code" :=
              GetFedExCountryCode(PackingStation."Ship-from Country Code")
          ELSE
            FedExXMLControl."Ship-to Country Code" := 'US';
          FedExXMLControl."Ship-to Residential" :=  FALSE;
          FedExXMLControlExt."Return RMA Reason" := FedExOptionPage."Return RMA Reason";
          FedExXMLControlExt."Return RMA Reason 2" := FedExOptionPage."Return RMA Reason 2";
          FedExXMLControl."Shipper Contact Name" := "Ship-to Contact";
          FedExXMLControl."Shipper Company Name" := "Ship-to Name";
          FedExXMLControl."Shipper Phone No." := "Ship-to Phone No.";

          FedExXMLControl."Shipper Address 1" := "Ship-to Address";
          FedExXMLControl."Shipper Address 2" := "Ship-to Address 2";
          FedExXMLControl."Shipper City" := "Ship-to City";
          FedExXMLControl."Shipper State" := "Ship-to State";
          FedExXMLControl."Shipper Zip Code" := "Ship-to ZIP Code";
          FedExXMLControl."Shipper Return Residential" := "Residential Delivery";
          IF "Ship-to Country Code" <> '' THEN
            FedExXMLControl."Shipper Country Code" := "Ship-to Country Code";
        END;

        IF NOT RateRequest THEN BEGIN
          CASE "Shipping Payment Type" OF
            "Shipping Payment Type"::Prepaid:
              BEGIN
                IF FedExXMLControl."FedEx Freight" THEN
                  FedExFreightXMLControl."Special Services Payment Type" := 'SHIPPER';
                FedExXMLControl."Payment Type" := 'SENDER';
                FedExXMLControl."Payor Account No." := ShippingAgentAccount."Account No.";
              END;
            "Shipping Payment Type"::"Third Party":
              BEGIN
                TESTFIELD("Third Party Ship. Account No.");
                FedExXMLControl."Payment Type" := 'THIRD_PARTY';
                FedExXMLControl."Payor Account No." := "Third Party Ship. Account No.";
              END;
            "Shipping Payment Type"::"Freight Collect":
              BEGIN
                IF FedExXMLControl."FedEx Freight" THEN
                  FedExFreightXMLControl."Special Services Payment Type" := 'CONSIGNEE';
                FedExXMLControl."Payment Type" := 'RECIPIENT';
                FedExXMLControl."Payor Account No." := "Third Party Ship. Account No.";
              END;
            "Shipping Payment Type"::Consignee:
              BEGIN
                IF FedExXMLControl."FedEx Freight" THEN
                  FedExFreightXMLControl."Special Services Payment Type" := 'CONSIGNEE';
                FedExXMLControl."Payment Type" := 'COLLECT';
                FedExXMLControl."Payor Account No." := "Third Party Ship. Account No.";
              END;
          END;
        END ELSE BEGIN
          FedExXMLControl."Payment Type" := 'SENDER';
          FedExXMLControl."Payor Account No." := ShippingAgentAccount."Account No.";
        END;

        IF "Service Indicator" = 'SP' THEN
          IF "Third Party Ship. Account No." <> '' THEN BEGIN
            FedExXMLControl."Payment Type" := 'THIRD_PARTY';
            FedExXMLControl."Payor Account No." := ShippingAgentAccount."Account No.";
            IF "Third Party Ship. Account No." <> '' THEN
              FedExXMLControl."Payor Account No." := "Third Party Ship. Account No.";
          END;
        FedExXMLControl."Recipient Related" := FedExOptionPage."Recipient Related";
        FedExXMLControl."Include Broker Info." := FedExOptionPage."Include Broker Info.";

        IF (COD AND ("Service Indicator" <> '92')) OR
           FedExOptionPage."Dry Ice" OR
           (FedExOptionPage."Dangerous Goods" AND FedExXMLControl."FedEx Freight") OR
           FedExOptionPage."Ship Notification" OR
           FedExOptionPageExt."Hold At Location" OR
           FedExOptionPage."Saturday Pickup" OR
           FedExOptionPage."Inside Pick Up" OR
           FedExOptionPage."Inside Delivery" OR
           FedExOptionPage."Liftgate Pickup" OR
           FedExOptionPage."Liftgate Delivery" OR
           FedExOptionPage."Return Shipment" OR
           FedExOptionPage."Include Broker Info." OR
           FedExOptionPageExt."Electronic Trade Documents" OR
           FedExOptionPage."Saturday Delivery" OR
           FedExOptionPageExt."Call Tag Request" OR
           FedExOptionPage."Intl Controlled Export Service" OR
           FedExOptionPage.ITAR OR
           FedExOptionPage."Call Before Delivery" OR
           FedExOptionPage."FedEx One Rate" OR
           FedExOptionPage."Extreme Length" OR
           FedExOptionPage."Call Before Delivery" OR
           FedExOptionPageExt."Do Not Break Down Pallets" OR
           FedExOptionPageExt."Do Not Stack Pallets" OR
           FedExOptionPage."Pharmacy Delivery" OR
           FedExOptionPage."Future Day Shipment"
        THEN
           FedExXMLControl."Shipment Special Services Flag" := TRUE;
        IF "Packing Date" > TODAY THEN
           FedExXMLControl."Shipment Special Services Flag" := TRUE;

        IF (COD AND ("Service Indicator" = '92')) OR
           FedExOptionPage."Dangerous Goods" OR
           FedExOptionPage."Signature Release" OR
           (FedExOptionPage."Delivery Signature Options" <>
             FedExOptionPage."Delivery Signature Options"::" ") OR
           FedExOptionPage."Priority Alert" OR
           FedExOptionPage.Alcohol OR
           FedExOptionPage."Additional Handling Required" OR
           FedExOptionPage."Dry Ice" OR
           FedExOptionPage."Non Standard Container" OR
           (FedExOptionPage."Home Delivery Premium Type" =
             FedExOptionPage."Home Delivery Premium Type"::"FedEx Appointment Home Delivery")
        THEN
           FedExXMLControl."Package Special Services Flag" := TRUE;

        IF "Packing Date" > TODAY THEN
           FedExXMLControl."Shipment Special Services Flag" := TRUE;

        IF FedExOptionPage."Home Delivery Premium Type" <> 0
        THEN
           FedExXMLControl."Shipment Special Services Flag" := TRUE;

        FedExXMLControl."Return Shipment" := FedExOptionPage."Return Shipment";
        FedExXMLControlExt."Ship and Return Label" := FedExOptionPage."Ship and Return Label";

        FedExXMLControl.COD := COD;
        IF "COD Cashiers Check" THEN
          FedExXMLControl."COD Collection Type" := 'GUARANTEED_FUNDS'
        ELSE
          IF FedExOptionPage."COD Cash Only" THEN
            FedExXMLControl."COD Collection Type" := 'CASH'
          ELSE
            FedExXMLControl."COD Collection Type" := 'ANY';

        IF FedExXMLControl."FedEx Freight" THEN
          IF (FedExXMLControl."COD Collection Type" = 'CASH') OR
             (FedExXMLControl."COD Collection Type" = 'ANY') THEN
            FedExXMLControl."COD Collection Type" := 'PERSONAL_CHECK';
        FedExXMLControl."COD Amount" := "COD Amount";
        IF FedExXMLControl."Service Indicator" = '92' THEN
          IF (ShippingAgentAccount."COD Rule" =
           ShippingAgentAccount."COD Rule"::"All on Last Package") THEN
             FedExXMLControl."COD Amount" := CurrentPackage."Calculation Value";

        IF "COD Collection Currency" <> '' THEN
          FedExXMLControl."COD Currency" := "COD Collection Currency"
        ELSE
          FedExXMLControl."COD Currency" := FedExXMLControl."Package Currency Code";

        FedExXMLControl."COD Add Charges Rate Basis" := FedExOptionPage."COD Add Charges Rate Basis";
        FedExXMLControl."COD Add Charges Charge Basis" := FedExOptionPage."COD Add Charges Charge Basis";
        FedExXMLControl."COD Add Charges Charge Level" := FedExOptionPage."COD Add Charges Charge Level";
        FedExXMLControl."COD Add Transportation Charge" := FedExOptionPage."COD Add Transportation Charge";
        FedExXMLControl."COD Reference" := FedExOptionPage."COD Reference";
        FedExXMLControl."Delivery Day" := FedExOptionPage."Delivery Day";
        FedExXMLControl."Extreme Length" := FedExOptionPage."Extreme Length";
        FedExXMLControl."FedEx One Rate" := FedExOptionPage."FedEx One Rate";
        FedExXMLControl."Future Day Shipment" := FedExOptionPage."Future Day Shipment";
        FedExXMLControl.Alcohol := FedExOptionPage.Alcohol;
        FedExXMLControl."Alcohol Recipient Type" := FedExOptionPage."Alcohol Recipient Type";
        FedExXMLControl."Add Shipping Charge to COD Amt" := "Add Shipping Charge to COD Amt";

        FedExXMLControl."Priority Alert" := FedExOptionPage."Priority Alert";
        FedExXMLControl."Priority Alert Detail" := FedExOptionPage."Priority Alert Detail";
        FedExXMLControl."Priority Alert Plus" := FedExOptionPage."Priority Alert Plus";

        FedExXMLControl."Ship Notification" := FedExOptionPage."Ship Notification";
        FedExXMLControl."Notification Memo" := FedExOptionPage."Ship Notification Memo";
        IF FedExOptionPage."Ship Notification" THEN
          FedExOptionPage.TESTFIELD(FedExOptionPage."Notification Format");
        CASE FedExOptionPage."Notification Format" OF
          FedExOptionPage."Notification Format"::HTML:
            FedExXMLControl."Notification Format" := 'HTML';
          FedExOptionPage."Notification Format"::Text:
            FedExXMLControl."Notification Format" := 'TEXT';
          FedExOptionPage."Notification Format"::Wireless:
            FedExXMLControl."Notification Format" := 'WIRELESS';
        END;
        FedExXMLControl."Notification Language Code" := 'EN';

        FedExXMLControl."Shipper Ship Notification" := FedExOptionPage."Shipper Ship Notification";
        FedExXMLControl."Shipper Exception Notification" :=
          FedExOptionPage."Shipper Exception Notification";
        FedExXMLControl."Shipper Delivery Notification" :=
          FedExOptionPage."Shipper Delivery Notification";
        FedExXMLControl."Shipper EMail Address" := PackingStation."Ship-from E-Mail";
        FedExXMLControl."Recipient Delivery Notif." := FedExOptionPage."Recipient Delivery Notif.";
        FedExXMLControl."Recipient Ship Notification" := FedExOptionPage."Recipient Ship Notification";
        FedExXMLControl."Recipient Exception Notif." := FedExOptionPage."Recipient Exception Notif.";
        FedExXMLControl."Optional Delivery Notification" :=
          FedExOptionPage."Optional Delivery Notification";
        FedExXMLControl."Optional Ship Notification" := FedExOptionPage."Optional Ship Notification";
        FedExXMLControl."Optional Exception Notif." := FedExOptionPage."Optional Exception Notif.";
        FedExXMLControl."Ship Notification Email" := FedExOptionPage."Ship Notification Email";
        FedExXMLControl."Ship Notification Email 2" := FedExOptionPage."Ship Notification Email 2";
        FedExXMLControl."Ship Notification Email 3" := FedExOptionPage."Ship Notification Email 3";
        FedExXMLControl."Broker Ship Notification" := FedExOptionPage."Broker Ship Notification";
        IF FedExXMLControl."Broker Ship Notification" THEN
          FedExXMLControlExt."Broker Email Address" := FedExOptionPage."Broker Email Address";
        FedExXMLControl."Broker Exception Notification" :=
          FedExOptionPage."Broker Exception Notification";
        FedExXMLControl."Broker Delivery Notification" :=
          FedExOptionPage."Broker Delivery Notification";

        FedExXMLControl."Hold at Location" := FedExOptionPageExt."Hold At Location";
        FedExXMLControl."HAL Recipient Phone Number" := FedExOptionPageExt."HAL Location Phone No.";
        FedExXMLControlExt."HAL Company" := FedExOptionPageExt."HAL Company";
        FedExXMLControlExt."HAL Contact Id" := FedExOptionPageExt."HAL Contact Id";
        FedExXMLControlExt."HAL Contact Title" := FedExOptionPageExt."HAL Contact Title";
        FedExXMLControl."HAL FedEx Location Address" := FedExOptionPageExt."HAL Location Address";
        FedExXMLControl."HAL FedEx Location City" := FedExOptionPageExt."HAL Location City";
        FedExXMLControl."HAL FedEx Location State" := FedExOptionPageExt."HAL Location State";
        FedExXMLControl."HAL FedEx Location Zip Code" := FedExOptionPageExt."HAL Location Zip";
        IF FedExOptionPageExt."HAL Location Country" <> '' THEN
          FedExXMLControl."HAL FedEx Location Country" :=
            GetFedExCountryCode(FedExOptionPageExt."HAL Location Country")
        ELSE
          FedExXMLControl."HAL FedEx Location Country" := 'US';
        FedExXMLControlExt."HAL Fedex Phone No." := FedExOptionPageExt."HAL Fedex Phone No.";
        FedExXMLControlExt."HAL Location Email Address" := FedExOptionPageExt."HAL Location Email Address";
        FedExXMLControlExt."HAL Location FAX No." := FedExOptionPageExt."HAL Location FAX No.";
        FedExXMLControlExt."HAL Location Pager No." := FedExOptionPageExt."HAL Location Pager No.";
        FedExXMLControlExt."HAL Location Phone Ext." := FedExOptionPageExt."HAL Location Phone Ext.";
        FedExXMLControlExt."HAL Location Urbanization Code" := FedExOptionPageExt."HAL Location Urbanization Code";
        FedExXMLControl."HAL Residential" := FALSE;

        FedExXMLControl."HAL Recipient Name" := FedExOptionPageExt."HAL Recipient Name";
        FedExXMLControl."HAL Fedex Location Type" := XMLManagement.Blank2Underscore(
          STRSUBSTNO('%1',FedExOptionPageExt."HAL FedEx Location Type"));

        FedExXMLControl."Insurance Charge" := FedExOptionPage."Insurance Charge";
        FedExXMLControl."Insurance Charge Currency" := FedExOptionPage."Insurance Charge Currency";
        FedExXMLControlExt."Importer Country" := FedExOptionPage."Importer Country";
        FedExXMLControlExt."Importer Name" := FedExOptionPage."Importer Name";
        FedExXMLControlExt."Importer Company" := FedExOptionPage."Importer Company";
        FedExXMLControlExt."Importer Address 1" := FedExOptionPage."Importer Address 1";
        FedExXMLControlExt."Importer Address 2" := FedExOptionPage."Importer Address 2";
        FedExXMLControlExt."Importer City" := FedExOptionPage."Importer City";
        FedExXMLControlExt."Importer State" := FedExOptionPage."Importer State";
        FedExXMLControlExt."Importer Postal Code" := FedExOptionPage."Importer Postal Code";
        FedExXMLControlExt."Importer Account No." := FedExOptionPage."Importer Account No.";
        FedExXMLControlExt."Importer Phone No." := FedExOptionPage."Importer Phone No.";
        FedExXMLControlExt."Importer SSN/EIN No." := FedExOptionPage."Importer SSN/EIN No.";
        FedExXMLControl."Intl Controlled Export Service" :=
          FedExOptionPage."Intl Controlled Export Service";
          FedExXMLControl."FICE License Type" := STRSUBSTNO ('%1',FedExOptionPage."FICE License Type");
          FedExXMLControl."FICE Foreign Trade Zone" := FedExOptionPage."FICE Foreign Trade Zone";
          FedExXMLControl."FICE Entry No." := FedExOptionPage."FICE Entry No.";
          FedExXMLControl."FICE License/Permit No." := FedExOptionPage."FICE License/Permit No.";
          FedExXMLControl."FICE License/Permit Exp. Date" :=
            FedExOptionPage."FICE License/Permit Exp. Date";

        FedExXMLControlExt.ITAR := FedExOptionPage.ITAR;
        FedExXMLControlExt."ITAR License or Exemption No." :=
          FedExOptionPage."ITAR License or Exemption No.";
        CASE FedExOptionPage."Home Delivery Premium Type" OF
          FedExOptionPage."Home Delivery Premium Type"::"FedEx Appointment Home Delivery":
            BEGIN
              FedExXMLControl."Home Delivery Type" := 'APPOINTMENT';
              FedExXMLControl."Home Delivery Date" := FedExOptionPage."FedEx Home Delivery Date";
            END;
          FedExOptionPage."Home Delivery Premium Type"::"FedEx Date Certain Home Delivery":
            BEGIN
              FedExXMLControl."Home Delivery Type" := 'DATE_CERTAIN';
              FedExXMLControl."Home Delivery Date" := FedExOptionPage."FedEx Home Delivery Date";
            END;
          FedExOptionPage."Home Delivery Premium Type"::"FedEx Evening Home Delivery":
            FedExXMLControl."Home Delivery Type" := 'EVENING';
        END;
        FedExXMLControl."Home Delivery Phone No." := FedExOptionPage."FedEx Home Delivery Phone No.";

        FedExXMLControl."Dry Ice" := FedExOptionPage."Dry Ice";
        FedExXMLControl."Dry Ice Weight" := FedExOptionPage."Dry Ice Weight";
        IF FedExOptionPage."Dangerous Goods" THEN BEGIN
          IF FedExOptionPage.Hazmat = FALSE THEN
            FedExOptionPage.TESTFIELD(FedExOptionPage."Dangerous Goods Access. Type");
          FedExXMLControl."Dangerous Goods" := FedExOptionPage."Dangerous Goods";
          FedExXMLControl."Cargo Aircraft" := FedExOptionPage."Cargo Aircraft";

          FedExXMLControlExt."DG Container Type" := FedExOptionPage."DG Container Type";
          CASE FedExOptionPage."Dangerous Goods Access. Type" OF
            FedExOptionPage."Dangerous Goods Access. Type"::Accessible:
              FedExXMLControl."Dangerous Goods Type" := 'ACCESSIBLE';
            FedExOptionPage."Dangerous Goods Access. Type"::Inaccessible:
              FedExXMLControl."Dangerous Goods Type" := 'INACCESSIBLE';
          END;
        END;

        FedExXMLControl.Hazmat := FedExOptionPage.Hazmat;
          FedExXMLControl."Hazmat Contact Phone No." := CarrierPackingStation."Hazmat Contact Phone No.";
          FedExXMLControl."Hazmat Contact Name" := CarrierPackingStation."Hazmat Contact Name";
        FedExXMLControl."Hazmat Option Type" := STRSUBSTNO('%1',FedExOptionPage."Hazmat Option Type");

        FedExXMLControl."Saturday Pickup" := FedExOptionPage."Saturday Pickup";
        FedExXMLControl."Saturday Delivery" := FedExOptionPage."Saturday Delivery";
        FedExXMLControl."Additional Handling Required" := FedExOptionPage."Additional Handling Required";
        FedExXMLControl."Non Standard Container" := FedExOptionPage."Non Standard Container";
        FedExXMLControl."Call Before Delivery" := FedExOptionPage."Call Before Delivery";
        FedExXMLControl."Inside Pickup" := FedExOptionPage."Inside Pick Up" ;
        FedExXMLControl."Inside Delivery" := FedExOptionPage."Inside Delivery" ;
        FedExXMLControl."Liftgate Pickup" := FedExOptionPage."Liftgate Pickup";
        FedExXMLControl."Liftgate Delivery" := FedExOptionPage."Liftgate Delivery";
        FedExXMLControl."Call Tag Request" := FedExOptionPageExt."Call Tag Request";
        FedExXMLControl."Call Tag Ready Date" := FedExOptionPageExt."Call Tag Request Date";
        FedExXMLControl."Call Tag Latest Pickup Date" := FedExOptionPageExt."Call Tag Latest Pickup Date";
        FedExXMLControl."Call Tag Courier Instructions" :=
          FedExOptionPageExt."Call Tag Courier Instructions";

        CASE FedExOptionPageExt."Call Tag Request Type" OF
          FedExOptionPageExt."Call Tag Request Type"::"Future Day":
            BEGIN
              FedExXMLControl."Call Tag Request Type" := 'FUTURE_DAY';
            END;
          FedExOptionPageExt."Call Tag Request Type"::"Same Day":
            BEGIN
              FedExXMLControl."Call Tag Request Type" := 'SAME_DAY';
            END;
        END;

        CASE FedExOptionPageExt."Call Tag Request Source" OF
          FedExOptionPageExt."Call Tag Request Source"::Automation:
            BEGIN
              FedExXMLControl."Call Tag Request Source" := 'AUTOMATION';
            END;
          FedExOptionPageExt."Call Tag Request Source"::"Customer Service":
            BEGIN
              FedExXMLControl."Call Tag Request Source" := 'CUSTOMER_SERVICE';
            END;
        END;

        FedExXMLControl."Delivery Signature Options" := FedExOptionPage."Delivery Signature Options";
        FedExXMLControl."Signature Release Auth." := FedExOptionPage."Signature Release Auth.";
        FedExXMLControl."Signature Release" := FedExOptionPage."Signature Release";

        FedExXMLControl."Smart Post Shipment" := FedExOptionPage."FedEx SmartPost Shipment";

        CASE FedExOptionPage."FedEx SmartPost Indicia" OF
          FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Media":
            FedExXMLControl."Smart Post Indicia" := 'MEDIA_MAIL';
          FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Parcel Select":
            FedExXMLControl."Smart Post Indicia" := 'PARCEL_SELECT';
          FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Bound Printed Matter":
            FedExXMLControl."Smart Post Indicia" := 'PRESORTED_BOUND_PRINTED_MATTER';
          FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Presorted Standard":
            FedExXMLControl."Smart Post Indicia" := 'PRESORTED_STANDARD';
          FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Returns":
            FedExXMLControl."Smart Post Indicia" := 'PARCEL_RETURN';
          FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Parcel Select Lightweight":
            FedExXMLControl."Smart Post Indicia" := 'PARCEL_SELECT_LIGHTWEIGHT';
          ELSE
            IF FedExOptionPage."FedEx SmartPost Shipment" THEN
              ERROR(Text007);
        END;

        CASE FedExOptionPage."FedEx SmartPost Endorsement" OF
          FedExOptionPage."FedEx SmartPost Endorsement"::"Address Correction":
            FedExXMLControl."Smart Post Endorsement" := 'ADDRESS_CORRECTION';
          FedExOptionPage."FedEx SmartPost Endorsement"::"Carrier Leave If No Response":
            FedExXMLControl."Smart Post Endorsement" := 'CARRIER_LEAVE_IF_NO_RESPONSE';
          FedExOptionPage."FedEx SmartPost Endorsement"::"Change Service":
            FedExXMLControl."Smart Post Endorsement" := 'CHANGE_SERVICE';
          FedExOptionPage."FedEx SmartPost Endorsement"::"Forwarding Service":
            FedExXMLControl."Smart Post Endorsement" := 'FORWARDING_SERVICE';
          FedExOptionPage."FedEx SmartPost Endorsement"::"Return Service":
            FedExXMLControl."Smart Post Endorsement" := 'RETURN_SERVICE';
        END;

        FedExXMLControl."Smart Post Hub ID" := ConvertSmartPostHubID(ShippingAgentAccount);
        FedExXMLControl."Smart Post Manifest ID" := FedExOptionPage."FedEx SmartPost Manifest ID";
        FedExXMLControl."Smart Post Delivery Conf." := FedExOptionPage."FedEx SmartPost Delivery Conf.";
        FedExXMLControl."Block Insight Visibility" := FedExOptionPage."Block Insight Visibility";
        FedExXMLControl."Packing List Enclosed" := FedExOptionPage."Packaging List Enclosed";
        FedExXMLControl."Shippers Load And Count" := FedExOptionPage."Shipper Load and Count";
        FedExXMLControl."Booking Confirmation No." := FedExOptionPage."Booking Confimation No.";

        FedExXMLControl."Label Format Type" := 'COMMON2D';
        CASE CarrierPackingStation."FedEx Label Printer Type" OF
          CarrierPackingStation."FedEx Label Printer Type"::"Eltron (EPL)":
            BEGIN
              FedExXMLControl."Label Image Type" := 'EPL2';
            END;
          CarrierPackingStation."FedEx Label Printer Type"::"Zebra (ZPL)":
            BEGIN
              FedExXMLControl."Label Image Type" := 'ZPLII';
            END;
        END;

        FedExXMLControl."Label Stock Type" := CarrierPackingStation."FedEx Label Media Type";
        CASE CarrierPackingStation."FedEx Print From" OF
          CarrierPackingStation."FedEx Print From"::Top:
            BEGIN
              FedExXMLControl."Label Printing Orientation" := 'TOP_EDGE_OF_TEXT_FIRST';
            END;
          CarrierPackingStation."FedEx Print From"::Bottom:
            BEGIN
              FedExXMLControl."Label Printing Orientation" := 'BOTTOM_EDGE_OF_TEXT_FIRST';
            END;
        END;

      IF NOT COD THEN BEGIN
          IF "Blind Shipment" OR "Double Blind Shipment" THEN BEGIN
            FedExXMLControl."Alternate Ship-To Person Name" := "Blind Ship-from Contact";
            FedExXMLControl."Alternate Ship-To Company Name" := "Blind Ship-from Name";
            FedExXMLControl."Alternate Ship-To Phone No." :=
              XMLManagement.FixPhoneNo(
                "Blind Ship-from Phone No.");
            FedExXMLControl."Alternate Ship-To Address 1" := "Blind Ship-from Address";
            FedExXMLControl."Alternate Ship-To Address 2" := "Blind Ship-from Address 2";
            FedExXMLControl."Alternate Ship-To City" := "Blind Ship-from City";
            FedExXMLControl."Alternate Ship-To State" :=
              XMLManagement.FixState(
                "Blind Ship-from State");
            FedExXMLControl."Alternate Ship-To Postal Code" :=
              XMLManagement.FixZIPCode(
                "Blind Ship-from ZIP Code");
            IF "Blind Ship-from Country Code" <> '' THEN
              FedExXMLControl."Alternate Ship-To Country" :=
                GetFedExCountryCode(
                  "Blind Ship-from Country Code")
            ELSE
              FedExXMLControl."Alternate Ship-To Country" := 'US';
            FedExXMLControl."Alternate Ship-To Residential" := FALSE;
          END ELSE BEGIN
            FedExXMLControl."Alternate Ship-To Person Name" := PackingStation."Ship-from Contact";
            FedExXMLControl."Alternate Ship-To Company Name" := PackingStation."Ship-from Company";
            FedExXMLControl."Alternate Ship-To Phone No." :=
              XMLManagement.FixPhoneNo(
                PackingStation."Ship-from Phone No.");
            FedExXMLControl."Alternate Ship-To Address 1" := PackingStation."Ship-from Address";
            FedExXMLControl."Alternate Ship-To Address 2" := PackingStation."Ship-from Address2";
            FedExXMLControl."Alternate Ship-To City" := PackingStation."Ship-from City";
            FedExXMLControl."Alternate Ship-To State" :=
              XMLManagement.FixState(
                PackingStation."Ship-from State");
            FedExXMLControl."Alternate Ship-To Postal Code" :=
              XMLManagement.FixZIPCode(
                PackingStation."Ship-from ZIP Code");
            IF PackingStation."Ship-from Country Code" <> '' THEN
              FedExXMLControl."Alternate Ship-To Country" :=
                GetFedExCountryCode(
                  PackingStation."Ship-from Country Code")
            ELSE
              FedExXMLControl."Alternate Ship-To Country" := 'US';
            FedExXMLControl."Alternate Ship-To Residential" := FALSE;
          END;
        END ELSE BEGIN
            CompanyInfo.GET;
            FedExXMLControl."Alternate Ship-To Person Name" := CompanyInfo."COD Department";
            FedExXMLControl."Alternate Ship-To Company Name" := CompanyInfo.Name;
            FedExXMLControl."Alternate Ship-To Phone No." :=
              XMLManagement.FixPhoneNo(
                CompanyInfo."COD Phone No.");
            FedExXMLControl."Alternate Ship-To Address 1" := CompanyInfo."COD Address 1";
            FedExXMLControl."Alternate Ship-To Address 2" := CompanyInfo."COD Address 2";
            FedExXMLControl."Alternate Ship-To City" := CompanyInfo."COD City";
            FedExXMLControl."Alternate Ship-To State" :=
              XMLManagement.FixState(
                CompanyInfo."COD State");
            FedExXMLControl."Alternate Ship-To Postal Code" :=
              XMLManagement.FixZIPCode(
                CompanyInfo."COD Zip Code");
            IF CompanyInfo."Ship-to Country/Region Code" <> '' THEN
              FedExXMLControl."Alternate Ship-To Country" :=
                GetFedExCountryCode(
                  CompanyInfo."Ship-to Country/Region Code")
            ELSE
              FedExXMLControl."Alternate Ship-To Country" := 'US';
            FedExXMLControl."Alternate Ship-To Residential" := FALSE;
        END;

        IF (CarrierPackingStation."FedEx Label Media Type" =
          CarrierPackingStation."FedEx Label Media Type"::"4X6 with Trailing Doc Tab") OR
            (CarrierPackingStation."FedEx Label Media Type" =
              CarrierPackingStation."FedEx Label Media Type"::"4X6 with Leading Doc Tab")

          THEN
            FedExXMLControl."Enable Doc Tab" := TRUE;

        FedExXMLControlExt."DocTab Field 1 Header" := 'Invoice';
        FedExXMLControlExt."DocTab Field 1 Literal Value" := "Source ID";
        FedExXMLControlExt."DocTab Field 1 DataField" := '';
        FedExXMLControlExt."DocTab Field 2 Header" := 'Customer';
        FedExXMLControlExt."DocTab Field 2 Literal Value" := "Ship-to No.";
        FedExXMLControlExt."DocTab Field 2 DataField" := '';
        FedExXMLControlExt."DocTab Field 3 Header" := 'Tracking';
        FedExXMLControlExt."DocTab Field 3 Literal Value" := '';
        FedExXMLControlExt."DocTab Field 3 DataField" := 'REPLY/SHIPMENT/MasterTrackingId/TrackingNumber';
        FedExXMLControlExt."DocTab Field 4 Header" := 'Date';
        FedExXMLControlExt."DocTab Field 4 Literal Value" :=
          XMLManagement.FormatDateYYYYMMDD(
            "Packing Date");
        FedExXMLControlExt."DocTab Field 4 DataField" := '';
        FedExXMLControlExt."DocTab Field 5 Header" := 'Weight';
        FedExXMLControlExt."DocTab Field 5 Literal Value" :=
          XMLManagement.Decimal2Text(
            "Calculation Weight",0);
        FedExXMLControlExt."DocTab Field 5 DataField" := '';
        FedExXMLControlExt."DocTab Field 6 Header" := 'COD';
        FedExXMLControlExt."DocTab Field 6 Literal Value" := XMLManagement.Boolean2YN(COD);
        FedExXMLControlExt."DocTab Field 6 DataField" := '';
        FedExXMLControlExt."DocTab Field 7 Header" := 'DV';
        FedExXMLControlExt."DocTab Field 7 Literal Value" :=
          XMLManagement.Decimal2Text(
            "Calculation Value",2);
        FedExXMLControlExt."DocTab Field 7 DataField" := '';
        FedExXMLControlExt."DocTab Field 8 Header" := 'Shipping Cost';
        FedExXMLControlExt."DocTab Field 8 Literal Value" := '';
        FedExXMLControlExt."DocTab Field 8 DataField" :=
          'REPLY/SHIPMENT/RATES/PAYOR_ACCOUNT_PACKAGE/TotalNetCharge/Amount';

        FedExXMLControlExt."DocTab Field 9 Header" := 'Tracking No.';
        FedExXMLControlExt."DocTab Field 9 Literal Value" := '';
        FedExXMLControlExt."DocTab Field 9 DataField" :=
          'TRANSACTION/CustomerTransactionId';

        FedExXMLControl."Label Customer Reference" := COPYSTR(Description,1,30);
        FedExXMLControl."Label PO Reference" := "External Document No.";
        FedExXMLControl."Label Dept. Reference" := '';
        FedExXMLControl."Label Inv. Reference" := "Source ID";

        CASE ShippingAgentAccount."Rate Option" OF
          ShippingAgentAccount."Rate Option"::List:
            BEGIN
              FedExXMLControl."Rate Request Type" := 'LIST';
              FedExXMLControlExt."DocTab Field 8 DataField" :=
                'REPLY/SHIPMENT/RATES/PAYOR_LIST_PACKAGE/TotalNetCharge/Amount';
            END;
          ShippingAgentAccount."Rate Option"::Discount:
            FedExXMLControl."Rate Request Type" := 'PREFERRED';
          ShippingAgentAccount."Rate Option"::Default:
            BEGIN
              FedExXMLControl."Rate Request Type" := 'LIST';
              FedExXMLControlExt."DocTab Field 8 DataField" :=
                'REPLY/SHIPMENT/RATES/PAYOR_LIST_PACKAGE/TotalNetCharge/Amount';
            END;
        END;
        IF FedExOptionPageExt."Rate Request Type" <> '' THEN
          FedExXMLControl."Rate Request Type" := FedExOptionPageExt."Rate Request Type";

        IF "Total Packages" > 1 THEN BEGIN
          GetFirstPackageTransaction(CurrentPackage,MasterTrackingNumber,MasterFormID);
          FedExXMLControl."Master Tracking No." := MasterTrackingNumber;
          FedExXMLControl."Master Tracking  Form ID" := MasterFormID;
        END;

        IF COD THEN
          IF "Total Packages" = "Package No." THEN BEGIN
            IF FedExOptionPage.GET(FedExOptionPage.Type::Package,"First Package No.",0,0) THEN BEGIN
              FedExXMLControl."COD Return Tracking No." := FedExOptionPage."COD Return Tracking No.";
              FedExXMLControl."COD Return Form ID" := FedExOptionPage."COD Return Form ID";
            END ELSE
              IF FedExPostedOptionPage.GET("First Package No.") THEN BEGIN
                FedExXMLControl."COD Return Tracking No." :=
                  FedExPostedOptionPage."COD Return Tracking No.";
                FedExXMLControl."COD Return Form ID" := FedExPostedOptionPage."COD Return Form ID";
              END;
          END;

        FedExXMLControl."Total Packages" := "Total Packages";
        FedExXMLControl."Package Detail" := 'INDIVIDUAL_PACKAGES';
        FedExXMLControl."Package Sequence No." := "Package No.";
        FedExXMLControl."Calculation Length" := "Calculation Length";
        FedExXMLControl."Calculation Width" := "Calculation Width";
        FedExXMLControl."Calculation Height" := "Calculation Height";
        IF ShippingSetup."Default Size Units" = ShippingSetup."Default Size Units"::"IN"
        THEN
          FedExXMLControl."Package Size Units" := 'IN'
        ELSE
          FedExXMLControl."Package Size Units" := 'CM';

        IF FedExXMLControl."FedEx Freight" THEN
          IF FedExOptionPageExt.Palletized THEN BEGIN
            FedExFreightXMLControl."FX Freight Shipment Dim Length" :=
              FedExOptionPageExt."FX Freight Pallet Length";
            FedExFreightXMLControl."FX Freight Shipment Dim Width" :=
              FedExOptionPageExt."FX Freight Pallet Width";
            FedExFreightXMLControl."FX Freight Shipment Dim Height" :=
              FedExOptionPageExt."FX Freight Pallet Height";
            IF ShippingSetup."Default Size Units" = ShippingSetup."Default Size Units"::"IN"
              THEN
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'IN'
              ELSE
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'CM';
          END ELSE BEGIN
            FedExFreightXMLControl."FX Freight Shipment Dim Length" :=
              ROUND(CurrentPackage."Calculation Length",1);
            FedExFreightXMLControl."FX Freight Shipment Dim Width" :=
              ROUND(CurrentPackage."Calculation Width",1);
            FedExFreightXMLControl."FX Freight Shipment Dim Height" :=
              ROUND(CurrentPackage."Calculation Height",1);
            IF ShippingSetup."Default Size Units" = ShippingSetup."Default Size Units"::"IN"
              THEN
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'IN'
              ELSE
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'CM';
          END;

        FedExXMLControl."Package Description" := Description;
        FedExXMLControl."Create Certificate of Origin":=
          FedExOptionPageExt."Create Certificate of Origin";
        FedExXMLControl."Create Gen. Agency Agreement":=
          FedExOptionPageExt."Create Gen. Agency Agreement";
        FedExXMLControl."Create NAFTA Cert. of Origin":=
          FedExOptionPageExt."Create NAFTA Cert. of Origin";
        FedExXMLControl."Create Pro Forma Invoice":= FedExOptionPageExt."Create Pro Forma Invoice";
        FedExXMLControl."Create Commercial Invoice":= FedExOptionPageExt."Create Commercial Invoice";

        IF "Third Party Ship. Account No." <> '' THEN BEGIN
          CLEAR(ShippingAccount);
          ShippingAccount.SETCURRENTKEY("Ship-to Type","Ship-to No.","Ship-to Code",
            "Shipping Agent Code","Account No.");
          ShippingAccount.SETRANGE("Ship-to Type",ShippingAccount."Ship-to Type"::Customer);
          ShippingAccount.SETRANGE(ShippingAccount."Ship-to No.",CurrentPackage."Ship-to No.");
          ShippingAccount.SETRANGE(ShippingAccount."Shipping Agent Code",
            CurrentPackage."Shipping Agent Code");
          ShippingAccount.SETRANGE("Account No.","Third Party Ship. Account No.");
          IF ShippingAccount.FIND('-') THEN
            FedExXMLControl."Third Party Country Code" :=
              XMLManagement.GetFedExCountryCode(ShippingAccount."Third Party Country Code");
        END;

        FedExXMLControl3."Customer Reference Type 1" :=
          STRSUBSTNO('%1',FedExOptionPageExt."Customer Reference Type 1");
        FedExXMLControl3."Customer Reference Value 1" := FedExOptionPageExt."Customer Reference Value 1";
        FedExXMLControl3."Customer Reference Type 2" :=
          STRSUBSTNO('%1',FedExOptionPageExt."Customer Reference Type 2");
        FedExXMLControl3."Customer Reference Value 2" := FedExOptionPageExt."Customer Reference Value 2";
        FedExXMLControl3."Customer Reference Type 3" :=
          STRSUBSTNO('%1',FedExOptionPageExt."Customer Reference Type 3");
        FedExXMLControl3."Customer Reference Value 3" := FedExOptionPageExt."Customer Reference Value 3";
        FedExXMLControl3."Customer Reference Type 4" :=
          STRSUBSTNO('%1',FedExOptionPageExt."Customer Reference Type 4");
        FedExXMLControl3."Customer Reference Value 4" := FedExOptionPageExt."Customer Reference Value 4";

        CASE FedExOptionPageExt."Physical Packaging Type" OF
          FedExOptionPageExt."Physical Packaging Type"::" ":
            FedExXMLControlExt."Physical Packaging Type" := '';
          FedExOptionPageExt."Physical Packaging Type"::BAG:
            FedExXMLControlExt."Physical Packaging Type" := 'BAG';
          FedExOptionPageExt."Physical Packaging Type"::BARREL:
            FedExXMLControlExt."Physical Packaging Type" := 'BARREL';
          FedExOptionPageExt."Physical Packaging Type"::BASKET:
            FedExXMLControlExt."Physical Packaging Type" := 'BASKET';
          FedExOptionPageExt."Physical Packaging Type"::BOX:
            FedExXMLControlExt."Physical Packaging Type" := 'BOX';
          FedExOptionPageExt."Physical Packaging Type"::BUCKET:
            FedExXMLControlExt."Physical Packaging Type" := 'BUCKET';
          FedExOptionPageExt."Physical Packaging Type"::BUNDLE:
            FedExXMLControlExt."Physical Packaging Type" := 'BUNDLE';
          FedExOptionPageExt."Physical Packaging Type"::CARTON:
            FedExXMLControlExt."Physical Packaging Type" := 'CARTON';
          FedExOptionPageExt."Physical Packaging Type"::"CASE":
            FedExXMLControlExt."Physical Packaging Type" := 'CASE';
          FedExOptionPageExt."Physical Packaging Type"::CONTAINER:
            FedExXMLControlExt."Physical Packaging Type" := 'CONTAINER';
          FedExOptionPageExt."Physical Packaging Type"::CRATE:
            FedExXMLControlExt."Physical Packaging Type" := 'CRATE';
          FedExOptionPageExt."Physical Packaging Type"::CYLINDER:
            FedExXMLControlExt."Physical Packaging Type" := 'CYLINDER';
          FedExOptionPageExt."Physical Packaging Type"::DRUM:
            FedExXMLControlExt."Physical Packaging Type" := 'DRUM';
          FedExOptionPageExt."Physical Packaging Type"::ENVELOPE:
            FedExXMLControlExt."Physical Packaging Type" := 'ENVELOPE';
          FedExOptionPageExt."Physical Packaging Type"::HAMPER:
            FedExXMLControlExt."Physical Packaging Type" := 'HAMPER';
          FedExOptionPageExt."Physical Packaging Type"::OTHER:
            FedExXMLControlExt."Physical Packaging Type" := 'OTHER';
          FedExOptionPageExt."Physical Packaging Type"::PAIL:
            FedExXMLControlExt."Physical Packaging Type" := 'PAIL';
          FedExOptionPageExt."Physical Packaging Type"::PALLET:
            FedExXMLControlExt."Physical Packaging Type" := 'PALLET';
          FedExOptionPageExt."Physical Packaging Type"::PIECE:
            FedExXMLControlExt."Physical Packaging Type" := 'PIECE';
          FedExOptionPageExt."Physical Packaging Type"::REEL:
            FedExXMLControlExt."Physical Packaging Type" := 'REEL';
          FedExOptionPageExt."Physical Packaging Type"::ROLL:
            FedExXMLControlExt."Physical Packaging Type" := 'ROLL';
          FedExOptionPageExt."Physical Packaging Type"::SKID:
            FedExXMLControlExt."Physical Packaging Type" := 'SKID';
          FedExOptionPageExt."Physical Packaging Type"::TANK:
            FedExXMLControlExt."Physical Packaging Type" := 'TANK';
          FedExOptionPageExt."Physical Packaging Type"::TUBE:
            FedExXMLControlExt."Physical Packaging Type" := 'TUBE';
        END;

        FedExXMLControl3."Do Not Stack Pallets" := FedExOptionPageExt."Do Not Stack Pallets";
        FedExXMLControl3."Do Not Break Down Pallets" := FedExOptionPageExt."Do Not Break Down Pallets";
        FedExXMLControlExt."Export B13A Filing Option" := ExportDoc."ITN No.";
        FedExXMLControlExt."Export Compliance Statement" := ExportDoc."ITN No.";
        FedExXMLControlExt.NAFTA := FedExOptionPage.NAFTA;
        FedExXMLControlExt."NAFTA Preference Criterion" :=
          FedExOptionPageExt."NAFTA Preference Criterion";
        FedExXMLControlExt."NAFTA Producer Determination" :=
          FedExOptionPageExt."NAFTA Producer Determination";
        FedExXMLControlExt."NAFTA Producer ID" := FedExOptionPageExt."NAFTA Producer ID";
        FedExXMLControlExt."NAFTA Net Cost Method" := FedExOptionPageExt."NAFTA Net Cost Method";
        FedExXMLControlExt."NAFTA Cost Beg. Date" := FedExOptionPage."NAFTA Cost Beg. Date";
        FedExXMLControlExt."NAFTA Cost End Date" := FedExOptionPage."NAFTA Cost End Date";
        FedExXMLControlExt."Requested Ship Date" := FedExOptionPage."Requested Ship Date";
        FedExXMLControlExt."Requested Ship Time" := FedExOptionPage."Requested Ship Time";

        FedExFreightXMLControl."Freight Label Stock Type" := 'PAPER_LETTER';
        FedExFreightXMLControl."Freight Label Format Type" :=
          STRSUBSTNO('%1',CarrierPackingStation."FedEx Freight BOL Type");
        FedExFreightXMLControl."Freight Label Image Type" := 'PDF';
        FedExFreightXMLControl."Freight Label Printing Orient." := 'BOTTOM_EDGE_OF_TEXT_FIRST';
        FedExFreightXMLControl."FX Freight Account No." := "Shipping Agent Account No.";
        FedExFreightXMLControl."FX Freight Contact Name" := PackingStation."Ship-from Contact";
        FedExFreightXMLControl."FX Freight Contact Company" :=
          PackingStation."Ship-from Company";
        FedExFreightXMLControl."FX Freight Contact Pager No." :=
          XMLManagement.FixPhoneNo(PackingStation."Ship-from Phone No.");
        FedExFreightXMLControl."FX Freight Address" := PackingStation."Ship-from Address";
        FedExFreightXMLControl."FX Freight City" := PackingStation."Ship-from City";
        FedExFreightXMLControl."FX Freight State" := PackingStation."Ship-from State";
        FedExFreightXMLControl."FX Freight Postal Code" := PackingStation."Ship-from ZIP Code";
        FedExFreightXMLControl."FX Freight Country Code" :=
          PackingStation."Ship-from Country Code";
        FedExFreightXMLControl."Rated Package No." := CurrentPackage."No.";
        CASE FedExOptionPageExt."Shipment Role" OF
          FedExOptionPageExt."Shipment Role"::Shipper:
        FedExFreightXMLControl."FX Freight Role" := 'SHIPPER';
          FedExOptionPageExt."Shipment Role"::Consignee:
             FedExFreightXMLControl."FX Freight Role" := 'CONSIGNEE';
        END;

        CASE "Shipping Payment Type" OF
          "Shipping Payment Type"::Prepaid:
            FedExFreightXMLControl."FX Freight Payment Type" := 'PREPAID';
          "Shipping Payment Type"::"Third Party":
            BEGIN
              FedExFreightXMLControl."FX Freight Payment Type" := 'THIRD_PARTY';
              FedExFreightXMLControl."Third Party Contact Name" := ShippingAccount."Third Party Contact";
              FedExFreightXMLControl."Third Party Contact Company" := ShippingAccount."Third Party Name";
              FedExFreightXMLControl."Third Party Contact Phone" := ShippingAccount."Third Party Phone No.";
              FedExFreightXMLControl."Third Party Address" := ShippingAccount."Third Party Address";
              FedExFreightXMLControl."Third Party Address 2" := ShippingAccount."Third Party Address 2";
              FedExFreightXMLControl."Third Party City" := ShippingAccount."Third Party City";
              FedExFreightXMLControl."Third Party State" := ShippingAccount."Third Party State";
              FedExFreightXMLControl."Third Party Postal Code" := ShippingAccount."Third Party ZIP Code";
              FedExFreightXMLControl."Third Party Country Code" := ShippingAccount."Third Party Country Code";
              IF FedExFreightXMLControl."Third Party Country Code" = '' THEN
                FedExFreightXMLControl."Third Party Country Code" := 'US';
            END;
          "Shipping Payment Type"::"Freight Collect":
            FedExFreightXMLControl."FX Freight Payment Type" := 'COLLECT';
          "Shipping Payment Type"::Consignee:
            FedExFreightXMLControl."FX Freight Payment Type" := 'COLLECT';
        END;
        FedExFreightXMLControl."FX Freight Value Currency" := FedExXMLControl."Package Currency Code";
        FedExFreightXMLControl."FX Freight Value Amount" := "Value (Cost)";
        CurrentPackage.CALCFIELDS("Total Line Quantity");
        FedExFreightXMLControl."FX Freight Value Units" := ROUND(CurrentPackage."Total Line Quantity",1,'>');
        CASE FedExOptionPageExt."Liability Coverage Type" OF
          FedExOptionPageExt."Liability Coverage Type"::" ":
        FedExFreightXMLControl."FX Freight Liability Cov. Type" := 'NEW';
          FedExOptionPageExt."Liability Coverage Type"::New:
            FedExFreightXMLControl."FX Freight Liability Cov. Type" := 'NEW';
          FedExOptionPageExt."Liability Coverage Type"::"Used or Reconditioned":
            FedExFreightXMLControl."FX Freight Liability Cov. Type" := 'USED_OR_RECONDITIONED'
        END;
        CASE FedExOptionPageExt."Collect Terms Type" OF
          FedExOptionPageExt."Collect Terms Type"::" ":
            FedExFreightXMLControl."Collect Terms Type" := '';
          FedExOptionPageExt."Collect Terms Type"::STANDARD:
            FedExFreightXMLControl."Collect Terms Type" := 'STANDARD';
          FedExOptionPageExt."Collect Terms Type"::NON_RECOURSE_SHIPPER_SIGNED:
            FedExFreightXMLControl."Collect Terms Type" := 'NON_RECOURSE_SHIPPER_SIGNED'
        END;
        IF FedExOptionPageExt."Liability Coverage Amount" <> 0 THEN
          FedExFreightXMLControl."FX Freight Coverage Amount" := FedExOptionPageExt."Liability Coverage Amount"
        ELSE
        FedExFreightXMLControl."FX Freight Coverage Amount" := "Calculation Insured Value";
        IF CurrentPackage."Override Insured Value" <> 0 THEN
          FedExFreightXMLControl."FX Freight Coverage Amount" := "Override Insured Value";

        IF FedExOptionPageExt."Liability Coverage Currency" <> '' THEN
          FedExFreightXMLControl."FX Freight Coverage Amt. Curr." := FedExOptionPageExt."Liability Coverage Currency"
        ELSE
          FedExFreightXMLControl."FX Freight Coverage Amt. Curr." := FedExXMLControl."Package Currency Code";

        IF FedExOptionPageExt."FX Freight Pallet Weight Units" =
          FedExOptionPageExt."FX Freight Pallet Weight Units"::LBS THEN
            FedExFreightXMLControl."FX Freight Pallet Weight Units" := 'LB'
          ELSE
            FedExFreightXMLControl."FX Freight Pallet Weight Units" := 'KG';
        IF FedExOptionPageExt."FX Freight Pallet Weight Value" <> 0 THEN
          FedExFreightXMLControl."FX Freight Pallet Weight Value" :=
            FedExOptionPageExt."FX Freight Pallet Weight Value"
        ELSE
          FedExFreightXMLControl."FX Freight Pallet Weight Value" :=
            ShippingSetup."Default Pallet Weight";
        FedExFreightXMLControl."No. of Pallets" := FedExOptionPageExt."No. of Pallets";
        IF FedExOptionPageExt."No. of Pallets" > 0 THEN
          FedExFreightXMLControl."FX Freight Total Handling Unit" := FedExOptionPageExt."No. of Pallets"
        ELSE
          FedExFreightXMLControl."FX Freight Total Handling Unit" := "Total Packages";
        IF "Total Handling Units" <> 0 THEN
          FedExFreightXMLControl."FX Freight Total Handling Unit" := "Total Handling Units";

        FedExFreightXMLControl."No. of FedEx Freight Labels" :=
          ShippingAgentService."No. of Freight Labels / Pallet" * FedExOptionPageExt."No. of Pallets";
        FedExFreightXMLControl."No. of FedEx Freight BOLs" := ShippingAgentService."No. of BOL Copies / Shipment";
        IF FedExOptionPageExt.Palletized THEN BEGIN
          FedExFreightXMLControl."FXF Palletized" := TRUE;
          FedExFreightXMLControl."FX Freight Pallet Weight Value" :=
            FedExFreightXMLControl."FX Freight Pallet Weight Value" *
              FedExFreightXMLControl."FX Freight Total Handling Unit";
          FedExFreightXMLControl."FX Freight Shipment Dim Length" := FedExOptionPageExt."FX Freight Pallet Length";
          FedExFreightXMLControl."FX Freight Shipment Dim Width" := FedExOptionPageExt."FX Freight Pallet Width";
          FedExFreightXMLControl."FX Freight Shipment Dim Height" := FedExOptionPageExt."FX Freight Pallet Height";
        END;
        FedExFreightXMLControl."FedEx Freight BOL Line Type" :=
          CarrierPackingStation."FedEx Freight BOL Line Type";
        FedExFreightXMLControl."FX Freight Comment" := FedExOptionPageExt."FX Freight Comment";
        FedExFreightXMLControl."Special Delivery Instructions" := FedExOptionPageExt."Special Delivery Instructions";
        FedExFreightXMLControl."FXF Billing Contact Company" :=
          FedExGlobalRegistration."Billing Company Name";
        FedExFreightXMLControl."FXF Billing Contact Name" := STRSUBSTNO('%1 %2',
          FedExGlobalRegistration."Billing Contact First Name",
            FedExGlobalRegistration."Billing Contact Last Name");
        FedExFreightXMLControl."FXF Billing Contact Pager No." := '';
        FedExFreightXMLControl."FXF Billing Address" := FedExGlobalRegistration."Billing Address 1";
        FedExFreightXMLControl."FXF Billing City" := FedExGlobalRegistration."Billing City";
        FedExFreightXMLControl."FXF Billing State" := FedExGlobalRegistration."Billing State";
        FedExFreightXMLControl."FXF Billing Postal Code" :=
          FedExGlobalRegistration."Billing ZIP Code";
        FedExFreightXMLControl."FXF Billing Country Code" :=
          FedExGlobalRegistration."Billing Country Code";
        IF "Source Type" = 14000822 THEN
          FedExFreightXMLControl."Bill of Lading No." := "Source ID";
        FedExXMLControlExt."Shipping Document Type" :=
          FedExOptionPageExt."Shipping Document Type";
        FedExXMLControlExt."Shipping Document Image Type" :=
          FedExOptionPageExt."Shipping Document Image Type";
        FedExXMLControlExt."Shipping Document Stock Type" :=
          FedExOptionPageExt."Shipping Document Stock Type";
        FedExXMLControl."Electronic Trade Documents" :=
          FedExOptionPageExt."Electronic Trade Documents";

        IF "World Wide Service" THEN BEGIN
          CASE FedExOptionPage."Broker TIN Type" OF
            FedExOptionPage."Broker TIN Type"::SSN:
                FedExXMLControlExt."Broker TIN Type" := 'PERSONAL_NATIONAL';
            FedExOptionPage."Broker TIN Type"::EIN:
              FedExXMLControlExt."Broker TIN Type" := 'BUSINESS_NATIONAL';
          END;
          FedExXMLControlExt."Broker SSN/EIN" := FedExOptionPage."Broker SSN/EIN";
          FedExXMLControlExt."Broker Account No." := FedExOptionPage."Broker FDX Account No.";
          FedExXMLControlExt."Broker Company Name" := FedExOptionPage."Broker Company Name";
          FedExXMLControlExt."Broker Contact Id" := FedExOptionPage."Broker Contact Id";
          FedExXMLControlExt."Broker Type" := FedExOptionPage."Broker Type";
          FedExXMLControlExt."Broker Name" := FedExOptionPage."Broker Name";
          FedExXMLControlExt."Broker Phone No." := FedExOptionPage."Broker Phone No.";
          FedExXMLControlExt."Broker Email Address" := FedExOptionPage."Broker Email Address";
          FedExXMLControlExt."Broker Address 1" := FedExOptionPage."Broker Address 1";
          FedExXMLControlExt."Broker City" := FedExOptionPage."Broker City";
          FedExXMLControlExt."Broker State" := FedExOptionPage."Broker State";
          FedExXMLControlExt."Broker Postal Code" := FedExOptionPage."Broker Postal Code";
          FedExXMLControlExt."Broker Country Code" := FedExOptionPage."Broker Country Code";

          CASE FedExOptionPage."Clearance Brokerage Type" OF
            FedExOptionPage."Clearance Brokerage Type"::"Broker Inclusive":
              FedExXMLControlExt."Clearance Brokerage Type" := 'BROKER_INCLUSIVE';
            FedExOptionPage."Clearance Brokerage Type"::"Broker Inclusive Non Resident Importer":
              FedExXMLControlExt."Clearance Brokerage Type" := 'BROKER_INCLUSIVE_NON_RESIDENT_IMPORTER';
            FedExOptionPage."Clearance Brokerage Type"::"Broker Select":
              FedExXMLControlExt."Clearance Brokerage Type" := 'BROKER_SELECT';
            FedExOptionPage."Clearance Brokerage Type"::"Broker Select Non Resident Importer":
              FedExXMLControlExt."Clearance Brokerage Type" := 'BROKER_SELECT_NON_RESIDENT_IMPORTER';
            FedExOptionPage."Clearance Brokerage Type"::"Broker Unassigned":
              FedExXMLControlExt."Clearance Brokerage Type" := 'BROKER_UNASSIGNED';
          END;
          CASE FedExOptionPage."Customs Option Type" OF
            FedExOptionPage."Customs Option Type"::" ":
              FedExXMLControlExt."Customs Option Type" := '';
            FedExOptionPage."Customs Option Type"::"Courtesy Return Label":
              FedExXMLControlExt."Customs Option Type" := 'COURTESY_RETURN_LABEL';
            FedExOptionPage."Customs Option Type"::"Exhibition Trade Show":
              FedExXMLControlExt."Customs Option Type" := 'EXHIBITION_TRADE_SHOW';
            FedExOptionPage."Customs Option Type"::"Faulty Item":
              FedExXMLControlExt."Customs Option Type" := 'FAULTY_ITEM';
            FedExOptionPage."Customs Option Type"::"Following Repair":
              FedExXMLControlExt."Customs Option Type" := 'FOLLOWING_REPAIR';
            FedExOptionPage."Customs Option Type"::"For Repair":
              FedExXMLControlExt."Customs Option Type" := 'FOR_REPAIR';
            FedExOptionPage."Customs Option Type"::"Item for Loan":
              FedExXMLControlExt."Customs Option Type" := 'ITEM_FOR_LOAN';
            FedExOptionPage."Customs Option Type"::Other:
              FedExXMLControlExt."Customs Option Type" := 'OTHER';
            FedExOptionPage."Customs Option Type"::Rejected:
              FedExXMLControlExt."Customs Option Type" := 'REJECTED';
            FedExOptionPage."Customs Option Type"::Replacement:
              FedExXMLControlExt."Customs Option Type" := 'REPLACEMENT';
            FedExOptionPage."Customs Option Type"::Trial:
              FedExXMLControlExt."Customs Option Type" := 'TRIAL';
          END;
          FedExXMLControlExt."Customs Option Description" := FedExOptionPage."Customs Option Description";
          FedExXMLControlExt."Non-dutiable Document" := FedExOptionPage."Non-dutiable Document";
          FedExXMLControlExt."Export Declared Value" := FedExOptionPage."Export Declared Value";

          IF FedExOptionPage."Duties Payer Account No." <> '' THEN BEGIN
            FedExXMLControlExt."Duties Payor Account No." := FedExOptionPage."Duties Payer Account No.";
            IF FedExOptionPage."Duties Payer Country Code" <> '' THEN
              FedExXMLControlExt."Duties Payor Country Code" :=
                GetFedExCountryCode(
                  FedExOptionPage."Duties Payer Country Code")
            ELSE
              FedExXMLControlExt."Duties Payor Country Code" := 'US';
          END ELSE BEGIN
            FedExXMLControlExt."Duties Payor Account No." :=
              CarrierPackingStation."FedEx Shipping Agent Acc. No.";
            IF PackingStation."Ship-from Country Code" <> '' THEN
              FedExXMLControlExt."Duties Payor Country Code" :=
                GetFedExCountryCode(
                  PackingStation."Ship-from Country Code")
            ELSE
              FedExXMLControlExt."Duties Payor Country Code" := 'US';
          END;

          CASE FedExOptionPage."Duties Payer Type" OF
            FedExOptionPage."Duties Payer Type"::" ":
              BEGIN
                FedExXMLControlExt."Duties Payor Type" := 'SENDER';
                FedExXMLControlExt."Duties Payor Account No." :=
                  CarrierPackingStation."FedEx Shipping Agent Acc. No.";
              END;
            FedExOptionPage."Duties Payer Type"::Shipper:
              BEGIN
                FedExXMLControlExt."Duties Payor Type" := 'SENDER';
                FedExXMLControlExt."Duties Payor Account No." :=
                  CarrierPackingStation."FedEx Shipping Agent Acc. No.";
              END;
            FedExOptionPage."Duties Payer Type"::Recipient:
              BEGIN
              FedExXMLControlExt."Duties Payor Type" := 'RECIPIENT';
                FedExXMLControlExt."Duties Payor Account No." := '';
              END;
            FedExOptionPage."Duties Payer Type"::"Third Party":
              BEGIN
              FedExXMLControlExt."Duties Payor Type" := 'THIRD_PARTY';
              IF FedExOptionPage."Duties Payer Account No." <> '' THEN
                  FedExXMLControlExt."Duties Payor Account No." :=
                    FedExOptionPage."Duties Payer Account No."
                ELSE
                  FedExXMLControlExt."Duties Payor Account No." := '';
              END;
          END;

          FedExXMLControl3."Duties Payor Contact Id" := FedExOptionPageExt."Duties Payor Contact Id";
          FedExXMLControl3."Duties Payor Name" := FedExOptionPageExt."Duties Payor Name";
          FedExXMLControl3."Duties Payor Address" := FedExOptionPageExt."Duties Payor Address";
          FedExXMLControl3."Duties Payor City" := FedExOptionPageExt."Duties Payor City";
          FedExXMLControl3."Duties Payor State" := FedExOptionPageExt."Duties Payor State";
          FedExXMLControl3."Duties Payor Postal" := FedExOptionPageExt."Duties Payor Postal";
          FedExXMLControl3."Duties Payor Residential" := FedExOptionPageExt."Duties Payor Residential";
          FedExXMLControl3."Duties Payor Phone" := FedExOptionPageExt."Duties Payor Phone";
          FedExXMLControl3."Duties Payor Email" := FedExOptionPageExt."Duties Payor Email";
          FedExXMLControl3."Duties Payor Tins No" := FedExOptionPageExt."Duties Payor Tins No";
          CASE FedExOptionPageExt."Duties Payor Tins Type" OF
            FedExOptionPageExt."Duties Payor Tins Type"::PERSONAL_NATIONAL:
              FedExXMLControl3."Duties Payor Tins Type" := 'PERSONAL_NATIONAL';
            FedExOptionPageExt."Duties Payor Tins Type"::BUSINESS_NATIONAL:
              FedExXMLControl3."Duties Payor Tins Type" := 'BUSINESS_NATIONAL';
          END;
          ExportDoc.CALCFIELDS("Total Value USD");
          IF ExportDoc."Total Value USD" > FedExXMLControlExt."Export Declared Value" THEN
          FedExXMLControlExt."Export Declared Value" := ExportDoc."Total Value USD";

          FedExXMLControlExt."Export Declared Value Currency" :=
            FedExXMLControl."Package Currency Code";

          FedExXMLControlExt."Include Commercial Invoice" :=
            FedExOptionPage."Include Commercial Invoice";
          IF FedExOptionPageExt."Create Commercial Invoice" THEN
            FedExXMLControlExt."Include Commercial Invoice" := TRUE;
          FedExXMLControlExt."Customer Invoice No." := FedExOptionPage."Customer Invoice No.";
          FedExXMLControlExt."Commercial Invoice Comments" := FedExOptionPageExt."Commercial Invoice Comments";

          CASE FedExOptionPage."International Terms of Sale" OF
            FedExOptionPage."International Terms of Sale"::"Freight On Board":
              FedExXMLControlExt."International Terms of Sale" := 'FOB_OR_FCA';
            FedExOptionPage."International Terms of Sale"::"Cost-Insurance-Freight":
              FedExXMLControlExt."International Terms of Sale" := 'CIF_OR_CIP';
            FedExOptionPage."International Terms of Sale"::"Cost and Freight":
              FedExXMLControlExt."International Terms of Sale" := 'CFR_OR_CPT';
            FedExOptionPage."International Terms of Sale"::"Free Carrier":
              FedExXMLControlExt."International Terms of Sale" := 'FOB_OR_FCA';
            FedExOptionPage."International Terms of Sale"::"Carriage Insurance Paid":
              FedExXMLControlExt."International Terms of Sale" := 'CIF_OR_CIP';
            FedExOptionPage."International Terms of Sale"::"Carrier Paid To":
              FedExXMLControlExt."International Terms of Sale" := 'CFR_OR_CPT';
            FedExOptionPage."International Terms of Sale"::"Ex Works":
              FedExXMLControlExt."International Terms of Sale" := 'EXW';
            FedExOptionPage."International Terms of Sale"::"Delivered Duty Unpaid":
              FedExXMLControlExt."International Terms of Sale" := 'DDU';
            FedExOptionPage."International Terms of Sale"::"Delivered Duty Paid":
              FedExXMLControlExt."International Terms of Sale" := 'DDP';
            FedExOptionPage."International Terms of Sale"::"Delivered At Place":
              FedExXMLControlExt."International Terms of Sale" := 'DAP';
          END;

          IF "Override Shipping Charge" <> 0 THEN
            FedExXMLControlExt."CI Freight Charge" := "Override Shipping Charge"
          ELSE
          FedExXMLControlExt."CI Freight Charge" := FedExOptionPageExt."CI Freight Charge";
          FedExXMLControlExt."CI Freight Charge Currency" := FedExXMLControl."Package Currency Code";
          FedExXMLControlExt."CI Insurance Charge" := FedExOptionPageExt."CI Insurance Charge";
          FedExXMLControlExt."CI Insurance Charge Currency" := FedExXMLControl."Package Currency Code";
          FedExXMLControlExt."CI Misc Charge" := FedExOptionPageExt."CI Misc Charge";
          FedExXMLControlExt."CI Misc Charge Currency" := FedExXMLControl."Package Currency Code";
          FedExXMLControlExt."CI Purpose of Shipment":= FedExOptionPage."Purpose of Shipment";

          FedExXMLControlExt."AES ITN No." := "AES ITN No.";
          FedExXMLControlExt."Export License Required" := FedExOptionPage."EEI Required";
          FedExXMLControlExt."Export License No." := ExportDoc."License No.";
          FedExXMLControlExt."Export License Exp. Date" := ExportDoc."License Exp. Date";
        END;
      END;
    END;

    PROCEDURE TransferRateHdrToXMLControl@1240030000(VAR RateShopHeader@1240030004 : Record 14000741;CurrentShippingAgentService@1240030007 : Record 14000708;FedExGlobalRegistration@1240030005 : Record 14000786;VAR FedExXMLControl@1240030022 : Record 14000791;VAR FedExXMLControlExt@1240030021 : Record 14000792;VAR FedExXMLControl3@1240020002 : Record 14000796;VAR FedExFreightXMLControl@1240020001 : Record 14000795;GiveError@1240030001 : Boolean);
    VAR
      Customer@1240030008 : Record 18;
      FedExOptionPage@1240030003 : Record 14000781;
      FedExOptionPageExt@1240020000 : Record 14000793;
      CompanyInfo@1240020003 : Record 79;
    BEGIN
      WITH RateShopHeader DO BEGIN
        IF ShippingAgent."Disable Rate Calculation" THEN
          EXIT;
        GetShippingSetup;
        GetPackingStation;
        GetGlobalShipperInfo;
        CarrierPackingStation.TESTFIELD("FedEx Shipping Agent Acc. No.");
        ShippingAgentAccount.GET(CarrierPackingStation."FedEx Shipping Agent Acc. No.");

        IF NOT FedExOptionPage.GET(FedExOptionPage.Type::"Rate Shop",RateShopHeader."No.",0,0) THEN
          IF NOT FedExOptionPage.GET(FedExOptionPage.Type::Package,RateShopHeader."Package No.",0,0) THEN
            IF NOT FedExOptionPage.GET(
                     FedExOptionPage.Type::Document,RateShopHeader."Source ID",
                     RateShopHeader."Source Type",RateShopHeader."Source Subtype")
            THEN
              IF NOT FedExOptionPage.GET(
                       FedExOptionPage.Type::"Bill of Lading",RateShopHeader."Bill of Lading No.",0,0)
              THEN BEGIN
                FedExOptionPage.RESET;
                FedExOptionPage.SETCURRENTKEY(
                  Type,"Shipping Agent Code","Shipping Agent Service","World Wide Service");
                FedExOptionPage.SETRANGE(Type,FedExOptionPage.Type::Setup);
                FedExOptionPage.SETRANGE(
                  "Shipping Agent Code",CurrentShippingAgentService."Shipping Agent Code");
                FedExOptionPage.SETRANGE("Shipping Agent Service",CurrentShippingAgentService.Code);
                FedExOptionPage.SETRANGE(
                  "World Wide Service",CurrentShippingAgentService."World Wide Service");
                IF NOT FedExOptionPage.FIND('-') THEN
                  FedExOptionPage.INIT;
              END;
        IF NOT FedExOptionPageExt.GET(FedExOptionPageExt.Type::"Rate Shop",RateShopHeader."No.",0,0) THEN
          IF NOT FedExOptionPageExt.GET(
            FedExOptionPageExt.Type::Package,RateShopHeader."Package No.",0,0) THEN
            IF NOT FedExOptionPageExt.GET(
                     FedExOptionPageExt.Type::Document,RateShopHeader."Source ID",
                     RateShopHeader."Source Type",RateShopHeader."Source Subtype")
            THEN
              IF NOT FedExOptionPageExt.GET(
                       FedExOptionPageExt.Type::"Bill of Lading",RateShopHeader."Bill of Lading No.",0,0)
              THEN BEGIN
                FedExOptionPageExt.RESET;
                FedExOptionPageExt.SETCURRENTKEY(
                  Type,"Shipping Agent Code","Shipping Agent Service","World Wide Service");
                FedExOptionPageExt.SETRANGE(Type,FedExOptionPageExt.Type::Setup);
                FedExOptionPageExt.SETRANGE(
                  "Shipping Agent Code",CurrentShippingAgentService."Shipping Agent Code");
                FedExOptionPageExt.SETRANGE("Shipping Agent Service",CurrentShippingAgentService.Code);
                FedExOptionPageExt.SETRANGE(
                  "World Wide Service",CurrentShippingAgentService."World Wide Service");
                IF NOT FedExOptionPageExt.FIND('-') THEN
          FedExOptionPageExt.INIT;
              END;

        PackingStation.TESTFIELD(PackingStation."Ship-from Contact");

        FedExXMLControl."World Wide Service" := CurrentShippingAgentService."World Wide Service";

        IF CurrentShippingAgentService."Transport Method Type" =
          CurrentShippingAgentService."Transport Method Type"::Freight THEN BEGIN
            IF "Currency Code" <> '' THEN
              FedExXMLControl."Package Currency Code" := "Currency Code"
        ELSE
              FedExXMLControl."Package Currency Code" := 'USD';
            IF "Intra Canadian Service" THEN
          FedExXMLControl."Package Currency Code" := 'CAD';
          END ELSE
          IF FedExXMLControl."Ship-to Country Code" IN ['US',''] THEN
            FedExXMLControl."Package Currency Code" := ''
          ELSE
        FedExXMLControl."Package Currency Code" := 'NONE';

        CASE FedExOptionPage."FedEx Packaging Type" OF
          FedExOptionPage."FedEx Packaging Type"::"Customer Packaging":
            FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Pak":
            FedExXMLControl."Packaging Type" := 'FEDEX_PAK';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_BOX';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Tube":
            FedExXMLControl."Packaging Type" := 'FEDEX_TUBE';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Envelope":
            FedExXMLControl."Packaging Type" := 'FEDEX_ENVELOPE';
          FedExOptionPage."FedEx Packaging Type"::"FedEx 10kg Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_10KG_BOX';
          FedExOptionPage."FedEx Packaging Type"::"FedEx 25kg Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_25KG_BOX';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Small Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_SMALL_BOX';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Medium Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_MEDIUM_BOX';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Large Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_LARGE_BOX';
          FedExOptionPage."FedEx Packaging Type"::"FedEx Extra Large Box":
            FedExXMLControl."Packaging Type" := 'FEDEX_EXTRA_LARGE_BOX';
        END;

        CASE FedExOptionPage."Drop Off Type" OF
          FedExOptionPage."Drop Off Type"::"Regular Pickup":
            FedExXMLControl."Drop Off Type" := 'REGULAR_PICKUP';
          FedExOptionPage."Drop Off Type"::"Request Courier":
            FedExXMLControl."Drop Off Type" := 'REQUEST_COURIER';
          FedExOptionPage."Drop Off Type"::"Drop Box":
            FedExXMLControl."Drop Off Type" := 'DROP_BOX';
          FedExOptionPage."Drop Off Type"::"Drop at BSC":
            FedExXMLControl."Drop Off Type" := 'BUSINESS_SERVICE_CENTER';
          FedExOptionPage."Drop Off Type"::"Drop at Station":
            FedExXMLControl."Drop Off Type" := 'STATION';
          ELSE
            FedExXMLControl."Drop Off Type" := 'REGULAR_PICKUP'
        END;

        CurrentShippingAgentService.TESTFIELD("Service Indicator");
        FedExXMLControl."Service Indicator" := CurrentShippingAgentService."Service Indicator";

        CASE FedExOptionPage."World Wide Service" OF
          FedExOptionPage."World Wide Service"::"1":
            CASE CurrentShippingAgentService."Service Indicator" OF
              '70':
                BEGIN
                FedExXMLControl."Express Freight Shipment" := TRUE;
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                END;
              '86':
                BEGIN
                FedExXMLControl."Express Freight Shipment" := TRUE;
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                END;
              '92':
                FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
            END;
          FedExOptionPage."World Wide Service"::"0":
            CASE CurrentShippingAgentService."Service Indicator" OF
              '70':
                BEGIN
                FedExXMLControl."Express Freight Shipment" := TRUE;
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                END;
              '80':
                BEGIN
                FedExXMLControl."Express Freight Shipment" := TRUE;
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                END;
              '83':
                BEGIN
                FedExXMLControl."Express Freight Shipment" := TRUE;
                  FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
                END;
              '90':
                FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
              '92':
                FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
            END;
        ELSE
          FedExXMLControl."Express Freight Shipment" := FALSE;
        END;

        CASE CurrentShippingAgentService."Service Indicator" OF
          'FEF1','FEF2':
          BEGIN
            FedExXMLControl."FedEx Freight" := TRUE;
            FedExXMLControl."Packaging Type" := 'YOUR_PACKAGING';
          END
        ELSE
          FedExXMLControl."FedEx Freight" := FALSE;
        END;


        FedExXMLControl."Packing Date" := WORKDATE;
        FedExXMLControl."Package Weight" := "Calculation Weight";
        IF ShippingSetup."Default Weight Units" = ShippingSetup."Default Weight Units"::LBS
        THEN
          FedExXMLControl."Package Weight Units" := 'LB'
        ELSE
          FedExXMLControl."Package Weight Units" := 'KG';

        IF "Calculation Length" = 0 THEN
          "Calculation Length" := GetLength;
        IF "Calculation Width" = 0 THEN
          "Calculation Width" := GetWidth;
        IF "Calculation Height" = 0 THEN
          "Calculation Height" := GetHeight;

        FedExXMLControl."Calculation Length" := "Calculation Length";
        FedExXMLControl."Calculation Width" := "Calculation Width";
        FedExXMLControl."Calculation Height" := "Calculation Height";
        IF FedExXMLControl."FedEx Freight" THEN
          IF FedExOptionPageExt.Palletized THEN BEGIN
            FedExFreightXMLControl."FX Freight Shipment Dim Length" :=
              FedExOptionPageExt."FX Freight Pallet Length";
            FedExFreightXMLControl."FX Freight Shipment Dim Width" :=
              FedExOptionPageExt."FX Freight Pallet Width";
            FedExFreightXMLControl."FX Freight Shipment Dim Height" :=
              FedExOptionPageExt."FX Freight Pallet Height";
            IF ShippingSetup."Default Size Units" = ShippingSetup."Default Size Units"::"IN"
              THEN
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'IN'
              ELSE
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'CM';
          END ELSE BEGIN
            FedExFreightXMLControl."FX Freight Shipment Dim Length" := ROUND("Calculation Length",1);
            FedExFreightXMLControl."FX Freight Shipment Dim Width" := ROUND("Calculation Width",1);
            FedExFreightXMLControl."FX Freight Shipment Dim Height" := ROUND("Calculation Height",1);
            IF ShippingSetup."Default Size Units" = ShippingSetup."Default Size Units"::"IN"
              THEN
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'IN'
              ELSE
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'CM';
          END;
        FedExXMLControl."Total Shipment Weight" := RateShopHeader."Net Weight";
        IF FedExOptionPage."Total Shipment Weight" <> 0 THEN
          FedExXMLControl."Total Shipment Weight" := FedExOptionPage."Total Shipment Weight";
        IF ShippingSetup."Default Weight Units" = ShippingSetup."Default Weight Units"::LBS
        THEN
          FedExXMLControl."Package Weight Units" := 'LB'
        ELSE
         FedExXMLControl."Package Weight Units" := 'KG';

        FedExXMLControl."Insured Value" := "Calculation Insured Value";
        FedExXMLControl."Insured Value Currency" := "Currency Code";
        IF FedExXMLControl."Insured Value Currency" = '' THEN
          FedExXMLControl."Insured Value Currency" := FedExXMLControl."Package Currency Code";
        FedExXMLControl."Total Shipment Insured Value" := FedExXMLControl."Insured Value";

        IF FedExOptionPageExt."Call Tag Request" THEN BEGIN
          FedExXMLControl."Shipper Contact Name" := FedExOptionPageExt."Call Tag Contact";
          FedExXMLControl."Shipper Company Name" := FedExOptionPageExt."Call Tag Company Name";
          FedExXMLControl."Shipper Phone No." := FedExOptionPageExt."Call Tag Phone No.";
          FedExXMLControl."Shipper Address 1" := FedExOptionPageExt."Call Tag Address";
          FedExXMLControl."Shipper Address 2" := FedExOptionPageExt."Call Tag Address 2";
          FedExXMLControl."Shipper City" := FedExOptionPageExt."Call Tag City";
          FedExXMLControl."Shipper State" := FedExOptionPageExt."Call Tag State";
          FedExXMLControl."Shipper Zip Code" := FedExOptionPageExt."Call Tag ZIP Code";
          IF FedExOptionPageExt."Call Tag Country Code" <> '' THEN
            FedExXMLControl."Shipper Country Code" :=
              GetFedExCountryCode(FedExOptionPageExt."Call Tag Country Code")
          ELSE
            FedExXMLControl."Shipper Country Code" := 'US';
          FedExXMLControl."Shipper Return Residential" := FedExOptionPageExt."Call Tag Residential";
        END ELSE BEGIN
          FedExXMLControl."Shipper Account No." :=
            CarrierPackingStation."FedEx Shipping Agent Acc. No.";
          IF FedExOptionPage."World Wide Service" THEN BEGIN
            IF FedExOptionPage."Exporter EIN/SSN Indicator" <>
               FedExOptionPage."Exporter EIN/SSN Indicator"::" " THEN BEGIN
              CASE FedExOptionPage."Exporter EIN/SSN Indicator" OF
                FedExOptionPage."Exporter EIN/SSN Indicator"::SSN:
                  FedExXMLControl."Shipper TIN EIN/SSN Indicator" := 'PERSONAL_NATIONAL';
                FedExOptionPage."Exporter EIN/SSN Indicator"::EIN:
                  FedExXMLControl."Shipper TIN EIN/SSN Indicator" := 'BUSINESS_NATIONAL';
              END;
              FedExXMLControl."Shipper TIN EIN/SSN No." := FedExOptionPage."Exporter SSN/EIN No.";
            END;
          END;

          IF COD THEN BEGIN
            CompanyInfo.GET;
            FedExXMLControl."Shipper Contact Name" := CompanyInfo."COD Department";
            FedExXMLControl."Shipper Company Name" := CompanyInfo.Name;
            FedExXMLControl."Shipper Phone No." := XMLManagement.FixPhoneNo(CompanyInfo."COD Phone No.");
            FedExXMLControl."Shipper Address 1" := CompanyInfo."COD Address 1";
            FedExXMLControl."Shipper Address 2" := CompanyInfo."COD Address 2";
            FedExXMLControl."Shipper City" := CompanyInfo."COD City";
            FedExXMLControl."Shipper State" := XMLManagement.FixState(CompanyInfo."COD State");
            FedExXMLControl."Shipper Zip Code" := XMLManagement.FixZIPCode(CompanyInfo."COD Zip Code");
            IF CompanyInfo."Ship-to Country/Region Code" <> '' THEN
              FedExXMLControl."Shipper Country Code" :=
                GetFedExCountryCode(CompanyInfo."Ship-to Country/Region Code")
            ELSE
              FedExXMLControl."Shipper Country Code" := 'US';
            FedExXMLControl."Shipper Return Residential" := FALSE;
          END ELSE BEGIN
          FedExXMLControl."Shipper Contact Name" := PackingStation."Ship-from Contact";
          FedExXMLControl."Shipper Company Name" := PackingStation."Ship-from Company";
          FedExXMLControl."Shipper Phone No." := PackingStation."Ship-from Phone No.";
          FedExXMLControl."Shipper Address 1" := PackingStation."Ship-from Address";
          FedExXMLControl."Shipper Address 2" := PackingStation."Ship-from Address2";
          FedExXMLControl."Shipper City" := PackingStation."Ship-from City";
          FedExXMLControl."Shipper State" := PackingStation."Ship-from State";
          FedExXMLControl."Shipper Zip Code" := PackingStation."Ship-from ZIP Code";
          IF PackingStation."Ship-from Country Code" <> '' THEN
            FedExXMLControl."Shipper Country Code" :=
              GetFedExCountryCode(
                PackingStation."Ship-from Country Code")
          ELSE
            FedExXMLControl."Shipper Country Code" := 'US';
          FedExXMLControl."Shipper Return Residential" := FALSE;
          END;
        END;

        FedExXMLControl."Ship-to No." := "Sell-to Customer No.";
        FedExXMLControl."Ship-to Code" := "Ship-to Code";
        FedExXMLControl."Ship-to Contact Name" := "Ship-to Contact";
        FedExXMLControl."Ship-to Company Name" := "Ship-to Name";
        FedExXMLControl."Ship-to Phone No." := PackingStation."Phone No. to use If Blank";
        FedExXMLControl."Ship-to Address 1" := "Ship-to Address";
        FedExXMLControl."Ship-to Address 2" := "Ship-to Address 2";
        FedExXMLControl."Ship-to City" := "Ship-to City";
        FedExXMLControl."Ship-to State" := "Ship-to State";
        FedExXMLControl."Ship-to Zip Code" := "Ship-to ZIP Code";
        IF "Ship-to Country Code" <> '' THEN
          FedExXMLControl."Ship-to Country Code" := GetFedExCountryCode("Ship-to Country Code")
        ELSE
          FedExXMLControl."Ship-to Country Code" := 'US';

        IF "Residential Delivery" THEN
          FedExXMLControl."Ship-to Residential" := TRUE
        ELSE BEGIN
          IF FedExXMLControl."Service Indicator" = '90' THEN
            FedExXMLControl."Ship-to Residential" := TRUE
          ELSE
            FedExXMLControl."Ship-to Residential" := FALSE;
        END;

        FedExXMLControl."Payment Type" := 'SENDER';
        FedExXMLControl."Payor Account No." := ShippingAgentAccount."Account No.";
        FedExXMLControl."Recipient Related" := FedExOptionPage."Recipient Related";
        FedExXMLControl."Include Broker Info." := FedExOptionPage."Include Broker Info.";

        IF (COD AND (CurrentShippingAgentService."Service Indicator" <> '92')) OR
           FedExOptionPage."Dry Ice" OR
           (FedExOptionPage."Dangerous Goods" AND FedExXMLControl."FedEx Freight") OR
           FedExOptionPage."Ship Notification" OR
           FedExOptionPageExt."Hold At Location" OR
           FedExOptionPage."Saturday Pickup" OR
           FedExOptionPage."Inside Pick Up" OR
           FedExOptionPage."Inside Delivery" OR
           FedExOptionPage."Liftgate Pickup" OR
           FedExOptionPage."Liftgate Delivery" OR
           FedExOptionPage."Return Shipment" OR
           FedExOptionPage."Include Broker Info." OR
           FedExOptionPageExt."Electronic Trade Documents" OR
           FedExOptionPage."Saturday Delivery" OR
           FedExOptionPageExt."Call Tag Request" OR
           FedExOptionPage."Intl Controlled Export Service" OR
           FedExOptionPage.ITAR OR
           FedExOptionPage."Call Before Delivery" OR
           FedExOptionPage."FedEx One Rate" OR
           FedExOptionPage."Extreme Length" OR
           FedExOptionPage."Call Before Delivery" OR
           FedExOptionPageExt."Do Not Stack Pallets" OR
           FedExOptionPageExt."Do Not Break Down Pallets" OR
           FedExOptionPage."Pharmacy Delivery" OR
           FedExOptionPage."Future Day Shipment"
        THEN
           FedExXMLControl."Shipment Special Services Flag" := TRUE;
        IF "Shipment Date" > TODAY THEN
           FedExXMLControl."Shipment Special Services Flag" := TRUE;

        IF (COD AND (CurrentShippingAgentService."Service Indicator" = '92')) OR
           FedExOptionPage."Dangerous Goods" OR
          FedExOptionPage."Signature Release" OR
           (FedExOptionPage."Delivery Signature Options" <>
             FedExOptionPage."Delivery Signature Options"::" ") OR
           FedExOptionPage."Priority Alert" OR
           FedExOptionPage.Alcohol OR
           FedExOptionPage."Additional Handling Required" OR
           FedExOptionPage."Dry Ice" OR
           FedExOptionPage."Non Standard Container" OR
           (FedExOptionPage."Home Delivery Premium Type" =
             FedExOptionPage."Home Delivery Premium Type"::"FedEx Appointment Home Delivery")
        THEN
           FedExXMLControl."Package Special Services Flag" := TRUE;

        IF FedExOptionPage."Home Delivery Premium Type" <> 0
        THEN
           FedExXMLControl."Shipment Special Services Flag" := TRUE;

        FedExXMLControl."Return Shipment" := FedExOptionPage."Return Shipment";
        FedExXMLControlExt."Ship and Return Label" := FedExOptionPage."Ship and Return Label";
        FedExXMLControlExt."Return Shipment Return No." :=
          FedExOptionPageExt."Return Shipment Return No.";
        FedExXMLControlExt."Return RMA Reason" := FedExOptionPage."Return RMA Reason";
        FedExXMLControlExt."Return RMA Reason 2" := FedExOptionPage."Return RMA Reason 2";

        FedExXMLControl.COD := COD;
        IF "COD Cashiers Check" THEN
          FedExXMLControl."COD Collection Type" := 'GUARANTEED_FUNDS'
        ELSE
          IF FedExOptionPage."COD Cash Only" THEN
            FedExXMLControl."COD Collection Type" := 'CASH'
          ELSE
            FedExXMLControl."COD Collection Type" := 'ANY';

        IF FedExXMLControl."FedEx Freight" THEN
          IF (FedExXMLControl."COD Collection Type" = 'CASH') OR
             (FedExXMLControl."COD Collection Type" = 'ANY') THEN
            FedExXMLControl."COD Collection Type" := 'PERSONAL_CHECK';
        FedExXMLControl."COD Amount" := "COD Amount";

        IF "COD Collection Currency" <> '' THEN
          FedExXMLControl."COD Currency" := "COD Collection Currency"
        ELSE
          FedExXMLControl."COD Currency" := FedExXMLControl."Package Currency Code";

        FedExXMLControl."COD Add Charges Rate Basis" := FedExOptionPage."COD Add Charges Rate Basis";
        FedExXMLControl."COD Add Charges Charge Basis" := FedExOptionPage."COD Add Charges Charge Basis";
        FedExXMLControl."COD Add Charges Charge Level" := FedExOptionPage."COD Add Charges Charge Level";
        FedExXMLControl."COD Add Transportation Charge" := FedExOptionPage."COD Add Transportation Charge";
        FedExXMLControl."COD Reference" := FedExOptionPage."COD Reference";
        FedExXMLControl."Delivery Day" := FedExOptionPage."Delivery Day";
        FedExXMLControl."Extreme Length" := FedExOptionPage."Extreme Length";
        FedExXMLControl."FedEx One Rate" := FedExOptionPage."FedEx One Rate";
        FedExXMLControl."Future Day Shipment" := FedExOptionPage."Future Day Shipment";
        FedExXMLControl.Alcohol := FedExOptionPage.Alcohol;
        FedExXMLControl."Alcohol Recipient Type" := FedExOptionPage."Alcohol Recipient Type";
        FedExXMLControl."Priority Alert" := FedExOptionPage."Priority Alert";
        FedExXMLControl."Priority Alert Detail" := FedExOptionPage."Priority Alert Detail";
        FedExXMLControl."Priority Alert Plus" := FedExOptionPage."Priority Alert Plus";

        FedExXMLControl."Ship Notification" := FedExOptionPage."Ship Notification";
        FedExXMLControl."Notification Memo" := FedExOptionPage."Ship Notification Memo";
        IF FedExOptionPage."Ship Notification" THEN
          FedExOptionPage.TESTFIELD(FedExOptionPage."Notification Format");
        CASE FedExOptionPage."Notification Format" OF
          FedExOptionPage."Notification Format"::HTML:
            FedExXMLControl."Notification Format" := 'HTML';
          FedExOptionPage."Notification Format"::Text:
            FedExXMLControl."Notification Format" := 'TEXT';
          FedExOptionPage."Notification Format"::Wireless:
            FedExXMLControl."Notification Format" := 'WIRELESS';
        END;
        FedExXMLControl."Notification Language Code" := 'EN';

        FedExXMLControl."Shipper Ship Notification" := FedExOptionPage."Shipper Ship Notification";
        FedExXMLControl."Shipper Exception Notification" :=
          FedExOptionPage."Shipper Exception Notification";
        FedExXMLControl."Shipper Delivery Notification" :=
          FedExOptionPage."Shipper Delivery Notification";
        FedExXMLControl."Shipper EMail Address" := PackingStation."Ship-from E-Mail";
        FedExXMLControl."Recipient Delivery Notif." := FedExOptionPage."Recipient Delivery Notif.";
        FedExXMLControl."Recipient Ship Notification" := FedExOptionPage."Recipient Ship Notification";
        FedExXMLControl."Recipient Exception Notif." := FedExOptionPage."Recipient Exception Notif.";
        FedExXMLControl."Optional Delivery Notification" :=
          FedExOptionPage."Optional Delivery Notification";
        FedExXMLControl."Optional Ship Notification" := FedExOptionPage."Optional Ship Notification";
        FedExXMLControl."Optional Exception Notif." := FedExOptionPage."Optional Exception Notif.";
        FedExXMLControl."Ship Notification Email" := FedExOptionPage."Ship Notification Email";
        FedExXMLControl."Ship Notification Email 2" := FedExOptionPage."Ship Notification Email 2";
        FedExXMLControl."Ship Notification Email 3" := FedExOptionPage."Ship Notification Email 3";
        FedExXMLControl."Broker Ship Notification" := FedExOptionPage."Broker Ship Notification";
        IF FedExXMLControl."Broker Ship Notification" THEN
          FedExXMLControlExt."Broker Email Address" := FedExOptionPage."Broker Email Address";
        FedExXMLControl."Broker Exception Notification" :=
          FedExOptionPage."Broker Exception Notification";
        FedExXMLControl."Broker Delivery Notification" :=
          FedExOptionPage."Broker Delivery Notification";

        FedExXMLControl."Hold at Location" := FedExOptionPageExt."Hold At Location";
        FedExXMLControl."HAL Recipient Phone Number" := FedExOptionPageExt."HAL Location Phone No.";
        FedExXMLControlExt."HAL Company" := FedExOptionPageExt."HAL Company";
        FedExXMLControlExt."HAL Contact Id" := FedExOptionPageExt."HAL Contact Id";
        FedExXMLControlExt."HAL Contact Title" := FedExOptionPageExt."HAL Contact Title";
        FedExXMLControl."HAL FedEx Location Address" := FedExOptionPageExt."HAL Location Address";
        FedExXMLControl."HAL FedEx Location City" := FedExOptionPageExt."HAL Location City";
        FedExXMLControl."HAL FedEx Location State" := FedExOptionPageExt."HAL Location State";
        FedExXMLControl."HAL FedEx Location Zip Code" := FedExOptionPageExt."HAL Location Zip";
        IF FedExOptionPageExt."HAL Location Country" <> '' THEN
          FedExXMLControl."HAL FedEx Location Country" :=
            GetFedExCountryCode(FedExOptionPageExt."HAL Location Country")
        ELSE
          FedExXMLControl."HAL FedEx Location Country" := 'US';
        FedExXMLControlExt."HAL Fedex Phone No." := FedExOptionPageExt."HAL Fedex Phone No.";
        FedExXMLControlExt."HAL Location Email Address" := FedExOptionPageExt."HAL Location Email Address";
        FedExXMLControlExt."HAL Location FAX No." := FedExOptionPageExt."HAL Location FAX No.";
        FedExXMLControlExt."HAL Location Pager No." := FedExOptionPageExt."HAL Location Pager No.";
        FedExXMLControlExt."HAL Location Phone Ext." := FedExOptionPageExt."HAL Location Phone Ext.";
        FedExXMLControlExt."HAL Location Urbanization Code" := FedExOptionPageExt."HAL Location Urbanization Code";
        FedExXMLControl."HAL Residential" := FALSE;
        FedExXMLControl."HAL Recipient Name" := FedExOptionPageExt."HAL Recipient Name";
        FedExXMLControl."HAL Fedex Location Type" := XMLManagement.Blank2Underscore(
          STRSUBSTNO('%1',FedExOptionPageExt."HAL FedEx Location Type"));

        FedExXMLControl."Insurance Charge" := FedExOptionPage."Insurance Charge";
        FedExXMLControl."Insurance Charge Currency" := FedExOptionPage."Insurance Charge Currency";
        FedExXMLControlExt."Importer Country" := FedExOptionPage."Importer Country";
        FedExXMLControlExt."Importer Name" := FedExOptionPage."Importer Name";
        FedExXMLControlExt."Importer Company" := FedExOptionPage."Importer Company";
        FedExXMLControlExt."Importer Address 1" := FedExOptionPage."Importer Address 1";
        FedExXMLControlExt."Importer Address 2" := FedExOptionPage."Importer Address 2";
        FedExXMLControlExt."Importer City" := FedExOptionPage."Importer City";
        FedExXMLControlExt."Importer State" := FedExOptionPage."Importer State";
        FedExXMLControlExt."Importer Postal Code" := FedExOptionPage."Importer Postal Code";
        FedExXMLControlExt."Importer Account No." := FedExOptionPage."Importer Account No.";
        FedExXMLControlExt."Importer Phone No." := FedExOptionPage."Importer Phone No.";
        FedExXMLControlExt."Importer SSN/EIN No." := FedExOptionPage."Importer SSN/EIN No.";
        FedExXMLControl."Intl Controlled Export Service" :=
          FedExOptionPage."Intl Controlled Export Service";
          FedExXMLControl."FICE License Type" := STRSUBSTNO ('%1',FedExOptionPage."FICE License Type");
          FedExXMLControl."FICE Foreign Trade Zone" := FedExOptionPage."FICE Foreign Trade Zone";
          FedExXMLControl."FICE Entry No." := FedExOptionPage."FICE Entry No.";
          FedExXMLControl."FICE License/Permit No." := FedExOptionPage."FICE License/Permit No.";
          FedExXMLControl."FICE License/Permit Exp. Date" :=
            FedExOptionPage."FICE License/Permit Exp. Date";
        FedExXMLControlExt.ITAR := FedExOptionPage.ITAR;
        FedExXMLControlExt."ITAR License or Exemption No." :=
          FedExOptionPage."ITAR License or Exemption No.";
        IF FedExOptionPageExt."HAL Location Country" <> '' THEN
          FedExXMLControl."HAL FedEx Location Country" :=
            GetFedExCountryCode(FedExOptionPageExt."HAL Location Country")
        ELSE
          FedExXMLControl."HAL FedEx Location Country" := 'US';
        FedExXMLControl."HAL Residential" := FALSE;

        CASE FedExOptionPage."Home Delivery Premium Type" OF
          FedExOptionPage."Home Delivery Premium Type"::"FedEx Appointment Home Delivery":
            BEGIN
            FedExXMLControl."Home Delivery Type" := 'APPOINTMENT';
              FedExXMLControl."Home Delivery Date" := FedExOptionPage."FedEx Home Delivery Date";
            END;
          FedExOptionPage."Home Delivery Premium Type"::"FedEx Date Certain Home Delivery":
            BEGIN
              FedExXMLControl."Home Delivery Type" := 'DATE_CERTAIN';
              FedExXMLControl."Home Delivery Date" := FedExOptionPage."FedEx Home Delivery Date";
            END;
          FedExOptionPage."Home Delivery Premium Type"::"FedEx Evening Home Delivery":
            FedExXMLControl."Home Delivery Type" := 'EVENING';
        END;
        FedExXMLControl."Home Delivery Phone No." := FedExOptionPage."FedEx Home Delivery Phone No.";

        FedExXMLControl."Dry Ice" := FedExOptionPage."Dry Ice";
        FedExXMLControl."Dry Ice Weight" := FedExOptionPage."Dry Ice Weight";
        IF FedExOptionPage."Dangerous Goods" THEN BEGIN
          IF FedExOptionPage.Hazmat = FALSE THEN
            FedExOptionPage.TESTFIELD(FedExOptionPage."Dangerous Goods Access. Type");
          FedExXMLControl."Dangerous Goods" := FedExOptionPage."Dangerous Goods";

          CASE FedExOptionPage."Dangerous Goods Access. Type" OF
            FedExOptionPage."Dangerous Goods Access. Type"::Accessible:
              FedExXMLControl."Dangerous Goods Type" := 'ACCESSIBLE';
            FedExOptionPage."Dangerous Goods Access. Type"::Inaccessible:
              FedExXMLControl."Dangerous Goods Type" := 'INACCESSIBLE';
          END;
        END;

        FedExXMLControl.Hazmat := FedExOptionPage.Hazmat;
          FedExXMLControl."Hazmat Contact Phone No." := CarrierPackingStation."Hazmat Contact Phone No.";
          FedExXMLControl."Hazmat Contact Name" := CarrierPackingStation."Hazmat Contact Name";
        FedExXMLControl."Hazmat Option Type" := STRSUBSTNO('%1',FedExOptionPage."Hazmat Option Type");

        FedExXMLControl."Saturday Pickup" := FedExOptionPage."Saturday Pickup";
        FedExXMLControl."Saturday Delivery" := FedExOptionPage."Saturday Delivery";
        FedExXMLControl."Additional Handling Required" := FedExOptionPage."Additional Handling Required";
        FedExXMLControl."Non Standard Container" := FedExOptionPage."Non Standard Container";
        FedExXMLControl."Call Before Delivery" := FedExOptionPage."Call Before Delivery";
        FedExXMLControl."Inside Pickup" := FedExOptionPage."Inside Pick Up" ;
        FedExXMLControl."Inside Delivery" := FedExOptionPage."Inside Delivery" ;
        FedExXMLControl."Liftgate Pickup" := FedExOptionPage."Liftgate Pickup";
        FedExXMLControl."Liftgate Delivery" := FedExOptionPage."Liftgate Delivery";
        FedExXMLControl."Call Tag Request" := FedExOptionPageExt."Call Tag Request";
        FedExXMLControl."Call Tag Ready Date" := FedExOptionPageExt."Call Tag Request Date";
        FedExXMLControl."Call Tag Latest Pickup Date" := FedExOptionPageExt."Call Tag Latest Pickup Date";
        FedExXMLControl."Call Tag Courier Instructions" :=
          FedExOptionPageExt."Call Tag Courier Instructions";

        CASE FedExOptionPageExt."Call Tag Request Type" OF
          FedExOptionPageExt."Call Tag Request Type"::"Future Day":
            BEGIN
              FedExXMLControl."Call Tag Request Type" := 'FUTURE_DAY';
            END;
          FedExOptionPageExt."Call Tag Request Type"::"Same Day":
            BEGIN
              FedExXMLControl."Call Tag Request Type" := 'SAME_DAY';
            END;
        END;

        CASE FedExOptionPageExt."Call Tag Request Source" OF
          FedExOptionPageExt."Call Tag Request Source"::Automation:
            BEGIN
              FedExXMLControl."Call Tag Request Source" := 'AUTOMATION';
            END;
          FedExOptionPageExt."Call Tag Request Source"::"Customer Service":
            BEGIN
              FedExXMLControl."Call Tag Request Source" := 'CUSTOMER_SERVICE';
            END;
        END;

        FedExXMLControl."Delivery Signature Options" := FedExOptionPage."Delivery Signature Options";
        FedExXMLControl."Signature Release Auth." := FedExOptionPage."Signature Release Auth.";
        FedExXMLControl."Signature Release" := FedExOptionPage."Signature Release";
        IF CurrentShippingAgentService."Service Indicator" = 'SP' THEN BEGIN
          FedExOptionPage."FedEx SmartPost Shipment" := TRUE;
          IF FedExOptionPage."FedEx SmartPost Indicia" = FedExOptionPage."FedEx SmartPost Indicia"::" " THEN
            FedExOptionPage."FedEx SmartPost Indicia" :=
              FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Media";
        END;

        FedExXMLControl."Smart Post Shipment" := FedExOptionPage."FedEx SmartPost Shipment";

        CASE FedExOptionPage."FedEx SmartPost Indicia" OF
          FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Media":
            FedExXMLControl."Smart Post Indicia" := 'MEDIA_MAIL';
          FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Parcel Select":
            FedExXMLControl."Smart Post Indicia" := 'PARCEL_SELECT';
          FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Bound Printed Matter":
            FedExXMLControl."Smart Post Indicia" := 'PRESORTED_BOUND_PRINTED_MATTER';
          FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Presorted Standard":
            FedExXMLControl."Smart Post Indicia" := 'PRESORTED_STANDARD';
          FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Returns":
            FedExXMLControl."Smart Post Indicia" := 'PARCEL_RETURN';
          FedExOptionPage."FedEx SmartPost Indicia"::"FedEx SmartPost Parcel Select Lightweight":
            FedExXMLControl."Smart Post Indicia" := 'PARCEL_SELECT_LIGHTWEIGHT';
        ELSE
            IF FedExOptionPage."FedEx SmartPost Shipment" THEN
              ERROR(Text007);
        END;

        CASE FedExOptionPage."FedEx SmartPost Endorsement" OF
          FedExOptionPage."FedEx SmartPost Endorsement"::"Address Correction":
            FedExXMLControl."Smart Post Endorsement" := 'ADDRESS_CORRECTION';
          FedExOptionPage."FedEx SmartPost Endorsement"::"Carrier Leave If No Response":
            FedExXMLControl."Smart Post Endorsement" := 'CARRIER_LEAVE_IF_NO_RESPONSE';
          FedExOptionPage."FedEx SmartPost Endorsement"::"Change Service":
            FedExXMLControl."Smart Post Endorsement" := 'CHANGE_SERVICE';
          FedExOptionPage."FedEx SmartPost Endorsement"::"Forwarding Service":
            FedExXMLControl."Smart Post Endorsement" := 'FORWARDING_SERVICE';
          FedExOptionPage."FedEx SmartPost Endorsement"::"Return Service":
            FedExXMLControl."Smart Post Endorsement" := 'RETURN_SERVICE';
        END;

        FedExXMLControl."Smart Post Hub ID" := ConvertSmartPostHubID(ShippingAgentAccount);
        FedExXMLControl."Smart Post Manifest ID" := FedExOptionPage."FedEx SmartPost Manifest ID";

        FedExXMLControl."Smart Post Delivery Conf." := FedExOptionPage."FedEx SmartPost Delivery Conf.";

        FedExXMLControl."Block Insight Visibility" := FedExOptionPage."Block Insight Visibility";
        FedExXMLControl."Packing List Enclosed" := FedExOptionPage."Packaging List Enclosed";

        FedExXMLControl."Shippers Load And Count" := FedExOptionPage."Shipper Load and Count";
        FedExXMLControl."Booking Confirmation No." := FedExOptionPage."Booking Confimation No.";

        FedExXMLControl."Label Format Type" := 'COMMON2D';
        CASE CarrierPackingStation."FedEx Label Printer Type" OF
          CarrierPackingStation."FedEx Label Printer Type"::"Eltron (EPL)":
            BEGIN
              FedExXMLControl."Label Image Type" := 'EPL2';
            END;
          CarrierPackingStation."FedEx Label Printer Type"::"Zebra (ZPL)":
            BEGIN
              FedExXMLControl."Label Image Type" := 'ZPLII';
            END;
        END;

        FedExXMLControl."Label Stock Type" := CarrierPackingStation."FedEx Label Media Type";
        CASE CarrierPackingStation."FedEx Print From" OF
          CarrierPackingStation."FedEx Print From"::Top:
            BEGIN
        FedExXMLControl."Label Printing Orientation" := 'TOP_EDGE_OF_TEXT_FIRST';
            END;
          CarrierPackingStation."FedEx Print From"::Bottom:
            BEGIN
              FedExXMLControl."Label Printing Orientation" := 'BOTTOM_EDGE_OF_TEXT_FIRST';
            END;
        END;

        IF (CarrierPackingStation."FedEx Label Media Type" =
          CarrierPackingStation."FedEx Label Media Type"::"4X6 with Trailing Doc Tab") OR
            (CarrierPackingStation."FedEx Label Media Type" =
              CarrierPackingStation."FedEx Label Media Type"::"4X6 with Leading Doc Tab")
          THEN
            FedExXMLControl."Enable Doc Tab" := TRUE;

        FedExXMLControlExt."DocTab Field 1 Header" := 'Invoice';
        FedExXMLControlExt."DocTab Field 1 Literal Value" := "Source ID";
        FedExXMLControlExt."DocTab Field 1 DataField" := '';
        FedExXMLControlExt."DocTab Field 2 Header" := 'Customer';
        FedExXMLControlExt."DocTab Field 2 Literal Value" := "Sell-to Customer No.";
        FedExXMLControlExt."DocTab Field 2 DataField" := '';
        FedExXMLControlExt."DocTab Field 3 Header" := 'Dept.';
        FedExXMLControlExt."DocTab Field 3 Literal Value" := '';
        FedExXMLControlExt."DocTab Field 3 DataField" := '';
        FedExXMLControlExt."DocTab Field 4 Header" := 'Date';
        FedExXMLControlExt."DocTab Field 4 Literal Value" :=
          XMLManagement.FormatDateYYYYMMDD(
            "Shipment Date");
        FedExXMLControlExt."DocTab Field 4 DataField" := '';
        FedExXMLControlExt."DocTab Field 5 Header" := 'Weight';
        FedExXMLControlExt."DocTab Field 5 Literal Value" :=
          XMLManagement.Decimal2Text(
            "Calculation Weight",0);
        FedExXMLControlExt."DocTab Field 5 DataField" := '';
        FedExXMLControlExt."DocTab Field 6 Header" := 'COD';
        FedExXMLControlExt."DocTab Field 6 Literal Value" := XMLManagement.Boolean2YN(COD);
        FedExXMLControlExt."DocTab Field 6 DataField" := '';
        FedExXMLControlExt."DocTab Field 7 Header" := 'DV';
        FedExXMLControlExt."DocTab Field 7 Literal Value" :=
          XMLManagement.Decimal2Text(
            "Calculation Value",2);
        FedExXMLControlExt."DocTab Field 7 DataField" := '';
        FedExXMLControlExt."DocTab Field 8 Header" := 'Shipping';
        FedExXMLControlExt."DocTab Field 8 Literal Value" := '';
        FedExXMLControlExt."DocTab Field 8 DataField" := '';

        FedExXMLControlExt."DocTab Field 9 Header" := 'Tracking No.';
        FedExXMLControlExt."DocTab Field 9 Literal Value" := '';
        FedExXMLControlExt."DocTab Field 9 DataField" :=
          'TRANSACTION/CustomerTransactionId';
        CASE ShippingAgentAccount."Rate Option" OF
          ShippingAgentAccount."Rate Option"::List:
            BEGIN
              FedExXMLControl."Rate Request Type" := 'LIST';
              FedExXMLControlExt."DocTab Field 8 DataField" :=
                'REPLY/SHIPMENT/RATES/RATED_LIST_PACKAGE/TotalNetCharge/Amount';
            END;
          ShippingAgentAccount."Rate Option"::Discount:
            FedExXMLControl."Rate Request Type" := 'NONE';
          ShippingAgentAccount."Rate Option"::Default:
            FedExXMLControl."Rate Request Type" := 'LIST';
        END;
        IF FedExOptionPageExt."Rate Request Type" <> '' THEN
          FedExXMLControl."Rate Request Type" := FedExOptionPageExt."Rate Request Type";

        FedExXMLControl."Total Packages" := RateShopHeader."No. of Packages";
        FedExXMLControl."Package Detail" := 'INDIVIDUAL_PACKAGES';
        FedExXMLControl."Package Sequence No." := 1;
        FedExXMLControl."Calculation Length" := "Calculation Length";
        FedExXMLControl."Calculation Width" := "Calculation Width";
        FedExXMLControl."Calculation Height" := "Calculation Height";
        IF ShippingSetup."Default Size Units" = ShippingSetup."Default Size Units"::"IN"
        THEN
          FedExXMLControl."Package Size Units" := 'IN'
        ELSE
          FedExXMLControl."Package Size Units" := 'CM';
        IF FedExXMLControl."FedEx Freight" THEN
          IF FedExOptionPageExt.Palletized THEN BEGIN
            FedExFreightXMLControl."FX Freight Shipment Dim Length" :=
              FedExOptionPageExt."FX Freight Pallet Length";
            FedExFreightXMLControl."FX Freight Shipment Dim Width" :=
              FedExOptionPageExt."FX Freight Pallet Width";
            FedExFreightXMLControl."FX Freight Shipment Dim Height" :=
              FedExOptionPageExt."FX Freight Pallet Height";
            IF ShippingSetup."Default Size Units" = ShippingSetup."Default Size Units"::"IN"
              THEN
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'IN'
              ELSE
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'CM';
          END ELSE BEGIN
            FedExFreightXMLControl."FX Freight Shipment Dim Length" := ROUND("Calculation Length",1);
            FedExFreightXMLControl."FX Freight Shipment Dim Width" := ROUND("Calculation Width",1);
            FedExFreightXMLControl."FX Freight Shipment Dim Height" := ROUND("Calculation Height",1);
            IF ShippingSetup."Default Size Units" = ShippingSetup."Default Size Units"::"IN"
              THEN
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'IN'
              ELSE
                FedExFreightXMLControl."FX Freight Shipment Dim Units" := 'CM';
          END;

        FedExXMLControl."Create Certificate of Origin":=
          FedExOptionPageExt."Create Certificate of Origin";
        FedExXMLControl."Create Gen. Agency Agreement":=
          FedExOptionPageExt."Create Gen. Agency Agreement";
        FedExXMLControl."Create NAFTA Cert. of Origin":=
          FedExOptionPageExt."Create NAFTA Cert. of Origin";
        FedExXMLControl."Create Pro Forma Invoice":= FedExOptionPageExt."Create Pro Forma Invoice";
        FedExXMLControl."Create Commercial Invoice":= FedExOptionPageExt."Create Commercial Invoice";
        FedExXMLControl3."Customer Reference Type 1" :=
          STRSUBSTNO('%1',FedExOptionPageExt."Customer Reference Type 1");
        FedExXMLControl3."Customer Reference Value 1" := FedExOptionPageExt."Customer Reference Value 1";
        FedExXMLControl3."Customer Reference Type 2" :=
          STRSUBSTNO('%1',FedExOptionPageExt."Customer Reference Type 2");
        FedExXMLControl3."Customer Reference Value 2" := FedExOptionPageExt."Customer Reference Value 2";
        FedExXMLControl3."Customer Reference Type 3" :=
          STRSUBSTNO('%1',FedExOptionPageExt."Customer Reference Type 3");
        FedExXMLControl3."Customer Reference Value 3" := FedExOptionPageExt."Customer Reference Value 3";
        FedExXMLControl3."Customer Reference Type 4" :=
          STRSUBSTNO('%1',FedExOptionPageExt."Customer Reference Type 4");
        FedExXMLControl3."Customer Reference Value 4" := FedExOptionPageExt."Customer Reference Value 4";
          FedExXMLControlExt."Recipient Customs ID Type" :=
            FedExOptionPageExt."Recipient Customs ID Type";
        FedExXMLControlExt."Recipient Customs ID" := FedExOptionPageExt."Recipient Customs ID";

        CASE FedExOptionPageExt."Physical Packaging Type" OF
          FedExOptionPageExt."Physical Packaging Type"::" ":
            FedExXMLControlExt."Physical Packaging Type" := '';
          FedExOptionPageExt."Physical Packaging Type"::BAG:
            FedExXMLControlExt."Physical Packaging Type" := 'BAG';
          FedExOptionPageExt."Physical Packaging Type"::BARREL:
            FedExXMLControlExt."Physical Packaging Type" := 'BARREL';
          FedExOptionPageExt."Physical Packaging Type"::BASKET:
            FedExXMLControlExt."Physical Packaging Type" := 'BASKET';
          FedExOptionPageExt."Physical Packaging Type"::BOX:
            FedExXMLControlExt."Physical Packaging Type" := 'BOX';
          FedExOptionPageExt."Physical Packaging Type"::BUCKET:
            FedExXMLControlExt."Physical Packaging Type" := 'BUCKET';
          FedExOptionPageExt."Physical Packaging Type"::BUNDLE:
            FedExXMLControlExt."Physical Packaging Type" := 'BUNDLE';
          FedExOptionPageExt."Physical Packaging Type"::CARTON:
            FedExXMLControlExt."Physical Packaging Type" := 'CARTON';
          FedExOptionPageExt."Physical Packaging Type"::"CASE":
            FedExXMLControlExt."Physical Packaging Type" := 'CASE';
          FedExOptionPageExt."Physical Packaging Type"::CONTAINER:
            FedExXMLControlExt."Physical Packaging Type" := 'CONTAINER';
          FedExOptionPageExt."Physical Packaging Type"::CRATE:
            FedExXMLControlExt."Physical Packaging Type" := 'CRATE';
          FedExOptionPageExt."Physical Packaging Type"::CYLINDER:
            FedExXMLControlExt."Physical Packaging Type" := 'CYLINDER';
          FedExOptionPageExt."Physical Packaging Type"::DRUM:
            FedExXMLControlExt."Physical Packaging Type" := 'DRUM';
          FedExOptionPageExt."Physical Packaging Type"::ENVELOPE:
            FedExXMLControlExt."Physical Packaging Type" := 'ENVELOPE';
          FedExOptionPageExt."Physical Packaging Type"::HAMPER:
            FedExXMLControlExt."Physical Packaging Type" := 'HAMPER';
          FedExOptionPageExt."Physical Packaging Type"::OTHER:
            FedExXMLControlExt."Physical Packaging Type" := 'OTHER';
          FedExOptionPageExt."Physical Packaging Type"::PAIL:
            FedExXMLControlExt."Physical Packaging Type" := 'PAIL';
          FedExOptionPageExt."Physical Packaging Type"::PALLET:
            FedExXMLControlExt."Physical Packaging Type" := 'PALLET';
          FedExOptionPageExt."Physical Packaging Type"::PIECE:
            FedExXMLControlExt."Physical Packaging Type" := 'PIECE';
          FedExOptionPageExt."Physical Packaging Type"::REEL:
            FedExXMLControlExt."Physical Packaging Type" := 'REEL';
          FedExOptionPageExt."Physical Packaging Type"::ROLL:
            FedExXMLControlExt."Physical Packaging Type" := 'ROLL';
          FedExOptionPageExt."Physical Packaging Type"::SKID:
            FedExXMLControlExt."Physical Packaging Type" := 'SKID';
          FedExOptionPageExt."Physical Packaging Type"::TANK:
            FedExXMLControlExt."Physical Packaging Type" := 'TANK';
          FedExOptionPageExt."Physical Packaging Type"::TUBE:
            FedExXMLControlExt."Physical Packaging Type" := 'TUBE';
        END;

        FedExXMLControl3."Do Not Stack Pallets" := FedExOptionPageExt."Do Not Stack Pallets";
        FedExXMLControl3."Do Not Break Down Pallets" := FedExOptionPageExt."Do Not Break Down Pallets";
        FedExXMLControlExt."Customer Reference" := FedExOptionPageExt."Customer Reference";

        FedExXMLControlExt."Export B13A Filing Option" :=
          FedExOptionPageExt."Export B13A Filing Option";
        FedExXMLControlExt."Export Compliance Statement" :=
          FedExOptionPageExt."Export Compliance Statement";
        FedExXMLControlExt.NAFTA := FedExOptionPage.NAFTA;
        FedExXMLControlExt."NAFTA Preference Criterion" :=
          FedExOptionPageExt."NAFTA Preference Criterion";
        FedExXMLControlExt."NAFTA Producer Determination" :=
          FedExOptionPageExt."NAFTA Producer Determination";
        FedExXMLControlExt."NAFTA Producer ID" := FedExOptionPageExt."NAFTA Producer ID";
        FedExXMLControlExt."NAFTA Net Cost Method" := FedExOptionPageExt."NAFTA Net Cost Method";
        FedExXMLControlExt."NAFTA Cost Beg. Date" := FedExOptionPage."NAFTA Cost Beg. Date";
        FedExXMLControlExt."NAFTA Cost End Date" := FedExOptionPage."NAFTA Cost End Date";
        FedExXMLControlExt."Requested Ship Date" := FedExOptionPage."Requested Ship Date";
        FedExXMLControlExt."Requested Ship Time" := FedExOptionPage."Requested Ship Time";

        FedExFreightXMLControl."Freight Label Stock Type" := 'PAPER_LETTER';
        FedExFreightXMLControl."Freight Label Format Type" :=
          STRSUBSTNO('%1',CarrierPackingStation."FedEx Freight BOL Type");
        FedExFreightXMLControl."Freight Label Image Type" := 'PDF';
        FedExFreightXMLControl."Freight Label Printing Orient." := 'BOTTOM_EDGE_OF_TEXT_FIRST';
        FedExFreightXMLControl."FX Freight Account No." := ShippingAgentAccount."Account No.";
        FedExFreightXMLControl."FX Freight Contact Name" := PackingStation."Ship-from Contact";
        FedExFreightXMLControl."FX Freight Contact Company" :=
          PackingStation."Ship-from Company";
        FedExFreightXMLControl."FX Freight Contact Pager No." :=
          XMLManagement.FixPhoneNo(PackingStation."Ship-from Phone No.");
        FedExFreightXMLControl."FX Freight Address" := PackingStation."Ship-from Address";
        FedExFreightXMLControl."FX Freight City" := PackingStation."Ship-from City";
        FedExFreightXMLControl."FX Freight State" := PackingStation."Ship-from State";
        FedExFreightXMLControl."FX Freight Postal Code" := PackingStation."Ship-from ZIP Code";
        FedExFreightXMLControl."FX Freight Country Code" :=
          PackingStation."Ship-from Country Code";
        FedExFreightXMLControl."FX Freight Role" := 'SHIPPER';
        FedExFreightXMLControl."Rated Package No." := RateShopHeader."Package No.";
        FedExFreightXMLControl."Bill of Lading No." := RateShopHeader."Bill of Lading No.";

        CASE FedExOptionPageExt."Shipment Role" OF
          FedExOptionPageExt."Shipment Role"::Shipper:
             FedExFreightXMLControl."FX Freight Role" := 'SHIPPER';
          FedExOptionPageExt."Shipment Role"::Consignee:
             FedExFreightXMLControl."FX Freight Role" := 'CONSIGNEE';
        END;
        CASE "Shipping Payment Type" OF
          "Shipping Payment Type"::Prepaid:
            FedExFreightXMLControl."FX Freight Payment Type" := 'PREPAID';
          "Shipping Payment Type"::"Third Party":
            FedExFreightXMLControl."FX Freight Payment Type" := 'PREPAID';
          "Shipping Payment Type"::"Freight Collect":
            FedExFreightXMLControl."FX Freight Payment Type" := 'COLLECT';
          "Shipping Payment Type"::Consignee:
            FedExFreightXMLControl."FX Freight Payment Type" := 'COLLECT';
        END;

        FedExFreightXMLControl."FX Freight Value Currency" := FedExXMLControl."Package Currency Code";
        FedExFreightXMLControl."FX Freight Value Amount" := "Value (Cost)";
        FedExFreightXMLControl."FX Freight Value Units" := "No. of Packages";
        CASE FedExOptionPageExt."Liability Coverage Type" OF
          FedExOptionPageExt."Liability Coverage Type"::" ":
        FedExFreightXMLControl."FX Freight Liability Cov. Type" := 'NEW';
          FedExOptionPageExt."Liability Coverage Type"::New:
            FedExFreightXMLControl."FX Freight Liability Cov. Type" := 'NEW';
          FedExOptionPageExt."Liability Coverage Type"::"Used or Reconditioned":
            FedExFreightXMLControl."FX Freight Liability Cov. Type" := 'USED_OR_RECONDITIONED'
        END;
        CASE FedExOptionPageExt."Collect Terms Type" OF
          FedExOptionPageExt."Collect Terms Type"::" ":
            FedExFreightXMLControl."Collect Terms Type" := '';
          FedExOptionPageExt."Collect Terms Type"::STANDARD:
            FedExFreightXMLControl."Collect Terms Type" := 'STANDARD';
          FedExOptionPageExt."Collect Terms Type"::NON_RECOURSE_SHIPPER_SIGNED:
            FedExFreightXMLControl."Collect Terms Type" := 'NON_RECOURSE_SHIPPER_SIGNED'
        END;
        IF FedExOptionPageExt."Liability Coverage Amount" <> 0 THEN
          FedExFreightXMLControl."FX Freight Coverage Amount" := FedExOptionPageExt."Liability Coverage Amount"
        ELSE
        FedExFreightXMLControl."FX Freight Coverage Amount" := "Calculation Insured Value";
        IF "Override Insured Value" <> 0 THEN
          FedExFreightXMLControl."FX Freight Coverage Amount" := "Override Insured Value";
        IF FedExOptionPageExt."Liability Coverage Currency" <> '' THEN
          FedExFreightXMLControl."FX Freight Coverage Amt. Curr." := FedExOptionPageExt."Liability Coverage Currency"
        ELSE
          FedExFreightXMLControl."FX Freight Coverage Amt. Curr." := FedExXMLControl."Package Currency Code";
        IF FedExOptionPageExt."FX Freight Pallet Weight Units" =
          FedExOptionPageExt."FX Freight Pallet Weight Units"::LBS THEN
            FedExFreightXMLControl."FX Freight Pallet Weight Units" := 'LB'
          ELSE
            FedExFreightXMLControl."FX Freight Pallet Weight Units" := 'KG';
        IF FedExOptionPageExt."FX Freight Pallet Weight Value" <> 0 THEN
          FedExFreightXMLControl."FX Freight Pallet Weight Value" :=
            FedExOptionPageExt."FX Freight Pallet Weight Value"
        ELSE
          FedExFreightXMLControl."FX Freight Pallet Weight Value" :=
            ShippingSetup."Default Pallet Weight";
        FedExFreightXMLControl."No. of Pallets" := FedExOptionPageExt."No. of Pallets";
        IF FedExOptionPageExt."No. of Pallets" > 0 THEN
          FedExFreightXMLControl."FX Freight Total Handling Unit" := FedExOptionPageExt."No. of Pallets"
        ELSE
          FedExFreightXMLControl."FX Freight Total Handling Unit" := "No. of Packages";
        FedExFreightXMLControl."No. of FedEx Freight Labels" :=
          ShippingAgentService."No. of Freight Labels / Pallet" * FedExOptionPageExt."No. of Pallets";
        FedExFreightXMLControl."No. of FedEx Freight BOLs" := ShippingAgentService."No. of BOL Copies / Shipment";
        IF FedExOptionPageExt.Palletized THEN BEGIN
          FedExFreightXMLControl."FXF Palletized" := TRUE;
          FedExFreightXMLControl."FX Freight Pallet Weight Value" :=
            FedExFreightXMLControl."FX Freight Pallet Weight Value" *
              FedExFreightXMLControl."FX Freight Total Handling Unit";
          FedExFreightXMLControl."FX Freight Shipment Dim Length" := FedExOptionPageExt."FX Freight Pallet Length";
          FedExFreightXMLControl."FX Freight Shipment Dim Width" := FedExOptionPageExt."FX Freight Pallet Width";
          FedExFreightXMLControl."FX Freight Shipment Dim Height" := FedExOptionPageExt."FX Freight Pallet Height";
        END;
        FedExFreightXMLControl."FedEx Freight BOL Line Type" :=
          CarrierPackingStation."FedEx Freight BOL Line Type";
        FedExFreightXMLControl."FX Freight Comment" := FedExOptionPageExt."FX Freight Comment";
        FedExFreightXMLControl."Special Delivery Instructions" := FedExOptionPageExt."Special Delivery Instructions";
        FedExXMLControlExt."Shipping Document Type" := FedExOptionPageExt."Shipping Document Type";
        FedExXMLControlExt."Shipping Document Image Type" :=
          FedExOptionPageExt."Shipping Document Image Type";
        FedExXMLControlExt."Shipping Document Stock Type" :=
          FedExOptionPageExt."Shipping Document Stock Type";
        FedExXMLControl."Electronic Trade Documents" :=
          FedExOptionPageExt."Electronic Trade Documents";
        FedExFreightXMLControl."FXF Billing Contact Company" :=
          FedExGlobalRegistration."Billing Company Name";
        FedExFreightXMLControl."FXF Billing Contact Name" := STRSUBSTNO('%1 %2',
          FedExGlobalRegistration."Billing Contact First Name",
            FedExGlobalRegistration."Billing Contact Last Name");
        FedExFreightXMLControl."FXF Billing Contact Pager No." := '';
        FedExFreightXMLControl."FXF Billing Address" := FedExGlobalRegistration."Billing Address 1";
        FedExFreightXMLControl."FXF Billing City" := FedExGlobalRegistration."Billing City";
        FedExFreightXMLControl."FXF Billing State" := FedExGlobalRegistration."Billing State";
        FedExFreightXMLControl."FXF Billing Postal Code" := FedExGlobalRegistration."Billing ZIP Code";
        FedExFreightXMLControl."FXF Billing Country Code" :=
          FedExGlobalRegistration."Billing Country Code";
        IF "Source Type" = 14000822 THEN
          FedExFreightXMLControl."Bill of Lading No." := "Source ID";
        IF FedExOptionPage."World Wide Service" THEN BEGIN
          CASE FedExOptionPage."Broker TIN Type" OF
            FedExOptionPage."Broker TIN Type"::SSN:
              FedExXMLControlExt."Broker TIN Type" := 'PERSONAL_NATIONAL';
            FedExOptionPage."Broker TIN Type"::EIN:
              FedExXMLControlExt."Broker TIN Type" := 'BUSINESS_NATIONAL';
          END;
          FedExXMLControlExt."Broker SSN/EIN" := FedExOptionPage."Broker SSN/EIN";
          FedExXMLControlExt."Broker Account No." := FedExOptionPage."Broker FDX Account No.";
          FedExXMLControlExt."Broker Company Name" := FedExOptionPage."Broker Company Name";
          FedExXMLControlExt."Broker Contact Id" := FedExOptionPage."Broker Contact Id";
          FedExXMLControlExt."Broker Type" := FedExOptionPage."Broker Type";
          FedExXMLControlExt."Broker Name" := FedExOptionPage."Broker Name";
          FedExXMLControlExt."Broker Phone No." := FedExOptionPage."Broker Phone No.";
          FedExXMLControlExt."Broker Email Address" := FedExOptionPage."Broker Email Address";
          FedExXMLControlExt."Broker Address 1" := FedExOptionPage."Broker Address 1";
          FedExXMLControlExt."Broker City" := FedExOptionPage."Broker City";
          FedExXMLControlExt."Broker State" := FedExOptionPage."Broker State";
          FedExXMLControlExt."Broker Postal Code" := FedExOptionPage."Broker Postal Code";
          FedExXMLControlExt."Broker Country Code" := FedExOptionPage."Broker Country Code";
          CASE FedExOptionPage."Clearance Brokerage Type" OF
            FedExOptionPage."Clearance Brokerage Type"::"Broker Inclusive":
              FedExXMLControlExt."Clearance Brokerage Type" := 'BROKER_INCLUSIVE';
            FedExOptionPage."Clearance Brokerage Type"::"Broker Inclusive Non Resident Importer":
              FedExXMLControlExt."Clearance Brokerage Type" := 'BROKER_INCLUSIVE_NON_RESIDENT_IMPORTER';
            FedExOptionPage."Clearance Brokerage Type"::"Broker Select":
              FedExXMLControlExt."Clearance Brokerage Type" := 'BROKER_SELECT';
            FedExOptionPage."Clearance Brokerage Type"::"Broker Select Non Resident Importer":
              FedExXMLControlExt."Clearance Brokerage Type" := 'BROKER_SELECT_NON_RESIDENT_IMPORTER';
            FedExOptionPage."Clearance Brokerage Type"::"Broker Unassigned":
              FedExXMLControlExt."Clearance Brokerage Type" := 'BROKER_UNASSIGNED';
          END;
          CASE FedExOptionPage."Customs Option Type" OF
            FedExOptionPage."Customs Option Type"::" ":
              FedExXMLControlExt."Customs Option Type" := '';
            FedExOptionPage."Customs Option Type"::"Courtesy Return Label":
              FedExXMLControlExt."Customs Option Type" := 'COURTESY_RETURN_LABEL';
            FedExOptionPage."Customs Option Type"::"Exhibition Trade Show":
              FedExXMLControlExt."Customs Option Type" := 'EXHIBITION_TRADE_SHOW';
            FedExOptionPage."Customs Option Type"::"Faulty Item":
              FedExXMLControlExt."Customs Option Type" := 'FAULTY_ITEM';
            FedExOptionPage."Customs Option Type"::"Following Repair":
              FedExXMLControlExt."Customs Option Type" := 'FOLLOWING_REPAIR';
            FedExOptionPage."Customs Option Type"::"For Repair":
              FedExXMLControlExt."Customs Option Type" := 'FOR_REPAIR';
            FedExOptionPage."Customs Option Type"::"Item for Loan":
              FedExXMLControlExt."Customs Option Type" := 'ITEM_FOR_LOAN';
            FedExOptionPage."Customs Option Type"::Other:
              FedExXMLControlExt."Customs Option Type" := 'OTHER';
            FedExOptionPage."Customs Option Type"::Rejected:
              FedExXMLControlExt."Customs Option Type" := 'REJECTED';
            FedExOptionPage."Customs Option Type"::Replacement:
              FedExXMLControlExt."Customs Option Type" := 'REPLACEMENT';
            FedExOptionPage."Customs Option Type"::Trial:
              FedExXMLControlExt."Customs Option Type" := 'TRIAL';
          END;
          FedExXMLControlExt."Customs Option Description" := FedExOptionPage."Customs Option Description";
          FedExXMLControlExt."Non-dutiable Document" := FedExOptionPage."Non-dutiable Document";
          FedExXMLControlExt."Export Declared Value" := FedExOptionPage."Export Declared Value";
          IF FedExOptionPage."Duties Payer Account No." <> '' THEN BEGIN
            FedExXMLControlExt."Duties Payor Account No." := FedExOptionPage."Duties Payer Account No.";
            IF FedExOptionPage."Duties Payer Country Code" <> '' THEN
              FedExXMLControlExt."Duties Payor Country Code" :=
                GetFedExCountryCode(
                  FedExOptionPage."Duties Payer Country Code")
            ELSE
              FedExXMLControlExt."Duties Payor Country Code" := 'US';
          END ELSE BEGIN
            FedExXMLControlExt."Duties Payor Account No." :=
              CarrierPackingStation."FedEx Shipping Agent Acc. No.";
            IF PackingStation."Ship-from Country Code" <> '' THEN
              FedExXMLControlExt."Duties Payor Country Code" :=
                GetFedExCountryCode(
                  PackingStation."Ship-from Country Code")
            ELSE
              FedExXMLControlExt."Duties Payor Country Code" := 'US';
          END;
          CASE FedExOptionPage."Duties Payer Type" OF
            FedExOptionPage."Duties Payer Type"::" ":
              BEGIN
                FedExXMLControlExt."Duties Payor Type" := 'SENDER';
                FedExXMLControlExt."Duties Payor Account No." :=
                  CarrierPackingStation."FedEx Shipping Agent Acc. No.";
              END;
            FedExOptionPage."Duties Payer Type"::Shipper:
              BEGIN
                FedExXMLControlExt."Duties Payor Type" := 'SENDER';
                FedExXMLControlExt."Duties Payor Account No." :=
                  CarrierPackingStation."FedEx Shipping Agent Acc. No.";
              END;
            FedExOptionPage."Duties Payer Type"::Recipient:
              BEGIN
                FedExXMLControlExt."Duties Payor Type" := 'RECIPIENT';
                FedExXMLControlExt."Duties Payor Account No." := '';
              END;
            FedExOptionPage."Duties Payer Type"::"Third Party":
              BEGIN
                FedExXMLControlExt."Duties Payor Type" := 'THIRD_PARTY';
                IF FedExOptionPage."Duties Payer Account No." <> '' THEN
                  FedExXMLControlExt."Duties Payor Account No." :=
                    FedExOptionPage."Duties Payer Account No."
                ELSE
                  FedExXMLControlExt."Duties Payor Account No." := '';
              END;
          END;
          FedExXMLControl3."Duties Payor Contact Id" := FedExOptionPageExt."Duties Payor Contact Id";
          FedExXMLControl3."Duties Payor Name" := FedExOptionPageExt."Duties Payor Name";
          FedExXMLControl3."Duties Payor Address" := FedExOptionPageExt."Duties Payor Address";
          FedExXMLControl3."Duties Payor City" := FedExOptionPageExt."Duties Payor City";
          FedExXMLControl3."Duties Payor State" := FedExOptionPageExt."Duties Payor State";
          FedExXMLControl3."Duties Payor Postal" := FedExOptionPageExt."Duties Payor Postal";
          FedExXMLControl3."Duties Payor Residential" := FedExOptionPageExt."Duties Payor Residential";
          FedExXMLControl3."Duties Payor Phone" := FedExOptionPageExt."Duties Payor Phone";
          FedExXMLControl3."Duties Payor Email" := FedExOptionPageExt."Duties Payor Email";
          FedExXMLControl3."Duties Payor Tins No" := FedExOptionPageExt."Duties Payor Tins No";
          CASE FedExOptionPageExt."Duties Payor Tins Type" OF
            FedExOptionPageExt."Duties Payor Tins Type"::PERSONAL_NATIONAL:
              FedExXMLControl3."Duties Payor Tins Type" := 'PERSONAL_NATIONAL';
            FedExOptionPageExt."Duties Payor Tins Type"::BUSINESS_NATIONAL:
              FedExXMLControl3."Duties Payor Tins Type" := 'BUSINESS_NATIONAL';
          END;

          IF FedExOptionPage."Export Declared Value" <> 0 THEN BEGIN
            FedExXMLControlExt."Export Declared Value" := FedExOptionPage."Export Declared Value";
          END ELSE BEGIN
              FedExXMLControlExt."Export Declared Value" := "Override Value";
            END;
          END;
          FedExXMLControlExt."Export Declared Value Currency" :=
            FedExXMLControl."Package Currency Code";

          FedExXMLControlExt."Include Commercial Invoice" :=
            FedExOptionPage."Include Commercial Invoice";
          IF FedExOptionPageExt."Create Commercial Invoice" THEN
            FedExXMLControlExt."Include Commercial Invoice" := TRUE;
          FedExXMLControlExt."Customer Invoice No." := FedExOptionPage."Customer Invoice No.";
          FedExXMLControlExt."Commercial Invoice Comments" := FedExOptionPageExt."Commercial Invoice Comments";

          CASE FedExOptionPage."International Terms of Sale" OF
            FedExOptionPage."International Terms of Sale"::"Freight On Board":
              FedExXMLControlExt."International Terms of Sale" := 'FOB_OR_FCA';
            FedExOptionPage."International Terms of Sale"::"Cost-Insurance-Freight":
              FedExXMLControlExt."International Terms of Sale" := 'CIF_OR_CIP';
            FedExOptionPage."International Terms of Sale"::"Cost and Freight":
              FedExXMLControlExt."International Terms of Sale" := 'CFR_OR_CPT';
            FedExOptionPage."International Terms of Sale"::"Free Carrier":
              FedExXMLControlExt."International Terms of Sale" := 'FOB_OR_FCA';
            FedExOptionPage."International Terms of Sale"::"Carriage Insurance Paid":
              FedExXMLControlExt."International Terms of Sale" := 'CIF_OR_CIP';
            FedExOptionPage."International Terms of Sale"::"Carrier Paid To":
              FedExXMLControlExt."International Terms of Sale" := 'CFR_OR_CPT';
            FedExOptionPage."International Terms of Sale"::"Ex Works":
              FedExXMLControlExt."International Terms of Sale" := 'EXW';
            FedExOptionPage."International Terms of Sale"::"Delivered Duty Unpaid":
              FedExXMLControlExt."International Terms of Sale" := 'DDU';
            FedExOptionPage."International Terms of Sale"::"Delivered Duty Paid":
              FedExXMLControlExt."International Terms of Sale" := 'DDP';
            FedExOptionPage."International Terms of Sale"::"Delivered At Place":
              FedExXMLControlExt."International Terms of Sale" := 'DAP';
          END;

          FedExXMLControlExt."CI Freight Charge" := FedExOptionPageExt."CI Freight Charge";
          FedExXMLControlExt."CI Freight Charge Currency" := "Currency Code";
          FedExXMLControlExt."CI Misc Charge" := FedExOptionPageExt."CI Misc Charge";
          FedExXMLControlExt."CI Misc Charge Currency" := "Currency Code";
          FedExXMLControlExt."CI Purpose of Shipment":= FedExOptionPage."Purpose of Shipment";
      END;
    END;

    PROCEDURE TrackPackage@1240030001(CurrentPackage@1240030000 : Record 14000701);
    VAR
      Country@1240030010 : Record 9;
    BEGIN
      WITH CurrentPackage DO BEGIN
        ShippingAgent.GET("Shipping Agent Code");

        Country.INIT;
        IF "Ship-to Country Code" <> '' THEN
          Country.GET("Ship-to Country Code");

        HYPERLINK(
          STRSUBSTNO(
            ShippingAgent."Internet Address","External Tracking No.",Country.Code,
            "Pickup Date",ShippingAgent."Account No."));
      END;
    END;

    LOCAL PROCEDURE GetFirstPackageTransaction@53(CurrentPackage@1240030000 : Record 14000701;VAR MasterTrackingNumber@1240030001 : Code[20];VAR MasterFormID@1240030002 : Code[4]);
    VAR
      FedExOptionPage@1240030003 : Record 14000781;
      FedExPostedOptionPage@1240030004 : Record 14000782;
      PackageTmp@1240030006 : TEMPORARY Record 14000701;
      Package2@1240030005 : Record 14000701;
      Package4@1240030007 : Record 14000701;
    BEGIN
      WITH CurrentPackage DO BEGIN
        Package2.SETCURRENTKEY("Source Type","Source Subtype","Source ID");
        Package2.SETRANGE("Source Type","Source Type");
        Package2.SETRANGE("Source Subtype","Source Subtype");
        IF "Multi Document Package"  THEN
          Package2.SETRANGE("Multi Document No.","Multi Document No.")
        ELSE
          Package2.SETRANGE("Source ID","Source ID");
        IF Package2.FIND('-') THEN
          REPEAT
            IF Package2."Original Package No." <> '' THEN BEGIN
              Package4.GET(Package2."Original Package No.");
              PackageTmp := Package4;
            END ELSE
              PackageTmp := Package2;
            IF PackageTmp.INSERT THEN
            ;
          UNTIL Package2.NEXT = 0;
        PackageTmp.SETCURRENTKEY("No.");
        IF PackageTmp.FIND('-') THEN
          IF FedExOptionPage.GET(FedExOptionPage.Type::Package,PackageTmp."No.",0,0) THEN BEGIN
            MasterTrackingNumber := FedExOptionPage."Master Tracking No.";
            MasterFormID := FedExOptionPage."Tracking Form ID";
          END ELSE
            IF FedExPostedOptionPage.GET(PackageTmp."No.") THEN BEGIN
              MasterTrackingNumber := FedExPostedOptionPage."Master Tracking No.";
              MasterFormID := FedExPostedOptionPage."Tracking Form ID";
            END;
      END;
    END;

    PROCEDURE CheckXMLResponseError@1240030003(XMLResponseDoc@1240030000 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";DocNameSpace@1240030001 : Text[30];ShowError@1240030003 : Boolean) TransactionResponse : Text[1024];
    VAR
      "Response Severity"@1240030002 : Text[150];
      XMLNodeList@1240030005 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNodeList";
      XMLCurrNode@1240030006 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
      XMLNsMgrError@1240020000 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNamespaceManager";
      Loop@1240030007 : Integer;
    BEGIN
      WITH XMLManagement DO BEGIN
        CurrNode := XMLResponseDoc.DocumentElement;
        IF FindNode(
             CurrNode,'//'+DocNameSpace+':Notifications/'+DocNameSpace+':Severity',CurrNode,XMLNsMgr) THEN BEGIN
          "Response Severity" := CurrNode.InnerText;
          CurrNode := XMLResponseDoc.DocumentElement;
          XMLNodeList :=
            XMLResponseDoc.SelectNodes('//'+DocNameSpace+':Notifications/'+DocNameSpace+':Message',XMLNsMgr);
          IF XMLNodeList.Count > 0 THEN BEGIN
            FOR Loop := 0 TO XMLNodeList.Count - 1 DO BEGIN
              XMLCurrNode := XMLNodeList.Item(Loop);
              IF COPYSTR(XMLCurrNode.InnerText,1,125) = 'No Shipments to Close' THEN
                "Response Severity" := '';
              IF (ShowError AND ("Response Severity" = 'ERROR')) OR ShippingAgentAccount."Show Soft Errors" THEN
                MESSAGE("Response Severity" + ': ' +
                  COPYSTR(
                    FORMAT(
                      XMLCurrNode.InnerText),1,250))
              ELSE BEGIN
                IF COPYSTR(XMLCurrNode.InnerText,1,125) <> 'No Shipments to Close' THEN
                  TransactionResponse := "Response Severity" + ': ' + COPYSTR(XMLCurrNode.InnerText,1,125)
                ELSE BEGIN
                  "Response Severity" := '';
                  TransactionResponse := '';
                  MESSAGE(Text016);
                END;
                IF COPYSTR(XMLCurrNode.InnerText,1,125) = 'Unable to obtain courtesy rates.' THEN
                  ERROR(Text014 + COPYSTR(XMLCurrNode.InnerText,1,125));
              END;
            END;
            IF ShowError AND ("Response Severity" = 'ERROR') THEN
              ERROR(Text015);
          END;
        END ELSE BEGIN

          XMLNsMgrError := XMLNsMgrError.XmlNamespaceManager(XMLResponseDoc.NameTable);
          CurrNode := XMLResponseDoc.DocumentElement;
          XMLNsMgrError.AddNamespace(CurrNode.Prefix,CurrNode.NamespaceURI);
          XMLNsMgrError.AddNamespace('con','http://www.bea.com/wli/sb/context');
          XMLNsMgrError.AddNamespace('con1','http://www.bea.com/wli/sb/stages/transform/config');
          XMLNsMgrError.AddNamespace('soapenv', CurrNode.NamespaceURI);
          XMLNsMgrError.AddNamespace('ns',DocNameSpace);

          //FedEx Internal Server Error
          IF FindNode(CurrNode,'//soapenv:Fault/detail/con:errorCode',CurrNode,XMLNsMgrError) THEN
            "Response Severity" := CurrNode.InnerText;
          CurrNode := XMLResponseDoc.DocumentElement;
          IF FindNode(CurrNode,'//soapenv:Fault/detail/con:reason',CurrNode,XMLNsMgrError) THEN
            IF STRLEN(CurrNode.InnerText) > 0 THEN
              TransactionResponse := Text012 + COPYSTR(CurrNode.InnerText,1,125);

          //FedEx Internal Server Error 2
          CurrNode := XMLResponseDoc.DocumentElement;
          IF FindNode(CurrNode,'//soapenv:Fault/detail/errorCode',CurrNode,XMLNsMgrError) THEN
            "Response Severity" := CurrNode.InnerText;
          CurrNode := XMLResponseDoc.DocumentElement;
          IF FindNode(CurrNode,'//soapenv:Fault/detail/reason',CurrNode,XMLNsMgrError) THEN
            IF STRLEN(CurrNode.InnerText) > 0 THEN
              TransactionResponse := Text012 + COPYSTR(CurrNode.InnerText,1,125);

          //NameSpace: con1
          CurrNode := XMLResponseDoc.DocumentElement;
          IF FindNode(CurrNode,'//con1:ValidationFailureDetail/con1:message',CurrNode,XMLNsMgrError) THEN
            IF STRLEN(CurrNode.InnerText) > 0 THEN BEGIN
              "Response Severity" := 'ERROR';
              TransactionResponse := "Response Severity" + ': ' + COPYSTR(CurrNode.InnerText,1,125);
            END;

          //NameSpace: con1
          CurrNode := XMLResponseDoc.DocumentElement;
          IF FindNode(CurrNode,'//con1:Severity',CurrNode,XMLNsMgrError) THEN
            "Response Severity" := CurrNode.InnerText;
          CurrNode := XMLResponseDoc.DocumentElement;
          IF FindNode(CurrNode,'//con1:Message',CurrNode,XMLNsMgrError) THEN
            IF STRLEN(CurrNode.InnerText) > 0 THEN
              TransactionResponse := "Response Severity" + ': ' +  COPYSTR(CurrNode.InnerText,1,125);

          //NameSpace: ns
          CurrNode := XMLResponseDoc.DocumentElement;
          IF FindNode(CurrNode,'//ns:Severity',CurrNode,XMLNsMgrError) THEN
            "Response Severity" := CurrNode.InnerText;
          CurrNode := XMLResponseDoc.DocumentElement;
          IF FindNode(CurrNode,'//ns:Message',CurrNode,XMLNsMgrError) THEN
            IF STRLEN(CurrNode.InnerText) > 0 THEN
              TransactionResponse := "Response Severity" + ': ' + COPYSTR(CurrNode.InnerText,1,125);

          //NameSpace: Blank
          CurrNode := XMLResponseDoc.DocumentElement;
          IF FindNode(CurrNode,'//Severity',CurrNode,XMLNsMgrError) THEN
            "Response Severity" := CurrNode.InnerText;
          CurrNode := XMLResponseDoc.DocumentElement;
          IF FindNode(CurrNode,'//HighestSeverity',CurrNode,XMLNsMgrError) THEN
            IF CurrNode.InnerText <> 'SUCCESS' THEN
              IF FindNode(CurrNode,'//Notifications/Message',CurrNode,XMLNsMgrError) THEN
                IF STRLEN(CurrNode.InnerText) > 0 THEN
                  TransactionResponse := "Response Severity" + ': ' + COPYSTR(CurrNode.InnerText,1,125);

          //NameSpace: SOAP-ENV
          CurrNode := XMLResponseDoc.DocumentElement;
          IF FindNode(CurrNode,'//SOAP-ENV:Fault/detail/code',CurrNode,XMLNsMgrError) THEN
            "Response Severity" := 'ERROR';
            IF STRLEN(CurrNode.InnerText) > 0 THEN
              TransactionResponse := "Response Severity" + ': ' + CurrNode.InnerText;
        END;

        IF STRLEN(TransactionResponse) > 125 THEN
          TransactionResponse := TransactionResponse + '...';

        IF ShowError THEN BEGIN
          CASE "Response Severity" OF
            'ERROR':
              BEGIN
                ERROR(TransactionResponse);
              END;
            'FAILURE':
              BEGIN
                ERROR(TransactionResponse);
              END;
            'WARNING':
              BEGIN
                IF ShippingAgentAccount."Show Soft Errors" THEN
                  MESSAGE(TransactionResponse);
              END;
            'NOTE':
              BEGIN
                IF ShippingAgentAccount."Show Soft Errors" THEN
                  MESSAGE(TransactionResponse);
              END;
          END;
        END;
      END;
    END;

    PROCEDURE FormatTimeForFileOutput@1240030004(TimetoFormat@1240030000 : Time) TimeFormatted : Text[12];
    VAR
      hour@1240030002 : Integer;
    BEGIN
      TimeFormatted := FORMAT(TimetoFormat);
      IF COPYSTR(TimeFormatted,1,1) = ' ' THEN
        EVALUATE(hour,COPYSTR(TimeFormatted,2,1))
      ELSE
        EVALUATE(hour,COPYSTR(TimeFormatted,1,2));

      IF (STRPOS(TimeFormatted,'PM') > 0) AND
         (hour < 12)
      THEN
        hour := hour + 12;

      TimeFormatted := FORMAT(
                         hour) + '.' +
                         COPYSTR(
                           TimeFormatted,4,2) + '.' +
                           COPYSTR(
                             TimeFormatted,7,2);

      IF STRLEN(TimeFormatted) < 8 THEN
        TimeFormatted := '0' + TimeFormatted;
    END;

    PROCEDURE ConvertSmartPostHubID@1240030006(ShippingAgentAccount@1240030000 : Record 14000788) "Smart Post Hub ID" : Code[20];
    BEGIN
      CASE ShippingAgentAccount."SmartPost Hub ID" OF
        ShippingAgentAccount."SmartPost Hub ID"::"Atlanta GA":
          "Smart Post Hub ID" := '5303';
        ShippingAgentAccount."SmartPost Hub ID"::"Charlotte NC":
          "Smart Post Hub ID" := '5281';
        ShippingAgentAccount."SmartPost Hub ID"::"Chicago IL":
          "Smart Post Hub ID" := '5602';
        ShippingAgentAccount."SmartPost Hub ID"::"Chino CA":
          "Smart Post Hub ID" := '5929';
        ShippingAgentAccount."SmartPost Hub ID"::"Dallas TX":
          "Smart Post Hub ID" := '5751';
        ShippingAgentAccount."SmartPost Hub ID"::"Denver CO":
          "Smart Post Hub ID" := '5802';
        ShippingAgentAccount."SmartPost Hub ID"::"Detroit MI":
          "Smart Post Hub ID" := '5481';
        ShippingAgentAccount."SmartPost Hub ID"::"Edison NJ":
          "Smart Post Hub ID" := '5087';
        ShippingAgentAccount."SmartPost Hub ID"::"Grove City OH":
          "Smart Post Hub ID" := '5431';
        ShippingAgentAccount."SmartPost Hub ID"::"Houston TX":
          "Smart Post Hub ID" := '5771';
        ShippingAgentAccount."SmartPost Hub ID"::"Indianapolis IN":
          "Smart Post Hub ID" := '5465';
        ShippingAgentAccount."SmartPost Hub ID"::"Kansas City KS":
          "Smart Post Hub ID" := '5648';
        ShippingAgentAccount."SmartPost Hub ID"::"Los Angeles CA":
          "Smart Post Hub ID" := '5902';
        ShippingAgentAccount."SmartPost Hub ID"::"Martinsburg WV":
          "Smart Post Hub ID" := '5254';
        ShippingAgentAccount."SmartPost Hub ID"::"Memphis TN":
          "Smart Post Hub ID" := '5379';
        ShippingAgentAccount."SmartPost Hub ID"::"Minneapolis MN":
          "Smart Post Hub ID" := '5552';
        ShippingAgentAccount."SmartPost Hub ID"::"New Berlin WI":
          "Smart Post Hub ID" := '5531';
        ShippingAgentAccount."SmartPost Hub ID"::"Newburgh NY":
          "Smart Post Hub ID" := '5110';
        ShippingAgentAccount."SmartPost Hub ID"::"Northborough MA":
          "Smart Post Hub ID" := '5015';
        ShippingAgentAccount."SmartPost Hub ID"::"Orlando FL":
          "Smart Post Hub ID" := '5327';
        ShippingAgentAccount."SmartPost Hub ID"::"Philadelphia PA":
          "Smart Post Hub ID" := '5194';
        ShippingAgentAccount."SmartPost Hub ID"::"Phoenix AZ":
          "Smart Post Hub ID" := '5854';
        ShippingAgentAccount."SmartPost Hub ID"::"Pittsburgh PA":
          "Smart Post Hub ID" := '5150';
        ShippingAgentAccount."SmartPost Hub ID"::"Sacramento CA":
          "Smart Post Hub ID" := '5958';
        ShippingAgentAccount."SmartPost Hub ID"::"Salt Lake City UT":
          "Smart Post Hub ID" := '5843';
        ShippingAgentAccount."SmartPost Hub ID"::"Seattle WA":
          "Smart Post Hub ID" := '5983';
        ShippingAgentAccount."SmartPost Hub ID"::"St. Louis MO":
          "Smart Post Hub ID" := '5631';
        ShippingAgentAccount."SmartPost Hub ID"::"Allentown PA":
          "Smart Post Hub ID" := '5185';
      END;

      EXIT("Smart Post Hub ID");
    END;

    PROCEDURE CheckName@1240030019(ShippingAgent@1240030007 : Record 291;FromType@1240030006 : 'Package,Document,Master Data';VAR Name@1240030005 : Text[100];VAR Name2@1240030004 : Text[100];VAR Contact@1240030003 : Text[100];NameCaption@1240030002 : Text[100];Name2Caption@1240030001 : Text[100];ContactCaption@1240030000 : Text[100]);
    VAR
      LongNameType@1240030008 : Integer;
    BEGIN
      LongNameType := NameAndAddressMgt.GetLongNameType(ShippingAgent,FromType);

      NameAndAddressMgt.CheckCorrectTextLen(Name,LongNameType,35,NameCaption);
      NameAndAddressMgt.CheckCorrectTextLen(Name2,LongNameType,35,Name2Caption);
      NameAndAddressMgt.CheckCorrectTextLen(Contact,LongNameType,35,ContactCaption);
    END;

    PROCEDURE CheckAddress@1240030002(ShippingAgent@1240030013 : Record 291;FromType@1240030012 : 'Package,Document,Master Data';VAR Address@1240030011 : Text[100];VAR Address2@1240030010 : Text[100];VAR City@1240030009 : Text[100];VAR PostCode@1240030008 : Code[100];VAR State@1240030007 : Text[100];VAR Country@1240030006 : Code[100];AddressCaption@1240030005 : Text[100];Address2Caption@1240030004 : Text[100];CityCaption@1240030003 : Text[100];PostCodeCaption@1240030002 : Text[100];StateCaption@1240030001 : Text[100];CountryCaption@1240030000 : Text[100]);
    VAR
      TempText@1240030015 : Text[100];
      LongAddressType@1240030014 : Integer;
    BEGIN
      LongAddressType := NameAndAddressMgt.GetLongAddressType(ShippingAgent,FromType);

      NameAndAddressMgt.CheckCorrectTextLen(Address,LongAddressType,35,AddressCaption);
      NameAndAddressMgt.CheckCorrectTextLen(Address2,LongAddressType,35,Address2Caption);
      NameAndAddressMgt.CheckCorrectTextLen(City,LongAddressType,35,CityCaption);
      TempText := PostCode;
      NameAndAddressMgt.CheckCorrectTextLen(TempText,LongAddressType,10,PostCodeCaption);
      PostCode := TempText;
      IF Country = 'AU' THEN
        NameAndAddressMgt.CheckCorrectTextLen(State,LongAddressType,3,StateCaption)
      ELSE
      NameAndAddressMgt.CheckCorrectTextLen(State,LongAddressType,2,StateCaption);
    END;

    PROCEDURE CreateReturnLabelPackage@1240020000(VAR CurrentPackage@1240030000 : Record 14000701;VAR FedExOptionPage@1240020001 : Record 14000781;VAR FedExOptionPageExt@1240020002 : Record 14000793;VAR MultiDocPackageTmp@1240030001 : Record 14000701;CurrentShippingAgent@1240030002 : Record 291;PrintLabel@1240030003 : Boolean);
    VAR
      ReturnPackage@1240030007 : Record 14000701;
      ReturnFedExOptionPage@1240020003 : Record 14000781;
      ReturnFedExOptionPageExt@1240020004 : Record 14000793;
      PackageLine@1240020005 : Record 14000702;
      ReturnPackageLine@1240020006 : Record 14000702;
      ReturnPackageNo@1240020000 : Code[10];
    BEGIN
      ReturnPackage.INIT;
      ReturnPackage."No." := '';
      ReturnPackage.Miscellaneous := TRUE;

      ReturnPackage.INSERT(TRUE);
      ReturnPackageNo := ReturnPackage."No.";
      FedExOptionPage.GET(FedExOptionPage.Type::Package,CurrentPackage."No.",0,0);
      FedExOptionPage."Return/Original Package No." := ReturnPackageNo;
      FedExOptionPage.MODIFY;

      ReturnPackage.COPY(CurrentPackage);
      ReturnPackage.GET(ReturnPackage."No.");
      ReturnPackage."No." := ReturnPackageNo;
      ReturnPackage.Miscellaneous := TRUE;
      ReturnPackage.Closed := FALSE;
      IF NOT ReturnPackage."World Wide Service" THEN
        ReturnPackage.VALIDATE("Shipping Agent Service",'FEDEX_GROUND');
      ReturnPackage.Description := STRSUBSTNO(Text019,CurrentPackage."No.");
      ReturnPackage."Source ID" := 'RETURN';
      IF ReturnPackage."External Document No." = '' THEN
        ReturnPackage."External Document No." := CurrentPackage."Source ID";
      ReturnPackage."Total Packages" := 1;
      ReturnPackage.MODIFY;

      ReturnFedExOptionPage.COPY(FedExOptionPage);
      ReturnFedExOptionPage.GET(ReturnFedExOptionPage.Type::Package,CurrentPackage."No.",0,0);
      ReturnFedExOptionPage."Source ID" := ReturnPackageNo;
      ReturnFedExOptionPage."Return Shipment" := TRUE;
      ReturnFedExOptionPage."Ship and Return Label" := FALSE;
      ReturnFedExOptionPage."Return/Original Package No." := CurrentPackage."No.";
      IF ReturnFedExOptionPage."World Wide Service" THEN BEGIN
        ReturnFedExOptionPage."Customs Option Type" :=
          ReturnFedExOptionPage."Customs Option Type"::Other;
        ReturnFedExOptionPage."Customs Option Description" := 'Return';
      END;
      ReturnFedExOptionPage.MODIFY;

      FedExOptionPageExt.GET(FedExOptionPageExt.Type::Package,CurrentPackage."No.",0,0);
      ReturnFedExOptionPageExt.COPY(FedExOptionPageExt);
      ReturnFedExOptionPageExt."Source ID" := ReturnPackageNo;
      IF NOT ReturnFedExOptionPageExt.INSERT THEN
        ReturnFedExOptionPageExt.MODIFY;

      PackageLine.RESET;
      PackageLine.SETRANGE("Package No.",CurrentPackage."No.");
      IF PackageLine.FIND('-') THEN
        REPEAT
          ReturnPackageLine.COPY(PackageLine);
          ReturnPackageLine."Package No." := ReturnPackageNo;
          ReturnPackageLine.INSERT(TRUE);
        UNTIL PackageLine.NEXT = 0;

      CurrentPackage := ReturnPackage;
      FedExOptionPage := ReturnFedExOptionPage;
      FedExOptionPageExt := ReturnFedExOptionPageExt;
    END;

    PROCEDURE CreateFedExBOL@1240020002(VAR BillOfLading@1240020000 : Record 14000822);
    VAR
      PackageManagement@1240020001 : Codeunit 14000702;
      BillOfLadingMgt@1240020020 : Codeunit 14000821;
      SalesOrder@1240020009 : Record 36;
      Package@1240020002 : Record 14000701;
      NewPackage@1240020006 : Record 14000701;
      Package2@1240020011 : Record 14000701;
      PackageLine@1240020003 : Record 14000702;
      NewPackageLine@1240020008 : Record 14000702;
      ExistingPackageLine@1240020017 : Record 14000702;
      PostedPackage@1240020013 : Record 14000704;
      PostedPackageLine@1240020015 : Record 14000705;
      PackingControl@1240020004 : Record 14000717;
      BillOfLadingLine@1240020005 : Record 14000823;
      BillOfLadingLine2@1240020012 : Record 14000823;
      FedExOptionPage@1240020021 : Record 14000781;
      FedExOptionPageExt@1240020027 : Record 14000793;
      PackageLineFilter@1240020007 : Text[1000];
      PostedPackageLineFilter@1240020014 : Text[1000];
      LineItemsCreated@1240020018 : Text[1000];
      PackageCount@1240020019 : Integer;
      NewPackageLineNo@1240020010 : Integer;
      LineExists@1240020016 : Boolean;
      PackageClosed@1240020022 : Boolean;
      BOLFedExOptionPage@1240020026 : Record 14000781;
      BOLFedExOptionPageExt@1240020028 : Record 14000793;
      NMFCCode@1240020023 : Record 14000730;
      HazMatItem@1240020024 : Record 14050102;
      HazMat@1240020025 : Boolean;
    BEGIN
      DeleteFedExBOL(BillOfLading);
      GetPackingStation;
      GetShippingSetup;
      CarrierPackingStation.GetPackingStation(PackingStation);
      CASE CarrierPackingStation."FedEx Freight BOL Line Type" OF
        CarrierPackingStation."FedEx Freight BOL Line Type"::Item:
          CreateFedExBOLByItem(BillOfLading);
        CarrierPackingStation."FedEx Freight BOL Line Type"::"BOL Info. Lines":
          CreateFedExBOLByInfoLines(BillOfLading);
        CarrierPackingStation."FedEx Freight BOL Line Type"::"Freight Class":
          CreateFedExBOLByClass(BillOfLading);
      END;
    END;

    PROCEDURE DeleteFedExBOL@1240020003(VAR BillOfLading@1240020000 : Record 14000822);
    VAR
      Package@1240020002 : Record 14000701;
      PostedPackage@1240020001 : Record 14000704;
      BOLManagement@1240020008 : Codeunit 14000821;
      BillOfLading2@1240020009 : Record 14000822;
      SalesHeader@1240020003 : Record 36;
      SalesLine@1240020004 : Record 37;
      SalesLine2@1240020007 : Record 37;
      ReleaseSalesDocument@1240020005 : Codeunit 414;
      ReleaseSalesOrder@1240020006 : Boolean;
    BEGIN
      GetPackingStation;
      GetShippingSetup;
      CarrierPackingStation.GetPackingStation(PackingStation);
      IF Package.GET(BillOfLading."FedEx Generated Package No.") THEN BEGIN
        Package.Closed := FALSE;
        Package."External Tracking No." := '*** VOIDED ***';
        Package.MODIFY;
      END;
      IF PostedPackage.GET(BillOfLading."FedEx Generated Package No.") THEN BEGIN
        PostedPackage.Closed := FALSE;
        PostedPackage."External Tracking No." := '*** VOIDED ***';
        PostedPackage.MODIFY;
      END;
      BillOfLading2.GET(BillOfLading."No.");
      BillOfLading2."Shipping Charge" := 0;
      BillOfLading2."Shipping Cost" := 0;
      IF BillOfLading."External Tracking No." <> '' THEN
        IF NOT CarrierPackingStation."Do Not Display BOL Delete Msg" THEN
          MESSAGE(Text028 + Text023 + Text024,
            BillOfLading."FedEx Generated Package No.",BillOfLading."No.",
              BillOfLading."External Tracking No.");
      BillOfLading2.GET(BillOfLading."No.");
      BillOfLading2."External Tracking No." := '';
      BillOfLading2."FedEx Generated Package No." := '';
      BillOfLading2.MODIFY;
      BillOfLading.GET(BillOfLading."No.");
    END;

    PROCEDURE FedExFreightPalletized@1240020004(BillOfLadingNo@1240020000 : Code[10]) : Boolean;
    VAR
      FedExOptionPageExt@1240020001 : Record 14000793;
    BEGIN
      IF NOT FedExOptionPageExt.GET(FedExOptionPageExt.Type::"Bill of Lading",BillOfLadingNo,0,0) THEN
        BEGIN
          FedExOptionPageExt.INIT;
          FedExOptionPageExt.Type := FedExOptionPageExt.Type::"Bill of Lading";
          FedExOptionPageExt."Source ID" := BillOfLadingNo;
          FedExOptionPageExt."Source Type" := 0;
          FedExOptionPageExt."Source Subtype" := 0;
          FedExOptionPageExt.INSERT(TRUE);
        END;
      FedExOptionPageExt.VALIDATE(Palletized,TRUE);
      FedExOptionPageExt.MODIFY(TRUE);
    END;

    PROCEDURE CreateFedExBOLByItem@1240020001(VAR BillOfLading@1240020000 : Record 14000822);
    VAR
      PackageManagement@1240020001 : Codeunit 14000702;
      BillOfLadingMgt@1240020020 : Codeunit 14000821;
      SalesOrder@1240020009 : Record 36;
      Package@1240020002 : Record 14000701;
      NewPackage@1240020006 : Record 14000701;
      Package2@1240020011 : Record 14000701;
      PackageLine@1240020003 : Record 14000702;
      NewPackageLine@1240020008 : Record 14000702;
      ExistingPackageLine@1240020017 : Record 14000702;
      PostedPackage@1240020013 : Record 14000704;
      PostedPackageLine@1240020015 : Record 14000705;
      PackingControl@1240020004 : Record 14000717;
      BillOfLadingLine@1240020005 : Record 14000823;
      BillOfLadingLine2@1240020012 : Record 14000823;
      FedExOptionPage@1240020021 : Record 14000781;
      FedExOptionPageExt@1240020028 : Record 14000793;
      PackageLineFilter@1240020007 : Text[1000];
      PostedPackageLineFilter@1240020014 : Text[1000];
      LineItemsCreated@1240020018 : Text[1000];
      PackageCount@1240020019 : Integer;
      NewPackageLineNo@1240020010 : Integer;
      LineExists@1240020016 : Boolean;
      PackageClosed@1240020022 : Boolean;
      BOLFedExOptionPage@1240020027 : Record 14000781;
      BOLFedExOptionPageExt@1240020026 : Record 14000793;
      NMFCCode@1240020025 : Record 14000730;
      HazMatItem@1240020024 : Record 14050102;
      HazMat@1240020023 : Boolean;
    BEGIN
      GetPackingStation;
      GetShippingSetup;
      CarrierPackingStation.GetPackingStation(PackingStation);
      ShippingAgentService.GET(BillOfLading."Shipping Agent Code",BillOfLading."Shipping Agent Service");

      BillOfLadingLine.RESET;
      BillOfLadingLine.SETRANGE("Bill of Lading No.",BillOfLading."No.");
      BillOfLadingLine.SETFILTER(Type,'Order|Package');
      IF BillOfLadingLine.FINDFIRST THEN
        CASE BillOfLadingLine.Type OF
          BillOfLadingLine.Type::Order:
            IF NOT SalesOrder.GET(1,BillOfLadingLine."No.") THEN
              ERROR(Text021,BillOfLadingLine."No.",BillOfLading."No.");
          BillOfLadingLine.Type::Package:
            IF NOT Package.GET(BillOfLadingLine."No.") THEN
              ERROR(Text022,BillOfLadingLine."No.",BillOfLading."No.");
        END;

      PackingControl.INIT;
      IF ((SalesOrder."No." = '') AND (Package."No." = '')) THEN
        ERROR(Text020,BillOfLading."No.");
      IF SalesOrder."No." <> '' THEN
        PackingControl.TransferFromSource(36,1,SalesOrder."No.")
      ELSE
        PackingControl.TransferFromPackage(Package);
      NewPackage.INIT;
      PackageManagement.Initialize(PackingStation,ShippingSetup);
      PackageManagement.CreatePackage(NewPackage,PackingControl);
      NewPackage.Closed := FALSE;
      NewPackage.Miscellaneous := TRUE;
      NewPackage."Shipping Agent Code" := BillOfLading."Shipping Agent Code";
      NewPackage."Shipping Agent Service" := BillOfLading."Shipping Agent Service";
      NewPackage."Source Type" := 14000822;
      NewPackage."Source Subtype" := 0;
      NewPackage."Source ID" := BillOfLading."No.";

      NewPackage.COD := BillOfLading."COD Payment";
      NewPackage."COD Amount" := BillOfLading."COD Amount";
      NewPackage."COD Cashiers Check" := BillOfLading."COD Cashiers Check";
      NewPackage."Add Shipping Charge to COD Amt" := BillOfLading."Add Shipping Charge to COD Amt";
      NewPackage."Shipping Payment Type" := BillOfLading."Shipping Payment Type";
      IF BillOfLading."Third Party Ship. Account No." <> '' THEN
        NewPackage."Third Party Ship. Account No." := BillOfLading."Third Party Ship. Account No.";
      IF BillOfLading."Ship-to Phone No." <> '' THEN
        NewPackage."Ship-to Phone No." := BillOfLading."Ship-to Phone No.";
      NewPackage.MODIFY;

      PackageLineFilter := '';
      PostedPackageLineFilter := '';
      LineItemsCreated := '';
      PackageCount := 0;
      BillOfLadingLine.RESET;
      BillOfLadingLine.SETRANGE("Bill of Lading No.",BillOfLading."No.");
      BillOfLadingLine.SETFILTER(Type,'Order|Package');
      IF BillOfLadingLine.FINDFIRST THEN
        REPEAT
          CASE BillOfLadingLine.Type OF
            BillOfLadingLine.Type::Order:
              BEGIN
                SalesOrder.RESET;
                SalesOrder.SETRANGE("Document Type",SalesOrder."Document Type"::Order);
                SalesOrder.SETRANGE("No.",BillOfLadingLine."No.");
                IF SalesOrder.FINDFIRST THEN
                  REPEAT
                    Package.RESET;
                    Package.SETCURRENTKEY("Source Type","Source Subtype","Source ID");
                    Package.SETRANGE("Source Type",36);
                    Package.SETRANGE("Source Subtype",1);
                    Package.SETRANGE("Source ID",SalesOrder."No.");
                    IF Package.FINDFIRST THEN
                      REPEAT
                        IF PackageLineFilter = '' THEN
                          PackageLineFilter := PackageLineFilter + Package."No."
                        ELSE
                          PackageLineFilter := PackageLineFilter + '|' + Package."No.";
                        PackageCount += 1;
                        Package.CALCFIELDS("Exist in Other Package");
                        IF NOT Package."Exist in Other Package" THEN BEGIN
                          PackageClosed := Package.Closed;
                          IF PackageClosed THEN
                            BEGIN
                              Package.Closed := FALSE;
                              Package.MODIFY;
                            END;
                          ShippingSetup.TESTFIELD("Prepack Shipping Agent Code");
                          ShippingSetup.TESTFIELD("Prepack Shipping Agent Service");
                          CarrierPackingStation.TESTFIELD("Default FedEx Freight Service");
                          Package.TESTFIELD(Closed,FALSE);
                          IF ((Package."Shipping Agent Code" = ShippingSetup."Prepack Shipping Agent Code") AND
                              (Package."Shipping Agent Service" = ShippingSetup."Prepack Shipping Agent Service"))
                          THEN BEGIN
                            IF ShippingAgentService.GET(BillOfLading."Shipping Agent Code",BillOfLading."Shipping Agent Service") THEN
                              BEGIN
                                Package.VALIDATE("Shipping Agent Code",BillOfLading."Shipping Agent Code");
                                Package.VALIDATE("Shipping Agent Service",BillOfLading."Shipping Agent Service");
                              END ELSE BEGIN
                                Package.VALIDATE("Shipping Agent Code",'FEDEX');
                                Package.VALIDATE("Shipping Agent Service",CarrierPackingStation."Default FedEx Freight Service");
                              END;
                          END;
                          Package."Manual Shipment" := TRUE;
                          Package.Closed := PackageClosed;
                          Package.MODIFY;
                        END;
                      UNTIL Package.NEXT = 0;
                  UNTIL SalesOrder.NEXT = 0;
              END;
            BillOfLadingLine.Type::Package:
              BEGIN
                BillOfLadingLine2.RESET;
                BillOfLadingLine2.SETRANGE("Bill of Lading No.",BillOfLading."No.");
                BillOfLadingLine2.SETRANGE(Type,BillOfLadingLine2.Type::Package);
                IF BillOfLadingLine2.FINDFIRST THEN
                  REPEAT
                    PostedPackage.RESET;
                    PostedPackage.SETCURRENTKEY("No.");
                    PostedPackage.SETRANGE("No.",BillOfLadingLine2."No.");
                    IF PostedPackage.FINDFIRST THEN
                      REPEAT
                        IF PostedPackageLineFilter = '' THEN
                          PostedPackageLineFilter := PostedPackageLineFilter + PostedPackage."No."
                        ELSE
                          PostedPackageLineFilter := PostedPackageLineFilter + '|' + PostedPackage."No.";
                        PackageCount += 1;
                      UNTIL PostedPackage.NEXT = 0;
                  UNTIL BillOfLadingLine2.NEXT = 0;
              END;
          END;
        UNTIL BillOfLadingLine.NEXT = 0;

      IF PackageLineFilter <> '' THEN BEGIN
        NewPackageLineNo := 0;
        PackageLine.RESET;
        PackageLine.SETFILTER("Package No.",PackageLineFilter);
        PackageLine.SETFILTER(Type,'Item|Package');
        IF PackageLine.FINDFIRST THEN
          REPEAT
            IF PackageLine.Type = PackageLine.Type::Package THEN
              PackageCount -= 1
            ELSE BEGIN
              LineExists := FALSE;
              NewPackageLine.COPY(PackageLine);
              NewPackageLine."Package No." := NewPackage."No.";
              NewPackageLineNo += 10000;
              NewPackageLine."Line No." := NewPackageLineNo;
              IF NewPackageLine."LTL Freight Type" = '' THEN
                NewPackageLine."LTL Freight Type" := ShippingAgentService."Default LTL Freight Type";
              IF NewPackageLine."NMFC Code" = '' THEN
                NewPackageLine."NMFC Code" := ShippingSetup."Default NMFC Code";

              HazMatItem.RESET;
              HazMatItem.SETRANGE(HazMatItem.Type,NewPackageLine.Type);
              HazMatItem.SETRANGE("No.",NewPackageLine."No.");
              IF HazMatItem.FINDFIRST THEN BEGIN
                NewPackageLine."FXF Hazmat" := TRUE;
                NewPackageLine."FXF Hazmat Item No." := NewPackageLine."No.";
                HazMat := TRUE;
              END;
              IF STRPOS(LineItemsCreated,NewPackageLine."No.") = 0 THEN
                LineItemsCreated += STRSUBSTNO('%1 ',NewPackageLine."No.")
              ELSE
                BEGIN
                  ExistingPackageLine.RESET;
                  ExistingPackageLine.SETFILTER("Package No.",NewPackage."No.");
                  ExistingPackageLine.SETRANGE(Type,ExistingPackageLine.Type::Item);
                  ExistingPackageLine.SETRANGE("No.",NewPackageLine."No.");
                  IF ExistingPackageLine.FINDFIRST THEN
                    BEGIN
                      LineExists := TRUE;
                      ExistingPackageLine.VALIDATE(Quantity,ExistingPackageLine.Quantity +
                        NewPackageLine.Quantity);
                            ExistingPackageLine.VALIDATE("Net Weight",ExistingPackageLine."Net Weight" +
                              NewPackageLine."Net Weight");
                      ExistingPackageLine.VALIDATE("Handling Units",ExistingPackageLine."Handling Units" +
                        NewPackageLine."Handling Units");
                      ExistingPackageLine.MODIFY;
                    END;
                END;
              IF NOT LineExists THEN
                NewPackageLine.INSERT(TRUE);
            END;
          UNTIL PackageLine.NEXT = 0;
        END;

      IF PostedPackageLineFilter <> '' THEN BEGIN
        PostedPackageLine.RESET;
        PostedPackageLine.SETFILTER("Package No.",PostedPackageLineFilter);
        PostedPackageLine.SETRANGE(Type,PostedPackageLine.Type::Item);
        IF PostedPackageLine.FINDFIRST THEN
          REPEAT
            IF PostedPackageLine.Type = PostedPackageLine.Type::Package THEN
              PackageCount -= 1
            ELSE BEGIN
              NewPackageLine.TRANSFERFIELDS(PostedPackageLine);
              NewPackageLine."Package No." := NewPackage."No.";
              NewPackageLineNo += 10000;
              NewPackageLine."Line No." := NewPackageLineNo;
                    IF NewPackageLine."LTL Freight Type" = '' THEN
                      NewPackageLine."LTL Freight Type" := ShippingAgentService."Default LTL Freight Type";
                    IF NewPackageLine."NMFC Code" = '' THEN
                      NewPackageLine."NMFC Code" := ShippingSetup."Default NMFC Code";
              HazMatItem.RESET;
              HazMatItem.SETRANGE(HazMatItem.Type,NewPackageLine.Type);
              HazMatItem.SETRANGE("No.",NewPackageLine."No.");
              IF HazMatItem.FINDFIRST THEN BEGIN
                      NewPackageLine."FXF Hazmat" := TRUE;
                      NewPackageLine."FXF Hazmat Item No." := NewPackageLine."No.";
                      HazMat := TRUE;
                    END;
              IF STRPOS(LineItemsCreated,NewPackageLine."No.") = 0 THEN
                LineItemsCreated += STRSUBSTNO('%1 ',NewPackageLine."No.")
              ELSE
                BEGIN
                  ExistingPackageLine.RESET;
                  ExistingPackageLine.SETFILTER("Package No.",NewPackage."No.");
                  ExistingPackageLine.SETRANGE(Type,ExistingPackageLine.Type::Item);
                  ExistingPackageLine.SETRANGE("No.",NewPackageLine."No.");
                  IF ExistingPackageLine.FINDFIRST THEN
                    BEGIN
                      LineExists := TRUE;
                      ExistingPackageLine.VALIDATE(Quantity,ExistingPackageLine.Quantity +
                        NewPackageLine.Quantity);
                            ExistingPackageLine.VALIDATE("Net Weight",ExistingPackageLine."Net Weight" +
                              NewPackageLine."Net Weight");
                      ExistingPackageLine.VALIDATE("Handling Units",ExistingPackageLine."Handling Units" +
                        NewPackageLine."Handling Units");
                      ExistingPackageLine.MODIFY;
                    END;
                END;
              IF NOT LineExists THEN
                NewPackageLine.INSERT(TRUE);
            END;
          UNTIL PostedPackageLine.NEXT = 0;
        END;

            IF NOT FedExOptionPage.GET(FedExOptionPage.Type::Package,NewPackage."No.",0,0) THEN
              BEGIN
                BOLFedExOptionPage.GET(BOLFedExOptionPage.Type::"Bill of Lading",BillOfLading."No.",0,0);
                FedExOptionPage.INIT;
                FedExOptionPage.COPY(BOLFedExOptionPage);
                FedExOptionPage.Type := FedExOptionPage.Type::Package;
                FedExOptionPage."Source ID" := NewPackage."No.";
                FedExOptionPage."Source Type" := 0;
                FedExOptionPage."Source Subtype" := 0;
                FedExOptionPage.INSERT(TRUE);
              END;
            IF HazMat THEN BEGIN
              FedExOptionPage.Hazmat := TRUE;
              FedExOptionPage."Dangerous Goods" := TRUE;
              FedExOptionPage."Dangerous Goods Access. Type" := FedExOptionPage."Dangerous Goods Access. Type"::" ";
            END;
            FedExOptionPage.MODIFY(TRUE);
            IF NOT BOLFedExOptionPageExt.GET(BOLFedExOptionPage.Type::"Bill of Lading",BillOfLading."No.",0,0) THEN
              BOLFedExOptionPageExt.INIT;
            IF NOT FedExOptionPageExt.GET(FedExOptionPage.Type::Package,NewPackage."No.",0,0) THEN
              BEGIN
                FedExOptionPageExt.INIT;
                FedExOptionPageExt.COPY(BOLFedExOptionPage);
                FedExOptionPageExt.Type := FedExOptionPageExt.Type::Package;
                FedExOptionPageExt."Source ID" := NewPackage."No.";
                FedExOptionPageExt."Source Type" := 0;
                FedExOptionPageExt."Source Subtype" := 0;
                FedExOptionPageExt.INSERT(TRUE);
              END;
            IF NOT FedExOptionPageExt.GET(FedExOptionPageExt.Type::Package,NewPackage."No.",0,0) THEN
              BEGIN
                FedExOptionPageExt.INIT;
                FedExOptionPageExt.COPY(BOLFedExOptionPageExt);
                FedExOptionPageExt.Type := FedExOptionPageExt.Type::Package;
                FedExOptionPageExt."Source ID" := NewPackage."No.";
                FedExOptionPageExt."Source Type" := 0;
                FedExOptionPageExt."Source Subtype" := 0;
                FedExOptionPageExt.INSERT(TRUE);
              END;
            FedExOptionPageExt."FX Freight Comment" := BOLFedExOptionPageExt."FX Freight Comment";
            FedExOptionPageExt.Palletized := BOLFedExOptionPageExt.Palletized;
            FedExOptionPageExt."FX Freight Pallet Weight Units" := BOLFedExOptionPageExt."FX Freight Pallet Weight Units";
            FedExOptionPageExt."FX Freight Pallet Weight Value" := BOLFedExOptionPageExt."FX Freight Pallet Weight Value";
            FedExOptionPageExt."No. of Pallets" := BOLFedExOptionPageExt."No. of Pallets";

            FedExOptionPageExt."Special Delivery Instructions" := BOLFedExOptionPageExt."Special Delivery Instructions";
            FedExOptionPageExt.MODIFY(TRUE);
            IF FedExOptionPageExt."No. of Pallets" <> 0 THEN
              NewPackage."Total Handling Units" := FedExOptionPageExt."No. of Pallets"
            ELSE
              NewPackage."Total Handling Units" := PackageCount;
            ClosePackage(NewPackage,Package2,ShippingAgent,TRUE);
            IF NOT PackingStation."Close Package Command" AND
               NOT PackingStation."Close Package Print Command"
            THEN
              PackingStation.TESTFIELD("Close Package Command");
            NewPackage.TESTFIELD(Closed);
            Shipping.PostPackage(NewPackage,'','',WORKDATE);
            BillOfLading."External Tracking No." := NewPackage."External Tracking No.";
            BillOfLading."FedEx Generated Package No." := NewPackage."No.";
            IF NewPackage."Net Weight" = 0 THEN
              NewPackage."Net Weight" := NewPackage."Gross Weight";
            BillOfLading."Calculation Weight" := NewPackage."Net Weight";
            BillOfLading."Shipping Charge" := NewPackage."Shipping Charge";
            BillOfLading."Shipping Cost" := NewPackage."Shipping Cost";
            BillOfLading.MODIFY;
            IF NOT FedExOptionPage.GET(FedExOptionPage.Type::"Bill of Lading",BillOfLading."No.",0,0) THEN
              BEGIN
                FedExOptionPage.INIT;
                FedExOptionPage.Type := FedExOptionPage.Type::"Bill of Lading";
                FedExOptionPage."Source ID" := BillOfLading."No.";
                FedExOptionPage."Source Type" := 0;
                FedExOptionPage."Source Subtype" := 0;
                FedExOptionPage.INSERT(TRUE);
              END;
            IF HazMat THEN
              FedExOptionPage.Hazmat := TRUE;
            FedExOptionPage."FedEx Freight Generated Pkg." := NewPackage."No.";
            FedExOptionPage.MODIFY(TRUE);
            IF PackageLineFilter <> '' THEN BEGIN
              Package.RESET;
              Package.SETFILTER("No.",PackageLineFilter);
              IF Package.FINDFIRST THEN
                REPEAT
                  IF FedExOptionPage.GET(FedExOptionPage.Type::Package,Package."No.",0,0) THEN
                    BEGIN
                      FedExOptionPage."FedEx Freight Generated Pkg." := NewPackage."No.";
                      FedExOptionPage.MODIFY;
                    END;
                  Package."External Tracking No." := NewPackage."External Tracking No.";
                  Package.MODIFY;
                UNTIL Package.NEXT = 0;
            END;
            IF CarrierPackingStation."Auto Distr. FX Freight Charge" THEN
              BillOfLadingMgt.DistributeShippingCharge(BillOfLading);
    END;

    PROCEDURE CreateFedExBOLByClass@1240020005(VAR BillOfLading@1240020000 : Record 14000822);
    VAR
      PackageManagement@1240020001 : Codeunit 14000702;
      BillOfLadingMgt@1240020020 : Codeunit 14000821;
      SalesOrder@1240020009 : Record 36;
      Package@1240020002 : Record 14000701;
      SalesShipment@1240020032 : Record 110;
      NewPackage@1240020006 : Record 14000701;
      Package2@1240020011 : Record 14000701;
      PackageLine@1240020003 : Record 14000702;
      NewPackageLine@1240020008 : Record 14000702;
      ExistingPackageLine@1240020017 : Record 14000702;
      PostedPackage@1240020013 : Record 14000704;
      PostedPackageLine@1240020015 : Record 14000705;
      PackingControl@1240020004 : Record 14000717;
      BillOfLadingLine@1240020005 : Record 14000823;
      BillOfLadingLine2@1240020012 : Record 14000823;
      FedExOptionPage@1240020021 : Record 14000781;
      FedExOptionPageExt@1240020027 : Record 14000793;
      PackageLineFilter@1240020007 : Text[1000];
      PostedPackageLineFilter@1240020014 : Text[1000];
      LineItemsCreated@1240020018 : Text[1000];
      PackageCount@1240020019 : Integer;
      NewPackageLineNo@1240020010 : Integer;
      LineExists@1240020016 : Boolean;
      PackageClosed@1240020022 : Boolean;
      BOLFedExOptionPage@1240020026 : Record 14000781;
      BOLFedExOptionPageExt@1240020028 : Record 14000793;
      NMFCCode@1240020023 : Record 14000730;
      HazMatItem@1240020024 : Record 14050102;
      HazMat@1240020025 : Boolean;
      NoOfPalletsInput@1240020029 : Page 14000795;
      NoOfPallets@1240020030 : Integer;
      i@1240020031 : Integer;
    BEGIN
      DeleteFedExBOL(BillOfLading);
      GetPackingStation;
      GetShippingSetup;
      CarrierPackingStation.GetPackingStation(PackingStation);
      ShippingAgentService.GET(BillOfLading."Shipping Agent Code",BillOfLading."Shipping Agent Service");
      BillOfLadingLine.RESET;
      BillOfLadingLine.SETRANGE("Bill of Lading No.",BillOfLading."No.");
      BillOfLadingLine.SETRANGE(Type, 1, 3);
      IF BillOfLadingLine.FINDFIRST THEN
        CASE BillOfLadingLine.Type OF
          BillOfLadingLine.Type::Order:
            IF NOT SalesOrder.GET(1,BillOfLadingLine."No.") THEN
              ERROR(Text021,BillOfLadingLine."No.",BillOfLading."No.");
          BillOfLadingLine.Type::Package:
            IF NOT Package.GET(BillOfLadingLine."No.") THEN
              ERROR(Text022,BillOfLadingLine."No.",BillOfLading."No.");
          BillOfLadingLine.Type::"Sales Shipment (Posted)":
            BEGIN
              IF NOT SalesShipment.GET(BillOfLadingLine."No.") THEN
                ERROR(Text027,BillOfLadingLine."No.",BillOfLading."No.");
              IF NOT SalesOrder.GET(1,SalesShipment."Order No.") THEN
                ERROR(Text021,BillOfLadingLine."No.",BillOfLading."No.");
           END;
        END;
      PackingControl.INIT;
      IF ((SalesOrder."No." = '') AND (Package."No." = '') AND (SalesShipment."No." = '')) THEN
        ERROR(Text020,BillOfLading."No.");
      IF SalesOrder."No." <> '' THEN
        PackingControl.TransferFromSource(36,1,SalesOrder."No.")
      ELSE
        PackingControl.TransferFromPackage(Package);
      NewPackage.INIT;
      PackageManagement.Initialize(PackingStation,ShippingSetup);
      PackageManagement.CreatePackage(NewPackage,PackingControl);
      NewPackage.Closed := FALSE;
      NewPackage.Miscellaneous := TRUE;
      NewPackage."Shipping Agent Code" := BillOfLading."Shipping Agent Code";
      NewPackage."Shipping Agent Service" := BillOfLading."Shipping Agent Service";
      NewPackage."Source Type" := 14000822;
      NewPackage."Source Subtype" := 0;
      NewPackage."Source ID" := BillOfLading."No.";
      NewPackage.COD := BillOfLading."COD Payment";
      NewPackage."COD Amount" := BillOfLading."COD Amount";
      NewPackage."COD Cashiers Check" := BillOfLading."COD Cashiers Check";
      NewPackage."Add Shipping Charge to COD Amt" := BillOfLading."Add Shipping Charge to COD Amt";
      NewPackage."Shipping Payment Type" := BillOfLading."Shipping Payment Type";
      IF BillOfLading."Third Party Ship. Account No." <> '' THEN
        NewPackage."Third Party Ship. Account No." := BillOfLading."Third Party Ship. Account No.";
      IF BillOfLading."Ship-to Phone No." <> '' THEN
        NewPackage."Ship-to Phone No." := BillOfLading."Ship-to Phone No.";
      NewPackage.MODIFY;
      PackageLineFilter := '';
      PostedPackageLineFilter := '';
      LineItemsCreated := '';
      PackageCount := 0;
      BillOfLadingLine.RESET;
      BillOfLadingLine.SETRANGE("Bill of Lading No.",BillOfLading."No.");
      BillOfLadingLine.SETRANGE(Type, 1, 3);
      IF BillOfLadingLine.FINDFIRST THEN
        REPEAT
          CASE BillOfLadingLine.Type OF
            BillOfLadingLine.Type::Order:
              BEGIN
                SalesOrder.RESET;
                SalesOrder.SETRANGE("Document Type",SalesOrder."Document Type"::Order);
                SalesOrder.SETRANGE("No.",BillOfLadingLine."No.");
                IF SalesOrder.FINDFIRST THEN
                  REPEAT
                    Package.RESET;
                    Package.SETCURRENTKEY("Source Type","Source Subtype","Source ID");
                    Package.SETRANGE("Source Type",36);
                    Package.SETRANGE("Source Subtype",1);
                    Package.SETRANGE("Source ID",SalesOrder."No.");
                    IF Package.FINDFIRST THEN
                      REPEAT
                        IF PackageLineFilter = '' THEN
                          PackageLineFilter := PackageLineFilter + Package."No."
                        ELSE
                          PackageLineFilter := PackageLineFilter + '|' + Package."No.";
                        PackageCount += 1;
                        Package.CALCFIELDS("Exist in Other Package");
                        IF NOT Package."Exist in Other Package" THEN BEGIN
                          PackageClosed := Package.Closed;
                          IF PackageClosed THEN
                            BEGIN
                              Package.Closed := FALSE;
                              Package.MODIFY;
                            END;
                          ShippingSetup.TESTFIELD("Prepack Shipping Agent Code");
                          ShippingSetup.TESTFIELD("Prepack Shipping Agent Service");
                          CarrierPackingStation.TESTFIELD("Default FedEx Freight Service");
                          Package.TESTFIELD(Closed,FALSE);
                          IF ((Package."Shipping Agent Code" = ShippingSetup."Prepack Shipping Agent Code") AND
                              (Package."Shipping Agent Service" = ShippingSetup."Prepack Shipping Agent Service"))
                          THEN BEGIN
                            IF ShippingAgentService.GET(BillOfLading."Shipping Agent Code",BillOfLading."Shipping Agent Service") THEN
                              BEGIN
                                Package.VALIDATE("Shipping Agent Code",BillOfLading."Shipping Agent Code");
                                Package.VALIDATE("Shipping Agent Service",BillOfLading."Shipping Agent Service");
                              END ELSE BEGIN
                                Package.VALIDATE("Shipping Agent Code",'FEDEX');
                                Package.VALIDATE("Shipping Agent Service",CarrierPackingStation."Default FedEx Freight Service");
                              END;
                          END;
                          Package."Manual Shipment" := TRUE;
                          Package.Closed := PackageClosed;
                          Package.MODIFY;
                        END;
                      UNTIL Package.NEXT = 0;
                  UNTIL SalesOrder.NEXT = 0;
              END;
            BillOfLadingLine.Type::Package:
              BEGIN
                BillOfLadingLine2.RESET;
                BillOfLadingLine2.SETRANGE("Bill of Lading No.",BillOfLading."No.");
                BillOfLadingLine2.SETRANGE(Type,BillOfLadingLine2.Type::Package);
                IF BillOfLadingLine2.FINDFIRST THEN
                  REPEAT
                    PostedPackage.RESET;
                    PostedPackage.SETCURRENTKEY("No.");
                    PostedPackage.SETRANGE("No.",BillOfLadingLine2."No.");
                    IF PostedPackage.FINDFIRST THEN
                      REPEAT
                        IF PostedPackageLineFilter = '' THEN
                          PostedPackageLineFilter := PostedPackageLineFilter + PostedPackage."No."
                        ELSE
                          PostedPackageLineFilter := PostedPackageLineFilter + '|' + PostedPackage."No.";
                        PackageCount += 1;
                      UNTIL PostedPackage.NEXT = 0;
                  UNTIL BillOfLadingLine2.NEXT = 0;
              END;
            BillOfLadingLine.Type::"Sales Shipment (Posted)":
              BEGIN
                PostedPackage.RESET;
                PostedPackage.SETCURRENTKEY("Source Type","Source Subtype","Posted Source ID","Bill of Lading No.");
                PostedPackage.SETRANGE("Source Type",36);
                PostedPackage.SETRANGE("Posted Source ID",BillOfLadingLine."No.");
                IF PostedPackage.FINDFIRST THEN
                  REPEAT
                    IF PostedPackageLineFilter = '' THEN
                      PostedPackageLineFilter := PostedPackageLineFilter + PostedPackage."No."
                    ELSE
                      IF STRPOS(PostedPackageLineFilter,PostedPackage."No.") = 0 THEN
                        PostedPackageLineFilter := PostedPackageLineFilter + '|' + PostedPackage."No.";
                    PackageCount += 1;
                  UNTIL PostedPackage.NEXT = 0;
              END;
          END;
        UNTIL BillOfLadingLine.NEXT = 0;
      IF PackageLineFilter <> '' THEN BEGIN
        NewPackageLineNo := 0;
        PackageLine.RESET;
        PackageLine.SETFILTER("Package No.",PackageLineFilter);
        PackageLine.SETFILTER(Type,'Item|Package');
        IF PackageLine.FINDLAST THEN
          NewPackageLineNo := PackageLine."Line No.";
        IF PackageLine.FINDFIRST THEN
          REPEAT
            IF PackageLine.Type = PackageLine.Type::Package THEN
              PackageCount -= 1
            ELSE BEGIN
              LineExists := FALSE;
              NewPackageLine.COPY(PackageLine);
              NewPackageLine."Package No." := NewPackage."No.";
              NewPackageLineNo += 10000;
              NewPackageLine."Line No." := NewPackageLineNo;
              IF NewPackageLine."LTL Freight Type" = '' THEN
                NewPackageLine."LTL Freight Type" := ShippingAgentService."Default LTL Freight Type";
              IF NewPackageLine."NMFC Code" = '' THEN
                NewPackageLine."NMFC Code" := ShippingSetup."Default NMFC Code";
              HazMatItem.RESET;
              HazMatItem.SETRANGE(HazMatItem.Type,NewPackageLine.Type);
              HazMatItem.SETRANGE("No.",NewPackageLine."No.");
              IF HazMatItem.FINDFIRST THEN BEGIN
                NewPackageLine."FXF Hazmat" := TRUE;
                NewPackageLine."FXF Hazmat Item No." := NewPackageLine."No.";
                HazMat := TRUE;
              END;
              NewPackageLine.Type := NewPackageLine.Type::" ";
              NewPackageLine."No." := '';
              NMFCCode.GET(NewPackageLine."NMFC Code");
              NewPackageLine.Description := NMFCCode.Description;
              IF STRPOS(LineItemsCreated,STRSUBSTNO('%1~%2',
                NewPackageLine."LTL Freight Type",NewPackageLine."NMFC Code")) = 0 THEN
                  LineItemsCreated += STRSUBSTNO('%1~%2 ',
                    NewPackageLine."LTL Freight Type",NewPackageLine."NMFC Code")
              ELSE
                BEGIN
                  ExistingPackageLine.RESET;
                  ExistingPackageLine.SETFILTER("Package No.",NewPackage."No.");
                  ExistingPackageLine.SETRANGE(Type,ExistingPackageLine.Type::" ");
                  ExistingPackageLine.SETRANGE("No.",'');
                  ExistingPackageLine.SETRANGE("LTL Freight Type",NewPackageLine."LTL Freight Type");
                  ExistingPackageLine.SETRANGE("NMFC Code",NewPackageLine."NMFC Code");
                  IF ExistingPackageLine.FINDFIRST THEN BEGIN
                    LineExists := TRUE;
                    ExistingPackageLine.VALIDATE(Quantity,ExistingPackageLine.Quantity +
                      NewPackageLine.Quantity);
                    ExistingPackageLine.VALIDATE("Net Weight",ExistingPackageLine."Net Weight" +
                      NewPackageLine."Net Weight");
                    ExistingPackageLine.VALIDATE("Handling Units",ExistingPackageLine."Handling Units" +
                      NewPackageLine."Handling Units");
                    ExistingPackageLine.MODIFY;
                  END;
                END;
              IF NOT LineExists THEN
                NewPackageLine.INSERT(TRUE);
            END;
          UNTIL PackageLine.NEXT = 0;
        END;
      IF PostedPackageLineFilter <> '' THEN BEGIN
        PostedPackageLine.RESET;
        PostedPackageLine.SETFILTER("Package No.",PostedPackageLineFilter);
        PostedPackageLine.SETRANGE(Type,PostedPackageLine.Type::Item);
        IF PostedPackageLine.FINDFIRST THEN
          REPEAT
            IF PostedPackageLine.Type = PostedPackageLine.Type::Package THEN
              PackageCount -= 1
            ELSE BEGIN
              NewPackageLine.TRANSFERFIELDS(PostedPackageLine);
              NewPackageLine."Package No." := NewPackage."No.";
              NewPackageLineNo += 10000;
              NewPackageLine."Line No." := NewPackageLineNo;
              IF NewPackageLine."LTL Freight Type" = '' THEN
                NewPackageLine."LTL Freight Type" := ShippingAgentService."Default LTL Freight Type";
              IF NewPackageLine."NMFC Code" = '' THEN
                NewPackageLine."NMFC Code" := ShippingSetup."Default NMFC Code";
              HazMatItem.RESET;
              HazMatItem.SETRANGE(HazMatItem.Type,NewPackageLine.Type);
              HazMatItem.SETRANGE("No.",NewPackageLine."No.");
              IF HazMatItem.FINDFIRST THEN BEGIN
                NewPackageLine."FXF Hazmat" := TRUE;
                NewPackageLine."FXF Hazmat Item No." := NewPackageLine."No.";
                HazMat := TRUE;
              END;
              NewPackageLine.Type := NewPackageLine.Type::" ";
              NewPackageLine."No." := '';
              NMFCCode.GET(NewPackageLine."NMFC Code");
              NewPackageLine.Description := NMFCCode.Description;
              IF STRPOS(LineItemsCreated,STRSUBSTNO('%1~%2',
                NewPackageLine."LTL Freight Type",NewPackageLine."NMFC Code")) = 0 THEN
                  LineItemsCreated += STRSUBSTNO('%1~%2 ',
                    NewPackageLine."LTL Freight Type",NewPackageLine."NMFC Code")
              ELSE
                BEGIN
                  ExistingPackageLine.RESET;
                  ExistingPackageLine.SETFILTER("Package No.",NewPackage."No.");
                  ExistingPackageLine.SETRANGE(Type,ExistingPackageLine.Type::" ");
                  ExistingPackageLine.SETRANGE("No.",'');
                  ExistingPackageLine.SETRANGE("LTL Freight Type",NewPackageLine."LTL Freight Type");
                  ExistingPackageLine.SETRANGE("NMFC Code",NewPackageLine."NMFC Code");
                  IF ExistingPackageLine.FINDFIRST THEN BEGIN
                    LineExists := TRUE;
                    ExistingPackageLine.VALIDATE(Quantity,ExistingPackageLine.Quantity +
                      NewPackageLine.Quantity);
                    ExistingPackageLine.VALIDATE("Net Weight",ExistingPackageLine."Net Weight" +
                      NewPackageLine."Net Weight");
                    ExistingPackageLine.VALIDATE("Handling Units",ExistingPackageLine."Handling Units" +
                      NewPackageLine."Handling Units");
                    ExistingPackageLine.MODIFY;
                  END;
                END;
              IF NOT LineExists THEN
                NewPackageLine.INSERT(TRUE);
            END;
          UNTIL PostedPackageLine.NEXT = 0;
        END;
      IF NOT FedExOptionPage.GET(FedExOptionPage.Type::Package,NewPackage."No.",0,0) THEN
        BEGIN
          BOLFedExOptionPage.GET(BOLFedExOptionPage.Type::"Bill of Lading",BillOfLading."No.",0,0);
          FedExOptionPage.INIT;
          FedExOptionPage.COPY(BOLFedExOptionPage);
          FedExOptionPage.Type := FedExOptionPage.Type::Package;
          FedExOptionPage."Source ID" := NewPackage."No.";
          FedExOptionPage."Source Type" := 0;
          FedExOptionPage."Source Subtype" := 0;
          FedExOptionPage.INSERT(TRUE);
        END;
      IF HazMat THEN BEGIN
        FedExOptionPage.Hazmat := TRUE;
        FedExOptionPage."Dangerous Goods" := TRUE;
        FedExOptionPage."Dangerous Goods Access. Type" := FedExOptionPage."Dangerous Goods Access. Type"::" ";
      END;
      FedExOptionPage.MODIFY(TRUE);
      IF NOT BOLFedExOptionPageExt.GET(BOLFedExOptionPage.Type::"Bill of Lading",BillOfLading."No.",0,0) THEN
        BOLFedExOptionPageExt.INIT;
      IF NOT FedExOptionPageExt.GET(FedExOptionPageExt.Type::Package,NewPackage."No.",0,0) THEN
        BEGIN
          FedExOptionPageExt.INIT;
          FedExOptionPageExt.COPY(BOLFedExOptionPageExt);
          FedExOptionPageExt.Type := FedExOptionPageExt.Type::Package;
          FedExOptionPageExt."Source ID" := NewPackage."No.";
          FedExOptionPageExt."Source Type" := 0;
          FedExOptionPageExt."Source Subtype" := 0;
          FedExOptionPageExt.INSERT(TRUE);
        END;
      FedExOptionPageExt."FX Freight Comment" := BOLFedExOptionPageExt."FX Freight Comment";
      FedExOptionPageExt.Palletized := BOLFedExOptionPageExt.Palletized;
      FedExOptionPageExt."FX Freight Pallet Weight Units" := BOLFedExOptionPageExt."FX Freight Pallet Weight Units";
      FedExOptionPageExt."FX Freight Pallet Weight Value" := BOLFedExOptionPageExt."FX Freight Pallet Weight Value";
      FedExOptionPageExt."No. of Pallets" := BOLFedExOptionPageExt."No. of Pallets";

      FedExOptionPageExt."Special Delivery Instructions" := BOLFedExOptionPageExt."Special Delivery Instructions";
      FedExOptionPageExt.MODIFY(TRUE);
      IF FedExOptionPageExt."No. of Pallets" <> 0 THEN
        NewPackage."Total Handling Units" := FedExOptionPageExt."No. of Pallets"
      ELSE
      NewPackage."Total Handling Units" := PackageCount;
      COMMIT;
      ClosePackage(NewPackage,Package2,ShippingAgent,TRUE);

      IF NOT PackingStation."Close Package Command" AND
         NOT PackingStation."Close Package Print Command"
      THEN
        PackingStation.TESTFIELD("Close Package Command");
      NewPackage.TESTFIELD(Closed);
      Shipping.PostPackage(NewPackage,'','',WORKDATE);

      BillOfLading."External Tracking No." := NewPackage."External Tracking No.";
      BillOfLading."FedEx Generated Package No." := NewPackage."No.";
      IF NewPackage."Net Weight" = 0 THEN
        NewPackage."Net Weight" := NewPackage."Gross Weight";
      BillOfLading."Calculation Weight" := NewPackage."Net Weight";
      BillOfLading."Shipping Charge" := NewPackage."Shipping Charge";
      BillOfLading."Shipping Cost" := NewPackage."Shipping Cost";
      BillOfLading.MODIFY;

      IF NOT FedExOptionPage.GET(FedExOptionPage.Type::"Bill of Lading",BillOfLading."No.",0,0) THEN
        BEGIN
          FedExOptionPage.INIT;
          FedExOptionPage.Type := FedExOptionPage.Type::"Bill of Lading";
          FedExOptionPage."Source ID" := BillOfLading."No.";
          FedExOptionPage."Source Type" := 0;
          FedExOptionPage."Source Subtype" := 0;
          FedExOptionPage.INSERT(TRUE);
        END;
      IF HazMat THEN
        FedExOptionPage.Hazmat := TRUE;
      FedExOptionPage."FedEx Freight Generated Pkg." := NewPackage."No.";
      FedExOptionPage.MODIFY(TRUE);

      IF PackageLineFilter <> '' THEN BEGIN
        Package.RESET;
        Package.SETFILTER("No.",PackageLineFilter);
        IF Package.FINDFIRST THEN
          REPEAT
            IF FedExOptionPage.GET(FedExOptionPage.Type::Package,Package."No.",0,0) THEN
              BEGIN
                FedExOptionPage."FedEx Freight Generated Pkg." := NewPackage."No.";
                FedExOptionPage.MODIFY;
              END;
            Package."External Tracking No." := NewPackage."External Tracking No.";
            Package.MODIFY;
          UNTIL Package.NEXT = 0;
      END;
      IF CarrierPackingStation."Auto Distr. FX Freight Charge" THEN
        BillOfLadingMgt.DistributeShippingCharge(BillOfLading);
    END;

    PROCEDURE CreateFedExBOLByInfoLines@1240020008(VAR BillOfLading@1240020000 : Record 14000822);
    VAR
      PackageManagement@1240020001 : Codeunit 14000702;
      BillOfLadingMgt@1240020020 : Codeunit 14000821;
      SalesOrder@1240020009 : Record 36;
      Package@1240020002 : Record 14000701;
      SalesShipment@1240020032 : Record 110;
      NewPackage@1240020006 : Record 14000701;
      Package2@1240020011 : Record 14000701;
      PackageLine@1240020003 : Record 14000702;
      NewPackageLine@1240020008 : Record 14000702;
      ExistingPackageLine@1240020017 : Record 14000702;
      PostedPackage@1240020013 : Record 14000704;
      PostedPackageLine@1240020015 : Record 14000705;
      PackingControl@1240020004 : Record 14000717;
      BillOfLadingInfoLine@1240020005 : Record 14000827;
      BillOfLadingLine2@1240020012 : Record 14000823;
      FedExOptionPage@1240020021 : Record 14000781;
      FedExOptionPageExt@1240020027 : Record 14000793;
      PackageLineFilter@1240020007 : Text[1000];
      PostedPackageLineFilter@1240020014 : Text[1000];
      LineItemsCreated@1240020018 : Text[1000];
      PackageCount@1240020019 : Integer;
      NewPackageLineNo@1240020010 : Integer;
      LineExists@1240020016 : Boolean;
      PackageClosed@1240020022 : Boolean;
      BOLFedExOptionPage@1240020026 : Record 14000781;
      BOLFedExOptionPageExt@1240020028 : Record 14000793;
      NMFCCode@1240020023 : Record 14000730;
      HazMatItem@1240020024 : Record 14050102;
      HazMat@1240020025 : Boolean;
      NoOfPallets@1240020030 : Integer;
      i@1240020031 : Integer;
    BEGIN
      DeleteFedExBOL(BillOfLading);
      GetPackingStation;
      GetShippingSetup;
      CarrierPackingStation.GetPackingStation(PackingStation);
      ShippingAgentService.GET(BillOfLading."Shipping Agent Code",BillOfLading."Shipping Agent Service");
      IF NOT BOLFedExOptionPage.GET(BOLFedExOptionPage.Type::"Bill of Lading",BillOfLading."No.",0,0) THEN
            BOLFedExOptionPage.INIT;
      IF NOT BOLFedExOptionPageExt.GET(BOLFedExOptionPage.Type::"Bill of Lading",BillOfLading."No.",0,0) THEN
        BOLFedExOptionPageExt.INIT;
      BillOfLadingInfoLine.RESET;
      BillOfLadingInfoLine.SETRANGE("Bill of Lading No.",BillOfLading."No.");
      BillOfLadingInfoLine.SETFILTER("Info. Line Type",'Commodity Info.');
      BillOfLadingInfoLine.SETFILTER(Description,'<>%1','MIXED PALLET(S)');
      IF BillOfLadingInfoLine.FINDFIRST THEN BEGIN
        BillOfLadingInfoLine.TESTFIELD("Packages (Lower Level)");
        BillOfLadingInfoLine.TESTFIELD("Packages (Top Level)");
        NewPackage.INIT;
        PackageManagement.Initialize(PackingStation,ShippingSetup);
        PackageManagement.CreatePackage(NewPackage,PackingControl);
        NewPackage.Closed := FALSE;
        NewPackage.Miscellaneous := TRUE;
        NewPackage."Shipping Agent Account No." := BillOfLading."Shipping Agent Account No.";
        NewPackage."Shipping Agent Code" := BillOfLading."Shipping Agent Code";
        NewPackage."Shipping Agent Service" := BillOfLading."Shipping Agent Service";
        NewPackage."Source Type" := 14000822;
        NewPackage."Source Subtype" := 0;
        NewPackage."Source ID" := BillOfLading."No.";
        NewPackage."Ship-to Address" := BillOfLading."Ship-to Address";
        NewPackage."Ship-to Address 2" := BillOfLading."Ship-to Address 2";
        NewPackage."Ship-to City" := BillOfLading."Ship-to City";
        NewPackage."Ship-to Code" := BillOfLading."Ship-to Code";
        NewPackage."Ship-to Contact" := BillOfLading."Ship-to Contact";
        NewPackage."Ship-to Country Code" := BillOfLading."Ship-to Country Code";
        NewPackage."Ship-to Name" := BillOfLading."Ship-to Name";
        NewPackage."Ship-to Name 2" := BillOfLading."Ship-to Name 2";
        NewPackage."Ship-to No." := BillOfLading."Ship-to No.";
        NewPackage."Ship-to Phone No." := BillOfLading."Ship-to Phone No.";
        NewPackage."Ship-to State" := BillOfLading."Ship-to State";
        NewPackage."Ship-to Type" := BillOfLading."Ship-to Type";
        NewPackage."Ship-to ZIP Code" := BillOfLading."Ship-to ZIP Code";
        NewPackage."Residential Delivery" := BillOfLading."Residential Delivery";
        NewPackage.COD := BillOfLading."COD Payment";
        NewPackage."COD Amount" := BillOfLading."COD Amount";
        NewPackage."COD Cashiers Check" := BillOfLading."COD Cashiers Check";
        NewPackage."Add Shipping Charge to COD Amt" := BillOfLading."Add Shipping Charge to COD Amt";
        NewPackage."Shipping Payment Type" := BillOfLading."Shipping Payment Type";
        IF BillOfLading."Third Party Ship. Account No." <> '' THEN
          NewPackage."Third Party Ship. Account No." := BillOfLading."Third Party Ship. Account No.";
        IF BillOfLading."Ship-to Phone No." <> '' THEN
          NewPackage."Ship-to Phone No." := BillOfLading."Ship-to Phone No.";
        NewPackage."Calculation Weight" := 0;
        NewPackage."Calculation Weight (LBS)" := 0;
        NewPackage."Service Indicator" := ShippingAgentService."Service Indicator";
        NewPackage.MODIFY;
      END;

      NoOfPallets := 0;

      BillOfLadingInfoLine.RESET;
      BillOfLadingInfoLine.SETRANGE("Bill of Lading No.",BillOfLading."No.");
      BillOfLadingInfoLine.SETFILTER("Info. Line Type",'Commodity Info.');
      BillOfLadingInfoLine.SETFILTER(Description,'<>%1','MIXED PALLET(S)');
      IF BillOfLadingInfoLine.FINDFIRST THEN
        REPEAT
          NewPackageLine.INIT;
          NewPackageLine."Package No." := NewPackage."No.";
          NewPackageLineNo += 10000;
          NewPackageLine."Line No." := NewPackageLineNo;
          NewPackageLine.Type := NewPackageLine.Type::" ";
          NewPackageLine."No." := '';
          NewPackageLine.Quantity := BillOfLadingInfoLine."Packages (Lower Level)";
          NewPackageLine."Quantity (Base)" := BillOfLadingInfoLine."Packages (Lower Level)";
          NewPackageLine."Handling Units" := BillOfLadingInfoLine."Packages (Top Level)";
          CASE BillOfLadingInfoLine."Handling Unit Type" OF
            BillOfLadingInfoLine."Handling Unit Type"::Pallets:
              BEGIN
                NewPackageLine."Unit of Measure Code" := 'PALLETS';
                NoOfPallets += NewPackageLine."Handling Units";
              END;
            BillOfLadingInfoLine."Handling Unit Type"::Cartons:
              NewPackageLine."Unit of Measure Code" := 'CARTONS';
            BillOfLadingInfoLine."Handling Unit Type"::" ":
              BEGIN
                NewPackageLine."Unit of Measure Code" := 'PALLETS';
                NoOfPallets += NewPackageLine."Handling Units";
              END;
          END;
          NewPackageLine."Qty. per Unit of Measure" := 1;
          NewPackageLine.Description := BillOfLadingInfoLine.Description;
          NewPackageLine."Net Weight" := BillOfLadingInfoLine.Weight;
          NewPackageLine."Gross Weight" := BillOfLadingInfoLine.Weight;
          NewPackageLine."Value (Price)" := BillOfLadingInfoLine.Value;
          NewPackageLine."Value (Cost)" := BillOfLadingInfoLine.Value;
          NewPackageLine.Volume := BillOfLadingInfoLine.Volume;
          NewPackageLine."Source Type" := 14000822;
          NewPackageLine."Source Subtype" := 0;
          NewPackageLine."Source ID" := BillOfLading."No.";
          NewPackage."Calculation Weight" += NewPackageLine."Net Weight";
          NewPackage."Calculation Weight (LBS)" += NewPackageLine."Net Weight";

          IF BillOfLadingInfoLine.Weight <> 0 THEN BEGIN
            IF BillOfLadingInfoLine."LTL Freight Type" = '' THEN
              NewPackageLine."LTL Freight Type" := ShippingAgentService."Default LTL Freight Type"
            ELSE
              NewPackageLine."LTL Freight Type" := BillOfLadingInfoLine."LTL Freight Type";
            IF BillOfLadingInfoLine."NMFC #" = '' THEN
              NewPackageLine."NMFC Code" := ShippingSetup."Default NMFC Code"
            ELSE
              NewPackageLine."NMFC Code" := BillOfLadingInfoLine."NMFC #";
          END;

          NewPackageLine."Line Weight Type" := NewPackageLine."Line Weight Type"::Pounds;

          NewPackageLine."FXF Hazmat" := BillOfLadingInfoLine."Hazardous Material";
          IF NOT HazMat THEN
            HazMat := BillOfLadingInfoLine."Hazardous Material";
          HazMatItem.RESET;
          HazMatItem.SETRANGE(HazMatItem.Type,HazMatItem.Type::Item);
          HazMatItem.SETRANGE("No.",BillOfLadingInfoLine."HazMat Code");
          IF HazMatItem.FINDFIRST THEN BEGIN
            NewPackageLine."FXF Hazmat" := TRUE;
            NewPackageLine."FXF Hazmat Item No." := HazMatItem."No.";
            HazMat := TRUE;
          END;
          NewPackageLine."Use Unit of measure Dimensions" := FALSE;
          NewPackageLine."Unit Length" := ShippingSetup."Default Pallet Length";
          NewPackageLine."Unit Width" := ShippingSetup."Default Pallet Width";
          NewPackageLine."Unit Height" := ShippingSetup."Default Pallet Height (Packed)";
          IF BOLFedExOptionPageExt."FX Freight Pallet Length" <> 0 THEN
            NewPackageLine."Unit Length" := BOLFedExOptionPageExt."FX Freight Pallet Length";
          IF BOLFedExOptionPageExt."FX Freight Pallet Width" <> 0 THEN
            NewPackageLine."Unit Width" := BOLFedExOptionPageExt."FX Freight Pallet Width";
          IF BOLFedExOptionPageExt."FX Freight Pallet Height" <> 0 THEN
            NewPackageLine."Unit Height" := BOLFedExOptionPageExt."FX Freight Pallet Height";
          IF NMFCCode.GET(NewPackageLine."NMFC Code") THEN
            NewPackageLine.Description := NMFCCode.Description;
          NewPackageLine.INSERT(TRUE);
        UNTIL BillOfLadingInfoLine.NEXT = 0;

      NewPackage.MODIFY;

      IF NOT FedExOptionPage.GET(FedExOptionPage.Type::Package,NewPackage."No.",0,0) THEN
        BEGIN
          IF NOT BOLFedExOptionPage.GET(BOLFedExOptionPage.Type::"Bill of Lading",BillOfLading."No.",0,0) THEN
            BOLFedExOptionPage.INIT;
          FedExOptionPage.INIT;
          FedExOptionPage.COPY(BOLFedExOptionPage);
          FedExOptionPage.Type := FedExOptionPage.Type::Package;

          FedExOptionPage."Source ID" := NewPackage."No.";
          FedExOptionPage."Source Type" := 0;
          FedExOptionPage."Source Subtype" := 0;
          FedExOptionPage.INSERT;
        END;
      IF HazMat THEN BEGIN
        FedExOptionPage.Hazmat := TRUE;
        FedExOptionPage."Hazmat Option Type" := FedExOptionPage."Hazmat Option Type"::HAZARDOUS_MATERIALS;
        FedExOptionPage."Dangerous Goods" := TRUE;
        FedExOptionPage."Dangerous Goods Access. Type" := FedExOptionPage."Dangerous Goods Access. Type"::" ";
      END;
      FedExOptionPage.MODIFY(TRUE);
      IF NOT BOLFedExOptionPageExt.GET(BOLFedExOptionPage.Type::"Bill of Lading",BillOfLading."No.",0,0) THEN
        BOLFedExOptionPageExt.INIT;
      IF NOT FedExOptionPageExt.GET(FedExOptionPageExt.Type::Package,NewPackage."No.",0,0) THEN
        BEGIN
          IF NOT BOLFedExOptionPageExt.GET(BOLFedExOptionPageExt.Type::"Bill of Lading",BillOfLading."No.",0,0) THEN
            BOLFedExOptionPageExt.INIT;
          FedExOptionPageExt.INIT;
          FedExOptionPageExt.COPY(BOLFedExOptionPageExt);
          FedExOptionPageExt.Type := FedExOptionPageExt.Type::Package;
          FedExOptionPageExt."Source ID" := NewPackage."No.";
          FedExOptionPageExt."Source Type" := 0;
          FedExOptionPageExt."Source Subtype" := 0;
          FedExOptionPageExt.INSERT;
        END;
      FedExOptionPageExt."FX Freight Comment" := BOLFedExOptionPageExt."FX Freight Comment";
      IF NoOfPallets > 0 THEN
        BEGIN
          FedExOptionPageExt.Palletized := TRUE;
          FedExOptionPageExt."Physical Packaging Type" :=
            FedExOptionPageExt."Physical Packaging Type"::PALLET
        END
      ELSE
        FedExOptionPageExt."Physical Packaging Type" :=
            FedExOptionPageExt."Physical Packaging Type"::CARTON;

      FedExOptionPageExt."FX Freight Pallet Weight Units" := BOLFedExOptionPageExt."FX Freight Pallet Weight Units";
      FedExOptionPageExt."FX Freight Pallet Weight Value" := BOLFedExOptionPageExt."FX Freight Pallet Weight Value";
      FedExOptionPageExt."No. of Pallets" := NoOfPallets;

      FedExOptionPageExt."Special Delivery Instructions" := BOLFedExOptionPageExt."Special Delivery Instructions";
      FedExOptionPageExt.MODIFY(TRUE);
      IF FedExOptionPageExt."No. of Pallets" <> 0 THEN
        NewPackage."Total Handling Units" := FedExOptionPageExt."No. of Pallets"
      ELSE
        NewPackage."Total Handling Units" := PackageCount;
      COMMIT;

      ClosePackage(NewPackage,Package2,ShippingAgent,TRUE);

      IF NOT PackingStation."Close Package Command" AND
         NOT PackingStation."Close Package Print Command"
      THEN
        PackingStation.TESTFIELD("Close Package Command");
      NewPackage.TESTFIELD(Closed);
      Shipping.PostPackage(NewPackage,'','',WORKDATE);

      IF BillOfLading.Released THEN
        BillOfLading.Released := FALSE;
      BillOfLading."External Tracking No." := NewPackage."External Tracking No.";
      BillOfLading."FedEx Generated Package No." := NewPackage."No.";
      IF NewPackage."Net Weight" = 0 THEN
        NewPackage."Net Weight" := NewPackage."Gross Weight";
      BillOfLading."Calculation Weight" := NewPackage."Net Weight";
      BillOfLading."Shipping Charge" := NewPackage."Shipping Charge";
      BillOfLading."Shipping Cost" := NewPackage."Shipping Cost";
      BillOfLading.MODIFY;
      BillOfLading.Released := TRUE;
      BillOfLading.MODIFY;


      IF NOT FedExOptionPage.GET(FedExOptionPage.Type::"Bill of Lading",BillOfLading."No.",0,0) THEN
        BEGIN
          FedExOptionPage.INIT;
          FedExOptionPage.Type := FedExOptionPage.Type::"Bill of Lading";
          FedExOptionPage."Source ID" := BillOfLading."No.";
          FedExOptionPage."Source Type" := 0;
          FedExOptionPage."Source Subtype" := 0;
          FedExOptionPage.INSERT(TRUE);
        END;
      IF HazMat THEN
        FedExOptionPage.Hazmat := TRUE;
      FedExOptionPage."FedEx Freight Generated Pkg." := NewPackage."No.";
      FedExOptionPage.MODIFY;

      IF PackageLineFilter <> '' THEN BEGIN
        Package.RESET;
        Package.SETFILTER("No.",PackageLineFilter);
        IF Package.FINDFIRST THEN
          REPEAT
            IF FedExOptionPage.GET(FedExOptionPage.Type::Package,Package."No.",0,0) THEN
              BEGIN
                FedExOptionPage."FedEx Freight Generated Pkg." := NewPackage."No.";
                FedExOptionPage.MODIFY;
              END;
            Package."External Tracking No." := NewPackage."External Tracking No.";
            Package.MODIFY;
          UNTIL Package.NEXT = 0;
      END;
      IF CarrierPackingStation."Auto Distr. FX Freight Charge" THEN
        BillOfLadingMgt.DistributeShippingCharge(BillOfLading);
    END;

    PROCEDURE ReduceLabelDensity@1240020006(FileName@1240030000 : Text[1000]);
    VAR
      TempFile@1240030002 : File;
      NewFile@1240020005 : File;
      TextFileLine@1240020004 : Text[1024];
      NewFileName@1240020006 : Text[1000];
    BEGIN
      NewFileName := STRSUBSTNO('%1%2',FileName,'x');
      NewFile.CREATE(NewFileName);
      NewFile.CLOSE;
      NewFile.WRITEMODE(TRUE);
      NewFile.TEXTMODE(TRUE);
      NewFile.OPEN(NewFileName);
      TempFile.WRITEMODE(FALSE);
      TempFile.TEXTMODE(TRUE);
      TempFile.OPEN(FileName);
      REPEAT
        TempFile.READ(TextFileLine);
        IF TextFileLine = 'D15' THEN
          TextFileLine := 'D7';
        NewFile.WRITE(TextFileLine);
      UNTIL TempFile.POS = TempFile.LEN;
      TempFile.CLOSE;
      TempFile.WRITEMODE(FALSE);
      TempFile.TEXTMODE(FALSE);
      ERASE(FileName);
      NewFile.CLOSE;
      COPY(NewFileName,FileName);
      ERASE(NewFileName);
    END;

    LOCAL PROCEDURE CheckForBillOfLading@1240020007(FreightPackage@1240020000 : Record 14000701) : Boolean;
    VAR
      BOLLine@1240020001 : Record 14000823;
    BEGIN
      BOLLine.SETCURRENTKEY("Source Type","Source Subtype","Source ID");
      BOLLine.SETRANGE("Source Type",FreightPackage."Source Type");
      BOLLine.SETRANGE("Source Subtype",FreightPackage."Source Subtype");
      BOLLine.SETRANGE("Source ID",FreightPackage."Source ID");
      IF BOLLine.FINDFIRST THEN EXIT(TRUE)
      ELSE
        EXIT(FALSE);
    END;

    EVENT XMLDOMDocument@1240030012::onreadystatechange@-609();
    BEGIN
    END;

    EVENT XMLRequestDocument@1240030017::ondataavailable@198();
    BEGIN
    END;

    EVENT XMLRequestDocument@1240030017::onreadystatechange@-609();
    BEGIN
    END;

    EVENT XMLDocOut@1240030019::ondataavailable@198();
    BEGIN
    END;

    EVENT XMLDocOut@1240030019::onreadystatechange@-609();
    BEGIN
    END;

    BEGIN
    END.
  }
}

