OBJECT Codeunit 2104 O365 Send + Resend Invoice
{
  OBJECT-PROPERTIES
  {
    Date=11/22/17;
    Time=12:00:00 PM;
    Version List=NAVW111.00;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      ThereIsNothingToSellInvoiceErr@1003 : TextConst 'ENU=Please add at least one line item to the invoice.;ESM=Agregue al menos un producto de l¡nea a la factura.;FRC=Ajoutez au moins un article ligne … la facture.;ENC=Please add at least one line item to the invoice.';
      ThereIsNothingToSellQuoteErr@1008 : TextConst 'ENU=Please add at least one line item to the estimate.;ESM=Agregue al menos un producto de l¡nea a la estimaci¢n.;FRC=Ajoutez au moins un article ligne … l''estimation.;ENC=Please add at least one line item to the estimate.';
      InvoiceSendingMsg@1002 : TextConst 'ENU=Your invoice is being sent.;ESM=La factura se est  enviando.;FRC=Votre facture est en cours d''envoi.;ENC=Your invoice is being sent.';
      EstimateSendingMsg@1001 : TextConst 'ENU=Your estimate is being sent.;ESM=La estimaci¢n se est  enviando.;FRC=Votre estimation est en cours d''envoi.;ENC=Your estimate is being sent.';
      CannotSendCanceledDocErr@1000 : TextConst 'ENU=You can''t resend a canceled invoice.;ESM=No puede reenviar una factura cancelada.;FRC=Vous ne pouvez pas renvoyer une facture annul‚e.;ENC=You can''t resend a cancelled invoice.';
      O365SalesEmailManagement@1004 : Codeunit 2151;
      CustomerDoesNotExistInvoiceErr@1009 : TextConst '@@@="%1 = Customer Name";ENU=Customer %1 cannot be found.\\To send the invoice, you must recreate the customer.;ESM=No se encuentra el cliente %1.\\Para enviar la factura, debe volver a crear el registro de cliente.;FRC=Le client %1 est introuvable.\\Pour envoyer la facture, vous devez recr‚er l''enregistrement du client.;ENC=Customer %1 cannot be found.\\To send the invoice, you must recreate the customer.';
      CustomerDoesNotExistQuoteErr@1005 : TextConst '@@@="%1 = Customer Name";ENU=Customer %1 cannot be found.\\To send the estimate, you must recreate the customer.;ESM=No se encuentra el cliente %1.\\Para enviar la estimaci¢n, debe volver a crear el registro de cliente.;FRC=Le client %1 est introuvable.\\Pour envoyer l''estimation, vous devez recr‚er l''enregistrement du client.;ENC=Customer %1 cannot be found.\\To send the estimate, you must recreate the customer.';
      ConfirmPostingZeroAmountInvoiceQst@1010 : TextConst 'ENU=You''re about to save an invoice that will not result in any payment. Continue?;ESM=Est  a punto de guardar una factura que no dar  lugar a ning£n pago. ¨Desea continuar?;FRC=Vous ˆtes sur le point d''enregistrer une facture qui n''implique pas de paiement. Continuerÿ?;ENC=You''re about to save an invoice that will not result in any payment. Continue?';
      ConfirmSendingZeroAmountEstimateQst@1006 : TextConst 'ENU=You''re about to save an estimate that will not result in any payment. Continue?;ESM=Est  a punto de guardar una estimaci¢n que no dar  lugar a ning£n pago. ¨Desea continuar?;FRC=Vous ˆtes sur le point d''enregistrer une estimation qui n''implique pas de paiement. Continuerÿ?;ENC=You''re about to save an estimate that will not result in any payment. Continue?';
      ConfirmConvertToInvoiceQst@1007 : TextConst 'ENU=Do you want to turn the estimate into a draft invoice?;ESM=¨Desea convertir la estimaci¢n en un borrador de factura?;FRC=Souhaitez-vous transformer l''estimation en une facture provisoireÿ?;ENC=Do you want to turn the estimate into a draft invoice?';
      CouponsNotValidMsg@1011 : TextConst 'ENU=One or more coupons are no longer valid. Remove them, and then try again.;ESM=Hay uno o m s cupones que ya no son v lidos. Elim¡nelos y vuelva a intentarlo.;FRC=Un ou plusieurs coupons ne sont plus valides. Supprimez-les et r‚essayez.;ENC=One or more coupons are no longer valid. Remove them, and then try again.';

    PROCEDURE SendOrResendSalesDocument@1(O365SalesDocument@1000 : Record 2103) : Boolean;
    VAR
      SalesInvoiceHeader@1001 : Record 112;
      SalesHeader@1002 : Record 36;
    BEGIN
      WITH O365SalesDocument DO BEGIN
        IF Canceled THEN
          ERROR(CannotSendCanceledDocErr);

        IF Posted THEN BEGIN
          IF NOT SalesInvoiceHeader.GET("No.") THEN
            EXIT(FALSE);
          EXIT(ResendSalesInvoice(SalesInvoiceHeader));
        END;

        IF NOT SalesHeader.GET("Document Type","No.") THEN
          EXIT(FALSE);
        EXIT(SendSalesInvoiceOrOpenPage(SalesHeader,TRUE,O365SalesDocument,TRUE));
      END;
    END;

    PROCEDURE ResendSalesInvoice@2(SalesInvoiceHeader@1000 : Record 112) : Boolean;
    BEGIN
      WITH SalesInvoiceHeader DO BEGIN
        SETRECFILTER;
        CODEUNIT.RUN(CODEUNIT::"O365 Setup Email");

        IF NOT O365SalesEmailManagement.ShowEmailDialog("No.") THEN
          EXIT(FALSE);

        EmailRecords(FALSE);
        MESSAGE(InvoiceSendingMsg);
      END;

      EXIT(TRUE);
    END;

    LOCAL PROCEDURE SendSalesInvoiceOrOpenPage@3(SalesHeader@1000 : Record 36;OpenInvoiceIfNoItems@1001 : Boolean;O365SalesDocument@1002 : Record 2103;ShowMessage@1003 : Boolean) : Boolean;
    BEGIN
      WITH SalesHeader DO BEGIN
        SETRECFILTER;
        IF NOT CheckDocumentCanBeSent(SalesHeader,OpenInvoiceIfNoItems,O365SalesDocument) THEN
          EXIT(FALSE);

        IF NOT O365SalesEmailManagement.ShowEmailDialog("No.") THEN
          EXIT(FALSE);

        FIND;
        IF "Document Type" = "Document Type"::Quote THEN BEGIN
          EmailRecords(FALSE);
          IF ShowMessage THEN
            MESSAGE(EstimateSendingMsg);
        END ELSE BEGIN
          SendToPosting(CODEUNIT::"Sales-Post + Email");
          IF ShowMessage THEN
            MESSAGE(InvoiceSendingMsg);
        END;
      END;

      EXIT(TRUE);
    END;

    PROCEDURE SendSalesInvoiceOrQuote@4(SalesHeader@1000 : Record 36) : Boolean;
    VAR
      O365SalesDocument@1001 : Record 2103;
    BEGIN
      EXIT(SendSalesInvoiceOrOpenPage(SalesHeader,FALSE,O365SalesDocument,TRUE));
    END;

    PROCEDURE SendSalesInvoiceOrQuoteFromBC@9(SalesHeader@1000 : Record 36) : Boolean;
    VAR
      O365SalesDocument@1001 : Record 2103;
    BEGIN
      EXIT(SendSalesInvoiceOrOpenPage(SalesHeader,FALSE,O365SalesDocument,FALSE));
    END;

    PROCEDURE SendInvoiceFromQuote@5(SalesHeader@1000 : Record 36;OpenInvoiceIfNoItems@1003 : Boolean) : Boolean;
    VAR
      O365SalesDocument@1004 : Record 2103;
    BEGIN
      IF NOT CheckDocumentCanBeSent(SalesHeader,OpenInvoiceIfNoItems,O365SalesDocument) THEN
        EXIT(FALSE);

      MakeInvoiceFromQuote(SalesHeader,FALSE);

      IF NOT O365SalesEmailManagement.ShowEmailDialog(SalesHeader."No.") THEN
        EXIT(TRUE);

      SalesHeader.FIND;
      SalesHeader.SendToPosting(CODEUNIT::"Sales-Post + Email");
      MESSAGE(InvoiceSendingMsg);
      EXIT(TRUE);
    END;

    PROCEDURE MakeInvoiceFromQuote@6(VAR SalesHeader@1001 : Record 36;ShowConfirmDialog@1002 : Boolean) : Boolean;
    VAR
      SalesQuoteToInvoice@1000 : Codeunit 1305;
    BEGIN
      IF ShowConfirmDialog THEN
        IF NOT CONFIRM(ConfirmConvertToInvoiceQst,FALSE) THEN
          EXIT(FALSE);

      SalesHeader.LOCKTABLE;
      SalesHeader.FIND;
      SalesQuoteToInvoice.RUN(SalesHeader);
      SalesQuoteToInvoice.GetSalesInvoiceHeader(SalesHeader);
      EXIT(TRUE);
    END;

    LOCAL PROCEDURE CheckDocumentCanBeSent@8(SalesHeader@1000 : Record 36;OpenInvoiceIfNoItems@1002 : Boolean;O365SalesDocument@1003 : Record 2103) : Boolean;
    VAR
      O365CouponClaim@1004 : Record 2115;
      Customer@1001 : Record 18;
      Confirmed@1005 : Boolean;
    BEGIN
      WITH SalesHeader DO BEGIN
        CheckDocumentIfNoItemsExists(SalesHeader,OpenInvoiceIfNoItems,O365SalesDocument);
        IF NOT Customer.GET("Sell-to Customer No.") THEN
          CASE "Document Type" OF
            "Document Type"::Invoice:
              ERROR(STRSUBSTNO(CustomerDoesNotExistInvoiceErr,"Sell-to Customer Name"));
            ELSE
              ERROR(STRSUBSTNO(CustomerDoesNotExistQuoteErr,"Sell-to Customer Name"));
          END;

        // Verify all coupons are still valid
        O365CouponClaim.SETRANGE("Document Type Filter","Document Type");
        O365CouponClaim.SETRANGE("Document No. Filter","No.");
        O365CouponClaim.SETRANGE("Is applied",TRUE);
        O365CouponClaim.SETRANGE("Is Valid",FALSE);
        IF NOT O365CouponClaim.ISEMPTY THEN BEGIN
          MESSAGE(CouponsNotValidMsg);
          EXIT(FALSE);
        END;

        CALCFIELDS("Amount Including VAT");
        IF "Amount Including VAT" = 0 THEN BEGIN
          CASE "Document Type" OF
            "Document Type"::Invoice:
              Confirmed := CONFIRM(ConfirmPostingZeroAmountInvoiceQst);
            ELSE
              Confirmed := CONFIRM(ConfirmSendingZeroAmountEstimateQst);
          END;
          IF NOT Confirmed THEN
            EXIT(FALSE);
        END;

        CODEUNIT.RUN(CODEUNIT::"O365 Setup Email");
      END;

      EXIT(TRUE);
    END;

    [External]
    PROCEDURE CheckDocumentIfNoItemsExists@7(SalesHeader@1000 : Record 36;OpenInvoiceIfNoItems@1002 : Boolean;O365SalesDocument@1003 : Record 2103);
    BEGIN
      WITH SalesHeader DO
        IF NOT SalesLinesExist THEN BEGIN
          IF OpenInvoiceIfNoItems AND (O365SalesDocument."No." <> '') THEN
            O365SalesDocument.OpenInvoice;
          CASE "Document Type" OF
            "Document Type"::Invoice:
              ERROR(ThereIsNothingToSellInvoiceErr);
            ELSE
              ERROR(ThereIsNothingToSellQuoteErr);
          END;
        END;
    END;

    BEGIN
    END.
  }
}

