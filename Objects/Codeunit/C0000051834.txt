OBJECT Codeunit 51834 Page9307EventSubscriber
{
  OBJECT-PROPERTIES
  {
    Date=09/08/21;
    Time=12:00:00 AM;
    Modified=Yes;
    Version List=NAVEVENT,001;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {

    [EventSubscriber(Page,9307,OnAfterActionEvent,SendApprovalRequest)]
    LOCAL PROCEDURE Pg9307_SendApprovalRequest_onAfterAction@1000000000(VAR Rec@1000000000 : Record 38);
    VAR
      NotificationManagement@1000000005 : Codeunit 1510;
      ApprovalEntry@1000000004 : Record 454;
      JobQueueEntry@1000000003 : Record 472;
      UserSetup@1000000002 : Record 91;
      PurchasesPayablesSetup@1000000001 : Record 312;
    BEGIN
      //>>001 TPZ3341
      WITH Rec DO BEGIN
        ApprovalEntry.SETCURRENTKEY("Table ID","Document Type","Document No.","Sequence No.");
        ApprovalEntry.SETRANGE("Table ID",DATABASE::"Purchase Header");
        ApprovalEntry.SETRANGE("Document Type","Document Type");
        ApprovalEntry.SETRANGE("Document No.","No.");
        ApprovalEntry.SETRANGE(Status,ApprovalEntry.Status::Open);
        IF ApprovalEntry.FIND('+') THEN BEGIN
          JobQueueEntry.INIT();
          JobQueueEntry."Object Type to Run" := JobQueueEntry."Object Type to Run"::Codeunit;
          JobQueueEntry."Object ID to Run" := CODEUNIT::"Select ParameterString";
          JobQueueEntry."Parameter String":= 'SendApprovalRequest';
          JobQueueEntry.ID:=CREATEGUID;
          JobQueueEntry."Timeout (sec.)" := 5000;
          JobQueueEntry."Earliest Start Date/Time" := CURRENTDATETIME;
          JobQueueEntry.Description := ApprovalEntry."Document No.";
          JobQueueEntry.INSERT;
          CODEUNIT.RUN(CODEUNIT::"Job Queue - Enqueue",JobQueueEntry);
        END;
      END;
      //ForBen
      IF PurchasesPayablesSetup.GET THEN;
      WITH Rec DO BEGIN
        ApprovalEntry.SETCURRENTKEY("Table ID","Document Type","Document No.","Sequence No.");
        ApprovalEntry.SETRANGE("Table ID",DATABASE::"Purchase Header");
        ApprovalEntry.SETRANGE("Document Type","Document Type");
        ApprovalEntry.SETRANGE("Document No.","No.");
        ApprovalEntry.SETRANGE(Status,ApprovalEntry.Status::Open);
        IF ApprovalEntry.FIND('+') THEN BEGIN
          JobQueueEntry.INIT();
          JobQueueEntry."Object Type to Run" := JobQueueEntry."Object Type to Run"::Codeunit;
          JobQueueEntry."Object ID to Run" := CODEUNIT::"Select ParameterString";
          JobQueueEntry."Parameter String":= 'DelegatedAway';
          JobQueueEntry.ID:=CREATEGUID;
          JobQueueEntry."Timeout (sec.)" := 5000;
          IF PurchasesPayablesSetup."Workflow Delegate After (Hrs)" > 0 THEN
            JobQueueEntry."Earliest Start Date/Time" := CURRENTDATETIME+(PurchasesPayablesSetup."Workflow Delegate After (Hrs)"*3600000)
            //JobQueueEntry."Earliest Start Date/Time" := CURRENTDATETIME + 60000
          ELSE
            JobQueueEntry."Earliest Start Date/Time" := CURRENTDATETIME;
          JobQueueEntry.Description := ApprovalEntry."Document No.";
          JobQueueEntry.INSERT;
          CODEUNIT.RUN(CODEUNIT::"Job Queue - Enqueue",JobQueueEntry);
        END;
      END;

      //ForSherrie
      IF PurchasesPayablesSetup.GET THEN;
      WITH Rec DO BEGIN
        ApprovalEntry.SETCURRENTKEY("Table ID","Document Type","Document No.","Sequence No.");
        ApprovalEntry.SETRANGE("Table ID",DATABASE::"Purchase Header");
        ApprovalEntry.SETRANGE("Document Type","Document Type");
        ApprovalEntry.SETRANGE("Document No.","No.");
        ApprovalEntry.SETRANGE(Status,ApprovalEntry.Status::Open);
        IF ApprovalEntry.FIND('+') THEN BEGIN
          JobQueueEntry.INIT();
          JobQueueEntry."Object Type to Run" := JobQueueEntry."Object Type to Run"::Codeunit;
          JobQueueEntry."Object ID to Run" := CODEUNIT::"Select ParameterString";
          JobQueueEntry."Parameter String":= 'DelegatedAway2';
          JobQueueEntry.ID:=CREATEGUID;
          JobQueueEntry."Timeout (sec.)" := 5000;
          IF PurchasesPayablesSetup."Workflow Delegate After (Hrs)" > 0 THEN
            JobQueueEntry."Earliest Start Date/Time" := CURRENTDATETIME+(PurchasesPayablesSetup."Workflow Delegate After (Hrs)"*3600000*2)
          //        JobQueueEntry."Earliest Start Date/Time" := CURRENTDATETIME + 90000
          ELSE
            JobQueueEntry."Earliest Start Date/Time" := CURRENTDATETIME;
          JobQueueEntry.Description := ApprovalEntry."Document No.";
          JobQueueEntry.INSERT;
          CODEUNIT.RUN(CODEUNIT::"Job Queue - Enqueue",JobQueueEntry);
        END;
      END;
      //<<001 TPZ3341
    END;

    BEGIN
    {
      001 TPZ3341 RPS 09082021 - PO Approval Process change
    }
    END.
  }
}

