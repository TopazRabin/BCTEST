OBJECT Codeunit 5773 Whse.-Transfer Release
{
  OBJECT-PROPERTIES
  {
    Date=09/22/20;
    Time=[ 8:28:30 AM];
    Modified=Yes;
    Version List=NAVW111.00;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      Location@1000 : Record 14;
      WhseMgt@1001 : Codeunit 5775;
      CalledFromTransferOrder@1002 : Boolean;

    [External]
    PROCEDURE Release@1(TransHeader@1000 : Record 5740);
    VAR
      WhseRqst@1001 : Record 5765;
      OldWhseRqst@1000000000 : Record 5765;
      TransferLineLoc@1000000001 : Record 5741;
    BEGIN
      WITH TransHeader DO BEGIN
        InitializeWhseRequest(WhseRqst,TransHeader,Status::Released);
        //>>TPZ2830 Event Created
        {
        //TM BEG 061115
        OldWhseRqst.SETCURRENTKEY("Source Type","Source No.");
        OldWhseRqst.SETRANGE("Source Type", DATABASE::"Transfer Line");
        OldWhseRqst.SETRANGE("Source No.","No.");
        IF OldWhseRqst.FINDFIRST THEN BEGIN
          WhseRqst."Activity Status" := OldWhseRqst."Activity Status";
        END;

        WhseRqst."E-Ship Agent Service" := "E-Ship Agent Service";
        WhseRqst."Sell-to/Transfer-to No." := "Transfer-to Code";
        WhseRqst."Sell-to/Transfer-to Name" := "Transfer-to Name";
        WhseRqst."Division Code" := "Shortcut Dimension 5 Code";
        //TM END 061115
        //-->TPZ2781 PSHUKLA
        TransferLineLoc.RESET;
        TransferLineLoc.SETRANGE("Document No.",TransHeader."No.");
        TransferLineLoc.SETRANGE("Item No.",'<>%1','');
        IF TransferLineLoc.FINDSET THEN
          WhseRqst."Number of Lines" := TransferLineLoc.COUNT;
        WhseRqst."Shipping Method" := TransHeader."Shipping Agent Code";
        WhseRqst."Pick Type" := WhseRqst."Pick Type"::"TO";
        //<--
        }
        //<<TPZ2830
        IF Location.RequireReceive("Transfer-to Code") OR
           Location.RequirePutaway("Transfer-to Code")
        THEN BEGIN
          CheckUnitOfMeasureCode("No.");
        IF Location.RequireReceive("Transfer-to Code") OR Location.RequirePutaway("Transfer-to Code") THEN
          CreateInboundWhseRequest(WhseRqst,TransHeader);
        IF Location.RequireShipment("Transfer-from Code") OR Location.RequirePicking("Transfer-from Code") THEN
          CreateOutboundWhseRequest(WhseRqst,TransHeader);

          WhseRqst.Type := WhseRqst.Type::Inbound;
          WhseRqst."Source Subtype" := 1;
          WhseRqst."Source Document" := WhseMgt.GetSourceDocument(WhseRqst."Source Type",WhseRqst."Source Subtype");
          WhseRqst."Location Code" := "Transfer-to Code";
          SETRANGE("Location Filter","Transfer-to Code");
          CALCFIELDS("Completely Received");
          WhseRqst."Completely Handled" := "Completely Received";
          WhseRqst."Shipment Method Code" := "Shipment Method Code";
          WhseRqst."Shipping Agent Code" := "Shipping Agent Code";
          WhseRqst."Expected Receipt Date" := "Receipt Date";
          WhseRqst."Destination No." := "Transfer-to Code";
          IF CalledFromTransferOrder THEN BEGIN
            IF WhseRqst.MODIFY THEN;
          END ELSE
            IF NOT WhseRqst.INSERT THEN
              WhseRqst.MODIFY;
        END;
        IF Location.RequireShipment("Transfer-from Code") OR
           Location.RequirePicking("Transfer-from Code")
        THEN BEGIN
          CheckUnitOfMeasureCode("No.");

          WhseRqst.Type := WhseRqst.Type::Outbound;
          WhseRqst."Location Code" := "Transfer-from Code";
          WhseRqst."Source Subtype" := 0;
          WhseRqst."Source Document" := WhseMgt.GetSourceDocument(WhseRqst."Source Type",WhseRqst."Source Subtype");
          WhseRqst."Shipping Advice" := "Shipping Advice";
          WhseRqst."Shipment Method Code" := "Shipment Method Code";
          WhseRqst."Shipping Agent Code" := "Shipping Agent Code";
          SETRANGE("Location Filter","Transfer-from Code");
          CALCFIELDS("Completely Shipped");
          WhseRqst."Completely Handled" := "Completely Shipped";
          WhseRqst."Shipment Date" := "Shipment Date";
          // >> RF
          WhseRqst.UpdateWarehouseRequest;
          // << RF
          WhseRqst."Destination No." := "Transfer-from Code";
          //>>TPZ2830
          OnBeforeCreateWhseRequest(WhseRqst,TransHeader);
          //<<TPZ2830
          IF NOT WhseRqst.INSERT THEN
            WhseRqst.MODIFY;
        END;

        WhseRqst.RESET;
        WhseRqst.SETCURRENTKEY("Source Type","Source No.");
        WhseRqst.SETRANGE("Source Type",DATABASE::"Transfer Line");
        WhseRqst.SETRANGE("Source No.","No.");
        WhseRqst.SETRANGE("Document Status",Status::Open);
        WhseRqst.DELETEALL(TRUE);
        DeleteOpenWhseRequest("No.");
      END;
    END;

    [External]
    PROCEDURE Reopen@2(TransHeader@1000 : Record 5740);
    VAR
      WhseRqst@1001 : Record 5765;
    BEGIN
      WITH TransHeader DO BEGIN
        IF WhseRqst.GET(WhseRqst.Type::Inbound,"Transfer-to Code",DATABASE::"Transfer Line",1,"No.") THEN BEGIN
          WhseRqst."Document Status" := Status::Open;
          WhseRqst.MODIFY;
        END;
        IF WhseRqst.GET(WhseRqst.Type::Outbound,"Transfer-from Code",DATABASE::"Transfer Line",0,"No.") THEN BEGIN
          WhseRqst."Document Status" := Status::Open;
          WhseRqst.MODIFY;
        END;
      END;
    END;

    PROCEDURE InitializeWhseRequest@7(VAR WarehouseRequest@1001 : Record 5765;TransferHeader@1000 : Record 5740;DocumentStatus@1002 : Option);
    BEGIN
      WITH WarehouseRequest DO BEGIN
        "Source Type" := DATABASE::"Transfer Line";
        "Source No." := TransferHeader."No.";
        "Document Status" := DocumentStatus;
        "Destination Type" := "Destination Type"::Location;
        "External Document No." := TransferHeader."External Document No.";
      END;
    END;

    PROCEDURE CreateInboundWhseRequest@9(VAR WarehouseRequest@1001 : Record 5765;TransferHeader@1000 : Record 5740);
    BEGIN
      WITH WarehouseRequest DO BEGIN
        CheckUnitOfMeasureCode(TransferHeader."No.");
        TransferHeader.SETRANGE("Location Filter",TransferHeader."Transfer-to Code");
        TransferHeader.CALCFIELDS("Completely Received");

        Type := Type::Inbound;
        "Source Subtype" := 1;
        "Source Document" := WhseMgt.GetSourceDocument("Source Type","Source Subtype");
        "Expected Receipt Date" := TransferHeader."Receipt Date";
        "Location Code" := TransferHeader."Transfer-to Code";
        "Completely Handled" := TransferHeader."Completely Received";
        "Shipment Method Code" := TransferHeader."Shipment Method Code";
        "Shipping Agent Code" := TransferHeader."Shipping Agent Code";
        "Destination No." := TransferHeader."Transfer-to Code";

        OnBeforeCreateWhseRequest(WarehouseRequest,TransferHeader);

        IF CalledFromTransferOrder THEN BEGIN
          IF MODIFY THEN;
        END ELSE
          IF NOT INSERT THEN
            MODIFY;
      END;
    END;

    PROCEDURE CreateOutboundWhseRequest@11(VAR WarehouseRequest@1001 : Record 5765;TransferHeader@1000 : Record 5740);
    BEGIN
      WITH WarehouseRequest DO BEGIN
        CheckUnitOfMeasureCode(TransferHeader."No.");
        TransferHeader.SETRANGE("Location Filter",TransferHeader."Transfer-from Code");
        TransferHeader.CALCFIELDS("Completely Shipped");

        Type := Type::Outbound;
        "Source Subtype" := 0;
        "Source Document" := WhseMgt.GetSourceDocument("Source Type","Source Subtype");
        "Location Code" := TransferHeader."Transfer-from Code";
        "Completely Handled" := TransferHeader."Completely Shipped";
        "Shipment Method Code" := TransferHeader."Shipment Method Code";
        "Shipping Agent Code" := TransferHeader."Shipping Agent Code";
        "Shipping Advice" := TransferHeader."Shipping Advice";
        "Shipment Date" := TransferHeader."Shipment Date";
        "Destination No." := TransferHeader."Transfer-from Code";

        OnBeforeCreateWhseRequest(WarehouseRequest,TransferHeader);

        IF NOT INSERT THEN
          MODIFY;
      END;
    END;

    LOCAL PROCEDURE DeleteOpenWhseRequest@13(TransferOrderNo@1000 : Code[20]);
    VAR
      WarehouseRequest@1001 : Record 5765;
    BEGIN
      WITH WarehouseRequest DO BEGIN
        SETCURRENTKEY("Source Type","Source No.");
        SETRANGE("Source Type",DATABASE::"Transfer Line");
        SETRANGE("Source No.",TransferOrderNo);
        SETRANGE("Document Status","Document Status"::Open);
        IF NOT ISEMPTY THEN
          DELETEALL(TRUE);
      END;
    END;

    [External]
    PROCEDURE SetCallFromTransferOrder@3(CalledFromTransferOrder2@1000 : Boolean);
    BEGIN
      CalledFromTransferOrder := CalledFromTransferOrder2;
    END;

    LOCAL PROCEDURE CheckUnitOfMeasureCode@5(DocumentNo@1000 : Code[20]);
    VAR
      TransLine@1001 : Record 5741;
    BEGIN
      TransLine.SETRANGE("Document No.",DocumentNo);
      TransLine.SETRANGE("Unit of Measure Code",'');
      TransLine.SETFILTER("Item No.",'<>%1','');
      IF TransLine.FINDFIRST THEN
        TransLine.TESTFIELD("Unit of Measure Code");
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeCreateWhseRequest@4(VAR WarehouseRequest@1000 : Record 5765;TransferHeader@1001 : Record 5740);
    BEGIN
    END;

    BEGIN
    {
      20200331  TPZ2781  PSHUKLA  Added code to flow Pck type, shipping method and Number of lines
    }
    END.
  }
}

