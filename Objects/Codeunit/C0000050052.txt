OBJECT Codeunit 50052 CustomerPriceBook
{
  OBJECT-PROPERTIES
  {
    Date=04/09/21;
    Time=12:00:00 AM;
    Modified=Yes;
    Version List=TPZ000.00.00,001;
  }
  PROPERTIES
  {
    OnRun=BEGIN
            CustomerPriceBook;
            //MfrCustomerPriceBook
          END;

  }
  CODE
  {

    LOCAL PROCEDURE CustomerPriceBook@1000000011();
    VAR
      Customer@1000000007 : Record 18;
      CustomerDivision_Local@1000000000 : Record 50007;
      CustomerPriceBookReport@1000000001 : Report 51014;
      MailVar@1000000004 : Codeunit 400;
      SMTP_Setup@1000000003 : Record 409;
      ReportUser@1000000002 : Record 50015;
      Excel@1000000006 : TextConst 'ENU=.xlsx';
      Text0001@1000000005 : TextConst 'ENU=Synched Contact Report';
      Strtdate@1000000008 : Date;
    BEGIN
      Strtdate:=CALCDATE('-2Y',WORKDATE);//<TPZ3146>
      CustomerDivision_Local.RESET;
      CustomerDivision_Local.SETFILTER("Mfr. Rep. Code",'EA');
      CustomerDivision_Local.SETRANGE("Shortcut Dimension 5 Code",'E');
      IF CustomerDivision_Local.FINDSET THEN BEGIN
        REPEAT
          //<TPZ3146>
          Customer.RESET;
          Customer.SETRANGE("No.",CustomerDivision_Local."Customer No.");
          Customer.SETFILTER(Blocked,'<>%1',Customer.Blocked::All);
          Customer.SETRANGE("Date Filter",Strtdate,WORKDATE);
          Customer.SETFILTER("Sales (LCY)",'<>%1',0);
          IF Customer.FINDFIRST THEN BEGIN //</TPZ3146>
        //  IF Customer.GET(CustomerDivision_Local."Customer No.") THEN BEGIN //<TPZ3146>
          //  MESSAGE(FORMAT(Customer."No."));
            SMTP_Setup.GET('');
            CLEAR(CustomerPriceBookReport);
            ReportUser.GET(FORMAT(COPYSTR(CustomerPriceBookReport.OBJECTID(FALSE),8,15)));
            CustomerPriceBookReport.ApplyFilters(CustomerDivision_Local."Customer No.",CustomerDivision_Local."Shortcut Dimension 5 Code",WORKDATE,TRUE,'00');
            IF (CustomerDivision_Local."Mfr. Rep. Code"<>'') THEN
               CustomerPriceBookReport.SAVEASEXCEL(ReportUser."File Path"+CustomerDivision_Local."Mfr. Rep. Code"+'_'+Customer."No."+Excel)
            ELSE
              CustomerPriceBookReport.SAVEASEXCEL(ReportUser."File Path"+CustomerDivision_Local."Salesperson Code"+'_'+Customer."No."+'_OSR'+Excel);
          END;
        UNTIL CustomerDivision_Local.NEXT =0;
      END;
    END;

    LOCAL PROCEDURE MfrCustomerPriceBook@1000000000();
    VAR
      Customer@1000000007 : Record 18;
      CustomerDivision_Local@1000000000 : Record 50007;
      CustomerPriceBookReport@1000000001 : Report 51014;
      MailVar@1000000004 : Codeunit 400;
      SMTP_Setup@1000000003 : Record 409;
      ReportUser@1000000002 : Record 50015;
      Excel@1000000006 : TextConst 'ENU=.xlsx';
      Text0001@1000000005 : TextConst 'ENU=Synched Contact Report';
      MfrRep@1000000008 : Record 50027;
      FileSystemAutomation@1000000009 : Automation "{420B2830-E718-11CF-893D-00A0C9054228} 1.0:{0D43FE01-F093-11CF-8940-00A0C9054228}:'Microsoft Scripting Runtime'.FileSystemObject";
      FolderName@1000000010 : Text;
      CustomerName@1000000011 : Text;
      Shell32@1000000012 : Automation "{50A7E9B0-70EF-11D1-B75A-00A0C90564FE} 1.0:{13709620-C279-11CE-A49E-444553540000}:'Microsoft Shell Controls And Automation'.Shell";
      ZIPFolder@1000000013 : Automation "{50A7E9B0-70EF-11D1-B75A-00A0C90564FE} 1.0:{BBCBDE60-C3FF-11CE-8350-444553540000}:'Microsoft Shell Controls And Automation'.Folder";
      ZipFile@1000000014 : File;
      Filename@1000000015 : Text;
      IntVal@1000000016 : Integer;
      ZipFileName@1000000017 : Text;
      i@1000000018 : Integer;
      zip@1000000019 : TextConst 'ENU=.zip';
    BEGIN
      IF ISCLEAR(FileSystemAutomation) THEN
        CREATE(FileSystemAutomation,FALSE,TRUE);
      FolderName := '';
      MfrRep.RESET;
      //MfrRep.SETFILTER(Code,'%1|%2','CNW','UVD','BLA');
      IF MfrRep.FINDSET THEN BEGIN
       REPEAT
         FolderName := '';
        CustomerDivision_Local.RESET;
        CustomerDivision_Local.SETFILTER("Mfr. Rep. Code",MfrRep.Code);
        //CustomerDivision_Local.SETFILTER("Customer No.",'%1|%2|%3|%4','01441','54642','00310','00937');
        CustomerDivision_Local.SETRANGE("Shortcut Dimension 5 Code",'E');
        IF CustomerDivision_Local.FINDSET THEN BEGIN
          REPEAT
            FolderName := '\\nyvsvnavnsttst6\UserData\Reporting\Price1\' + MfrRep.Code +'\';
            CustomerName := '';
            Customer.RESET;
            IF Customer.GET(CustomerDivision_Local."Customer No.") THEN BEGIN
              SMTP_Setup.GET('');
              CLEAR(CustomerPriceBookReport);
              //ReportUser.GET(FORMAT(COPYSTR(CustomerPriceBookReport.OBJECTID(FALSE),8,15)));

              CustomerName := DELCHR(Customer.Name,'=','!|@|#|$|%|\|/|*|:|"|<|>|?');
              IF NOT FileSystemAutomation.FolderExists(FolderName) THEN
                    FileSystemAutomation.CreateFolder(FolderName);
              CustomerPriceBookReport.ApplyFilters(CustomerDivision_Local."Customer No.",CustomerDivision_Local."Shortcut Dimension 5 Code",WORKDATE,TRUE,'00');
              //IF (CustomerDivision_Local."Mfr. Rep. Code"<>'') THEN
                 CustomerPriceBookReport.SAVEASEXCEL(FolderName + CustomerDivision_Local."Mfr. Rep. Code"+'_'+Customer."No."+'_'+CustomerName+Excel)
             // ELSE
               // CustomerPriceBookReport.SAVEASEXCEL(ReportUser."File Path"+CustomerDivision_Local."Salesperson Code"+'_'+Customer."No."+'_OSR'+Excel);
            END;
          UNTIL CustomerDivision_Local.NEXT =0;
                  ZipFile.CREATE('\\nyvsvnavnsttst6\UserData\Reporting\Price1\' + MfrRep.Code +zip);
                  ZipFile.TEXTMODE(FALSE);
                  IntVal:=101010256;
                  ZipFile.WRITE(IntVal);
                  IntVal:=0;
                  FOR i:=1 TO 9 DO
                    ZipFile.WRITE(IntVal);
                  ZipFile.CLOSE;
                  IF ISCLEAR(Shell32) THEN
                      CREATE(Shell32,FALSE,TRUE);
                //  CREATE(Shell32);
                  ZIPFolder:=Shell32.NameSpace('\\nyvsvnavnsttst6\UserData\Reporting\Price1\' + MfrRep.Code+zip);
                 // Filename := FolderName + CustomerDivision_Local."Mfr. Rep. Code"+'_'+Customer."No."+'_'+CustomerName+Excel;
                 Filename := '\\nyvsvnavnsttst6\UserData\Reporting\Price1\' + MfrRep.Code;
                  ZIPFolder.CopyHere(Filename);
                  CLEAR(Shell32);
        END;
       UNTIL MfrRep.NEXT = 0;
      END;
    END;

    BEGIN
    {
      2018-04-30 TPZ2286 DKUMAR
        Price Book Export Batch for Electric customers

      001 TPZ3146 UTK 04092021 Added code for Bolcked and Sales filters.
    }
    END.
  }
}

