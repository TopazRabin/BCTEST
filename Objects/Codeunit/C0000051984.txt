OBJECT Codeunit 51984 Page10038EventSubscriber
{
  OBJECT-PROPERTIES
  {
    Date=09/10/20;
    Time=[ 8:50:32 AM];
    Modified=Yes;
    Version List=TPZ000.00.00;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {

    [EventSubscriber(Codeunit,51983,Pg10038_OnGetVendorCost)]
    PROCEDURE Pg10038_GetVendorCost@1000000001(VAR Sender@1000000000 : Codeunit 51983;VAR VendorCost@1000000002 : Decimal;VAR TotVendorCost@1000000006 : Decimal;SalesHeader@1000000007 : Record 36);
    VAR
      Item@1000000004 : Record 27;
      Vendor@1000000003 : Record 23;
      SalesLine@1000000001 : Record 37;
      PurchPrice@1000000005 : Record 7012;
    BEGIN
      //TOP150 - KT ABCSI Sales Order Margin Review 04072015 Start
      SalesLine.RESET;
      SalesLine.SETCURRENTKEY("Document Type","Document No.","Line No.");
      SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine.SETRANGE("Document No.",SalesHeader."No.");
      SalesLine.SETRANGE(Type,SalesLine.Type::Item);
      IF SalesLine.FIND('-') THEN REPEAT
        IF Item.GET(SalesLine."No.") AND Vendor.GET(Item."Vendor No.") THEN BEGIN
          PurchPrice.RESET;
          PurchPrice.SETCURRENTKEY("Item No.","Vendor No.","Unit of Measure Code");
          PurchPrice.SETRANGE("Item No.",Item."No.");
          PurchPrice.SETRANGE("Vendor No.",Vendor."No.");
          PurchPrice.SETRANGE("Unit of Measure Code",'PCS');
          IF PurchPrice.FIND('-') AND ( PurchPrice."Direct Unit Cost" <> 0) THEN BEGIN
            VendorCost += PurchPrice."Direct Unit Cost" * (( 100 + Item."Indirect Cost %") / 100);
            TotVendorCost += SalesLine."Quantity (Base)" * PurchPrice."Direct Unit Cost" * (( 100 + Item."Indirect Cost %") / 100);
          END ELSE BEGIN
            VendorCost += SalesLine."Unit Cost (LCY)";
            TotVendorCost += SalesLine."Quantity (Base)" * SalesLine."Unit Cost (LCY)";
          END;
        END ELSE BEGIN
          VendorCost += SalesLine."Unit Cost (LCY)";
          TotVendorCost += SalesLine."Quantity (Base)" * SalesLine."Unit Cost (LCY)";
        END;
      UNTIL SalesLine.NEXT = 0;
      //TOP150 - KT ABCSI Sales Order Margin Review 04072015 End
    END;

    [EventSubscriber(Codeunit,51983,Pg10038_OnAfterGetRecord)]
    LOCAL PROCEDURE Pg10038_OnAfterGetRecord@1000000000(VAR Sender@1000000000 : Codeunit 51983;TotalSalesLineLCY@1000000001 : ARRAY [3] OF Record 37;TotalVendorCost@1000000002 : Decimal;VAR VendorPft@1000000003 : Decimal;VAR "VendorPft%"@1000000004 : Decimal);
    BEGIN

      //TOP150 - KT ABCSI Sales Order Margin Review 04072015 Start
      VendorPft := TotalSalesLineLCY[1].Amount - TotalVendorCost;
      IF TotalSalesLineLCY[1].Amount <> 0 THEN
        "VendorPft%" := ROUND( ( VendorPft * 100) / TotalSalesLineLCY[1].Amount, 0.1);
      //TOP150 - KT ABCSI Sales Order Margin Review 04072015 Start
    END;

    BEGIN
    END.
  }
}

